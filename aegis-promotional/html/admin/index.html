<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aegis OS - Admin Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0f1419;
            --bg-card: #1a1f2e;
            --bg-hover: #252b3b;
            --primary: #6366f1;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #2d3748;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .nav-section { margin-bottom: 1.5rem; }
        .nav-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            letter-spacing: 0.05em;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            margin-bottom: 0.25rem;
        }
        .nav-item:hover, .nav-item.active {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .nav-item.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        .nav-icon { font-size: 1.25rem; }
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
        }
        .header-actions { display: flex; gap: 1rem; align-items: center; }
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.875rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-danger { background: var(--error); color: white; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .stat-icon.users { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .stat-icon.downloads { background: linear-gradient(135deg, #10b981, #059669); }
        .stat-icon.revenue { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .stat-icon.licenses { background: linear-gradient(135deg, #ec4899, #db2777); }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        .stat-label { color: var(--text-secondary); font-size: 0.875rem; }
        .stat-change {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        .stat-change.positive { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .stat-change.negative { background: rgba(239, 68, 68, 0.2); color: var(--error); }
        .grid-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title { font-weight: 600; font-size: 1rem; }
        .card-body { padding: 1.5rem; }
        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .activity-icon.license { background: rgba(99, 102, 241, 0.2); }
        .activity-icon.download { background: rgba(16, 185, 129, 0.2); }
        .activity-icon.payment { background: rgba(245, 158, 11, 0.2); }
        .activity-icon.user { background: rgba(236, 72, 153, 0.2); }
        .activity-content { flex: 1; }
        .activity-title { font-size: 0.875rem; margin-bottom: 0.25rem; }
        .activity-time { font-size: 0.75rem; color: var(--text-secondary); }
        .quick-action {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            background: var(--bg-hover);
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: var(--text-primary);
        }
        .quick-action:hover {
            background: var(--primary);
            transform: translateX(5px);
        }
        .quick-action-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        .quick-action-text { font-size: 0.875rem; font-weight: 500; }
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .login-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
        }
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .login-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .login-header p { color: var(--text-secondary); }
        .form-group { margin-bottom: 1.25rem; }
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 0.875rem;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .btn-full { width: 100%; justify-content: center; padding: 0.875rem; }
        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: none;
        }
        .hidden { display: none !important; }
        @media (max-width: 1024px) {
            .sidebar { width: 80px; padding: 1rem; }
            .sidebar .nav-text, .sidebar .nav-section-title, .sidebar .logo span { display: none; }
            .main-content { margin-left: 80px; }
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card">
            <div class="login-header">
                <div class="logo" style="justify-content: center; margin-bottom: 1rem;">
                    <span>üõ°Ô∏è</span>
                    <span>Aegis Admin</span>
                </div>
                <h2>Admin Login</h2>
                <p>Enter your credentials to access the dashboard</p>
            </div>
            <div id="errorMsg" class="error-message"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-input" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Sign In</button>
            </form>
        </div>
    </div>

    <div id="adminPanel" class="admin-layout hidden">
        <aside class="sidebar">
            <div class="logo">
                <span>üõ°Ô∏è</span>
                <span>Aegis Admin</span>
            </div>
            <nav>
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="/admin" class="nav-item active">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-text">Dashboard</span>
                    </a>
                    <a href="/admin/licenses" class="nav-item">
                        <span class="nav-icon">üîë</span>
                        <span class="nav-text">Licenses</span>
                    </a>
                    <a href="/admin/pages" class="nav-item">
                        <span class="nav-icon">üìÑ</span>
                        <span class="nav-text">Page Builder</span>
                    </a>
                    <a href="/admin/giveaways" class="nav-item">
                        <span class="nav-icon">üéÅ</span>
                        <span class="nav-text">Giveaways</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Analytics</div>
                    <a href="#" class="nav-item" onclick="showAnalytics('sales')">
                        <span class="nav-icon">üí∞</span>
                        <span class="nav-text">Sales Analytics</span>
                    </a>
                    <a href="#" class="nav-item" onclick="showAnalytics('editions')">
                        <span class="nav-icon">üìà</span>
                        <span class="nav-text">Edition Breakdown</span>
                    </a>
                    <a href="#" class="nav-item" onclick="showAnalytics('trends')">
                        <span class="nav-icon">üìâ</span>
                        <span class="nav-text">Trends</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <a href="#" class="nav-item" onclick="showUsers()">
                        <span class="nav-icon">üë•</span>
                        <span class="nav-text">Users</span>
                    </a>
                    <a href="#" class="nav-item" onclick="showBulkOperations()">
                        <span class="nav-icon">üì¶</span>
                        <span class="nav-text">Bulk Operations</span>
                    </a>
                    <a href="#" class="nav-item" onclick="showReports()">
                        <span class="nav-icon">üìã</span>
                        <span class="nav-text">Reports</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <a href="#" class="nav-item" onclick="showSystemHealth()">
                        <span class="nav-icon">‚ù§Ô∏è</span>
                        <span class="nav-text">System Health</span>
                    </a>
                    <a href="#" class="nav-item" onclick="showSystemLogs()">
                        <span class="nav-icon">üìú</span>
                        <span class="nav-text">Audit Logs</span>
                    </a>
                    <a href="/admin/settings" class="nav-item">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span class="nav-text">Settings</span>
                    </a>
                    <a href="#" class="nav-item" onclick="logout()">
                        <span class="nav-icon">üö™</span>
                        <span class="nav-text">Logout</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1>Dashboard Overview</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
                    <button class="btn btn-primary" onclick="window.location.href='/admin/licenses'">+ New License</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon users">üë§</div>
                    </div>
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Registered Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon licenses">üîë</div>
                    </div>
                    <div class="stat-value" id="activeLicenses">0</div>
                    <div class="stat-label">Licenses Issued</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ec4899, #8b5cf6);">üéÅ</div>
                    </div>
                    <div class="stat-value" id="activeGiveaways">0</div>
                    <div class="stat-label">Active Giveaways</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon downloads">‚¨áÔ∏è</div>
                    </div>
                    <div class="stat-value" id="totalDownloads">0</div>
                    <div class="stat-label">Downloads</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Recent Activity</span>
                        <button class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">View All</button>
                    </div>
                    <div class="card-body" id="activityLog">
                        <div class="activity-item">
                            <div class="activity-icon license">üîë</div>
                            <div class="activity-content">
                                <div class="activity-title">New license activated - Gamer Edition</div>
                                <div class="activity-time">2 minutes ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon download">‚¨áÔ∏è</div>
                            <div class="activity-content">
                                <div class="activity-title">ISO downloaded - Freemium Edition</div>
                                <div class="activity-time">15 minutes ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon payment">üí≥</div>
                            <div class="activity-content">
                                <div class="activity-title">Payment received - $89 (Gamer Lifetime)</div>
                                <div class="activity-time">1 hour ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon user">üë§</div>
                            <div class="activity-content">
                                <div class="activity-title">New user registered</div>
                                <div class="activity-time">2 hours ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon license">üîë</div>
                            <div class="activity-content">
                                <div class="activity-title">License generated - AI-Dev Edition (bulk x5)</div>
                                <div class="activity-time">3 hours ago</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Quick Actions</span>
                    </div>
                    <div class="card-body">
                        <a href="/admin/licenses" class="quick-action">
                            <div class="quick-action-icon">üîë</div>
                            <span class="quick-action-text">Generate License</span>
                        </a>
                        <a href="/admin/licenses#gift" class="quick-action">
                            <div class="quick-action-icon">üéÅ</div>
                            <span class="quick-action-text">Gift Free License</span>
                        </a>
                        <a href="/admin/giveaways" class="quick-action">
                            <div class="quick-action-icon">üé≤</div>
                            <span class="quick-action-text">Create Giveaway</span>
                        </a>
                        <a href="/admin/pages" class="quick-action">
                            <div class="quick-action-icon">üìÑ</div>
                            <span class="quick-action-text">Edit Pages</span>
                        </a>
                        <a href="/admin/settings" class="quick-action">
                            <div class="quick-action-icon">‚öôÔ∏è</div>
                            <span class="quick-action-text">Site Settings</span>
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api/admin';
        let authToken = localStorage.getItem('adminToken');

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('errorMsg');
            
            try {
                const res = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await res.json();
                
                if (res.ok && data.token) {
                    localStorage.setItem('adminToken', data.token);
                    authToken = data.token;
                    showAdminPanel();
                    loadDashboardData();
                } else {
                    errorMsg.textContent = data.error || 'Invalid credentials';
                    errorMsg.style.display = 'block';
                }
            } catch (err) {
                errorMsg.textContent = 'Connection error. Please try again.';
                errorMsg.style.display = 'block';
            }
        });

        function showAdminPanel() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        function logout() {
            localStorage.removeItem('adminToken');
            authToken = null;
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
        }

        async function checkAuth() {
            if (!authToken) return false;
            try {
                const res = await fetch(`${API_BASE}/verify`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                return res.ok;
            } catch {
                return false;
            }
        }

        async function loadDashboardData() {
            try {
                const res = await fetch(`${API_BASE}/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('totalUsers').textContent = (data.users || 0).toLocaleString();
                    document.getElementById('totalDownloads').textContent = (data.downloads || 0).toLocaleString();
                    document.getElementById('activeLicenses').textContent = (data.licenses || 0).toLocaleString();
                    document.getElementById('activeGiveaways').textContent = (data.active_giveaways || 0).toLocaleString();
                }
            } catch (err) {
                console.log('Error loading stats:', err);
            }
        }

        async function refreshData() {
            await loadDashboardData();
        }

        function showModal(title, content) {
            const existingModal = document.getElementById('adminModal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'adminModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:2000;padding:2rem;';
            modal.innerHTML = `
                <div style="background:var(--bg-card);border-radius:16px;width:100%;max-width:900px;max-height:90vh;overflow:hidden;border:1px solid var(--border);">
                    <div style="padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
                        <h3 style="font-size:1.25rem;font-weight:600;">${title}</h3>
                        <button onclick="closeModal()" style="background:none;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer;">&times;</button>
                    </div>
                    <div style="padding:1.5rem;overflow-y:auto;max-height:calc(90vh - 70px);">${content}</div>
                </div>
            `;
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };
            document.body.appendChild(modal);
        }

        function closeModal() {
            const modal = document.getElementById('adminModal');
            if (modal) modal.remove();
        }

        async function showAnalytics(type) {
            try {
                let endpoint = '';
                let title = '';
                
                if (type === 'sales') {
                    endpoint = '/analytics/sales?period=month';
                    title = 'Sales Analytics (Last 30 Days)';
                } else if (type === 'editions') {
                    endpoint = '/analytics/editions';
                    title = 'Edition Breakdown';
                } else if (type === 'trends') {
                    endpoint = '/analytics/trends?days=30';
                    title = 'License Trends (30 Days)';
                }
                
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    let content = '<div style="font-family:monospace;background:var(--bg-dark);padding:1rem;border-radius:8px;overflow-x:auto;"><pre style="margin:0;white-space:pre-wrap;">' + JSON.stringify(data, null, 2) + '</pre></div>';
                    
                    if (type === 'sales') {
                        content = `
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem;">
                                <div style="background:var(--bg-hover);padding:1rem;border-radius:8px;text-align:center;">
                                    <div style="font-size:2rem;font-weight:700;color:var(--success);">$${(data.total_revenue || 0).toLocaleString()}</div>
                                    <div style="color:var(--text-secondary);font-size:0.875rem;">Total Revenue</div>
                                </div>
                                <div style="background:var(--bg-hover);padding:1rem;border-radius:8px;text-align:center;">
                                    <div style="font-size:2rem;font-weight:700;color:var(--primary);">${data.total_licenses || 0}</div>
                                    <div style="color:var(--text-secondary);font-size:0.875rem;">Licenses Sold</div>
                                </div>
                                <div style="background:var(--bg-hover);padding:1rem;border-radius:8px;text-align:center;">
                                    <div style="font-size:2rem;font-weight:700;color:var(--accent);">${data.period || 'month'}</div>
                                    <div style="color:var(--text-secondary);font-size:0.875rem;">Period</div>
                                </div>
                            </div>
                            <h4 style="margin-bottom:1rem;">Revenue by Edition</h4>
                            <div style="background:var(--bg-dark);padding:1rem;border-radius:8px;">
                                ${Object.entries(data.edition_revenue || {}).map(([ed, rev]) => `
                                    <div style="display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid var(--border);">
                                        <span style="text-transform:capitalize;">${ed}</span>
                                        <span style="color:var(--success);">$${rev.toLocaleString()}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else if (type === 'editions') {
                        content = `
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;">
                                ${Object.entries(data.edition_breakdown || {}).map(([ed, info]) => `
                                    <div style="background:var(--bg-hover);padding:1rem;border-radius:8px;">
                                        <div style="font-weight:600;text-transform:capitalize;margin-bottom:0.5rem;">${ed}</div>
                                        <div style="font-size:0.875rem;color:var(--text-secondary);">
                                            <div>Total: ${info.total}</div>
                                            <div>Active: <span style="color:var(--success);">${info.active}</span></div>
                                            <div>Revenue: <span style="color:var(--warning);">$${(info.revenue || 0).toFixed(2)}</span></div>
                                            <div>Lifetime: ${info.lifetime} | Annual: ${info.annual}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else if (type === 'trends') {
                        content = `
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem;">
                                <div style="background:var(--bg-hover);padding:1rem;border-radius:8px;text-align:center;">
                                    <div style="font-size:2rem;font-weight:700;color:var(--primary);">${data.total_licenses || 0}</div>
                                    <div style="color:var(--text-secondary);font-size:0.875rem;">Total Licenses (${data.period_days} days)</div>
                                </div>
                                <div style="background:var(--bg-hover);padding:1rem;border-radius:8px;text-align:center;">
                                    <div style="font-size:2rem;font-weight:700;color:var(--success);">${data.average_daily || 0}</div>
                                    <div style="color:var(--text-secondary);font-size:0.875rem;">Daily Average</div>
                                </div>
                            </div>
                            <h4 style="margin-bottom:1rem;">Daily Breakdown</h4>
                            <div style="background:var(--bg-dark);padding:1rem;border-radius:8px;max-height:300px;overflow-y:auto;">
                                ${Object.entries(data.daily_trend || {}).sort((a,b) => b[0].localeCompare(a[0])).map(([day, count]) => `
                                    <div style="display:flex;justify-content:space-between;padding:0.25rem 0;">
                                        <span>${day}</span>
                                        <span style="color:var(--primary);">${count} license(s)</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    showModal(title, content);
                } else {
                    showModal('Error', '<p style="color:var(--error);">Failed to load analytics data</p>');
                }
            } catch (err) {
                showModal('Error', `<p style="color:var(--error);">Error: ${err.message}</p>`);
            }
        }

        async function showUsers() {
            try {
                const res = await fetch(`${API_BASE}/users?per_page=50`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    const content = `
                        <div style="margin-bottom:1rem;display:flex;justify-content:space-between;align-items:center;">
                            <span>Total: ${data.pagination?.total || 0} users</span>
                        </div>
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="background:var(--bg-dark);">
                                    <th style="padding:0.75rem;text-align:left;border-bottom:1px solid var(--border);">ID</th>
                                    <th style="padding:0.75rem;text-align:left;border-bottom:1px solid var(--border);">Email</th>
                                    <th style="padding:0.75rem;text-align:left;border-bottom:1px solid var(--border);">Name</th>
                                    <th style="padding:0.75rem;text-align:left;border-bottom:1px solid var(--border);">Licenses</th>
                                    <th style="padding:0.75rem;text-align:left;border-bottom:1px solid var(--border);">Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(data.users || []).map(user => `
                                    <tr style="border-bottom:1px solid var(--border);">
                                        <td style="padding:0.75rem;">${user.id}</td>
                                        <td style="padding:0.75rem;">${user.email || '-'}</td>
                                        <td style="padding:0.75rem;">${user.name || '-'}</td>
                                        <td style="padding:0.75rem;">${user.license_count || 0}</td>
                                        <td style="padding:0.75rem;">${user.created_at ? new Date(user.created_at).toLocaleDateString() : '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    showModal('User Management', content);
                } else {
                    showModal('Error', '<p style="color:var(--error);">Failed to load users</p>');
                }
            } catch (err) {
                showModal('Error', `<p style="color:var(--error);">Error: ${err.message}</p>`);
            }
        }

        async function showSystemHealth() {
            try {
                const res = await fetch(`${API_BASE}/system/health`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    const statusColor = data.status === 'healthy' ? 'var(--success)' : data.status === 'degraded' ? 'var(--warning)' : 'var(--error)';
                    
                    const content = `
                        <div style="text-align:center;margin-bottom:1.5rem;">
                            <div style="font-size:3rem;margin-bottom:0.5rem;">${data.status === 'healthy' ? '‚úÖ' : data.status === 'degraded' ? '‚ö†Ô∏è' : '‚ùå'}</div>
                            <div style="font-size:1.5rem;font-weight:700;color:${statusColor};text-transform:uppercase;">${data.status}</div>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;">
                            <div style="background:var(--bg-hover);padding:1rem;border-radius:8px;">
                                <div style="font-weight:600;margin-bottom:0.5rem;">üíæ Database</div>
                                <div style="color:${data.checks?.database?.status === 'healthy' ? 'var(--success)' : 'var(--error)'};">${data.checks?.database?.status || 'unknown'}</div>
                            </div>
                            <div style="background:var(--bg-hover);padding:1rem;border-radius:8px;">
                                <div style="font-weight:600;margin-bottom:0.5rem;">üíΩ Disk</div>
                                <div>${data.checks?.disk?.usage_percent || 0}% used</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);">${data.checks?.disk?.free_gb || 0} GB free</div>
                            </div>
                            <div style="background:var(--bg-hover);padding:1rem;border-radius:8px;">
                                <div style="font-weight:600;margin-bottom:0.5rem;">üß† Memory</div>
                                <div>${data.checks?.memory?.usage_percent || 0}% used</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);">${data.checks?.memory?.free_mb || 0} MB free</div>
                            </div>
                            <div style="background:var(--bg-hover);padding:1rem;border-radius:8px;">
                                <div style="font-weight:600;margin-bottom:0.5rem;">üîß App</div>
                                <div>v${data.checks?.application?.version || '?'}</div>
                                <div style="font-size:0.75rem;color:var(--text-secondary);">${data.checks?.application?.active_admin_sessions || 0} active sessions</div>
                            </div>
                        </div>
                        <div style="margin-top:1.5rem;background:var(--bg-dark);padding:1rem;border-radius:8px;">
                            <div style="font-weight:600;margin-bottom:0.5rem;">Database Records</div>
                            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;font-size:0.875rem;">
                                <div>Users: ${data.checks?.tables?.users || 0}</div>
                                <div>Licenses: ${data.checks?.tables?.licenses || 0}</div>
                                <div>Giveaways: ${data.checks?.tables?.giveaways || 0}</div>
                                <div>Admins: ${data.checks?.tables?.admin_users || 0}</div>
                            </div>
                        </div>
                    `;
                    showModal('System Health', content);
                } else {
                    showModal('Error', '<p style="color:var(--error);">Failed to load system health</p>');
                }
            } catch (err) {
                showModal('Error', `<p style="color:var(--error);">Error: ${err.message}</p>`);
            }
        }

        async function showSystemLogs() {
            try {
                const res = await fetch(`${API_BASE}/system/logs?limit=50`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    const content = `
                        <div style="margin-bottom:1rem;">Showing ${data.returned} of ${data.total_available} logs</div>
                        <div style="background:var(--bg-dark);border-radius:8px;max-height:500px;overflow-y:auto;">
                            ${(data.logs || []).reverse().map(log => `
                                <div style="padding:0.75rem;border-bottom:1px solid var(--border);font-size:0.875rem;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:0.25rem;">
                                        <span style="font-weight:600;">${log.action || '-'}</span>
                                        <span style="color:${log.severity === 'HIGH' || log.severity === 'CRITICAL' ? 'var(--error)' : log.severity === 'WARNING' ? 'var(--warning)' : 'var(--text-secondary)'};">${log.severity || 'INFO'}</span>
                                    </div>
                                    <div style="color:var(--text-secondary);font-size:0.75rem;">${log.timestamp || '-'}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    showModal('Audit Logs', content);
                } else {
                    showModal('Error', '<p style="color:var(--error);">Failed to load logs</p>');
                }
            } catch (err) {
                showModal('Error', `<p style="color:var(--error);">Error: ${err.message}</p>`);
            }
        }

        async function showBulkOperations() {
            const content = `
                <div style="display:grid;gap:1.5rem;">
                    <div style="background:var(--bg-hover);padding:1.5rem;border-radius:8px;">
                        <h4 style="margin-bottom:1rem;">üì¶ Bulk Create Licenses</h4>
                        <div style="display:grid;gap:0.75rem;">
                            <div>
                                <label style="display:block;font-size:0.875rem;margin-bottom:0.25rem;">Count (1-100)</label>
                                <input type="number" id="bulkCount" value="5" min="1" max="100" style="width:100%;padding:0.5rem;border-radius:6px;border:1px solid var(--border);background:var(--bg-dark);color:var(--text-primary);">
                            </div>
                            <div>
                                <label style="display:block;font-size:0.875rem;margin-bottom:0.25rem;">Edition</label>
                                <select id="bulkEdition" style="width:100%;padding:0.5rem;border-radius:6px;border:1px solid var(--border);background:var(--bg-dark);color:var(--text-primary);">
                                    <option value="basic">Basic</option>
                                    <option value="gamer">Gamer</option>
                                    <option value="ai-dev">AI-Dev</option>
                                    <option value="server">Server</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block;font-size:0.875rem;margin-bottom:0.25rem;">Type</label>
                                <select id="bulkType" style="width:100%;padding:0.5rem;border-radius:6px;border:1px solid var(--border);background:var(--bg-dark);color:var(--text-primary);">
                                    <option value="lifetime">Lifetime</option>
                                    <option value="annual">Annual</option>
                                </select>
                            </div>
                            <button onclick="createBulkLicenses()" class="btn btn-primary" style="margin-top:0.5rem;">Create Licenses</button>
                        </div>
                    </div>
                    <div style="background:var(--bg-hover);padding:1.5rem;border-radius:8px;">
                        <h4 style="margin-bottom:1rem;">üìß Bulk Email</h4>
                        <div style="display:grid;gap:0.75rem;">
                            <div>
                                <label style="display:block;font-size:0.875rem;margin-bottom:0.25rem;">Subject</label>
                                <input type="text" id="emailSubject" placeholder="Email subject" style="width:100%;padding:0.5rem;border-radius:6px;border:1px solid var(--border);background:var(--bg-dark);color:var(--text-primary);">
                            </div>
                            <div>
                                <label style="display:block;font-size:0.875rem;margin-bottom:0.25rem;">Content</label>
                                <textarea id="emailContent" placeholder="Email content" rows="3" style="width:100%;padding:0.5rem;border-radius:6px;border:1px solid var(--border);background:var(--bg-dark);color:var(--text-primary);resize:vertical;"></textarea>
                            </div>
                            <button onclick="sendBulkEmails()" class="btn btn-primary" style="margin-top:0.5rem;">Send Emails</button>
                        </div>
                    </div>
                </div>
                <div id="bulkResult" style="margin-top:1rem;"></div>
            `;
            showModal('Bulk Operations', content);
        }

        async function createBulkLicenses() {
            const count = parseInt(document.getElementById('bulkCount').value);
            const edition = document.getElementById('bulkEdition').value;
            const type = document.getElementById('bulkType').value;
            
            try {
                const res = await fetch(`${API_BASE}/licenses/bulk`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count, edition, type })
                });
                
                const data = await res.json();
                document.getElementById('bulkResult').innerHTML = res.ok 
                    ? `<div style="background:rgba(16,185,129,0.2);color:var(--success);padding:1rem;border-radius:8px;">Created ${data.count} licenses!</div>`
                    : `<div style="background:rgba(239,68,68,0.2);color:var(--error);padding:1rem;border-radius:8px;">Error: ${data.error}</div>`;
            } catch (err) {
                document.getElementById('bulkResult').innerHTML = `<div style="background:rgba(239,68,68,0.2);color:var(--error);padding:1rem;border-radius:8px;">Error: ${err.message}</div>`;
            }
        }

        async function sendBulkEmails() {
            const subject = document.getElementById('emailSubject').value;
            const content = document.getElementById('emailContent').value;
            
            if (!subject || !content) {
                document.getElementById('bulkResult').innerHTML = `<div style="background:rgba(239,68,68,0.2);color:var(--error);padding:1rem;border-radius:8px;">Subject and content required</div>`;
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/emails/bulk`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject, content })
                });
                
                const data = await res.json();
                document.getElementById('bulkResult').innerHTML = res.ok 
                    ? `<div style="background:rgba(16,185,129,0.2);color:var(--success);padding:1rem;border-radius:8px;">Sent to ${data.total_recipients} recipients (${data.sent} sent, ${data.failed} failed)</div>`
                    : `<div style="background:rgba(239,68,68,0.2);color:var(--error);padding:1rem;border-radius:8px;">Error: ${data.error}</div>`;
            } catch (err) {
                document.getElementById('bulkResult').innerHTML = `<div style="background:rgba(239,68,68,0.2);color:var(--error);padding:1rem;border-radius:8px;">Error: ${err.message}</div>`;
            }
        }

        async function showReports() {
            const content = `
                <div style="display:grid;gap:1rem;">
                    <div style="background:var(--bg-hover);padding:1.25rem;border-radius:8px;cursor:pointer;" onclick="loadMonthlyReport()">
                        <div style="display:flex;align-items:center;gap:1rem;">
                            <div style="font-size:2rem;">üìä</div>
                            <div>
                                <div style="font-weight:600;">Monthly Report</div>
                                <div style="font-size:0.875rem;color:var(--text-secondary);">View sales and license summary for current month</div>
                            </div>
                        </div>
                    </div>
                    <div style="background:var(--bg-hover);padding:1.25rem;border-radius:8px;cursor:pointer;" onclick="exportData()">
                        <div style="display:flex;align-items:center;gap:1rem;">
                            <div style="font-size:2rem;">üì•</div>
                            <div>
                                <div style="font-weight:600;">Export All Data</div>
                                <div style="font-size:0.875rem;color:var(--text-secondary);">Download complete data export as JSON</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="reportResult" style="margin-top:1.5rem;"></div>
            `;
            showModal('Reports', content);
        }

        async function loadMonthlyReport() {
            try {
                const res = await fetch(`${API_BASE}/reports/monthly`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    const r = data.report;
                    document.getElementById('reportResult').innerHTML = `
                        <div style="background:var(--bg-dark);padding:1.5rem;border-radius:8px;">
                            <h4 style="margin-bottom:1rem;">Report: ${r.period}</h4>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1rem;">
                                <div style="text-align:center;">
                                    <div style="font-size:1.5rem;font-weight:700;color:var(--primary);">${r.summary?.total_licenses || 0}</div>
                                    <div style="font-size:0.75rem;color:var(--text-secondary);">Licenses</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:1.5rem;font-weight:700;color:var(--success);">$${(r.summary?.total_revenue || 0).toFixed(2)}</div>
                                    <div style="font-size:0.75rem;color:var(--text-secondary);">Revenue</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:1.5rem;font-weight:700;color:var(--accent);">${r.summary?.new_users || 0}</div>
                                    <div style="font-size:0.75rem;color:var(--text-secondary);">New Users</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                document.getElementById('reportResult').innerHTML = `<div style="color:var(--error);">Error loading report</div>`;
            }
        }

        async function exportData() {
            try {
                window.open(`${API_BASE}/reports/export?users=true&licenses=true&giveaways=true`, '_blank');
                document.getElementById('reportResult').innerHTML = `<div style="background:rgba(16,185,129,0.2);color:var(--success);padding:1rem;border-radius:8px;">Export started! Check your downloads.</div>`;
            } catch (err) {
                document.getElementById('reportResult').innerHTML = `<div style="color:var(--error);">Error exporting data</div>`;
            }
        }

        (async () => {
            if (await checkAuth()) {
                showAdminPanel();
                loadDashboardData();
            }
        })();
    </script>
</body>
</html>
