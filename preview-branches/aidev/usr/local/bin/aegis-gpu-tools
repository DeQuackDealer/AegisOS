#!/usr/bin/env python3
"""
Aegis GPU Tools - CUDA/ROCm configuration and multi-GPU management
Features: CUDA config, ROCm config, GPU monitoring, power management

Provides GUI (GTK) and CLI modes with tier-based feature gating.
"""

import os
import sys
import json
import subprocess
import logging
import argparse
import shutil
from pathlib import Path
from typing import Dict, List, Optional, Any

TIER_LIMIT = "aidev"
VERSION = "1.5.0"
APP_NAME = "Aegis GPU Tools"

CONFIG_FILE = "/etc/aegis/aidev-config.json"
LOG_FILE = "/var/log/aegis/gpu-tools.log"

try:
    import gi
    gi.require_version('Gtk', '3.0')
    from gi.repository import Gtk, GLib
    GTK_AVAILABLE = True
except ImportError:
    GTK_AVAILABLE = False


class LicenseTier:
    FREEMIUM = 1
    AIDEV = 4


class AegisGPUTools:
    def __init__(self, headless: bool = False):
        self.headless = headless
        self.version = VERSION
        self.config = {}
        self.license_tier = LicenseTier.FREEMIUM
        
        self.setup_logging()
        self.load_license_tier()
        self.load_config()
        
    def setup_logging(self):
        log_dir = Path(LOG_FILE).parent
        try:
            log_dir.mkdir(parents=True, exist_ok=True)
        except PermissionError:
            pass
        
        try:
            logging.basicConfig(
                level=logging.INFO,
                format='%(asctime)s - %(levelname)s - [%(name)s] %(message)s',
                handlers=[
                    logging.FileHandler(LOG_FILE) if os.access(str(log_dir), os.W_OK) else logging.NullHandler(),
                    logging.StreamHandler() if not self.headless else logging.NullHandler()
                ]
            )
        except Exception:
            logging.basicConfig(level=logging.INFO, handlers=[logging.StreamHandler()])
        
        self.logger = logging.getLogger("AegisGPUTools")
    
    def load_license_tier(self):
        if Path("/etc/aegis-aidev-marker").exists():
            self.license_tier = LicenseTier.AIDEV
    
    def load_config(self):
        self.config = {
            "cuda_enabled": True,
            "rocm_enabled": True,
            "multi_gpu": True,
            "power_management": True
        }
    
    def detect_gpu_vendor(self) -> str:
        try:
            lspci = subprocess.run(["lspci"], capture_output=True, text=True)
            output = lspci.stdout.lower()
            
            if "nvidia" in output:
                return "nvidia"
            elif "amd" in output or "radeon" in output:
                return "amd"
            elif "intel" in output:
                return "intel"
        except Exception:
            pass
        return "unknown"
    
    def get_nvidia_info(self) -> List[Dict[str, Any]]:
        if not shutil.which("nvidia-smi"):
            return []
        
        try:
            result = subprocess.run(
                ["nvidia-smi", "--query-gpu=index,name,memory.total,memory.used,temperature.gpu,utilization.gpu,power.draw", 
                 "--format=csv,noheader,nounits"],
                capture_output=True, text=True, timeout=10
            )
            
            if result.returncode == 0:
                gpus = []
                for line in result.stdout.strip().split('\n'):
                    if line:
                        parts = [p.strip() for p in line.split(',')]
                        if len(parts) >= 7:
                            gpus.append({
                                "index": int(parts[0]),
                                "name": parts[1],
                                "memory_total_mb": int(float(parts[2])),
                                "memory_used_mb": int(float(parts[3])),
                                "temperature_c": int(float(parts[4])),
                                "utilization_percent": int(float(parts[5])),
                                "power_draw_w": float(parts[6])
                            })
                return gpus
        except Exception as e:
            self.logger.error(f"Failed to get NVIDIA info: {e}")
        return []
    
    def get_amd_info(self) -> List[Dict[str, Any]]:
        if not shutil.which("rocm-smi"):
            return []
        
        try:
            result = subprocess.run(["rocm-smi", "--showproductname", "--json"], 
                                   capture_output=True, text=True, timeout=10)
            if result.returncode == 0:
                data = json.loads(result.stdout)
                gpus = []
                for gpu_id, gpu_info in data.items():
                    if gpu_id.startswith("card"):
                        gpus.append({
                            "index": int(gpu_id.replace("card", "")),
                            "name": gpu_info.get("Card series", "Unknown"),
                            "vendor": "AMD"
                        })
                return gpus
        except Exception as e:
            self.logger.error(f"Failed to get AMD info: {e}")
        return []
    
    def get_all_gpus(self) -> Dict[str, Any]:
        vendor = self.detect_gpu_vendor()
        gpus = []
        
        if vendor == "nvidia":
            gpus = self.get_nvidia_info()
        elif vendor == "amd":
            gpus = self.get_amd_info()
        
        return {
            "vendor": vendor,
            "count": len(gpus),
            "gpus": gpus,
            "cuda_available": shutil.which("nvidia-smi") is not None,
            "rocm_available": shutil.which("rocm-smi") is not None
        }
    
    def set_gpu_power_limit(self, gpu_index: int, power_limit_w: int) -> bool:
        if self.license_tier < LicenseTier.AIDEV:
            return False
        
        try:
            result = subprocess.run(
                ["nvidia-smi", "-i", str(gpu_index), "-pl", str(power_limit_w)],
                capture_output=True, timeout=10
            )
            return result.returncode == 0
        except Exception:
            return False
    
    def set_gpu_persistence_mode(self, enable: bool = True) -> bool:
        try:
            mode = "1" if enable else "0"
            result = subprocess.run(
                ["nvidia-smi", "-pm", mode],
                capture_output=True, timeout=10
            )
            return result.returncode == 0
        except Exception:
            return False
    
    def get_cuda_version(self) -> Optional[str]:
        try:
            result = subprocess.run(
                ["nvcc", "--version"],
                capture_output=True, text=True, timeout=10
            )
            if result.returncode == 0:
                for line in result.stdout.split('\n'):
                    if "release" in line:
                        return line.split("release")[1].split(",")[0].strip()
        except Exception:
            pass
        return None
    
    def get_rocm_version(self) -> Optional[str]:
        try:
            result = subprocess.run(
                ["rocm-smi", "--version"],
                capture_output=True, text=True, timeout=10
            )
            if result.returncode == 0:
                return result.stdout.strip().split('\n')[0]
        except Exception:
            pass
        return None
    
    def get_status(self) -> Dict[str, Any]:
        gpu_info = self.get_all_gpus()
        return {
            "gpu_info": gpu_info,
            "cuda_version": self.get_cuda_version(),
            "rocm_version": self.get_rocm_version(),
            "tier": self.license_tier
        }
    
    def run_gui(self):
        if not GTK_AVAILABLE:
            return self.run_cli()
        
        win = GPUToolsWindow(self)
        win.connect("destroy", Gtk.main_quit)
        win.show_all()
        Gtk.main()
    
    def run_cli(self):
        print(f"\n{'='*60}")
        print(f"  {APP_NAME} v{VERSION}")
        print(f"{'='*60}\n")
        
        status = self.get_status()
        gpu_info = status["gpu_info"]
        
        print(f"GPU Vendor: {gpu_info['vendor'].upper()}")
        print(f"GPU Count: {gpu_info['count']}")
        print(f"CUDA Available: {'✓' if gpu_info['cuda_available'] else '✗'}")
        print(f"ROCm Available: {'✓' if gpu_info['rocm_available'] else '✗'}")
        
        if status["cuda_version"]:
            print(f"CUDA Version: {status['cuda_version']}")
        if status["rocm_version"]:
            print(f"ROCm Version: {status['rocm_version']}")
        
        if gpu_info["gpus"]:
            print("\nGPU Details:")
            for gpu in gpu_info["gpus"]:
                print(f"  GPU {gpu['index']}: {gpu['name']}")
                if 'memory_total_mb' in gpu:
                    print(f"    Memory: {gpu['memory_used_mb']}/{gpu['memory_total_mb']} MB")
                    print(f"    Temperature: {gpu['temperature_c']}°C")
                    print(f"    Utilization: {gpu['utilization_percent']}%")


if GTK_AVAILABLE:
    class GPUToolsWindow(Gtk.Window):
        def __init__(self, app: AegisGPUTools):
            super().__init__(title=f"{APP_NAME} v{VERSION}")
            self.app = app
            self.set_default_size(800, 600)
            self.set_border_width(10)
            self.setup_ui()
        
        def setup_ui(self):
            vbox = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
            self.add(vbox)
            
            header = Gtk.Label()
            header.set_markup(f"<big><b>{APP_NAME}</b></big>")
            vbox.pack_start(header, False, False, 10)
            
            status = self.app.get_status()
            gpu_info = status["gpu_info"]
            
            info_label = Gtk.Label(label=f"Vendor: {gpu_info['vendor'].upper()} | GPUs: {gpu_info['count']}")
            vbox.pack_start(info_label, False, False, 10)
            
            for gpu in gpu_info["gpus"]:
                gpu_label = Gtk.Label(label=f"GPU {gpu['index']}: {gpu['name']}")
                vbox.pack_start(gpu_label, False, False, 5)


def main():
    parser = argparse.ArgumentParser(description=f"{APP_NAME}")
    parser.add_argument("--gui", action="store_true", help="Launch GUI mode")
    parser.add_argument("--cli", action="store_true", help="Run in CLI mode")
    parser.add_argument("--status", action="store_true", help="Show GPU status")
    parser.add_argument("--list", action="store_true", help="List GPUs")
    parser.add_argument("--version", action="version", version=f"{APP_NAME} {VERSION}")
    
    args = parser.parse_args()
    
    if args.status or args.list:
        app = AegisGPUTools(headless=True)
        print(json.dumps(app.get_status(), indent=2))
    elif args.cli or not GTK_AVAILABLE:
        app = AegisGPUTools(headless=False)
        app.run_cli()
    else:
        app = AegisGPUTools(headless=False)
        app.run_gui()


if __name__ == "__main__":
    main()
