#!/bin/bash
# Aegis OS External Media Handler
# Handles mounting/unmounting of external game media

MOUNT_BASE="/run/aegis/external-games"
LOG_FILE="/var/log/aegis/external-media.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE" 2>/dev/null
}

mkdir -p "$MOUNT_BASE" 2>/dev/null
mkdir -p "$(dirname $LOG_FILE)" 2>/dev/null

ACTION="$1"
DEVICE="$2"
DEVICE_PATH="/dev/$DEVICE"

case "$ACTION" in
    mount)
        if [ -b "$DEVICE_PATH" ]; then
            LABEL=$(blkid -s LABEL -o value "$DEVICE_PATH" 2>/dev/null)
            UUID=$(blkid -s UUID -o value "$DEVICE_PATH" 2>/dev/null)
            FSTYPE=$(blkid -s TYPE -o value "$DEVICE_PATH" 2>/dev/null)
            
            if [ -z "$LABEL" ]; then
                LABEL="AEGIS-$(echo $UUID | cut -c1-8)"
            fi
            
            MOUNT_POINT="$MOUNT_BASE/$LABEL"
            mkdir -p "$MOUNT_POINT"
            
            MOUNT_OPTS="rw,nosuid,nodev,relatime"
            case "$FSTYPE" in
                ntfs|ntfs-3g)
                    MOUNT_OPTS="$MOUNT_OPTS,uid=1000,gid=1000,dmask=022,fmask=133"
                    FSTYPE="ntfs-3g"
                    ;;
                exfat)
                    MOUNT_OPTS="$MOUNT_OPTS,uid=1000,gid=1000,dmask=022,fmask=133"
                    ;;
                vfat|fat32)
                    MOUNT_OPTS="$MOUNT_OPTS,uid=1000,gid=1000,dmask=022,fmask=133"
                    ;;
            esac
            
            if mount -t "$FSTYPE" -o "$MOUNT_OPTS" "$DEVICE_PATH" "$MOUNT_POINT" 2>/dev/null; then
                log "Mounted $DEVICE_PATH at $MOUNT_POINT (type: $FSTYPE)"
                
                if [ -f "$MOUNT_POINT/aegis-game.json" ]; then
                    log "Game manifest found on $LABEL - notifying game launcher"
                    dbus-send --system --type=signal /org/aegis/GameLauncher \
                        org.aegis.GameLauncher.MediaInserted \
                        string:"$MOUNT_POINT" 2>/dev/null
                fi
            else
                log "Failed to mount $DEVICE_PATH"
                rmdir "$MOUNT_POINT" 2>/dev/null
            fi
        fi
        ;;
    
    unmount)
        for MOUNT_POINT in "$MOUNT_BASE"/*; do
            if [ -d "$MOUNT_POINT" ]; then
                MOUNTED_DEV=$(findmnt -n -o SOURCE "$MOUNT_POINT" 2>/dev/null)
                if [ "$MOUNTED_DEV" = "$DEVICE_PATH" ] || [ -z "$MOUNTED_DEV" ]; then
                    if umount "$MOUNT_POINT" 2>/dev/null; then
                        log "Unmounted $MOUNT_POINT"
                        dbus-send --system --type=signal /org/aegis/GameLauncher \
                            org.aegis.GameLauncher.MediaRemoved \
                            string:"$MOUNT_POINT" 2>/dev/null
                    fi
                    rmdir "$MOUNT_POINT" 2>/dev/null
                fi
            fi
        done
        ;;
    
    *)
        log "Unknown action: $ACTION"
        exit 1
        ;;
esac

exit 0
