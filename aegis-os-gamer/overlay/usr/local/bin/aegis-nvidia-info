
#!/bin/bash

# Aegis OS - NVIDIA GPU Information Script
# Displays detailed information about NVIDIA GPUs using nouveau

echo "ðŸ›¡ï¸ Aegis OS - NVIDIA GPU Information"
echo "====================================="
echo

# Check if NVIDIA GPU is present
if ! lspci | grep -i nvidia > /dev/null 2>&1; then
    echo "âŒ No NVIDIA GPU detected"
    exit 1
fi

echo "âœ… NVIDIA GPU detected!"
echo

# Display GPU information
echo "ðŸ“Š GPU Details:"
lspci | grep -i nvidia | while read line; do
    echo "   $line"
done
echo

# Check nouveau driver status
echo "ðŸ”§ Driver Status:"
if lsmod | grep -q nouveau; then
    echo "   âœ… Nouveau driver loaded"
else
    echo "   âŒ Nouveau driver not loaded"
fi

# Display DRM information
if [ -d /sys/class/drm ]; then
    echo
    echo "ðŸ–¥ï¸ Display Information:"
    for card in /sys/class/drm/card*; do
        if [ -d "$card" ]; then
            card_name=$(basename "$card")
            echo "   Card: $card_name"
            
            # Check for connected displays
            for connector in "$card"/card*; do
                if [ -f "$connector/status" ]; then
                    status=$(cat "$connector/status" 2>/dev/null || echo "unknown")
                    connector_name=$(basename "$connector")
                    if [ "$status" = "connected" ]; then
                        echo "   âœ… $connector_name: $status"
                        
                        # Show modes if available
                        if [ -f "$connector/modes" ]; then
                            echo "      Modes: $(cat "$connector/modes" 2>/dev/null | head -1)"
                        fi
                    fi
                fi
            done
        fi
    done
fi

# Check OpenGL support
echo
echo "ðŸŽ® 3D Acceleration:"
if command -v glxinfo >/dev/null 2>&1; then
    renderer=$(glxinfo 2>/dev/null | grep "OpenGL renderer" | cut -d: -f2 | xargs || echo "Unknown")
    version=$(glxinfo 2>/dev/null | grep "OpenGL version" | cut -d: -f2 | xargs || echo "Unknown")
    echo "   Renderer: $renderer"
    echo "   OpenGL Version: $version"
else
    echo "   âš ï¸ glxinfo not available"
fi

# Check Vulkan support
echo
echo "ðŸŒ‹ Vulkan Support:"
if command -v vulkaninfo >/dev/null 2>&1; then
    if vulkaninfo --summary >/dev/null 2>&1; then
        echo "   âœ… Vulkan is available"
        vulkaninfo --summary 2>/dev/null | grep -E "(GPU|Driver Version)" | head -2
    else
        echo "   âŒ Vulkan not available"
    fi
else
    echo "   âš ï¸ vulkaninfo not available"
fi

echo
echo "ðŸ”§ Optimization Status:"
if [ -f /var/log/aegis-nouveau.log ]; then
    echo "   âœ… Nouveau optimizations applied"
    tail -3 /var/log/aegis-nouveau.log | sed 's/^/   /'
else
    echo "   âš ï¸ Run 'sudo systemctl start aegis-nouveau-optimizer' to apply optimizations"
fi

echo
echo "ðŸ’¡ Tips:"
echo "   â€¢ For gaming: ensure 'performance' CPU governor is set"
echo "   â€¢ Monitor GPU usage: watch -n1 'cat /sys/class/drm/card*/device/gpu_busy_percent 2>/dev/null || echo N/A'"
echo "   â€¢ Check temperatures: sensors nouveau-* 2>/dev/null || echo 'Install lm-sensors'"
