name: Build Aegis OS ISOs

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      edition:
        description: 'Edition to build'
        required: true
        default: 'freemium'
        type: choice
        options:
          - freemium
          - basic
          - gamer
          - workplace
          - aidev
          - gamer-ai
          - server
          - all

jobs:
  determine-matrix:
    name: Determine Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.edition }}" = "all" ]; then
            echo 'matrix=["freemium","basic","gamer","workplace","aidev","gamer-ai","server"]' >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo 'matrix=["${{ github.event.inputs.edition }}"]' >> $GITHUB_OUTPUT
          else
            echo 'matrix=["freemium"]' >> $GITHUB_OUTPUT
          fi

  validate:
    name: Validate Build System
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Validate Python files
        run: |
          echo "=== Validating Python syntax ==="
          errors=0
          for f in $(find . -name "*.py" -type f -not -path "./.cache/*" -not -path "./.pythonlibs/*"); do
            if python3 -m py_compile "$f" 2>/dev/null; then
              echo "OK: $f"
            else
              echo "ERROR: $f"
              errors=$((errors + 1))
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "Found $errors Python syntax errors"
            exit 1
          fi
      
      - name: Run simulation test
        run: |
          cd build-system
          python3 build-aegis.py --edition freemium --simulate --verbose

  build-iso:
    name: Build ${{ matrix.edition }} ISO
    needs: [determine-matrix, validate]
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    strategy:
      fail-fast: false
      matrix:
        edition: ${{ fromJson(needs.determine-matrix.outputs.matrix) }}
    
    steps:
      - name: Initialize pacman and enable multilib + Chaotic-AUR
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -e
          echo "=== Initializing pacman keyring ==="
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Sy --noconfirm archlinux-keyring
          echo "=== Enabling multilib repository ==="
          cp /etc/pacman.conf /etc/pacman.conf.orig
          sed -i '/^#\[multilib\]/,/^#Include/ s/^#//' /etc/pacman.conf
          echo "=== Verifying multilib is enabled ==="
          grep -A1 "\[multilib\]" /etc/pacman.conf || echo "WARNING: multilib section not found"
          
          echo "=== Adding Chaotic-AUR repository for AUR packages ==="
          pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
          pacman-key --lsign-key 3056513887B78AEB
          pacman -U --noconfirm 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst'
          pacman -U --noconfirm 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'
          
          echo "" >> /etc/pacman.conf
          echo "[chaotic-aur]" >> /etc/pacman.conf
          echo "Include = /etc/pacman.d/chaotic-mirrorlist" >> /etc/pacman.conf
          
          echo "=== Syncing package databases ==="
          pacman -Syy --noconfirm
          
      - name: Install build dependencies
        run: |
          set -e
          echo "=== Installing build dependencies ==="
          pacman -S --needed --noconfirm git python archiso squashfs-tools libisoburn dosfstools e2fsprogs mtools grub efibootmgr rsync wget curl gnupg
      
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup archiso profile
        run: |
          set -e
          echo "=== Setting up ${{ matrix.edition }} profile ==="
          EDITION="${{ matrix.edition }}"
          PROFILE_DIR="/tmp/aegis-${EDITION}"
          REPO_DIR="${GITHUB_WORKSPACE}"
          VERSION="1.0.0"
          BUILD_DATE=$(date +%Y.%m.%d)
          
          cp -r /usr/share/archiso/configs/releng "${PROFILE_DIR}"
          echo "=== Copying pacman.conf with multilib and Chaotic-AUR to profile ==="
          cp /etc/pacman.conf "${PROFILE_DIR}/pacman.conf"
          
          echo "=== Configuring pacman to ignore Chaotic-AUR provider conflicts ==="
          sed -i '/\[options\]/a IgnorePkg = dashbinsh nvidia-340xx-utils' "${PROFILE_DIR}/pacman.conf"
          mkdir -p "${PROFILE_DIR}/airootfs/etc/pacman.d"
          cp /etc/pacman.d/mirrorlist "${PROFILE_DIR}/airootfs/etc/pacman.d/mirrorlist"
          cp /etc/pacman.d/chaotic-mirrorlist "${PROFILE_DIR}/airootfs/etc/pacman.d/chaotic-mirrorlist" 2>/dev/null || true
          mkdir -p "${PROFILE_DIR}/airootfs/etc/aegis"
          echo "aegis-${EDITION}" > "${PROFILE_DIR}/airootfs/etc/hostname"
          echo "{\"edition\": \"${EDITION}\", \"version\": \"${VERSION}\"}" > "${PROFILE_DIR}/airootfs/etc/aegis/edition.json"
          
          echo "=== Creating custom profiledef.sh with Aegis branding ==="
          cat > "${PROFILE_DIR}/profiledef.sh" << 'PROFILEDEF'
          #!/usr/bin/env bash
          iso_name="aegis-os-EDITION_PLACEHOLDER"
          iso_label="AEGIS_$(date +%Y%m)"
          iso_publisher="Aegis OS <https://aegis-os.com>"
          iso_application="Aegis OS EDITION_NAME_PLACEHOLDER Edition Live/Install"
          iso_version="VERSION_PLACEHOLDER"
          install_dir="aegis"
          buildmodes=('iso')
          bootmodes=('bios.syslinux' 'uefi-x64.grub.esp')
          arch="x86_64"
          pacman_conf="pacman.conf"
          airootfs_image_type="squashfs"
          airootfs_image_tool_options=('-comp' 'xz' '-Xbcj' 'x86' '-b' '1M' '-Xdict-size' '1M')
          pacstrap_args=('--noconfirm' '--needed' '--overwrite' '*')
          file_permissions=(
            ["/etc/shadow"]="0:0:400"
            ["/etc/gshadow"]="0:0:400"
            ["/etc/sudoers.d/aegis"]="0:0:440"
            ["/usr/local/bin/*"]="0:0:755"
            ["/home/aegis"]="1000:1000:755"
          )
          PROFILEDEF
          
          EDITION_NAME=$(echo "$EDITION" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
          sed -i "s/EDITION_PLACEHOLDER/${EDITION}/g" "${PROFILE_DIR}/profiledef.sh"
          sed -i "s/EDITION_NAME_PLACEHOLDER/${EDITION_NAME}/g" "${PROFILE_DIR}/profiledef.sh"
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" "${PROFILE_DIR}/profiledef.sh"
          chmod +x "${PROFILE_DIR}/profiledef.sh"
          
          echo "=== Creating custom /etc/os-release ==="
          cat > "${PROFILE_DIR}/airootfs/etc/os-release" << OSRELEASE
          NAME="Aegis OS"
          PRETTY_NAME="Aegis OS ${VERSION} (${EDITION_NAME})"
          ID=aegis
          ID_LIKE=arch
          VERSION="${VERSION}"
          VERSION_ID="${VERSION}"
          VERSION_CODENAME="${EDITION}"
          BUILD_ID="${BUILD_DATE}"
          HOME_URL="https://aegis-os.com/"
          DOCUMENTATION_URL="https://aegis-os.com/docs/"
          SUPPORT_URL="https://aegis-os.com/support/"
          BUG_REPORT_URL="https://github.com/aegis-os/aegis-os/issues"
          LOGO=aegis-logo
          ANSI_COLOR="0;36"
          OSRELEASE
          
          echo "=== Creating LightDM configuration ==="
          mkdir -p "${PROFILE_DIR}/airootfs/etc/lightdm"
          cat > "${PROFILE_DIR}/airootfs/etc/lightdm/lightdm.conf" << 'LIGHTDM'
          [Seat:*]
          greeter-session=lightdm-gtk-greeter
          user-session=xfce
          autologin-user=aegis
          autologin-session=xfce
          LIGHTDM
          
          cat > "${PROFILE_DIR}/airootfs/etc/lightdm/lightdm-gtk-greeter.conf" << 'GREETER'
          [greeter]
          theme-name=Aegis-Win10
          icon-theme-name=Papirus
          font-name=Noto Sans 10
          background=/usr/share/backgrounds/aegis/default.jpg
          user-background=false
          position=50%,center 50%,center
          indicators=~host;~spacer;~clock;~spacer;~session;~a11y;~power
          clock-format=%A, %B %d  %H:%M
          GREETER
          
          echo "=== Creating Plymouth configuration ==="
          mkdir -p "${PROFILE_DIR}/airootfs/etc/plymouth"
          cat > "${PROFILE_DIR}/airootfs/etc/plymouth/plymouthd.conf" << 'PLYMOUTH'
          [Daemon]
          Theme=spinner
          ShowDelay=0
          DeviceTimeout=8
          PLYMOUTH
          
          echo "=== Creating custom Aegis Plymouth theme with spinner fallback ==="
          mkdir -p "${PROFILE_DIR}/airootfs/usr/share/plymouth/themes/aegis"
          cat > "${PROFILE_DIR}/airootfs/usr/share/plymouth/themes/aegis/aegis.plymouth" << 'AEGISPLYMOUTH'
          [Plymouth Theme]
          Name=Aegis OS
          Description=Aegis OS boot splash with spinner animation
          ModuleName=script
          
          [script]
          ImageDir=/usr/share/plymouth/themes/aegis
          ScriptFile=/usr/share/plymouth/themes/aegis/aegis.script
          AEGISPLYMOUTH
          
          cat > "${PROFILE_DIR}/airootfs/usr/share/plymouth/themes/aegis/aegis.script" << 'AEGISSCRIPT'
          Window.SetBackgroundTopColor(0.10, 0.10, 0.18);
          Window.SetBackgroundBottomColor(0.09, 0.13, 0.24);
          
          message_sprite = Sprite();
          message_sprite.SetPosition(Window.GetWidth() * 0.5 - 100, Window.GetHeight() * 0.7, 1);
          
          fun message_callback(text) {
              my_image = Image.Text(text, 1, 1, 1);
              message_sprite.SetImage(my_image);
          }
          
          Plymouth.SetMessageFunction(message_callback);
          
          fun display_normal_callback() {
              global.status = "normal";
          }
          
          fun display_password_callback(prompt, bullets) {
              global.status = "password";
          }
          
          Plymouth.SetDisplayNormalFunction(display_normal_callback);
          Plymouth.SetDisplayPasswordFunction(display_password_callback);
          AEGISSCRIPT
          
          echo "=== Creating default user configuration ==="
          mkdir -p "${PROFILE_DIR}/airootfs/etc/skel/.config"
          
          echo "=== Creating custom fastfetch configuration ==="
          mkdir -p "${PROFILE_DIR}/airootfs/etc/skel/.config/fastfetch"
          cat > "${PROFILE_DIR}/airootfs/etc/skel/.config/fastfetch/config.jsonc" << 'FASTFETCH'
          {
            "$schema": "https://github.com/fastfetch-cli/fastfetch/raw/dev/doc/json_schema.json",
            "logo": {
              "type": "builtin",
              "source": "arch"
            },
            "display": {
              "separator": "  "
            },
            "modules": [
              {
                "type": "title",
                "format": "{user-name}@{host-name}"
              },
              "break",
              {
                "type": "os",
                "key": "OS",
                "format": "Aegis OS {version} ({codename})"
              },
              {
                "type": "kernel",
                "key": "Kernel"
              },
              {
                "type": "uptime",
                "key": "Uptime"
              },
              {
                "type": "packages",
                "key": "Packages"
              },
              {
                "type": "shell",
                "key": "Shell"
              },
              {
                "type": "de",
                "key": "Desktop"
              },
              {
                "type": "wm",
                "key": "WM"
              },
              {
                "type": "terminal",
                "key": "Terminal"
              },
              {
                "type": "cpu",
                "key": "CPU"
              },
              {
                "type": "gpu",
                "key": "GPU"
              },
              {
                "type": "memory",
                "key": "Memory"
              },
              "break",
              "colors"
            ]
          }
          FASTFETCH
          
          echo "=== Creating aegis user for autologin ==="
          mkdir -p "${PROFILE_DIR}/airootfs/etc"
          
          cat >> "${PROFILE_DIR}/airootfs/etc/passwd" << 'PASSWD'
          aegis:x:1000:1000:Aegis User:/home/aegis:/bin/bash
          PASSWD
          
          cat >> "${PROFILE_DIR}/airootfs/etc/shadow" << 'SHADOW'
          aegis:$6$rounds=656000$aegis$8iJnYLuJuq5pGQ6xGDZY6NqQ4aVXX.yQQ9dYcR0DfHZJZNvZ3ZZcW0ZZZoZZZcZZZJZZpZZZmZZZnZZZvZZZsZZZxZZZ:19000:0:99999:7:::
          SHADOW
          
          cat >> "${PROFILE_DIR}/airootfs/etc/group" << 'GROUP'
          aegis:x:1000:
          GROUP
          
          cat >> "${PROFILE_DIR}/airootfs/etc/gshadow" << 'GSHADOW'
          aegis:!::
          GSHADOW
          
          mkdir -p "${PROFILE_DIR}/airootfs/home/aegis"
          mkdir -p "${PROFILE_DIR}/airootfs/home/aegis/.config"
          
          echo "=== Copying skel to aegis home ==="
          cp -r "${PROFILE_DIR}/airootfs/etc/skel/." "${PROFILE_DIR}/airootfs/home/aegis/" 2>/dev/null || true
          
          echo "=== Setting ownership via file_permissions in profiledef ==="
          
          echo "=== Configuring sudo for aegis user ==="
          mkdir -p "${PROFILE_DIR}/airootfs/etc/sudoers.d"
          echo "aegis ALL=(ALL) NOPASSWD: ALL" > "${PROFILE_DIR}/airootfs/etc/sudoers.d/aegis"
          chmod 440 "${PROFILE_DIR}/airootfs/etc/sudoers.d/aegis"
          
          echo "=== Creating user setup script ==="
          mkdir -p "${PROFILE_DIR}/airootfs/usr/lib/systemd/system"
          cat > "${PROFILE_DIR}/airootfs/usr/lib/systemd/system/aegis-setup.service" << 'SETUPSVC'
          [Unit]
          Description=Aegis OS First Boot Setup
          After=network.target
          ConditionPathExists=!/var/lib/aegis/setup-complete
          
          [Service]
          Type=oneshot
          ExecStart=/usr/local/bin/aegis-first-boot
          RemainAfterExit=yes
          
          [Install]
          WantedBy=multi-user.target
          SETUPSVC
          
          cat > "${PROFILE_DIR}/airootfs/usr/local/bin/aegis-first-boot" << 'FIRSTBOOT'
          #!/bin/bash
          mkdir -p /var/lib/aegis
          chown -R aegis:aegis /home/aegis
          usermod -aG wheel,audio,video,storage,optical,network,power aegis 2>/dev/null || true
          touch /var/lib/aegis/setup-complete
          FIRSTBOOT
          chmod +x "${PROFILE_DIR}/airootfs/usr/local/bin/aegis-first-boot"
          
          echo "=== Setting up systemd services ==="
          mkdir -p "${PROFILE_DIR}/airootfs/etc/systemd/system/multi-user.target.wants"
          mkdir -p "${PROFILE_DIR}/airootfs/etc/systemd/system/graphical.target.wants"
          
          ln -sf /usr/lib/systemd/system/NetworkManager.service \
            "${PROFILE_DIR}/airootfs/etc/systemd/system/multi-user.target.wants/NetworkManager.service" 2>/dev/null || true
          ln -sf /usr/lib/systemd/system/lightdm.service \
            "${PROFILE_DIR}/airootfs/etc/systemd/system/graphical.target.wants/lightdm.service" 2>/dev/null || true
          ln -sf /usr/lib/systemd/system/aegis-setup.service \
            "${PROFILE_DIR}/airootfs/etc/systemd/system/multi-user.target.wants/aegis-setup.service" 2>/dev/null || true
          
          if [ -d "${REPO_DIR}/build-system/overlays/common" ]; then
            echo "Copying common overlays..."
            rsync -av "${REPO_DIR}/build-system/overlays/common/" "${PROFILE_DIR}/airootfs/"
          fi
          if [ "$EDITION" != "freemium" ] && [ -d "${REPO_DIR}/build-system/overlays/pro" ]; then
            echo "Copying pro overlays..."
            rsync -av "${REPO_DIR}/build-system/overlays/pro/" "${PROFILE_DIR}/airootfs/"
          fi
          if [ "$EDITION" = "basic" ] || [ "$EDITION" = "workplace" ]; then
            if [ -d "${REPO_DIR}/build-system/overlays/pro-productivity" ]; then
              echo "Copying pro-productivity overlays..."
              rsync -av "${REPO_DIR}/build-system/overlays/pro-productivity/" "${PROFILE_DIR}/airootfs/"
            fi
          fi
          if [ -d "${REPO_DIR}/build-system/overlays/${EDITION}" ]; then
            echo "Copying ${EDITION} overlays..."
            rsync -av "${REPO_DIR}/build-system/overlays/${EDITION}/" "${PROFILE_DIR}/airootfs/"
          fi
          find "${PROFILE_DIR}/airootfs/usr/local/bin/" -type f -exec chmod +x {} \; 2>/dev/null || true
          echo "=== Overlay contents ==="
          ls -la "${PROFILE_DIR}/airootfs/usr/local/bin/" 2>/dev/null || echo "No tools in usr/local/bin"
          echo "=== Profiledef contents ==="
          cat "${PROFILE_DIR}/profiledef.sh"
          echo "=== OS-Release contents ==="
          cat "${PROFILE_DIR}/airootfs/etc/os-release"
          echo "PROFILE_DIR=${PROFILE_DIR}" >> $GITHUB_ENV

      - name: Create package list
        run: |
          set -e
          EDITION="${{ matrix.edition }}"
          PROFILE_DIR="${{ env.PROFILE_DIR }}"
          
          # IMPORTANT: Start fresh - REPLACE releng's packages.x86_64, don't append to it
          # This prevents conflicts between releng base packages and our custom selection
          
          # Base system packages (required for bootable system) - NO leading whitespace!
          echo "base" > "${PROFILE_DIR}/packages.x86_64"
          echo "linux" >> "${PROFILE_DIR}/packages.x86_64"
          echo "linux-firmware" >> "${PROFILE_DIR}/packages.x86_64"
          echo "syslinux" >> "${PROFILE_DIR}/packages.x86_64"
          echo "mkinitcpio" >> "${PROFILE_DIR}/packages.x86_64"
          echo "mkinitcpio-archiso" >> "${PROFILE_DIR}/packages.x86_64"
          echo "efibootmgr" >> "${PROFILE_DIR}/packages.x86_64"
          echo "grub" >> "${PROFILE_DIR}/packages.x86_64"
          
          # Explicit provider packages to avoid interactive prompts
          # Note: pipewire-jack provides JACK - do NOT add jack2 (they conflict)
          echo "bash" >> "${PROFILE_DIR}/packages.x86_64"
          echo "libglvnd" >> "${PROFILE_DIR}/packages.x86_64"
          echo "iptables-nft" >> "${PROFILE_DIR}/packages.x86_64"
          echo "pipewire-jack" >> "${PROFILE_DIR}/packages.x86_64"
          echo "xdg-desktop-portal-gtk" >> "${PROFILE_DIR}/packages.x86_64"
          echo "lib32-libglvnd" >> "${PROFILE_DIR}/packages.x86_64"
          
          # Chaotic-AUR keyring for the installed system
          echo "chaotic-keyring" >> "${PROFILE_DIR}/packages.x86_64"
          echo "chaotic-mirrorlist" >> "${PROFILE_DIR}/packages.x86_64"
          
          # Desktop environment
          echo "xfce4" >> "${PROFILE_DIR}/packages.x86_64"
          echo "xfce4-goodies" >> "${PROFILE_DIR}/packages.x86_64"
          echo "lightdm" >> "${PROFILE_DIR}/packages.x86_64"
          echo "lightdm-gtk-greeter" >> "${PROFILE_DIR}/packages.x86_64"
          
          # Core apps
          echo "firefox" >> "${PROFILE_DIR}/packages.x86_64"
          echo "vlc" >> "${PROFILE_DIR}/packages.x86_64"
          echo "libreoffice-fresh" >> "${PROFILE_DIR}/packages.x86_64"
          
          # Fonts
          echo "ttf-dejavu" >> "${PROFILE_DIR}/packages.x86_64"
          echo "ttf-liberation" >> "${PROFILE_DIR}/packages.x86_64"
          echo "noto-fonts" >> "${PROFILE_DIR}/packages.x86_64"
          
          # Icons
          echo "papirus-icon-theme" >> "${PROFILE_DIR}/packages.x86_64"
          
          # Boot splash
          echo "plymouth" >> "${PROFILE_DIR}/packages.x86_64"
          
          # Networking
          echo "networkmanager" >> "${PROFILE_DIR}/packages.x86_64"
          echo "network-manager-applet" >> "${PROFILE_DIR}/packages.x86_64"
          
          # Audio (PipeWire stack)
          echo "pipewire" >> "${PROFILE_DIR}/packages.x86_64"
          echo "pipewire-pulse" >> "${PROFILE_DIR}/packages.x86_64"
          echo "pipewire-alsa" >> "${PROFILE_DIR}/packages.x86_64"
          echo "wireplumber" >> "${PROFILE_DIR}/packages.x86_64"
          echo "pavucontrol" >> "${PROFILE_DIR}/packages.x86_64"
          
          # File management
          echo "gvfs" >> "${PROFILE_DIR}/packages.x86_64"
          echo "gvfs-mtp" >> "${PROFILE_DIR}/packages.x86_64"
          echo "thunar-volman" >> "${PROFILE_DIR}/packages.x86_64"
          echo "xdg-user-dirs" >> "${PROFILE_DIR}/packages.x86_64"
          
          # System info
          echo "fastfetch" >> "${PROFILE_DIR}/packages.x86_64"
          
          # System utilities
          echo "sudo" >> "${PROFILE_DIR}/packages.x86_64"
          echo "bash-completion" >> "${PROFILE_DIR}/packages.x86_64"
          
          # Gamer edition packages
          if [ "$EDITION" = "gamer" ] || [ "$EDITION" = "gamer-ai" ]; then
            # Gaming platforms
            echo "steam" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lutris" >> "${PROFILE_DIR}/packages.x86_64"
            echo "heroic-games-launcher-bin" >> "${PROFILE_DIR}/packages.x86_64"
            
            # Performance tools
            echo "gamemode" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-gamemode" >> "${PROFILE_DIR}/packages.x86_64"
            echo "mangohud" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-mangohud" >> "${PROFILE_DIR}/packages.x86_64"
            echo "gamescope" >> "${PROFILE_DIR}/packages.x86_64"
            
            # Graphics libraries (64-bit)
            echo "vulkan-tools" >> "${PROFILE_DIR}/packages.x86_64"
            
            # lib32 libraries for Wine/Proton compatibility
            echo "lib32-pipewire-jack" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-mesa" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-vulkan-icd-loader" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-gnutls" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-libpulse" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-openal" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-vkd3d" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-libva" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-speex" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-libtheora" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-libvdpau" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-gst-plugins-base-libs" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-libjpeg-turbo" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-libgudev" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-mpg123" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-openssl" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-libusb" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-alsa-lib" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-alsa-plugins" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-libxcomposite" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-libxinerama" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-ncurses" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-ocl-icd" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-libxslt" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-libpng" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-sdl2" >> "${PROFILE_DIR}/packages.x86_64"
            
            # Wine/Proton
            echo "wine" >> "${PROFILE_DIR}/packages.x86_64"
            echo "wine-gecko" >> "${PROFILE_DIR}/packages.x86_64"
            echo "wine-mono" >> "${PROFILE_DIR}/packages.x86_64"
            echo "winetricks" >> "${PROFILE_DIR}/packages.x86_64"
            echo "vkd3d" >> "${PROFILE_DIR}/packages.x86_64"
            
            # VPN for gaming privacy
            echo "wireguard-tools" >> "${PROFILE_DIR}/packages.x86_64"
            
            # Streaming tools
            echo "obs-studio" >> "${PROFILE_DIR}/packages.x86_64"
            echo "xdotool" >> "${PROFILE_DIR}/packages.x86_64"
            echo "ffmpeg" >> "${PROFILE_DIR}/packages.x86_64"
            
            # Controller support (game-devices-udev only, DKMS modules deferred to post-install)
            echo "game-devices-udev" >> "${PROFILE_DIR}/packages.x86_64"
            
            # Retro gaming
            echo "retroarch" >> "${PROFILE_DIR}/packages.x86_64"
            
            # Wallpaper engine deps
            echo "mpv" >> "${PROFILE_DIR}/packages.x86_64"
            echo "python-pillow" >> "${PROFILE_DIR}/packages.x86_64"
          fi
          
          # AI Developer edition packages
          if [ "$EDITION" = "aidev" ] || [ "$EDITION" = "gamer-ai" ]; then
            echo "python" >> "${PROFILE_DIR}/packages.x86_64"
            echo "python-pip" >> "${PROFILE_DIR}/packages.x86_64"
            echo "python-virtualenv" >> "${PROFILE_DIR}/packages.x86_64"
            echo "jupyterlab" >> "${PROFILE_DIR}/packages.x86_64"
            echo "docker" >> "${PROFILE_DIR}/packages.x86_64"
            echo "podman" >> "${PROFILE_DIR}/packages.x86_64"
          fi
          
          # Workplace edition packages
          if [ "$EDITION" = "workplace" ]; then
            echo "remmina" >> "${PROFILE_DIR}/packages.x86_64"
            echo "freerdp" >> "${PROFILE_DIR}/packages.x86_64"
            echo "thunderbird" >> "${PROFILE_DIR}/packages.x86_64"
            echo "evolution" >> "${PROFILE_DIR}/packages.x86_64"
          fi
          
          # Server edition packages
          if [ "$EDITION" = "server" ]; then
            echo "docker" >> "${PROFILE_DIR}/packages.x86_64"
            echo "podman" >> "${PROFILE_DIR}/packages.x86_64"
            echo "nginx" >> "${PROFILE_DIR}/packages.x86_64"
            echo "mariadb" >> "${PROFILE_DIR}/packages.x86_64"
            echo "postgresql" >> "${PROFILE_DIR}/packages.x86_64"
            echo "redis" >> "${PROFILE_DIR}/packages.x86_64"
          fi
          
          # Sort and dedupe
          sort -u "${PROFILE_DIR}/packages.x86_64" > "${PROFILE_DIR}/packages.x86_64.tmp"
          mv "${PROFILE_DIR}/packages.x86_64.tmp" "${PROFILE_DIR}/packages.x86_64"
          echo "=== Final package list ($(wc -l < "${PROFILE_DIR}/packages.x86_64") packages) ==="
          cat "${PROFILE_DIR}/packages.x86_64"

      - name: Validate packages exist
        run: |
          echo "=== Validating all packages exist in repos ==="
          PROFILE_DIR="${{ env.PROFILE_DIR }}"
          missing_pkgs=()
          
          while IFS= read -r pkg || [ -n "$pkg" ]; do
            [ -z "$pkg" ] && continue
            # Use pacman -Sp to check if package exists (captures stderr for missing pkg errors)
            if ! pacman -Sp "$pkg" >/dev/null 2>&1; then
              echo "WARNING: Package not found: $pkg"
              missing_pkgs+=("$pkg")
            else
              echo "OK: $pkg"
            fi
          done < "${PROFILE_DIR}/packages.x86_64"
          
          if [ "${#missing_pkgs[@]}" -gt 0 ]; then
            echo ""
            echo "=== Missing packages detected (${#missing_pkgs[@]}) ==="
            printf '%s\n' "${missing_pkgs[@]}"
            echo ""
            echo "Removing missing packages from list..."
            for pkg in "${missing_pkgs[@]}"; do
              sed -i "/^${pkg}$/d" "${PROFILE_DIR}/packages.x86_64"
            done
            echo "=== Updated package list ($(wc -l < "${PROFILE_DIR}/packages.x86_64") packages) ==="
            echo "Continuing build without missing packages..."
          else
            echo "All packages validated successfully!"
          fi

      - name: Build ISO
        run: |
          set -e
          echo "=== Building ${{ matrix.edition }} ISO ==="
          EDITION="${{ matrix.edition }}"
          PROFILE_DIR="${{ env.PROFILE_DIR }}"
          OUTPUT_DIR="/tmp/aegis-output"
          WORK_DIR="/tmp/work-${EDITION}"
          mkdir -p "${OUTPUT_DIR}" "${WORK_DIR}"
          rm -rf "${WORK_DIR:?}"/*
          echo "=== Starting mkarchiso ==="
          echo "Profile: ${PROFILE_DIR}"
          echo "Work dir: ${WORK_DIR}"
          echo "Output: ${OUTPUT_DIR}"
          
          # Run mkarchiso (pacstrap_args in profiledef.sh handles --noconfirm)
          mkarchiso -v -w "${WORK_DIR}" -o "${OUTPUT_DIR}" "${PROFILE_DIR}"
          
          ISO_FILE=$(ls "${OUTPUT_DIR}"/*.iso 2>/dev/null | head -1)
          if [ -n "$ISO_FILE" ]; then
            FINAL_NAME="aegis-os-${EDITION}-1.0.0-x86_64.iso"
            mv "$ISO_FILE" "${OUTPUT_DIR}/${FINAL_NAME}"
            echo "ISO_PATH=${OUTPUT_DIR}/${FINAL_NAME}" >> $GITHUB_ENV
            sha256sum "${OUTPUT_DIR}/${FINAL_NAME}" > "${OUTPUT_DIR}/${FINAL_NAME}.sha256"
            echo "SHA256_PATH=${OUTPUT_DIR}/${FINAL_NAME}.sha256" >> $GITHUB_ENV
            echo "=== ISO Build Complete ==="
            ls -lh "${OUTPUT_DIR}/${FINAL_NAME}"
            cat "${OUTPUT_DIR}/${FINAL_NAME}.sha256"
          else
            echo "ERROR: No ISO file was produced!"
            echo "=== Checking work directory ==="
            ls -la "${WORK_DIR}/" || true
            echo "=== Checking output directory ==="
            ls -la "${OUTPUT_DIR}/" || true
            exit 1
          fi

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: aegis-os-${{ matrix.edition }}-iso
          path: |
            /tmp/aegis-output/*.iso
            /tmp/aegis-output/*.sha256
          retention-days: 30
          compression-level: 0

  release:
    name: Create Release
    needs: build-iso
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.iso
            artifacts/**/*.sha256
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
