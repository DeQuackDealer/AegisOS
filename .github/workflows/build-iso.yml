name: Build Aegis OS ISOs

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      edition:
        description: 'Edition to build'
        required: true
        default: 'freemium'
        type: choice
        options:
          - freemium
          - basic
          - gamer
          - workplace
          - aidev
          - gamer-ai
          - server
          - all

jobs:
  determine-matrix:
    name: Determine Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.edition }}" = "all" ]; then
            echo 'matrix=["freemium","basic","gamer","workplace","aidev","gamer-ai","server"]' >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo 'matrix=["${{ github.event.inputs.edition }}"]' >> $GITHUB_OUTPUT
          else
            echo 'matrix=["freemium"]' >> $GITHUB_OUTPUT
          fi

  validate:
    name: Validate Build System
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Validate Python files
        run: |
          echo "=== Validating Python syntax ==="
          errors=0
          for f in $(find . -name "*.py" -type f -not -path "./.cache/*" -not -path "./.pythonlibs/*"); do
            if python3 -m py_compile "$f" 2>/dev/null; then
              echo "OK: $f"
            else
              echo "ERROR: $f"
              errors=$((errors + 1))
            fi
          done
          if [ "$errors" -gt 0 ]; then
            echo "Found $errors Python syntax errors"
            exit 1
          fi
      
      - name: Run simulation test
        run: |
          cd build-system
          python3 build-aegis.py --edition freemium --simulate --verbose

  build-iso:
    name: Build ${{ matrix.edition }} ISO
    needs: [determine-matrix, validate]
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    strategy:
      fail-fast: false
      matrix:
        edition: ${{ fromJson(needs.determine-matrix.outputs.matrix) }}
    
    steps:
      - name: Initialize pacman and enable multilib
        run: |
          set -e
          echo "=== Initializing pacman keyring ==="
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Sy --noconfirm archlinux-keyring
          echo "=== Enabling multilib repository ==="
          cp /etc/pacman.conf /etc/pacman.conf.orig
          sed -i '/^#\[multilib\]/,/^#Include/ s/^#//' /etc/pacman.conf
          echo "=== Verifying multilib is enabled ==="
          grep -A1 "\[multilib\]" /etc/pacman.conf || echo "WARNING: multilib section not found"
          echo "=== Syncing package databases ==="
          pacman -Syy --noconfirm
          
      - name: Install build dependencies
        run: |
          set -e
          echo "=== Installing build dependencies ==="
          pacman -S --needed --noconfirm git python archiso squashfs-tools libisoburn dosfstools e2fsprogs mtools grub efibootmgr rsync wget curl gnupg
      
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup archiso profile
        run: |
          set -e
          echo "=== Setting up ${{ matrix.edition }} profile ==="
          EDITION="${{ matrix.edition }}"
          PROFILE_DIR="/tmp/aegis-${EDITION}"
          REPO_DIR="${GITHUB_WORKSPACE}"
          cp -r /usr/share/archiso/configs/releng "${PROFILE_DIR}"
          echo "=== Copying pacman.conf with multilib to profile ==="
          cp /etc/pacman.conf "${PROFILE_DIR}/pacman.conf"
          mkdir -p "${PROFILE_DIR}/airootfs/etc/pacman.d"
          cp /etc/pacman.d/mirrorlist "${PROFILE_DIR}/airootfs/etc/pacman.d/mirrorlist"
          mkdir -p "${PROFILE_DIR}/airootfs/etc/aegis"
          echo "aegis-${EDITION}" > "${PROFILE_DIR}/airootfs/etc/hostname"
          echo "{\"edition\": \"${EDITION}\", \"version\": \"1.0.0\"}" > "${PROFILE_DIR}/airootfs/etc/aegis/edition.json"
          if [ -d "${REPO_DIR}/build-system/overlays/common" ]; then
            echo "Copying common overlays..."
            rsync -av "${REPO_DIR}/build-system/overlays/common/" "${PROFILE_DIR}/airootfs/"
          fi
          if [ "$EDITION" != "freemium" ] && [ -d "${REPO_DIR}/build-system/overlays/pro" ]; then
            echo "Copying pro overlays..."
            rsync -av "${REPO_DIR}/build-system/overlays/pro/" "${PROFILE_DIR}/airootfs/"
          fi
          if [ "$EDITION" = "basic" ] || [ "$EDITION" = "workplace" ]; then
            if [ -d "${REPO_DIR}/build-system/overlays/pro-productivity" ]; then
              echo "Copying pro-productivity overlays..."
              rsync -av "${REPO_DIR}/build-system/overlays/pro-productivity/" "${PROFILE_DIR}/airootfs/"
            fi
          fi
          if [ -d "${REPO_DIR}/build-system/overlays/${EDITION}" ]; then
            echo "Copying ${EDITION} overlays..."
            rsync -av "${REPO_DIR}/build-system/overlays/${EDITION}/" "${PROFILE_DIR}/airootfs/"
          fi
          find "${PROFILE_DIR}/airootfs/usr/local/bin/" -type f -exec chmod +x {} \; 2>/dev/null || true
          echo "=== Overlay contents ==="
          ls -la "${PROFILE_DIR}/airootfs/usr/local/bin/" 2>/dev/null || echo "No tools in usr/local/bin"
          echo "PROFILE_DIR=${PROFILE_DIR}" >> $GITHUB_ENV

      - name: Create package list
        run: |
          set -e
          EDITION="${{ matrix.edition }}"
          PROFILE_DIR="${{ env.PROFILE_DIR }}"
          echo "xfce4" >> "${PROFILE_DIR}/packages.x86_64"
          echo "xfce4-goodies" >> "${PROFILE_DIR}/packages.x86_64"
          echo "lightdm" >> "${PROFILE_DIR}/packages.x86_64"
          echo "lightdm-gtk-greeter" >> "${PROFILE_DIR}/packages.x86_64"
          echo "firefox" >> "${PROFILE_DIR}/packages.x86_64"
          echo "vlc" >> "${PROFILE_DIR}/packages.x86_64"
          echo "libreoffice-fresh" >> "${PROFILE_DIR}/packages.x86_64"
          echo "ttf-dejavu" >> "${PROFILE_DIR}/packages.x86_64"
          echo "ttf-liberation" >> "${PROFILE_DIR}/packages.x86_64"
          echo "networkmanager" >> "${PROFILE_DIR}/packages.x86_64"
          echo "network-manager-applet" >> "${PROFILE_DIR}/packages.x86_64"
          echo "pipewire" >> "${PROFILE_DIR}/packages.x86_64"
          echo "pipewire-pulse" >> "${PROFILE_DIR}/packages.x86_64"
          echo "pipewire-alsa" >> "${PROFILE_DIR}/packages.x86_64"
          echo "wireplumber" >> "${PROFILE_DIR}/packages.x86_64"
          echo "pavucontrol" >> "${PROFILE_DIR}/packages.x86_64"
          echo "gvfs" >> "${PROFILE_DIR}/packages.x86_64"
          echo "gvfs-mtp" >> "${PROFILE_DIR}/packages.x86_64"
          echo "thunar-volman" >> "${PROFILE_DIR}/packages.x86_64"
          echo "xdg-user-dirs" >> "${PROFILE_DIR}/packages.x86_64"
          echo "fastfetch" >> "${PROFILE_DIR}/packages.x86_64"
          if [ "$EDITION" = "gamer" ] || [ "$EDITION" = "gamer-ai" ]; then
            echo "steam" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lutris" >> "${PROFILE_DIR}/packages.x86_64"
            echo "gamemode" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-gamemode" >> "${PROFILE_DIR}/packages.x86_64"
            echo "mangohud" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-mangohud" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-mesa" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-vulkan-icd-loader" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-gnutls" >> "${PROFILE_DIR}/packages.x86_64"
            echo "lib32-libpulse" >> "${PROFILE_DIR}/packages.x86_64"
            echo "wine" >> "${PROFILE_DIR}/packages.x86_64"
            echo "wine-gecko" >> "${PROFILE_DIR}/packages.x86_64"
            echo "wine-mono" >> "${PROFILE_DIR}/packages.x86_64"
            echo "winetricks" >> "${PROFILE_DIR}/packages.x86_64"
          fi
          if [ "$EDITION" = "aidev" ] || [ "$EDITION" = "gamer-ai" ]; then
            echo "python" >> "${PROFILE_DIR}/packages.x86_64"
            echo "python-pip" >> "${PROFILE_DIR}/packages.x86_64"
            echo "python-virtualenv" >> "${PROFILE_DIR}/packages.x86_64"
            echo "jupyterlab" >> "${PROFILE_DIR}/packages.x86_64"
            echo "docker" >> "${PROFILE_DIR}/packages.x86_64"
            echo "podman" >> "${PROFILE_DIR}/packages.x86_64"
          fi
          if [ "$EDITION" = "workplace" ]; then
            echo "remmina" >> "${PROFILE_DIR}/packages.x86_64"
            echo "freerdp" >> "${PROFILE_DIR}/packages.x86_64"
            echo "thunderbird" >> "${PROFILE_DIR}/packages.x86_64"
            echo "evolution" >> "${PROFILE_DIR}/packages.x86_64"
          fi
          if [ "$EDITION" = "server" ]; then
            echo "docker" >> "${PROFILE_DIR}/packages.x86_64"
            echo "podman" >> "${PROFILE_DIR}/packages.x86_64"
            echo "nginx" >> "${PROFILE_DIR}/packages.x86_64"
            echo "mariadb" >> "${PROFILE_DIR}/packages.x86_64"
            echo "postgresql" >> "${PROFILE_DIR}/packages.x86_64"
            echo "redis" >> "${PROFILE_DIR}/packages.x86_64"
          fi
          sort -u "${PROFILE_DIR}/packages.x86_64" > "${PROFILE_DIR}/packages.x86_64.tmp"
          mv "${PROFILE_DIR}/packages.x86_64.tmp" "${PROFILE_DIR}/packages.x86_64"
          echo "=== Final package list ($(wc -l < "${PROFILE_DIR}/packages.x86_64") packages) ==="
          cat "${PROFILE_DIR}/packages.x86_64"

      - name: Validate packages exist
        run: |
          set -e
          echo "=== Validating all packages exist in repos ==="
          PROFILE_DIR="${{ env.PROFILE_DIR }}"
          missing_pkgs=()
          while IFS= read -r pkg; do
            [ -z "$pkg" ] && continue
            if ! pacman -Si "$pkg" > /dev/null 2>&1; then
              echo "WARNING: Package not found: $pkg"
              missing_pkgs+=("$pkg")
            fi
          done < "${PROFILE_DIR}/packages.x86_64"
          if [ "${#missing_pkgs[@]}" -gt 0 ]; then
            echo ""
            echo "=== Missing packages detected ==="
            printf '%s\n' "${missing_pkgs[@]}"
            echo ""
            echo "Removing missing packages from list..."
            for pkg in "${missing_pkgs[@]}"; do
              sed -i "/^${pkg}$/d" "${PROFILE_DIR}/packages.x86_64"
            done
            echo "Continuing build without missing packages..."
          else
            echo "All packages validated successfully!"
          fi

      - name: Build ISO
        run: |
          set -e
          echo "=== Building ${{ matrix.edition }} ISO ==="
          EDITION="${{ matrix.edition }}"
          PROFILE_DIR="${{ env.PROFILE_DIR }}"
          OUTPUT_DIR="/tmp/aegis-output"
          WORK_DIR="/tmp/work-${EDITION}"
          mkdir -p "${OUTPUT_DIR}" "${WORK_DIR}"
          rm -rf "${WORK_DIR:?}"/*
          echo "=== Starting mkarchiso ==="
          echo "Profile: ${PROFILE_DIR}"
          echo "Work dir: ${WORK_DIR}"
          echo "Output: ${OUTPUT_DIR}"
          mkarchiso -v -w "${WORK_DIR}" -o "${OUTPUT_DIR}" "${PROFILE_DIR}"
          ISO_FILE=$(ls "${OUTPUT_DIR}"/*.iso 2>/dev/null | head -1)
          if [ -n "$ISO_FILE" ]; then
            FINAL_NAME="aegis-os-${EDITION}-1.0.0-x86_64.iso"
            mv "$ISO_FILE" "${OUTPUT_DIR}/${FINAL_NAME}"
            echo "ISO_PATH=${OUTPUT_DIR}/${FINAL_NAME}" >> $GITHUB_ENV
            sha256sum "${OUTPUT_DIR}/${FINAL_NAME}" > "${OUTPUT_DIR}/${FINAL_NAME}.sha256"
            echo "SHA256_PATH=${OUTPUT_DIR}/${FINAL_NAME}.sha256" >> $GITHUB_ENV
            echo "=== ISO Build Complete ==="
            ls -lh "${OUTPUT_DIR}/${FINAL_NAME}"
            cat "${OUTPUT_DIR}/${FINAL_NAME}.sha256"
          else
            echo "ERROR: No ISO file was produced!"
            ls -la "${WORK_DIR}/" || true
            ls -la "${OUTPUT_DIR}/" || true
            exit 1
          fi

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: aegis-os-${{ matrix.edition }}-iso
          path: |
            /tmp/aegis-output/*.iso
            /tmp/aegis-output/*.sha256
          retention-days: 30
          compression-level: 0

  release:
    name: Create Release
    needs: build-iso
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.iso
            artifacts/**/*.sha256
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
