name: Build Aegis OS ISOs

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      edition:
        description: 'Edition to build'
        required: true
        default: 'freemium'
        type: choice
        options:
          - freemium
          - basic
          - gamer
          - workplace
          - aidev
          - gamer-ai
          - server
          - all

jobs:
  validate:
    name: Validate Build System
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Validate Python files
        run: |
          echo "=== Validating Python syntax ==="
          errors=0
          while IFS= read -r f; do
            if python3 -m py_compile "$f" 2>/dev/null; then
              echo "OK: $f"
            else
              echo "ERROR: $f"
              errors=$((errors + 1))
            fi
          done < <(find . -name "*.py" -type f -not -path "./.cache/*" -not -path "./.pythonlibs/*")
          if [ "$errors" -gt 0 ]; then
            echo "Found $errors Python syntax errors"
            exit 1
          fi
      
      - name: Run simulation test
        run: |
          cd build-system
          python3 build-aegis.py --edition freemium --simulate --verbose

  build-iso:
    name: Build ${{ matrix.edition }} ISO
    needs: validate
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    strategy:
      fail-fast: false
      matrix:
        edition: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.edition == 'all' && fromJSON('["freemium", "basic", "gamer", "workplace", "aidev", "gamer-ai", "server"]') || fromJSON(format('["{0}"]', github.event.inputs.edition || 'freemium')) }}
    
    steps:
      - name: Initialize pacman and enable multilib
        run: |
          set -e
          echo "=== Initializing pacman keyring ==="
          pacman-key --init
          pacman-key --populate archlinux
          
          pacman -Sy --noconfirm archlinux-keyring
          
          echo "=== Enabling multilib repository ==="
          cp /etc/pacman.conf /etc/pacman.conf.orig
          sed -i '/^#\[multilib\]/,/^#Include/ s/^#//' /etc/pacman.conf
          
          echo "=== Verifying multilib is enabled ==="
          grep -A1 "\[multilib\]" /etc/pacman.conf || echo "WARNING: multilib section not found"
          
          echo "=== Syncing package databases ==="
          pacman -Syy --noconfirm
          
      - name: Install build dependencies
        run: |
          set -e
          echo "=== Installing build dependencies ==="
          pacman -S --needed --noconfirm \
            git \
            python \
            archiso \
            squashfs-tools \
            libisoburn \
            dosfstools \
            e2fsprogs \
            mtools \
            grub \
            efibootmgr \
            rsync \
            wget \
            curl \
            gnupg
      
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup archiso profile
        run: |
          set -e
          echo "=== Setting up ${{ matrix.edition }} profile ==="
          EDITION="${{ matrix.edition }}"
          PROFILE_DIR="/tmp/aegis-${EDITION}"
          REPO_DIR="${GITHUB_WORKSPACE}"
          
          cp -r /usr/share/archiso/configs/releng "${PROFILE_DIR}"
          
          echo "=== Copying pacman.conf with multilib to profile ==="
          cp /etc/pacman.conf "${PROFILE_DIR}/pacman.conf"
          
          mkdir -p "${PROFILE_DIR}/airootfs/etc/pacman.d"
          cp /etc/pacman.d/mirrorlist "${PROFILE_DIR}/airootfs/etc/pacman.d/mirrorlist"
          
          mkdir -p "${PROFILE_DIR}/airootfs/etc/aegis"
          echo "aegis-${EDITION}" > "${PROFILE_DIR}/airootfs/etc/hostname"
          echo "{\"edition\": \"${EDITION}\", \"version\": \"1.0.0\"}" > "${PROFILE_DIR}/airootfs/etc/aegis/edition.json"
          
          if [ -d "${REPO_DIR}/build-system/overlays/common" ]; then
            echo "Copying common overlays..."
            rsync -av "${REPO_DIR}/build-system/overlays/common/" "${PROFILE_DIR}/airootfs/"
          else
            echo "WARNING: No common overlays found"
          fi
          
          if [ "$EDITION" != "freemium" ] && [ -d "${REPO_DIR}/build-system/overlays/pro" ]; then
            echo "Copying pro overlays for paid edition..."
            rsync -av "${REPO_DIR}/build-system/overlays/pro/" "${PROFILE_DIR}/airootfs/"
          fi
          
          if [ "$EDITION" = "basic" ] || [ "$EDITION" = "workplace" ]; then
            if [ -d "${REPO_DIR}/build-system/overlays/pro-productivity" ]; then
              echo "Copying pro-productivity overlays..."
              rsync -av "${REPO_DIR}/build-system/overlays/pro-productivity/" "${PROFILE_DIR}/airootfs/"
            fi
          fi
          
          if [ -d "${REPO_DIR}/build-system/overlays/${EDITION}" ]; then
            echo "Copying ${EDITION} overlays..."
            rsync -av "${REPO_DIR}/build-system/overlays/${EDITION}/" "${PROFILE_DIR}/airootfs/"
          else
            echo "WARNING: No ${EDITION}-specific overlays found"
          fi
          
          find "${PROFILE_DIR}/airootfs/usr/local/bin/" -type f -exec chmod +x {} \; 2>/dev/null || true
          
          echo "=== Overlay contents ==="
          ls -la "${PROFILE_DIR}/airootfs/usr/local/bin/" 2>/dev/null || echo "No tools in usr/local/bin"
          ls -la "${PROFILE_DIR}/airootfs/etc/aegis/" 2>/dev/null || echo "No aegis config"
          
          # Add base packages using printf (avoids heredoc YAML issues)
          {
            printf '%s\n' "xfce4"
            printf '%s\n' "xfce4-goodies"
            printf '%s\n' "lightdm"
            printf '%s\n' "lightdm-gtk-greeter"
            printf '%s\n' "firefox"
            printf '%s\n' "vlc"
            printf '%s\n' "libreoffice-fresh"
            printf '%s\n' "ttf-dejavu"
            printf '%s\n' "ttf-liberation"
            printf '%s\n' "networkmanager"
            printf '%s\n' "network-manager-applet"
            printf '%s\n' "pipewire"
            printf '%s\n' "pipewire-pulse"
            printf '%s\n' "pipewire-alsa"
            printf '%s\n' "wireplumber"
            printf '%s\n' "pavucontrol"
            printf '%s\n' "gvfs"
            printf '%s\n' "gvfs-mtp"
            printf '%s\n' "thunar-volman"
            printf '%s\n' "xdg-user-dirs"
            printf '%s\n' "fastfetch"
          } >> "${PROFILE_DIR}/packages.x86_64"
          
          # Add gamer packages
          if [ "$EDITION" = "gamer" ] || [ "$EDITION" = "gamer-ai" ]; then
            {
              printf '%s\n' "steam"
              printf '%s\n' "lutris"
              printf '%s\n' "gamemode"
              printf '%s\n' "lib32-gamemode"
              printf '%s\n' "mangohud"
              printf '%s\n' "lib32-mangohud"
              printf '%s\n' "lib32-mesa"
              printf '%s\n' "lib32-vulkan-icd-loader"
              printf '%s\n' "lib32-gnutls"
              printf '%s\n' "lib32-libpulse"
              printf '%s\n' "wine"
              printf '%s\n' "wine-gecko"
              printf '%s\n' "wine-mono"
              printf '%s\n' "winetricks"
            } >> "${PROFILE_DIR}/packages.x86_64"
          fi
          
          # Add AI dev packages
          if [ "$EDITION" = "aidev" ] || [ "$EDITION" = "gamer-ai" ]; then
            {
              printf '%s\n' "python"
              printf '%s\n' "python-pip"
              printf '%s\n' "python-virtualenv"
              printf '%s\n' "jupyterlab"
              printf '%s\n' "docker"
              printf '%s\n' "podman"
            } >> "${PROFILE_DIR}/packages.x86_64"
          fi
          
          # Add workplace packages
          if [ "$EDITION" = "workplace" ]; then
            {
              printf '%s\n' "remmina"
              printf '%s\n' "freerdp"
              printf '%s\n' "thunderbird"
              printf '%s\n' "evolution"
            } >> "${PROFILE_DIR}/packages.x86_64"
          fi
          
          # Add server packages
          if [ "$EDITION" = "server" ]; then
            {
              printf '%s\n' "docker"
              printf '%s\n' "podman"
              printf '%s\n' "nginx"
              printf '%s\n' "mariadb"
              printf '%s\n' "postgresql"
              printf '%s\n' "redis"
            } >> "${PROFILE_DIR}/packages.x86_64"
          fi
          
          # Remove duplicate packages and blank lines
          grep -v '^$' "${PROFILE_DIR}/packages.x86_64" | sort -u > "${PROFILE_DIR}/packages.x86_64.tmp"
          mv "${PROFILE_DIR}/packages.x86_64.tmp" "${PROFILE_DIR}/packages.x86_64"
          
          echo "=== Final package list ($(wc -l < "${PROFILE_DIR}/packages.x86_64") packages) ==="
          cat "${PROFILE_DIR}/packages.x86_64"
          
          echo "PROFILE_DIR=${PROFILE_DIR}" >> $GITHUB_ENV

      - name: Validate packages exist
        run: |
          set -e
          echo "=== Validating all packages exist in repos ==="
          PROFILE_DIR="${{ env.PROFILE_DIR }}"
          missing_pkgs=()
          
          while IFS= read -r pkg; do
            [[ -z "$pkg" || "$pkg" =~ ^# ]] && continue
            
            if ! pacman -Si "$pkg" &>/dev/null; then
              echo "WARNING: Package not found: $pkg"
              missing_pkgs+=("$pkg")
            fi
          done < "${PROFILE_DIR}/packages.x86_64"
          
          if [ "${#missing_pkgs[@]}" -gt 0 ]; then
            echo ""
            echo "=== Missing packages detected ==="
            printf '%s\n' "${missing_pkgs[@]}"
            echo ""
            echo "Removing missing packages from list..."
            for pkg in "${missing_pkgs[@]}"; do
              sed -i "/^${pkg}$/d" "${PROFILE_DIR}/packages.x86_64"
            done
            echo "Continuing build without missing packages..."
          else
            echo "All packages validated successfully!"
          fi

      - name: Build ISO
        run: |
          set -e
          echo "=== Building ${{ matrix.edition }} ISO ==="
          EDITION="${{ matrix.edition }}"
          PROFILE_DIR="${{ env.PROFILE_DIR }}"
          OUTPUT_DIR="/tmp/aegis-output"
          WORK_DIR="/tmp/work-${EDITION}"
          
          mkdir -p "${OUTPUT_DIR}" "${WORK_DIR}"
          rm -rf "${WORK_DIR:?}"/*
          
          echo "=== Starting mkarchiso ==="
          echo "Profile: ${PROFILE_DIR}"
          echo "Work dir: ${WORK_DIR}"
          echo "Output: ${OUTPUT_DIR}"
          
          mkarchiso -v -w "${WORK_DIR}" -o "${OUTPUT_DIR}" "${PROFILE_DIR}"
          
          ISO_FILE=$(ls "${OUTPUT_DIR}"/*.iso 2>/dev/null | head -1)
          if [ -n "$ISO_FILE" ]; then
            FINAL_NAME="aegis-os-${EDITION}-1.0.0-x86_64.iso"
            mv "$ISO_FILE" "${OUTPUT_DIR}/${FINAL_NAME}"
            echo "ISO_PATH=${OUTPUT_DIR}/${FINAL_NAME}" >> $GITHUB_ENV
            
            sha256sum "${OUTPUT_DIR}/${FINAL_NAME}" > "${OUTPUT_DIR}/${FINAL_NAME}.sha256"
            echo "SHA256_PATH=${OUTPUT_DIR}/${FINAL_NAME}.sha256" >> $GITHUB_ENV
            
            echo "=== ISO Build Complete ==="
            ls -lh "${OUTPUT_DIR}/${FINAL_NAME}"
            cat "${OUTPUT_DIR}/${FINAL_NAME}.sha256"
          else
            echo "ERROR: No ISO file was produced!"
            echo "=== Work directory contents ==="
            ls -la "${WORK_DIR}/" || true
            echo "=== Output directory contents ==="
            ls -la "${OUTPUT_DIR}/" || true
            exit 1
          fi

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: aegis-os-${{ matrix.edition }}-iso
          path: |
            /tmp/aegis-output/*.iso
            /tmp/aegis-output/*.sha256
          retention-days: 30
          compression-level: 0

  release:
    name: Create Release
    needs: build-iso
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.iso
            artifacts/**/*.sha256
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
