name: Aegis OS CI

on:
  push:
    branches: [main, 'preview/*']
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Test Build System
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check files
        run: |
          echo "=== Repository contents ==="
          ls -la
          echo ""
          if [ -d "build-system" ]; then
            echo "=== Build system found ==="
            ls -la build-system/
          fi
          if [ -d "usr" ]; then
            echo "=== Tools found ==="
            ls -la usr/local/bin/ 2>/dev/null || true
          fi
      
      - name: Validate Python
        run: |
          find . -name "*.py" -type f | head -20 | while read f; do
            python3 -m py_compile "$f" && echo "OK: $f" || echo "FAIL: $f"
          done
      
      - name: Run simulation
        if: hashFiles('build-system/build-aegis.py') != ''
        run: |
          cd build-system
          python3 build-aegis.py --edition freemium --simulate --verbose
