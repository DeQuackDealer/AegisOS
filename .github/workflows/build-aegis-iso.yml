name: Build Aegis OS ISOs

on:
  workflow_dispatch:
    inputs:
      edition:
        description: 'Edition to build'
        required: true
        default: 'freemium'
        type: choice
        options:
          - freemium
          - basic
          - gamer
          - workplace
          - aidev
          - gamer-ai
          - server
          - all
  push:
    branches:
      - main
    paths:
      - 'build-system/**'
      - '.github/workflows/build-aegis-iso.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    
    strategy:
      fail-fast: false
      matrix:
        edition: ${{ github.event.inputs.edition == 'all' && fromJSON('["freemium", "basic", "gamer", "workplace", "aidev", "gamer-ai", "server"]') || fromJSON(format('["{0}"]', github.event.inputs.edition || 'freemium')) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update system and install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm \
            archiso \
            arch-install-scripts \
            squashfs-tools \
            libisoburn \
            mkinitcpio \
            grub \
            rsync \
            gnupg \
            python \
            python-pip \
            dosfstools \
            e2fsprogs \
            erofs-utils \
            libarchive \
            mtools

      - name: Verify build tools
        run: |
          echo "Checking installed tools..."
          which mkarchiso
          which pacstrap
          which mksquashfs
          which xorriso
          mkarchiso --version || true

      - name: Check build script
        run: |
          cd build-system
          python build-aegis.py --check-deps
          python build-aegis.py --list-editions

      - name: Build ${{ matrix.edition }} ISO
        run: |
          cd build-system
          python build-aegis.py --edition ${{ matrix.edition }} --real-build --verbose
        env:
          AEGIS_BUILD_CI: "true"

      - name: Generate checksums
        run: |
          cd build-system/output
          for iso in *.iso; do
            if [ -f "$iso" ]; then
              sha256sum "$iso" > "${iso}.sha256"
              echo "Generated checksum for $iso"
              cat "${iso}.sha256"
            fi
          done

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: aegis-os-${{ matrix.edition }}-iso
          path: |
            build-system/output/*.iso
            build-system/output/*.sha256
          retention-days: 30
          if-no-files-found: error

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs-${{ matrix.edition }}
          path: build-system/logs/
          retention-days: 7
          if-no-files-found: ignore

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: aegis-os-*-iso

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -name "*.iso" -o -name "*.sha256" | head -20

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            artifacts/**/*.iso
            artifacts/**/*.sha256
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
