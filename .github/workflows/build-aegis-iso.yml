name: Build Aegis OS ISOs

on:
  workflow_dispatch:
    inputs:
      edition:
        description: 'Edition to build'
        required: true
        default: 'freemium'
        type: choice
        options:
          - freemium
          - basic
          - gamer
          - workplace
          - aidev
          - gamer-ai
          - server

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Aegis profile
        run: |
          mkdir -p profile/airootfs/etc
          
          cat > profile/profiledef.sh << 'EOF'
          #!/usr/bin/env bash
          iso_name="aegis-os-${{ github.event.inputs.edition }}"
          iso_label="AEGIS_$(date +%Y%m)"
          iso_publisher="Aegis OS Project"
          iso_application="Aegis OS Live Medium"
          iso_version="$(date +%Y.%m.%d)"
          install_dir="arch"
          buildmodes=('iso')
          bootmodes=('bios.syslinux.mbr' 'bios.syslinux.eltorito')
          arch="x86_64"
          pacman_conf="pacman.conf"
          airootfs_image_type="squashfs"
          airootfs_image_tool_options=('-comp' 'xz' '-Xbcj' 'x86' '-b' '1M' '-Xdict-size' '1M')
          file_permissions=(
            ["/etc/shadow"]="0:0:400"
          )
          EOF
          
          cat > profile/pacman.conf << 'EOF'
          [options]
          Architecture = x86_64
          SigLevel = Required DatabaseOptional
          [core]
          Include = /etc/pacman.d/mirrorlist
          [extra]
          Include = /etc/pacman.d/mirrorlist
          EOF
          
          cat > profile/packages.x86_64 << 'EOF'
          base
          linux
          linux-firmware
          syslinux
          mkinitcpio
          mkinitcpio-archiso
          EOF
          
          cat > profile/airootfs/etc/hostname << 'EOF'
          aegis
          EOF
          
          cat > profile/airootfs/etc/os-release << EOF
          NAME="Aegis OS"
          PRETTY_NAME="Aegis OS ${{ github.event.inputs.edition }}"
          ID=aegis
          ID_LIKE=arch
          VERSION="3.0.0"
          HOME_URL="https://aegis-os.com"
          EOF
          
          mkdir -p profile/syslinux
          
          echo "Profile created:"
          find profile -type f

      - name: Build ISO with mkarchiso action
        uses: coderadu/actions-mkarchiso@v1
        with:
          profile-path: profile

      - name: Rename ISO
        run: |
          cd out
          ISO=$(ls *.iso 2>/dev/null | head -1)
          if [ -n "$ISO" ]; then
            FINAL="aegis-os-${{ github.event.inputs.edition }}-$(date +%Y%m%d).iso"
            mv "$ISO" "$FINAL"
            sha256sum "$FINAL" > "$FINAL.sha256"
            echo "Built: $FINAL"
            ls -lh
          else
            echo "No ISO found in out/"
            ls -la
          fi

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: aegis-os-${{ github.event.inputs.edition }}-iso
          path: out/*.iso
          retention-days: 30
          if-no-files-found: warn

      - name: Upload checksum
        uses: actions/upload-artifact@v4
        with:
          name: aegis-os-${{ github.event.inputs.edition }}-checksum  
          path: out/*.sha256
          retention-days: 30
          if-no-files-found: warn
