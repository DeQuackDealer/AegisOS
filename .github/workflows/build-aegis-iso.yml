name: Build Aegis OS ISOs

on:
  workflow_dispatch:
    inputs:
      edition:
        description: 'Edition to build'
        required: true
        default: 'freemium'
        type: choice
        options:
          - freemium
          - basic
          - gamer
          - workplace
          - aidev
          - gamer-ai
          - server
          - all

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    strategy:
      fail-fast: false
      matrix:
        edition: ${{ github.event.inputs.edition == 'all' && fromJSON('["freemium", "basic", "gamer", "workplace", "aidev", "gamer-ai", "server"]') || fromJSON(format('["{0}"]', github.event.inputs.edition || 'freemium')) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install archiso and dependencies
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm
          pacman -S --noconfirm archiso

      - name: Copy baseline profile and customize
        run: |
          cp -r /usr/share/archiso/configs/baseline /tmp/aegis-profile
          
          cat > /tmp/aegis-profile/profiledef.sh << 'EOF'
          #!/usr/bin/env bash
          iso_name="aegis-os"
          iso_label="AEGIS_$(date +%Y%m)"
          iso_publisher="Aegis OS Project"
          iso_application="Aegis OS Live Medium"
          iso_version="$(date +%Y.%m.%d)"
          install_dir="arch"
          buildmodes=('iso')
          bootmodes=('bios.syslinux.mbr' 'bios.syslinux.eltorito')
          arch="x86_64"
          pacman_conf="pacman.conf"
          airootfs_image_type="squashfs"
          airootfs_image_tool_options=('-comp' 'xz' '-Xbcj' 'x86' '-b' '1M' '-Xdict-size' '1M')
          file_permissions=(
            ["/etc/shadow"]="0:0:400"
          )
          EOF
          
          cat >> /tmp/aegis-profile/packages.x86_64 << 'PACKAGES'
          base
          linux
          linux-firmware
          syslinux
          mkinitcpio
          mkinitcpio-archiso
          vim
          nano
          htop
          neofetch
          networkmanager
          wget
          curl
          git
          PACKAGES
          
          mkdir -p /tmp/aegis-profile/airootfs/etc
          cat > /tmp/aegis-profile/airootfs/etc/hostname << 'HOSTNAME'
          aegis
          HOSTNAME
          
          cat > /tmp/aegis-profile/airootfs/etc/os-release << EOF
          NAME="Aegis OS"
          PRETTY_NAME="Aegis OS ${{ matrix.edition }}"
          ID=aegis
          ID_LIKE=arch
          VERSION="3.0.0"
          HOME_URL="https://aegis-os.com"
          EOF
          
          echo "Profile ready:"
          ls -la /tmp/aegis-profile/

      - name: Build ISO
        run: |
          mkdir -p /tmp/work /tmp/out
          mkarchiso -v -w /tmp/work -o /tmp/out /tmp/aegis-profile
          
          echo "Build complete. Output:"
          ls -lh /tmp/out/

      - name: Rename and generate checksum
        run: |
          cd /tmp/out
          ISO=$(ls *.iso | head -1)
          FINAL="aegis-os-${{ matrix.edition }}-$(date +%Y%m%d).iso"
          mv "$ISO" "$FINAL"
          sha256sum "$FINAL" > "$FINAL.sha256"
          echo "ISO: $FINAL"
          cat "$FINAL.sha256"

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: aegis-os-${{ matrix.edition }}-iso
          path: /tmp/out/*.iso
          retention-days: 30

      - name: Upload checksum
        uses: actions/upload-artifact@v4
        with:
          name: aegis-os-${{ matrix.edition }}-checksum
          path: /tmp/out/*.sha256
          retention-days: 30
