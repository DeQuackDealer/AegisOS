#!/usr/bin/env python3
"""
Aegis OS Gaming Optimizer - Freemium Edition
Basic gaming optimizations without AI features
"""

import os
import subprocess
import json
import logging

TIER_LIMIT = "full"  # "freemium" or "full" - controls feature availability

class AegisGamingOptimizer:
    def __init__(self):
        self.config_file = "/etc/aegis/gaming-config.json"
        self.log_file = "/var/log/aegis-gaming.log"
        self.setup_logging()
        
    def setup_logging(self):
        """Setup logging configuration"""
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler(self.log_file),
                logging.StreamHandler()
            ]
        )
        
    def load_config(self):
        """Load gaming configuration"""
        default_config = {
            "cpu_governor": "performance",
            "swappiness": 10,
            "dirty_ratio": 15,
            "proton_enabled": True,
            "wine_version": "stable"
        }
        
        try:
            with open(self.config_file, 'r') as f:
                config = json.load(f)
                return {**default_config, **config}
        except FileNotFoundError:
            os.makedirs("/etc/aegis", exist_ok=True)
            with open(self.config_file, 'w') as f:
                json.dump(default_config, f, indent=2)
            return default_config
    
    def set_cpu_governor(self, governor):
        """Set CPU governor for performance"""
        try:
            cpus = os.listdir("/sys/devices/system/cpu/")
            cpu_dirs = [cpu for cpu in cpus if cpu.startswith("cpu") and cpu[3:].isdigit()]
            
            for cpu in cpu_dirs:
                governor_path = f"/sys/devices/system/cpu/{cpu}/cpufreq/scaling_governor"
                if os.path.exists(governor_path):
                    with open(governor_path, 'w') as f:
                        f.write(governor)
                        
            logging.info(f"CPU governor set to {governor}")
        except Exception as e:
            logging.error(f"Failed to set CPU governor: {e}")
    
    def optimize_memory(self, swappiness, dirty_ratio):
        """Optimize memory settings for gaming"""
        try:
            with open("/proc/sys/vm/swappiness", 'w') as f:
                f.write(str(swappiness))
                
            with open("/proc/sys/vm/dirty_ratio", 'w') as f:
                f.write(str(dirty_ratio))
                
            logging.info("Memory optimization applied")
        except Exception as e:
            logging.error(f"Failed to optimize memory: {e}")
    
    def setup_proton(self):
        """Setup Proton for Steam compatibility"""
        proton_dir = "/home/aegis/.steam/steam/steamapps/common/"
        
        if not os.path.exists(proton_dir):
            logging.info("Steam not detected, skipping Proton setup")
            return
            
        # Set environment variables for Proton
        env_vars = {
            "PROTON_USE_WINED3D": "1",
            "PROTON_NO_ESYNC": "0",
            "PROTON_NO_FSYNC": "0",
            "PROTON_FORCE_LARGE_ADDRESS_AWARE": "1"
        }
        
        profile_path = "/home/aegis/.profile"
        with open(profile_path, 'a') as f:
            f.write("\n# Aegis OS Proton Configuration\n")
            for var, value in env_vars.items():
                f.write(f"export {var}={value}\n")
                
        logging.info("Proton configuration applied")
    
    def setup_wine(self):
        """Setup Wine for Windows application compatibility"""
        wine_prefix = "/home/aegis/.wine"
        
        if not os.path.exists("/usr/bin/wine"):
            logging.info("Wine not installed, skipping configuration")
            return
            
        try:
            # Initialize Wine prefix
            subprocess.run([
                "sudo", "-u", "aegis", 
                "WINEPREFIX=" + wine_prefix, 
                "winecfg", "/S"
            ], check=True, capture_output=True)
            
            # Install essential Windows libraries
            libraries = ["vcrun2019", "dotnet48", "corefonts"]
            for lib in libraries:
                subprocess.run([
                    "sudo", "-u", "aegis",
                    "WINEPREFIX=" + wine_prefix,
                    "winetricks", "-q", lib
                ], capture_output=True)
                
            logging.info("Wine configuration completed")
        except Exception as e:
            logging.error(f"Wine setup failed: {e}")
    
    def apply_custom_profile(self, game_name: str):
        """Apply per-game optimization profile"""
        if TIER_LIMIT == "freemium":
            logging.warning("Per-game profiles require full edition")
            print("‚ö†Ô∏è Per-game custom profiles are a premium feature.")
            print("   Upgrade to unlock per-game optimization profiles.")
            return False
        
        logging.info(f"Applying custom profile for: {game_name}")
        return True
    
    def apply_overclocking(self, settings: dict):
        """Apply GPU/CPU overclocking settings"""
        if TIER_LIMIT == "freemium":
            logging.warning("Overclocking features require full edition")
            print("‚ö†Ô∏è Overclocking is a premium feature.")
            print("   Upgrade to unlock GPU/CPU overclocking controls.")
            return False
        
        logging.info("Applying overclocking settings")
        return True
    
    def apply_optimizations(self):
        """Apply all gaming optimizations"""
        if TIER_LIMIT == "freemium":
            logging.info("Starting Aegis Gaming Optimizer - Freemium Edition")
            print("üéÆ Aegis Gaming Optimizer - Freemium Edition")
        else:
            logging.info("Starting Aegis Gaming Optimizer - Full Edition")
            print("üéÆ Aegis Gaming Optimizer - Full Edition")
        
        config = self.load_config()
        
        # Apply CPU optimization (basic - available in freemium)
        self.set_cpu_governor(config["cpu_governor"])
        
        # Apply memory optimization (basic - available in freemium)
        self.optimize_memory(config["swappiness"], config["dirty_ratio"])
        
        # Setup gaming compatibility layers (basic - available in freemium)
        if config["proton_enabled"]:
            self.setup_proton()
            
        self.setup_wine()
        
        logging.info("Gaming optimizations applied successfully")
        print("‚úÖ Basic gaming optimizations applied")
        
        if TIER_LIMIT == "freemium":
            print("")
            print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
            print("üîí PREMIUM FEATURES (Upgrade to unlock):")
            print("   ‚Ä¢ Per-game custom optimization profiles")
            print("   ‚Ä¢ GPU/CPU overclocking controls")
            print("   ‚Ä¢ AI-powered performance tuning")
            print("   ‚Ä¢ Advanced latency optimizations")
            print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
        else:
            print("‚úÖ All premium features available")

if __name__ == "__main__":
    optimizer = AegisGamingOptimizer()
    optimizer.apply_optimizations()
