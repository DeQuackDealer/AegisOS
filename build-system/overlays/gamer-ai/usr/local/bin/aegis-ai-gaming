#!/usr/bin/env python3
"""
Aegis AI Gaming - AI companion and real-time translation for Gamer AI edition
Features: AI companion, voice commands, real-time translation, strategy assistant

Provides GUI (GTK) and CLI modes with tier-based feature gating.
"""

import os
import sys
import json
import subprocess
import logging
import argparse
import shutil
import time
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Any

TIER_LIMIT = "gamer-ai"
VERSION = "1.5.0"
APP_NAME = "Aegis AI Gaming"

CONFIG_FILE = "/etc/aegis/gamer-ai-config.json"
LOG_FILE = "/var/log/aegis/ai-gaming.log"

try:
    import gi
    gi.require_version('Gtk', '3.0')
    from gi.repository import Gtk
    GTK_AVAILABLE = True
except ImportError:
    GTK_AVAILABLE = False


class LicenseTier:
    FREEMIUM = 1
    GAMER = 4
    GAMER_AI = 5


AI_FEATURES = {
    "companion": {
        "name": "AI Companion",
        "description": "In-game AI assistant for tips and strategies",
        "models": ["llama3.2", "mistral-7b", "phi-3"]
    },
    "translation": {
        "name": "Real-time Translation",
        "description": "Translate game text and voice in real-time",
        "models": ["whisper", "nllb-200"]
    },
    "voice_commands": {
        "name": "Voice Commands",
        "description": "Control games with voice commands",
        "models": ["whisper-small"]
    },
    "strategy": {
        "name": "Strategy Assistant",
        "description": "AI-powered game strategy suggestions",
        "models": ["llama3.2", "codellama"]
    }
}


class AegisAIGaming:
    def __init__(self, headless: bool = False):
        self.headless = headless
        self.version = VERSION
        self.config = {}
        self.license_tier = LicenseTier.FREEMIUM
        self.daemon_running = False
        
        self.setup_logging()
        self.load_license_tier()
        self.load_config()
        
    def setup_logging(self):
        log_dir = Path(LOG_FILE).parent
        try:
            log_dir.mkdir(parents=True, exist_ok=True)
            logging.basicConfig(level=logging.INFO)
        except Exception:
            pass
        self.logger = logging.getLogger("AegisAIGaming")
    
    def load_license_tier(self):
        if Path("/etc/aegis-gamer-ai-marker").exists():
            self.license_tier = LicenseTier.GAMER_AI
        elif Path("/etc/aegis-gamer-marker").exists():
            self.license_tier = LicenseTier.GAMER
    
    def is_feature_available(self) -> bool:
        return self.license_tier >= LicenseTier.GAMER_AI
    
    def load_config(self):
        self.config = {
            "ai_companion": True,
            "real_time_translation": True,
            "voice_commands": True
        }
    
    def check_ollama_installed(self) -> bool:
        return shutil.which("ollama") is not None
    
    def check_whisper_installed(self) -> bool:
        return shutil.which("whisper") is not None
    
    def get_ai_features_status(self) -> List[Dict[str, Any]]:
        features = []
        for fid, info in AI_FEATURES.items():
            features.append({
                "id": fid,
                "name": info["name"],
                "description": info["description"],
                "available": self.is_feature_available()
            })
        return features
    
    def start_companion(self, game: str = "general") -> Dict[str, Any]:
        if not self.is_feature_available():
            return {"success": False, "error": "Requires Gamer AI edition"}
        
        if not self.check_ollama_installed():
            return {"success": False, "error": "Ollama not installed"}
        
        self.logger.info(f"Starting AI companion for: {game}")
        return {"success": True, "game": game, "status": "active"}
    
    def translate_text(self, text: str, source_lang: str = "auto", target_lang: str = "en") -> Dict[str, Any]:
        if not self.is_feature_available():
            return {"success": False, "error": "Requires Gamer AI edition"}
        
        return {"success": True, "original": text, "translated": f"[Translated to {target_lang}]"}
    
    def get_status(self) -> Dict[str, Any]:
        return {
            "features": self.get_ai_features_status(),
            "ollama_installed": self.check_ollama_installed(),
            "whisper_installed": self.check_whisper_installed(),
            "tier": self.license_tier
        }
    
    def run_daemon(self):
        self.daemon_running = True
        self.logger.info("Starting AI gaming daemon")
        while self.daemon_running:
            time.sleep(60)
    
    def run_cli(self):
        print(f"\n{'='*60}")
        print(f"  {APP_NAME} v{VERSION}")
        print(f"{'='*60}\n")
        
        features = self.get_ai_features_status()
        print("AI Features:")
        for feature in features:
            status = "✓" if feature["available"] else "✗"
            print(f"  {feature['name']}: {status}")
            print(f"    {feature['description']}")
        
        print(f"\nOllama: {'✓' if self.check_ollama_installed() else '✗'}")
        print(f"Whisper: {'✓' if self.check_whisper_installed() else '✗'}")
    
    def run_gui(self):
        if not GTK_AVAILABLE:
            return self.run_cli()
        
        win = Gtk.Window(title=f"{APP_NAME}")
        win.set_default_size(800, 600)
        win.connect("destroy", Gtk.main_quit)
        
        vbox = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        win.add(vbox)
        
        header = Gtk.Label()
        header.set_markup(f"<big><b>{APP_NAME}</b></big>")
        vbox.pack_start(header, False, False, 20)
        
        for feature in self.get_ai_features_status():
            hbox = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)
            label = Gtk.Label(label=f"{feature['name']}: {feature['description']}")
            label.set_xalign(0)
            hbox.pack_start(label, True, True, 10)
            
            btn = Gtk.Button(label="Enable")
            btn.set_sensitive(self.license_tier >= LicenseTier.GAMER_AI)
            hbox.pack_end(btn, False, False, 10)
            
            vbox.pack_start(hbox, False, False, 5)
        
        win.show_all()
        Gtk.main()


def main():
    parser = argparse.ArgumentParser(description=f"{APP_NAME}")
    parser.add_argument("--gui", action="store_true")
    parser.add_argument("--cli", action="store_true")
    parser.add_argument("--daemon", action="store_true")
    parser.add_argument("--start-companion", metavar="GAME")
    parser.add_argument("--translate", metavar="TEXT")
    parser.add_argument("--status", action="store_true")
    parser.add_argument("--version", action="version", version=f"{APP_NAME} {VERSION}")
    
    args = parser.parse_args()
    
    if args.daemon:
        app = AegisAIGaming(headless=True)
        app.run_daemon()
    elif args.start_companion:
        app = AegisAIGaming(headless=True)
        result = app.start_companion(args.start_companion)
        print(json.dumps(result, indent=2))
    elif args.translate:
        app = AegisAIGaming(headless=True)
        result = app.translate_text(args.translate)
        print(json.dumps(result, indent=2))
    elif args.status:
        app = AegisAIGaming(headless=True)
        print(json.dumps(app.get_status(), indent=2))
    elif args.cli or not GTK_AVAILABLE:
        app = AegisAIGaming(headless=False)
        app.run_cli()
    else:
        app = AegisAIGaming(headless=False)
        app.run_gui()


if __name__ == "__main__":
    main()
