#!/usr/bin/env python3
"""
Aegis Upgrade Prompt - Shows upgrade options for Freemium users
Displays available editions and their features with purchase links.
"""

import os
import sys
import json
import subprocess
import webbrowser
import argparse
from pathlib import Path
from datetime import datetime

try:
    import gi
    gi.require_version('Gtk', '3.0')
    from gi.repository import Gtk, Gdk, GLib, Pango
    GTK_AVAILABLE = True
except ImportError:
    GTK_AVAILABLE = False

CONFIG_DIR = Path("/etc/aegis")
TIER_FILE = CONFIG_DIR / "tier.json"
TRIAL_FILE = Path.home() / ".config/aegis/trial.json"
PURCHASE_URL = "https://aegis-os.com/purchase"

EDITIONS = {
    "basic": {
        "name": "Basic Edition",
        "price": "$49",
        "color": "#228B22",
        "features": [
            "Security Suite (ClamAV, Firewall, Fail2ban)",
            "Backup Suite with Cloud Sync",
            "Media Suite (VLC, Handbrake, Recorder)",
            "100+ Themes & Icon Packs",
            "Productivity Tools",
            "Priority Support"
        ]
    },
    "gamer": {
        "name": "Gamer Edition",
        "price": "$79",
        "color": "#CC0000",
        "features": [
            "All Basic Features",
            "Steam, GOG, Epic Integration",
            "Wine/Proton Optimization",
            "FSR Upscaling",
            "MangoHud Performance Overlay",
            "Game Launcher with Library",
            "Streaming Tools"
        ]
    },
    "workplace": {
        "name": "Workplace Edition",
        "price": "$99",
        "color": "#4B0082",
        "features": [
            "All Basic Features",
            "Microsoft 365 Integration",
            "Google Workspace Integration",
            "Video Conferencing Tools",
            "Document Management (PDF, OCR)",
            "Enterprise VPN",
            "IT Management Tools"
        ]
    },
    "aidev": {
        "name": "AI Developer Edition",
        "price": "$149",
        "color": "#FF6600",
        "features": [
            "All Basic Features",
            "Jupyter Lab & VS Code",
            "PyTorch, TensorFlow, JAX",
            "CUDA 12.4 & ROCm 6.0",
            "Model Hub (HuggingFace, Ollama)",
            "LLM Tools (LangChain, Vector DBs)",
            "Inference Engines"
        ]
    },
    "gamer_ai": {
        "name": "Gamer + AI Edition",
        "price": "$199",
        "color": "#9933FF",
        "features": [
            "All Gamer Features",
            "All AI Developer Features",
            "Neural Upscaling (ANU)",
            "DLSS 3.5 / FSR 3.0 / XeSS",
            "AI Gaming Companion",
            "ML Performance Prediction",
            "AI Streaming Tools"
        ]
    },
    "server": {
        "name": "Server Edition",
        "price": "$199",
        "color": "#006699",
        "features": [
            "All Basic Features",
            "Enterprise Security (XDR)",
            "Kubernetes & Docker Swarm",
            "Load Balancing (nginx, haproxy)",
            "Disaster Recovery",
            "SIEM & Log Aggregation",
            "24/7 Priority Support"
        ]
    }
}

def get_trial_status():
    """Get current trial status"""
    if TRIAL_FILE.exists():
        try:
            with open(TRIAL_FILE) as f:
                data = json.load(f)
            start = datetime.fromisoformat(data.get("start_date", ""))
            days_used = (datetime.now() - start).days
            days_left = max(0, 30 - days_used)
            return {"active": days_left > 0, "days_left": days_left, "started": True}
        except:
            pass
    return {"active": False, "days_left": 0, "started": False}

def start_trial():
    """Start the 30-day premium trial"""
    TRIAL_FILE.parent.mkdir(parents=True, exist_ok=True)
    data = {
        "start_date": datetime.now().isoformat(),
        "edition": "freemium",
        "trial_features": ["security_suite", "backup_suite", "media_suite"]
    }
    with open(TRIAL_FILE, 'w') as f:
        json.dump(data, f, indent=2)
    print("30-day premium trial started!")
    return True

def open_purchase(edition=None):
    """Open purchase page"""
    url = PURCHASE_URL
    if edition:
        url += f"?edition={edition}"
    webbrowser.open(url)

class UpgradeWindow(Gtk.Window):
    def __init__(self):
        super().__init__(title="Upgrade Aegis OS")
        self.set_default_size(700, 600)
        self.set_position(Gtk.WindowPosition.CENTER)
        
        main_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        self.add(main_box)
        
        header = Gtk.Box(spacing=10)
        header.set_margin_top(20)
        header.set_margin_bottom(20)
        header.set_margin_start(20)
        header.set_margin_end(20)
        
        title = Gtk.Label()
        title.set_markup("<span size='xx-large' weight='bold'>Upgrade to Premium</span>")
        header.pack_start(title, True, True, 0)
        main_box.pack_start(header, False, False, 0)
        
        trial_status = get_trial_status()
        if not trial_status["started"]:
            trial_box = Gtk.Box(spacing=10)
            trial_box.set_margin_start(20)
            trial_box.set_margin_end(20)
            trial_box.set_margin_bottom(20)
            trial_label = Gtk.Label(label="Try premium features free for 30 days!")
            trial_box.pack_start(trial_label, True, True, 0)
            trial_btn = Gtk.Button(label="Start Free Trial")
            trial_btn.connect("clicked", self.on_start_trial)
            trial_box.pack_end(trial_btn, False, False, 0)
            main_box.pack_start(trial_box, False, False, 0)
        elif trial_status["active"]:
            trial_info = Gtk.Label()
            trial_info.set_markup(f"<span color='green'>Trial Active: {trial_status['days_left']} days remaining</span>")
            trial_info.set_margin_bottom(15)
            main_box.pack_start(trial_info, False, False, 0)
        
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        
        editions_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=15)
        editions_box.set_margin_start(20)
        editions_box.set_margin_end(20)
        editions_box.set_margin_bottom(20)
        
        for ed_id, ed_info in EDITIONS.items():
            frame = Gtk.Frame()
            frame.set_shadow_type(Gtk.ShadowType.OUT)
            
            ed_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=8)
            ed_box.set_margin_top(12)
            ed_box.set_margin_bottom(12)
            ed_box.set_margin_start(12)
            ed_box.set_margin_end(12)
            
            header_box = Gtk.Box(spacing=10)
            name_label = Gtk.Label()
            name_label.set_markup(f"<span weight='bold' color='{ed_info['color']}'>{ed_info['name']}</span>")
            header_box.pack_start(name_label, False, False, 0)
            price_label = Gtk.Label()
            price_label.set_markup(f"<span weight='bold'>{ed_info['price']}</span> lifetime")
            header_box.pack_end(price_label, False, False, 0)
            ed_box.pack_start(header_box, False, False, 0)
            
            features_text = "\n".join([f"  • {f}" for f in ed_info['features'][:4]])
            if len(ed_info['features']) > 4:
                features_text += f"\n  + {len(ed_info['features']) - 4} more..."
            features_label = Gtk.Label(label=features_text)
            features_label.set_xalign(0)
            ed_box.pack_start(features_label, False, False, 0)
            
            buy_btn = Gtk.Button(label=f"Get {ed_info['name']}")
            buy_btn.connect("clicked", lambda w, e=ed_id: self.on_purchase(e))
            ed_box.pack_start(buy_btn, False, False, 5)
            
            frame.add(ed_box)
            editions_box.pack_start(frame, False, False, 0)
        
        scroll.add(editions_box)
        main_box.pack_start(scroll, True, True, 0)
    
    def on_start_trial(self, widget):
        start_trial()
        dialog = Gtk.MessageDialog(
            transient_for=self,
            flags=0,
            message_type=Gtk.MessageType.INFO,
            buttons=Gtk.ButtonsType.OK,
            text="Trial Started!"
        )
        dialog.format_secondary_text("Your 30-day premium trial is now active. Enjoy!")
        dialog.run()
        dialog.destroy()
        self.destroy()
        Gtk.main_quit()
    
    def on_purchase(self, edition):
        open_purchase(edition)

def main():
    parser = argparse.ArgumentParser(description='Aegis OS Upgrade Prompt')
    parser.add_argument('--gui', action='store_true', help='Launch GUI')
    parser.add_argument('--trial', action='store_true', help='Start 30-day trial')
    parser.add_argument('--status', action='store_true', help='Show trial status')
    parser.add_argument('--purchase', metavar='EDITION', help='Open purchase page')
    parser.add_argument('--list', action='store_true', help='List editions')
    
    args = parser.parse_args()
    
    if args.trial:
        start_trial()
    elif args.status:
        status = get_trial_status()
        if status["started"]:
            if status["active"]:
                print(f"Trial active: {status['days_left']} days remaining")
            else:
                print("Trial expired")
        else:
            print("Trial not started (30 days available)")
    elif args.purchase:
        open_purchase(args.purchase)
    elif args.list:
        print("Available Editions:\n")
        for ed_id, ed_info in EDITIONS.items():
            print(f"  {ed_id}: {ed_info['name']} - {ed_info['price']}")
    elif args.gui or not any([args.trial, args.status, args.purchase, args.list]):
        if GTK_AVAILABLE:
            win = UpgradeWindow()
            win.connect("destroy", Gtk.main_quit)
            win.show_all()
            Gtk.main()
        else:
            print("Aegis OS Upgrade Options:\n")
            for ed_id, ed_info in EDITIONS.items():
                print(f"{ed_info['name']} ({ed_info['price']}):")
                for f in ed_info['features'][:3]:
                    print(f"  • {f}")
                print()
            print(f"Visit {PURCHASE_URL} to upgrade")

if __name__ == "__main__":
    main()
