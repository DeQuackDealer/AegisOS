#!/bin/bash
# Aegis Mode Switch - Toggle between Desktop and Game Mode
# Usage: aegis-mode-switch [desktop|game]

set -e

MODE="${1:-toggle}"
CONFIG_FILE="${HOME}/.config/aegis/game-mode.json"
CURRENT_MODE_FILE="${HOME}/.config/aegis/current-mode"

mkdir -p "${HOME}/.config/aegis"

get_current_mode() {
    if [ -f "$CURRENT_MODE_FILE" ]; then
        cat "$CURRENT_MODE_FILE"
    else
        echo "desktop"
    fi
}

set_mode() {
    local new_mode="$1"
    echo "$new_mode" > "$CURRENT_MODE_FILE"
}

switch_to_desktop() {
    echo "Switching to Desktop Mode..."
    set_mode "desktop"
    
    pkill -f aegis-game-hub 2>/dev/null || true
    pkill -f gamescope 2>/dev/null || true
    
    if command -v systemctl &> /dev/null; then
        systemctl --user stop aegis-game-mode.target 2>/dev/null || true
    fi
    
    if [ -n "$DISPLAY" ]; then
        notify-send -i computer "Aegis OS" "Switched to Desktop Mode" 2>/dev/null || true
    fi
    
    if ! pgrep -x xfce4-session &>/dev/null && ! pgrep -x xfwm4 &>/dev/null; then
        if command -v startxfce4 &>/dev/null; then
            exec startxfce4
        fi
    fi
}

switch_to_game_mode() {
    echo "Switching to Game Mode..."
    set_mode "game"
    
    if [ -n "$DISPLAY" ]; then
        notify-send -i applications-games "Aegis OS" "Launching Game Mode..." 2>/dev/null || true
    fi
    
    # Try systemd user service first
    if command -v systemctl &> /dev/null; then
        systemctl --user enable aegis-game-hub.service 2>/dev/null || true
        systemctl --user start aegis-game-mode.target 2>/dev/null && exit 0
    fi
    
    # Fallback to direct launch
    if command -v gamescope &> /dev/null; then
        exec gamescope -f -W 1920 -H 1080 -- /usr/local/bin/aegis-game-hub
    else
        exec /usr/local/bin/aegis-game-hub
    fi
}

show_switcher_gui() {
    if ! command -v zenity &> /dev/null; then
        echo "Zenity not installed. Usage: aegis-mode-switch [desktop|game]"
        exit 1
    fi
    
    current=$(get_current_mode)
    
    choice=$(zenity --list \
        --title="Aegis Mode Switch" \
        --text="Current mode: ${current^}\nSelect mode to switch to:" \
        --radiolist \
        --column="Select" \
        --column="Mode" \
        --column="Description" \
        FALSE "desktop" "Desktop Mode - Full XFCE desktop environment" \
        FALSE "game" "Game Mode - Full-screen game library (Big Picture style)" \
        --width=500 \
        --height=250 \
        2>/dev/null) || exit 0
    
    case "$choice" in
        desktop)
            switch_to_desktop
            ;;
        game)
            switch_to_game_mode
            ;;
    esac
}

case "$MODE" in
    desktop)
        switch_to_desktop
        ;;
    game)
        switch_to_game_mode
        ;;
    toggle)
        current=$(get_current_mode)
        if [ "$current" = "desktop" ]; then
            switch_to_game_mode
        else
            switch_to_desktop
        fi
        ;;
    gui)
        show_switcher_gui
        ;;
    status)
        echo "Current mode: $(get_current_mode)"
        ;;
    *)
        echo "Aegis Mode Switch"
        echo "Usage: aegis-mode-switch [desktop|game|toggle|gui|status]"
        echo ""
        echo "Modes:"
        echo "  desktop  - Switch to Desktop Mode (XFCE)"
        echo "  game     - Switch to Game Mode (full-screen launcher)"
        echo "  toggle   - Toggle between modes"
        echo "  gui      - Show graphical mode selector"
        echo "  status   - Show current mode"
        exit 1
        ;;
esac
