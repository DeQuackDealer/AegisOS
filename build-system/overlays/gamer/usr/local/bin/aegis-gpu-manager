#!/usr/bin/env python3
"""
Aegis GPU Manager - Multi-GPU and driver management
"""

import gi
gi.require_version('Gtk', '3.0')
from gi.repository import Gtk, GLib
import os
import subprocess
import json
from pathlib import Path
from typing import Dict, List, Optional

class GPUInfo:
    def __init__(self):
        self.vendor = "Unknown"
        self.model = "Unknown"
        self.driver = "Unknown"
        self.vram = "Unknown"
        self.temp = 0
        self.usage = 0
        self.power = 0
        self.clock_core = 0
        self.clock_mem = 0
        self.pci_id = ""

class AegisGPUManager(Gtk.Window):
    CSS = """
    window { background: #1a1a2e; }
    .header { background: rgba(0,0,0,0.6); padding: 20px; }
    .title { color: #76b900; font-size: 28px; font-weight: bold; }
    .card { background: rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; margin: 10px; }
    .card-title { color: #fff; font-size: 18px; font-weight: bold; }
    .gpu-card { background: linear-gradient(135deg, rgba(118,185,0,0.2), rgba(0,0,0,0.3));
                border: 2px solid rgba(118,185,0,0.4); border-radius: 12px; padding: 20px; margin: 10px; }
    .gpu-card.amd { background: linear-gradient(135deg, rgba(237,28,36,0.2), rgba(0,0,0,0.3));
                    border-color: rgba(237,28,36,0.4); }
    .gpu-card.intel { background: linear-gradient(135deg, rgba(0,113,197,0.2), rgba(0,0,0,0.3));
                      border-color: rgba(0,113,197,0.4); }
    .gpu-name { color: #fff; font-size: 20px; font-weight: bold; }
    .gpu-vendor { color: #76b900; font-size: 14px; }
    .gpu-vendor.amd { color: #ed1c24; }
    .gpu-vendor.intel { color: #0071c5; }
    .stat-box { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; margin: 4px; }
    .stat-value { color: #fff; font-size: 24px; font-weight: bold; }
    .stat-label { color: #888; font-size: 11px; }
    .meter-bg { background: rgba(255,255,255,0.1); border-radius: 4px; }
    .meter-fill { background: linear-gradient(90deg, #76b900, #00ff00); border-radius: 4px; }
    .meter-fill.hot { background: linear-gradient(90deg, #ff6600, #ff0000); }
    .profile-btn { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px 20px; 
                   color: #fff; margin: 4px; }
    .profile-btn:hover { background: rgba(118,185,0,0.3); }
    .profile-btn:checked { background: rgba(118,185,0,0.5); border: 1px solid #76b900; }
    .info-label { color: #888; font-size: 13px; }
    .apply-btn { background: #76b900; color: #fff; font-weight: bold; padding: 12px 32px; border-radius: 8px; }
    """
    
    def __init__(self):
        super().__init__(title="Aegis GPU Manager")
        self.set_default_size(950, 750)
        self.gpus: List[GPUInfo] = []
        self.selected_gpu = 0
        
        css = Gtk.CssProvider()
        css.load_from_data(self.CSS.encode())
        Gtk.StyleContext.add_provider_for_screen(self.get_screen(), css, Gtk.STYLE_PROVIDER_PRIORITY_APPLICATION)
        
        self._detect_gpus()
        self._create_ui()
        self._start_monitoring()
    
    def _detect_gpus(self):
        try:
            result = subprocess.run(["lspci", "-v"], capture_output=True, text=True)
            for line in result.stdout.split("\n"):
                if "VGA" in line or "3D" in line:
                    gpu = GPUInfo()
                    gpu.model = line.split(":")[-1].strip()[:60]
                    gpu.pci_id = line.split()[0]
                    
                    if "NVIDIA" in line.upper():
                        gpu.vendor = "NVIDIA"
                        self._get_nvidia_info(gpu)
                    elif "AMD" in line.upper() or "ATI" in line.upper():
                        gpu.vendor = "AMD"
                        self._get_amd_info(gpu)
                    elif "INTEL" in line.upper():
                        gpu.vendor = "Intel"
                        self._get_intel_info(gpu)
                    
                    self.gpus.append(gpu)
        except Exception as e:
            print(f"Error detecting GPUs: {e}")
    
    def _get_nvidia_info(self, gpu: GPUInfo):
        try:
            result = subprocess.run([
                "nvidia-smi", 
                "--query-gpu=driver_version,memory.total,temperature.gpu,utilization.gpu,power.draw,clocks.gr,clocks.mem",
                "--format=csv,noheader,nounits"
            ], capture_output=True, text=True)
            
            if result.returncode == 0:
                parts = [p.strip() for p in result.stdout.strip().split(",")]
                if len(parts) >= 7:
                    gpu.driver = parts[0]
                    gpu.vram = f"{parts[1]} MB"
                    gpu.temp = int(float(parts[2])) if parts[2] != "[N/A]" else 0
                    gpu.usage = int(float(parts[3])) if parts[3] != "[N/A]" else 0
                    gpu.power = int(float(parts[4])) if parts[4] != "[N/A]" else 0
                    gpu.clock_core = int(float(parts[5])) if parts[5] != "[N/A]" else 0
                    gpu.clock_mem = int(float(parts[6])) if parts[6] != "[N/A]" else 0
        except: pass
    
    def _get_amd_info(self, gpu: GPUInfo):
        try:
            hwmon_path = Path("/sys/class/drm/card0/device/hwmon")
            if hwmon_path.exists():
                for hwmon in hwmon_path.iterdir():
                    temp_file = hwmon / "temp1_input"
                    if temp_file.exists():
                        with open(temp_file) as f:
                            gpu.temp = int(f.read().strip()) // 1000
                    break
            
            gpu.driver = "amdgpu"
        except: pass
    
    def _get_intel_info(self, gpu: GPUInfo):
        gpu.driver = "i915"
    
    def _create_ui(self):
        main = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        self.add(main)
        
        header = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        header.get_style_context().add_class("header")
        
        title = Gtk.Label(label="Aegis GPU Manager")
        title.get_style_context().add_class("title")
        title.set_halign(Gtk.Align.START)
        header.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label(label=f"Detected {len(self.gpus)} GPU(s)")
        subtitle.get_style_context().add_class("info-label")
        subtitle.set_halign(Gtk.Align.START)
        header.pack_start(subtitle, False, False, 4)
        
        main.pack_start(header, False, False, 0)
        
        scroll = Gtk.ScrolledWindow()
        main.pack_start(scroll, True, True, 0)
        
        content = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        content.set_margin_start(20); content.set_margin_end(20)
        content.set_margin_top(20); content.set_margin_bottom(20)
        scroll.add(content)
        
        for i, gpu in enumerate(self.gpus):
            content.pack_start(self._create_gpu_card(i, gpu), False, False, 0)
        
        if not self.gpus:
            no_gpu = Gtk.Label(label="No GPUs detected")
            no_gpu.get_style_context().add_class("info-label")
            content.pack_start(no_gpu, True, True, 0)
        else:
            content.pack_start(self._create_profiles_card(), False, False, 0)
            content.pack_start(self._create_tools_card(), False, False, 0)
    
    def _create_gpu_card(self, index: int, gpu: GPUInfo) -> Gtk.Box:
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
        card.get_style_context().add_class("gpu-card")
        
        if gpu.vendor == "AMD":
            card.get_style_context().add_class("amd")
        elif gpu.vendor == "Intel":
            card.get_style_context().add_class("intel")
        
        header = Gtk.Box(spacing=12)
        
        info_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        
        name = Gtk.Label(label=gpu.model)
        name.get_style_context().add_class("gpu-name")
        name.set_halign(Gtk.Align.START)
        name.set_ellipsize(True)
        info_box.pack_start(name, False, False, 0)
        
        vendor = Gtk.Label(label=f"{gpu.vendor} | Driver: {gpu.driver} | VRAM: {gpu.vram}")
        vendor.get_style_context().add_class("gpu-vendor")
        if gpu.vendor == "AMD": vendor.get_style_context().add_class("amd")
        elif gpu.vendor == "Intel": vendor.get_style_context().add_class("intel")
        vendor.set_halign(Gtk.Align.START)
        info_box.pack_start(vendor, False, False, 4)
        
        header.pack_start(info_box, True, True, 0)
        card.pack_start(header, False, False, 0)
        
        stats_box = Gtk.Box(spacing=8)
        stats_box.set_halign(Gtk.Align.START)
        
        self.stat_widgets = {}
        
        temp_stat = self._create_stat_box("Temperature", f"{gpu.temp}Â°C", gpu.temp, 100)
        stats_box.pack_start(temp_stat, False, False, 0)
        self.stat_widgets[f"temp_{index}"] = temp_stat
        
        usage_stat = self._create_stat_box("GPU Usage", f"{gpu.usage}%", gpu.usage, 100)
        stats_box.pack_start(usage_stat, False, False, 0)
        self.stat_widgets[f"usage_{index}"] = usage_stat
        
        power_stat = self._create_stat_box("Power", f"{gpu.power}W", 0, 100)
        stats_box.pack_start(power_stat, False, False, 0)
        
        core_stat = self._create_stat_box("Core Clock", f"{gpu.clock_core} MHz", 0, 100)
        stats_box.pack_start(core_stat, False, False, 0)
        
        mem_stat = self._create_stat_box("Mem Clock", f"{gpu.clock_mem} MHz", 0, 100)
        stats_box.pack_start(mem_stat, False, False, 0)
        
        card.pack_start(stats_box, False, False, 0)
        
        return card
    
    def _create_stat_box(self, label: str, value: str, current: int, max_val: int) -> Gtk.Box:
        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=4)
        box.get_style_context().add_class("stat-box")
        box.set_size_request(100, -1)
        
        val_lbl = Gtk.Label(label=value)
        val_lbl.get_style_context().add_class("stat-value")
        box.pack_start(val_lbl, False, False, 0)
        box.value_label = val_lbl
        
        if max_val > 0 and current > 0:
            meter_bg = Gtk.Box()
            meter_bg.get_style_context().add_class("meter-bg")
            meter_bg.set_size_request(80, 6)
            
            meter_fill = Gtk.Box()
            meter_fill.get_style_context().add_class("meter-fill")
            if current > 80:
                meter_fill.get_style_context().add_class("hot")
            meter_fill.set_size_request(int(80 * current / max_val), 6)
            meter_bg.pack_start(meter_fill, False, False, 0)
            box.pack_start(meter_bg, False, False, 0)
            box.meter_fill = meter_fill
        
        name_lbl = Gtk.Label(label=label)
        name_lbl.get_style_context().add_class("stat-label")
        box.pack_start(name_lbl, False, False, 0)
        
        return box
    
    def _create_profiles_card(self) -> Gtk.Box:
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        card.get_style_context().add_class("card")
        
        title = Gtk.Label(label="Power Profiles")
        title.get_style_context().add_class("card-title")
        title.set_halign(Gtk.Align.START)
        card.pack_start(title, False, False, 8)
        
        profiles_box = Gtk.Box(spacing=8)
        
        profiles = [
            ("Maximum Performance", "Max clocks, full power"),
            ("Balanced", "Automatic power management"),
            ("Power Saving", "Reduced clocks, lower temps"),
            ("Quiet", "Fan curve optimized for silence"),
        ]
        
        self.profile_btns = {}
        for name, desc in profiles:
            btn = Gtk.ToggleButton(label=name)
            btn.get_style_context().add_class("profile-btn")
            btn.set_tooltip_text(desc)
            btn.connect("toggled", self._on_profile_select, name)
            self.profile_btns[name] = btn
            profiles_box.pack_start(btn, False, False, 0)
        
        self.profile_btns["Balanced"].set_active(True)
        
        card.pack_start(profiles_box, False, False, 8)
        
        return card
    
    def _create_tools_card(self) -> Gtk.Box:
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        card.get_style_context().add_class("card")
        
        title = Gtk.Label(label="GPU Tools")
        title.get_style_context().add_class("card-title")
        title.set_halign(Gtk.Align.START)
        card.pack_start(title, False, False, 8)
        
        tools_box = Gtk.Box(spacing=8)
        
        tools = [
            ("nvidia-settings", "NVIDIA Settings", self._launch_nvidia_settings),
            ("amdgpu_top", "AMD GPU Top", self._launch_amd_top),
            ("nvtop", "GPU Monitor", self._launch_nvtop),
            ("glxinfo", "OpenGL Info", self._show_glxinfo),
            ("vulkaninfo", "Vulkan Info", self._show_vulkaninfo),
        ]
        
        for cmd, name, callback in tools:
            btn = Gtk.Button(label=name)
            btn.get_style_context().add_class("profile-btn")
            btn.connect("clicked", callback)
            tools_box.pack_start(btn, False, False, 0)
        
        card.pack_start(tools_box, False, False, 8)
        
        return card
    
    def _on_profile_select(self, btn, profile_name):
        if btn.get_active():
            for name, b in self.profile_btns.items():
                if name != profile_name:
                    b.set_active(False)
    
    def _launch_nvidia_settings(self, btn):
        try:
            subprocess.Popen(["nvidia-settings"], start_new_session=True)
        except:
            self._show_error("nvidia-settings not found")
    
    def _launch_amd_top(self, btn):
        try:
            subprocess.Popen(["xterm", "-e", "amdgpu_top"], start_new_session=True)
        except:
            self._show_error("amdgpu_top not found")
    
    def _launch_nvtop(self, btn):
        try:
            subprocess.Popen(["xterm", "-e", "nvtop"], start_new_session=True)
        except:
            self._show_error("nvtop not found. Install with: sudo apt install nvtop")
    
    def _show_glxinfo(self, btn):
        try:
            result = subprocess.run(["glxinfo", "-B"], capture_output=True, text=True)
            self._show_info_dialog("OpenGL Info", result.stdout)
        except:
            self._show_error("glxinfo not found")
    
    def _show_vulkaninfo(self, btn):
        try:
            result = subprocess.run(["vulkaninfo", "--summary"], capture_output=True, text=True)
            self._show_info_dialog("Vulkan Info", result.stdout)
        except:
            self._show_error("vulkaninfo not found")
    
    def _show_error(self, message):
        dialog = Gtk.MessageDialog(transient_for=self, message_type=Gtk.MessageType.ERROR,
                                   buttons=Gtk.ButtonsType.OK, text="Error")
        dialog.format_secondary_text(message)
        dialog.run(); dialog.destroy()
    
    def _show_info_dialog(self, title, content):
        dialog = Gtk.Dialog(title=title, transient_for=self, flags=0)
        dialog.add_buttons(Gtk.STOCK_CLOSE, Gtk.ResponseType.CLOSE)
        dialog.set_default_size(600, 400)
        
        scroll = Gtk.ScrolledWindow()
        text = Gtk.TextView()
        text.get_buffer().set_text(content)
        text.set_editable(False)
        text.set_monospace(True)
        scroll.add(text)
        
        dialog.get_content_area().pack_start(scroll, True, True, 0)
        dialog.show_all()
        dialog.run()
        dialog.destroy()
    
    def _start_monitoring(self):
        def update():
            for i, gpu in enumerate(self.gpus):
                if gpu.vendor == "NVIDIA":
                    self._get_nvidia_info(gpu)
            return True
        GLib.timeout_add_seconds(2, update)

def main():
    win = AegisGPUManager()
    win.connect("destroy", Gtk.main_quit)
    win.show_all()
    Gtk.main()

if __name__ == "__main__":
    main()
