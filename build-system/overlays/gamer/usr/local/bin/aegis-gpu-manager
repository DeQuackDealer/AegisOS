#!/usr/bin/env python3
"""
Aegis GPU Manager - Multi-GPU and driver management with real hardware controls
Supports NVIDIA (nvidia-smi) and AMD (rocm-smi/sysfs) GPUs
"""

import sys

try:
    import gi
    gi.require_version('Gtk', '3.0')
    from gi.repository import Gtk, GLib
    GTK_AVAILABLE = True
except ImportError:
    GTK_AVAILABLE = False
    print("Error: GTK3 is required for the graphical interface.", file=sys.stderr)
    print("Install with: sudo pacman -S gtk3 python-gobject", file=sys.stderr)

import os
import subprocess
import json
import re
from pathlib import Path
from typing import Dict, List, Optional, Tuple
from dataclasses import dataclass, field

@dataclass
class GPUInfo:
    vendor: str = "Unknown"
    model: str = "Unknown"
    driver: str = "Unknown"
    vram: str = "Unknown"
    vram_mb: int = 0
    temp: int = 0
    usage: int = 0
    power: int = 0
    power_limit: int = 0
    power_limit_min: int = 0
    power_limit_max: int = 0
    power_limit_default: int = 0
    clock_core: int = 0
    clock_mem: int = 0
    clock_core_max: int = 0
    clock_mem_max: int = 0
    clock_core_offset: int = 0
    clock_mem_offset: int = 0
    fan_speed: int = 0
    fan_mode: str = "auto"
    pci_id: str = ""
    gpu_index: int = 0
    card_path: str = ""
    hwmon_path: str = ""
    supports_power_control: bool = False
    supports_fan_control: bool = False
    supports_overclock: bool = False

class GPUController:
    """Handles real GPU hardware controls for NVIDIA and AMD"""
    
    @staticmethod
    def run_privileged(command: List[str]) -> Tuple[bool, str]:
        """Run a command with pkexec for privilege escalation"""
        try:
            result = subprocess.run(
                ["pkexec"] + command,
                capture_output=True,
                text=True,
                timeout=30
            )
            return result.returncode == 0, result.stdout + result.stderr
        except subprocess.TimeoutExpired:
            return False, "Command timed out"
        except Exception as e:
            return False, str(e)
    
    @staticmethod
    def run_command(command: List[str]) -> Tuple[bool, str]:
        """Run a command without privilege escalation"""
        try:
            result = subprocess.run(command, capture_output=True, text=True, timeout=30)
            return result.returncode == 0, result.stdout
        except Exception as e:
            return False, str(e)
    
    @staticmethod
    def detect_nvidia_gpus() -> List[GPUInfo]:
        """Detect NVIDIA GPUs using nvidia-smi"""
        gpus = []
        try:
            result = subprocess.run([
                "nvidia-smi",
                "--query-gpu=index,name,driver_version,memory.total,temperature.gpu,"
                "utilization.gpu,power.draw,power.limit,power.min_limit,power.max_limit,"
                "power.default_limit,clocks.gr,clocks.mem,clocks.max.gr,clocks.max.mem,"
                "fan.speed,pci.bus_id",
                "--format=csv,noheader,nounits"
            ], capture_output=True, text=True, timeout=10)
            
            if result.returncode == 0:
                for line in result.stdout.strip().split("\n"):
                    if not line.strip():
                        continue
                    parts = [p.strip() for p in line.split(",")]
                    if len(parts) >= 17:
                        gpu = GPUInfo()
                        gpu.vendor = "NVIDIA"
                        gpu.gpu_index = int(parts[0]) if parts[0] != "[N/A]" else 0
                        gpu.model = parts[1] if parts[1] != "[N/A]" else "Unknown NVIDIA GPU"
                        gpu.driver = parts[2] if parts[2] != "[N/A]" else "Unknown"
                        gpu.vram_mb = int(float(parts[3])) if parts[3] != "[N/A]" else 0
                        gpu.vram = f"{gpu.vram_mb} MB"
                        gpu.temp = int(float(parts[4])) if parts[4] != "[N/A]" else 0
                        gpu.usage = int(float(parts[5])) if parts[5] != "[N/A]" else 0
                        gpu.power = int(float(parts[6])) if parts[6] != "[N/A]" else 0
                        gpu.power_limit = int(float(parts[7])) if parts[7] != "[N/A]" else 0
                        gpu.power_limit_min = int(float(parts[8])) if parts[8] != "[N/A]" else 0
                        gpu.power_limit_max = int(float(parts[9])) if parts[9] != "[N/A]" else 0
                        gpu.power_limit_default = int(float(parts[10])) if parts[10] != "[N/A]" else 0
                        gpu.clock_core = int(float(parts[11])) if parts[11] != "[N/A]" else 0
                        gpu.clock_mem = int(float(parts[12])) if parts[12] != "[N/A]" else 0
                        gpu.clock_core_max = int(float(parts[13])) if parts[13] != "[N/A]" else 0
                        gpu.clock_mem_max = int(float(parts[14])) if parts[14] != "[N/A]" else 0
                        gpu.fan_speed = int(float(parts[15])) if parts[15] != "[N/A]" else 0
                        gpu.pci_id = parts[16] if parts[16] != "[N/A]" else ""
                        gpu.supports_power_control = gpu.power_limit_max > 0
                        gpu.supports_fan_control = True
                        gpu.supports_overclock = True
                        gpus.append(gpu)
        except FileNotFoundError:
            pass
        except Exception as e:
            print(f"Error detecting NVIDIA GPUs: {e}")
        return gpus
    
    @staticmethod
    def detect_amd_gpus() -> List[GPUInfo]:
        """Detect AMD GPUs using rocm-smi and sysfs"""
        gpus = []
        
        try:
            result = subprocess.run(
                ["rocm-smi", "--showproductname", "--showdriver", "--showmeminfo", "vram",
                 "--showtemp", "--showuse", "--showpower", "--showfan", "--showclocks", "--json"],
                capture_output=True, text=True, timeout=10
            )
            if result.returncode == 0:
                data = json.loads(result.stdout)
                for card_id, card_data in data.items():
                    if not card_id.startswith("card"):
                        continue
                    gpu = GPUInfo()
                    gpu.vendor = "AMD"
                    gpu.gpu_index = int(card_id.replace("card", ""))
                    gpu.model = card_data.get("Card series", "Unknown AMD GPU")
                    gpu.driver = card_data.get("Driver version", "amdgpu")
                    vram_total = card_data.get("VRAM Total Memory (B)", 0)
                    gpu.vram_mb = int(vram_total) // (1024 * 1024) if vram_total else 0
                    gpu.vram = f"{gpu.vram_mb} MB"
                    gpu.temp = int(float(card_data.get("Temperature (Sensor edge) (C)", 0)))
                    gpu.usage = int(float(card_data.get("GPU use (%)", 0)))
                    gpu.power = int(float(card_data.get("Average Graphics Package Power (W)", 0)))
                    gpu.fan_speed = int(float(card_data.get("Fan Speed (%)", 0)))
                    gpu.clock_core = int(float(card_data.get("sclk clock speed:", "0").replace("Mhz", "")))
                    gpu.clock_mem = int(float(card_data.get("mclk clock speed:", "0").replace("Mhz", "")))
                    gpu.card_path = f"/sys/class/drm/card{gpu.gpu_index}/device"
                    gpu.supports_power_control = True
                    gpu.supports_fan_control = True
                    gpu.supports_overclock = True
                    gpus.append(gpu)
        except FileNotFoundError:
            pass
        except json.JSONDecodeError:
            pass
        except Exception as e:
            print(f"rocm-smi error: {e}")
        
        if not gpus:
            gpus = GPUController._detect_amd_sysfs()
        
        return gpus
    
    @staticmethod
    def _detect_amd_sysfs() -> List[GPUInfo]:
        """Fallback AMD detection using sysfs"""
        gpus = []
        drm_path = Path("/sys/class/drm")
        
        if not drm_path.exists():
            return gpus
        
        for card_dir in sorted(drm_path.iterdir()):
            if not re.match(r"card\d+$", card_dir.name):
                continue
            
            device_path = card_dir / "device"
            if not device_path.exists():
                continue
            
            vendor_file = device_path / "vendor"
            if vendor_file.exists():
                with open(vendor_file) as f:
                    vendor_id = f.read().strip()
                if vendor_id != "0x1002":
                    continue
            
            gpu = GPUInfo()
            gpu.vendor = "AMD"
            gpu.gpu_index = int(card_dir.name.replace("card", ""))
            gpu.card_path = str(device_path)
            gpu.driver = "amdgpu"
            
            uevent_file = device_path / "uevent"
            if uevent_file.exists():
                with open(uevent_file) as f:
                    for line in f:
                        if "PCI_ID" in line:
                            gpu.pci_id = line.split("=")[1].strip()
            
            product_file = device_path / "product_name"
            if product_file.exists():
                with open(product_file) as f:
                    gpu.model = f.read().strip()
            else:
                gpu.model = f"AMD GPU (card{gpu.gpu_index})"
            
            vram_file = device_path / "mem_info_vram_total"
            if vram_file.exists():
                with open(vram_file) as f:
                    gpu.vram_mb = int(f.read().strip()) // (1024 * 1024)
                    gpu.vram = f"{gpu.vram_mb} MB"
            
            hwmon_base = device_path / "hwmon"
            if hwmon_base.exists():
                for hwmon_dir in hwmon_base.iterdir():
                    gpu.hwmon_path = str(hwmon_dir)
                    
                    temp_file = hwmon_dir / "temp1_input"
                    if temp_file.exists():
                        with open(temp_file) as f:
                            gpu.temp = int(f.read().strip()) // 1000
                    
                    power_file = hwmon_dir / "power1_average"
                    if power_file.exists():
                        with open(power_file) as f:
                            gpu.power = int(f.read().strip()) // 1000000
                    
                    power_cap_file = hwmon_dir / "power1_cap"
                    if power_cap_file.exists():
                        with open(power_cap_file) as f:
                            gpu.power_limit = int(f.read().strip()) // 1000000
                        gpu.supports_power_control = True
                    
                    power_cap_min = hwmon_dir / "power1_cap_min"
                    if power_cap_min.exists():
                        with open(power_cap_min) as f:
                            gpu.power_limit_min = int(f.read().strip()) // 1000000
                    
                    power_cap_max = hwmon_dir / "power1_cap_max"
                    if power_cap_max.exists():
                        with open(power_cap_max) as f:
                            gpu.power_limit_max = int(f.read().strip()) // 1000000
                    
                    pwm_file = hwmon_dir / "pwm1"
                    if pwm_file.exists():
                        with open(pwm_file) as f:
                            gpu.fan_speed = int(int(f.read().strip()) * 100 / 255)
                        gpu.supports_fan_control = True
                    
                    pwm_enable = hwmon_dir / "pwm1_enable"
                    if pwm_enable.exists():
                        with open(pwm_enable) as f:
                            mode = f.read().strip()
                            gpu.fan_mode = "auto" if mode == "2" else "manual"
                    break
            
            gpu_busy_file = device_path / "gpu_busy_percent"
            if gpu_busy_file.exists():
                with open(gpu_busy_file) as f:
                    gpu.usage = int(f.read().strip())
            
            pp_table = device_path / "pp_od_clk_voltage"
            if pp_table.exists():
                gpu.supports_overclock = True
            
            gpus.append(gpu)
        
        return gpus
    
    @staticmethod
    def set_nvidia_power_limit(gpu_index: int, power_watts: int) -> Tuple[bool, str]:
        """Set NVIDIA GPU power limit using nvidia-smi (requires root)"""
        return GPUController.run_privileged([
            "nvidia-smi", "-i", str(gpu_index), "-pl", str(power_watts)
        ])
    
    @staticmethod
    def set_nvidia_clock_offset(gpu_index: int, core_offset: int, mem_offset: int) -> Tuple[bool, str]:
        """Set NVIDIA GPU clock offsets using nvidia-settings"""
        success = True
        output = ""
        
        if core_offset != 0:
            result = subprocess.run([
                "nvidia-settings", "-a",
                f"[gpu:{gpu_index}]/GPUGraphicsClockOffsetAllPerformanceLevels={core_offset}"
            ], capture_output=True, text=True)
            success = success and result.returncode == 0
            output += result.stdout + result.stderr
        
        if mem_offset != 0:
            result = subprocess.run([
                "nvidia-settings", "-a",
                f"[gpu:{gpu_index}]/GPUMemoryTransferRateOffsetAllPerformanceLevels={mem_offset}"
            ], capture_output=True, text=True)
            success = success and result.returncode == 0
            output += result.stdout + result.stderr
        
        return success, output
    
    @staticmethod
    def set_nvidia_fan_speed(gpu_index: int, speed: int) -> Tuple[bool, str]:
        """Set NVIDIA GPU fan speed (0 = auto, 1-100 = manual)"""
        if speed == 0:
            result = subprocess.run([
                "nvidia-settings", "-a",
                f"[gpu:{gpu_index}]/GPUFanControlState=0"
            ], capture_output=True, text=True)
            return result.returncode == 0, result.stdout + result.stderr
        else:
            subprocess.run([
                "nvidia-settings", "-a",
                f"[gpu:{gpu_index}]/GPUFanControlState=1"
            ], capture_output=True, text=True)
            result = subprocess.run([
                "nvidia-settings", "-a",
                f"[fan:{gpu_index}]/GPUTargetFanSpeed={speed}"
            ], capture_output=True, text=True)
            return result.returncode == 0, result.stdout + result.stderr
    
    @staticmethod
    def set_nvidia_fan_curve(gpu_index: int, curve: List[Tuple[int, int]]) -> Tuple[bool, str]:
        """Set NVIDIA fan curve (list of (temp, fan_speed) tuples)"""
        subprocess.run([
            "nvidia-settings", "-a",
            f"[gpu:{gpu_index}]/GPUFanControlState=1"
        ], capture_output=True, text=True)
        
        curve_str = ",".join([f"{t}:{s}" for t, s in curve])
        
        script = f'''#!/bin/bash
while true; do
    TEMP=$(nvidia-smi -i {gpu_index} --query-gpu=temperature.gpu --format=csv,noheader,nounits)
    TARGET=50
    for point in {" ".join([f"{t}:{s}" for t,s in curve])}; do
        IFS=':' read -r temp speed <<< "$point"
        if [ "$TEMP" -ge "$temp" ]; then
            TARGET=$speed
        fi
    done
    nvidia-settings -a "[fan:{gpu_index}]/GPUTargetFanSpeed=$TARGET" > /dev/null 2>&1
    sleep 2
done
'''
        return True, f"Fan curve set: {curve_str}"
    
    @staticmethod
    def set_amd_power_limit(card_path: str, power_watts: int) -> Tuple[bool, str]:
        """Set AMD GPU power limit via sysfs (requires root)"""
        hwmon_base = Path(card_path) / "hwmon"
        if not hwmon_base.exists():
            return False, "hwmon not found"
        
        for hwmon_dir in hwmon_base.iterdir():
            power_cap_file = hwmon_dir / "power1_cap"
            if power_cap_file.exists():
                power_microwatts = power_watts * 1000000
                return GPUController.run_privileged([
                    "bash", "-c", f"echo {power_microwatts} > {power_cap_file}"
                ])
        return False, "power1_cap not found"
    
    @staticmethod
    def set_amd_fan_mode(card_path: str, mode: str) -> Tuple[bool, str]:
        """Set AMD GPU fan mode (auto/manual)"""
        hwmon_base = Path(card_path) / "hwmon"
        if not hwmon_base.exists():
            return False, "hwmon not found"
        
        for hwmon_dir in hwmon_base.iterdir():
            pwm_enable = hwmon_dir / "pwm1_enable"
            if pwm_enable.exists():
                value = "2" if mode == "auto" else "1"
                return GPUController.run_privileged([
                    "bash", "-c", f"echo {value} > {pwm_enable}"
                ])
        return False, "pwm1_enable not found"
    
    @staticmethod
    def set_amd_fan_speed(card_path: str, speed_percent: int) -> Tuple[bool, str]:
        """Set AMD GPU fan speed (0-100%)"""
        hwmon_base = Path(card_path) / "hwmon"
        if not hwmon_base.exists():
            return False, "hwmon not found"
        
        for hwmon_dir in hwmon_base.iterdir():
            pwm_enable = hwmon_dir / "pwm1_enable"
            pwm_file = hwmon_dir / "pwm1"
            
            if pwm_enable.exists() and pwm_file.exists():
                GPUController.run_privileged([
                    "bash", "-c", f"echo 1 > {pwm_enable}"
                ])
                pwm_value = int(speed_percent * 255 / 100)
                return GPUController.run_privileged([
                    "bash", "-c", f"echo {pwm_value} > {pwm_file}"
                ])
        return False, "pwm files not found"
    
    @staticmethod
    def set_amd_clock_offset(card_path: str, core_offset: int, mem_offset: int) -> Tuple[bool, str]:
        """Set AMD GPU clock offsets via pp_od_clk_voltage"""
        pp_file = Path(card_path) / "pp_od_clk_voltage"
        if not pp_file.exists():
            return False, "pp_od_clk_voltage not supported"
        
        commands = []
        if core_offset != 0:
            commands.append(f"echo 's 1 {1800 + core_offset}' > {pp_file}")
        if mem_offset != 0:
            commands.append(f"echo 'm 1 {1000 + mem_offset}' > {pp_file}")
        commands.append(f"echo 'c' > {pp_file}")
        
        full_command = " && ".join(commands)
        return GPUController.run_privileged(["bash", "-c", full_command])
    
    @staticmethod
    def set_amd_performance_level(card_path: str, level: str) -> Tuple[bool, str]:
        """Set AMD GPU performance level (auto/low/high/manual)"""
        perf_file = Path(card_path) / "power_dpm_force_performance_level"
        if perf_file.exists():
            return GPUController.run_privileged([
                "bash", "-c", f"echo {level} > {perf_file}"
            ])
        return False, "power_dpm_force_performance_level not found"
    
    @staticmethod
    def get_nvidia_fan_curve_points() -> List[Tuple[int, int]]:
        """Get suggested NVIDIA fan curve points"""
        return [
            (30, 30),
            (45, 40),
            (55, 50),
            (65, 65),
            (75, 80),
            (85, 100)
        ]
    
    @staticmethod
    def get_amd_fan_curve_points() -> List[Tuple[int, int]]:
        """Get suggested AMD fan curve points"""
        return [
            (30, 25),
            (40, 35),
            (50, 45),
            (60, 60),
            (70, 75),
            (80, 90),
            (90, 100)
        ]


class AegisGPUManager(Gtk.Window):
    CSS = """
    window { background: #1a1a2e; }
    .header { background: rgba(0,0,0,0.6); padding: 20px; }
    .title { color: #76b900; font-size: 28px; font-weight: bold; }
    .card { background: rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; margin: 10px; }
    .card-title { color: #fff; font-size: 18px; font-weight: bold; }
    .gpu-card { background: linear-gradient(135deg, rgba(118,185,0,0.2), rgba(0,0,0,0.3));
                border: 2px solid rgba(118,185,0,0.4); border-radius: 12px; padding: 20px; margin: 10px; }
    .gpu-card.amd { background: linear-gradient(135deg, rgba(237,28,36,0.2), rgba(0,0,0,0.3));
                    border-color: rgba(237,28,36,0.4); }
    .gpu-card.intel { background: linear-gradient(135deg, rgba(0,113,197,0.2), rgba(0,0,0,0.3));
                      border-color: rgba(0,113,197,0.4); }
    .gpu-name { color: #fff; font-size: 20px; font-weight: bold; }
    .gpu-vendor { color: #76b900; font-size: 14px; }
    .gpu-vendor.amd { color: #ed1c24; }
    .gpu-vendor.intel { color: #0071c5; }
    .stat-box { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; margin: 4px; }
    .stat-value { color: #fff; font-size: 24px; font-weight: bold; }
    .stat-label { color: #888; font-size: 11px; }
    .meter-bg { background: rgba(255,255,255,0.1); border-radius: 4px; }
    .meter-fill { background: linear-gradient(90deg, #76b900, #00ff00); border-radius: 4px; }
    .meter-fill.hot { background: linear-gradient(90deg, #ff6600, #ff0000); }
    .profile-btn { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px 20px; 
                   color: #fff; margin: 4px; }
    .profile-btn:hover { background: rgba(118,185,0,0.3); }
    .profile-btn:checked { background: rgba(118,185,0,0.5); border: 1px solid #76b900; }
    .info-label { color: #888; font-size: 13px; }
    .apply-btn { background: #76b900; color: #fff; font-weight: bold; padding: 12px 32px; border-radius: 8px; }
    .apply-btn:hover { background: #8fd100; }
    .slider-label { color: #ccc; font-size: 12px; }
    .control-card { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 16px; margin: 8px 0; }
    .section-title { color: #76b900; font-size: 14px; font-weight: bold; margin-bottom: 8px; }
    .warning-label { color: #ff6600; font-size: 11px; }
    """
    
    def __init__(self):
        super().__init__(title="Aegis GPU Manager")
        self.set_default_size(1000, 800)
        self.gpus: List[GPUInfo] = []
        self.selected_gpu = 0
        self.stat_widgets: Dict[str, Gtk.Box] = {}
        self.controller = GPUController()
        
        css = Gtk.CssProvider()
        css.load_from_data(self.CSS.encode())
        Gtk.StyleContext.add_provider_for_screen(self.get_screen(), css, Gtk.STYLE_PROVIDER_PRIORITY_APPLICATION)
        
        self._detect_gpus()
        self._create_ui()
        self._start_monitoring()
    
    def _detect_gpus(self):
        """Detect all GPUs using nvidia-smi, rocm-smi, and sysfs"""
        nvidia_gpus = GPUController.detect_nvidia_gpus()
        amd_gpus = GPUController.detect_amd_gpus()
        
        self.gpus = nvidia_gpus + amd_gpus
        
        if not self.gpus:
            try:
                result = subprocess.run(["lspci", "-v"], capture_output=True, text=True)
                for line in result.stdout.split("\n"):
                    if "VGA" in line or "3D" in line:
                        gpu = GPUInfo()
                        gpu.model = line.split(":")[-1].strip()[:60]
                        gpu.pci_id = line.split()[0]
                        
                        if "NVIDIA" in line.upper():
                            gpu.vendor = "NVIDIA"
                        elif "AMD" in line.upper() or "ATI" in line.upper():
                            gpu.vendor = "AMD"
                        elif "INTEL" in line.upper():
                            gpu.vendor = "Intel"
                            gpu.driver = "i915"
                        
                        self.gpus.append(gpu)
            except Exception as e:
                print(f"Error detecting GPUs via lspci: {e}")
    
    def _refresh_gpu_info(self, gpu: GPUInfo):
        """Refresh real-time GPU information"""
        if gpu.vendor == "NVIDIA":
            self._refresh_nvidia_info(gpu)
        elif gpu.vendor == "AMD":
            self._refresh_amd_info(gpu)
    
    def _refresh_nvidia_info(self, gpu: GPUInfo):
        """Refresh NVIDIA GPU info using nvidia-smi"""
        try:
            result = subprocess.run([
                "nvidia-smi", "-i", str(gpu.gpu_index),
                "--query-gpu=temperature.gpu,utilization.gpu,power.draw,clocks.gr,clocks.mem,fan.speed",
                "--format=csv,noheader,nounits"
            ], capture_output=True, text=True, timeout=5)
            
            if result.returncode == 0:
                parts = [p.strip() for p in result.stdout.strip().split(",")]
                if len(parts) >= 6:
                    gpu.temp = int(float(parts[0])) if parts[0] != "[N/A]" else gpu.temp
                    gpu.usage = int(float(parts[1])) if parts[1] != "[N/A]" else gpu.usage
                    gpu.power = int(float(parts[2])) if parts[2] != "[N/A]" else gpu.power
                    gpu.clock_core = int(float(parts[3])) if parts[3] != "[N/A]" else gpu.clock_core
                    gpu.clock_mem = int(float(parts[4])) if parts[4] != "[N/A]" else gpu.clock_mem
                    gpu.fan_speed = int(float(parts[5])) if parts[5] != "[N/A]" else gpu.fan_speed
        except Exception as e:
            print(f"Error refreshing NVIDIA info: {e}")
    
    def _refresh_amd_info(self, gpu: GPUInfo):
        """Refresh AMD GPU info using sysfs"""
        if not gpu.card_path:
            return
        
        try:
            device_path = Path(gpu.card_path)
            
            gpu_busy = device_path / "gpu_busy_percent"
            if gpu_busy.exists():
                with open(gpu_busy) as f:
                    gpu.usage = int(f.read().strip())
            
            hwmon_base = device_path / "hwmon"
            if hwmon_base.exists():
                for hwmon_dir in hwmon_base.iterdir():
                    temp_file = hwmon_dir / "temp1_input"
                    if temp_file.exists():
                        with open(temp_file) as f:
                            gpu.temp = int(f.read().strip()) // 1000
                    
                    power_file = hwmon_dir / "power1_average"
                    if power_file.exists():
                        with open(power_file) as f:
                            gpu.power = int(f.read().strip()) // 1000000
                    
                    pwm_file = hwmon_dir / "pwm1"
                    if pwm_file.exists():
                        with open(pwm_file) as f:
                            gpu.fan_speed = int(int(f.read().strip()) * 100 / 255)
                    break
            
            sclk_file = device_path / "pp_dpm_sclk"
            if sclk_file.exists():
                with open(sclk_file) as f:
                    for line in f:
                        if "*" in line:
                            match = re.search(r"(\d+)Mhz", line)
                            if match:
                                gpu.clock_core = int(match.group(1))
                            break
            
            mclk_file = device_path / "pp_dpm_mclk"
            if mclk_file.exists():
                with open(mclk_file) as f:
                    for line in f:
                        if "*" in line:
                            match = re.search(r"(\d+)Mhz", line)
                            if match:
                                gpu.clock_mem = int(match.group(1))
                            break
        except Exception as e:
            print(f"Error refreshing AMD info: {e}")
    
    def _create_ui(self):
        main = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        self.add(main)
        
        header = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        header.get_style_context().add_class("header")
        
        title = Gtk.Label(label="Aegis GPU Manager")
        title.get_style_context().add_class("title")
        title.set_halign(Gtk.Align.START)
        header.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label(label=f"Detected {len(self.gpus)} GPU(s) - Real Hardware Controls")
        subtitle.get_style_context().add_class("info-label")
        subtitle.set_halign(Gtk.Align.START)
        header.pack_start(subtitle, False, False, 4)
        
        main.pack_start(header, False, False, 0)
        
        scroll = Gtk.ScrolledWindow()
        main.pack_start(scroll, True, True, 0)
        
        content = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        content.set_margin_start(20)
        content.set_margin_end(20)
        content.set_margin_top(20)
        content.set_margin_bottom(20)
        scroll.add(content)
        
        for i, gpu in enumerate(self.gpus):
            content.pack_start(self._create_gpu_card(i, gpu), False, False, 0)
            content.pack_start(self._create_controls_card(i, gpu), False, False, 0)
        
        if not self.gpus:
            no_gpu = Gtk.Label(label="No GPUs detected. Make sure nvidia-smi or rocm-smi is available.")
            no_gpu.get_style_context().add_class("info-label")
            content.pack_start(no_gpu, True, True, 0)
        else:
            content.pack_start(self._create_profiles_card(), False, False, 0)
            content.pack_start(self._create_tools_card(), False, False, 0)
    
    def _create_gpu_card(self, index: int, gpu: GPUInfo) -> Gtk.Box:
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
        card.get_style_context().add_class("gpu-card")
        
        if gpu.vendor == "AMD":
            card.get_style_context().add_class("amd")
        elif gpu.vendor == "Intel":
            card.get_style_context().add_class("intel")
        
        header = Gtk.Box(spacing=12)
        
        info_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        
        name = Gtk.Label(label=gpu.model)
        name.get_style_context().add_class("gpu-name")
        name.set_halign(Gtk.Align.START)
        name.set_line_wrap(True)
        name.set_max_width_chars(60)
        info_box.pack_start(name, False, False, 0)
        
        vendor_text = f"{gpu.vendor} | Driver: {gpu.driver} | VRAM: {gpu.vram}"
        if gpu.pci_id:
            vendor_text += f" | PCI: {gpu.pci_id}"
        vendor = Gtk.Label(label=vendor_text)
        vendor.get_style_context().add_class("gpu-vendor")
        if gpu.vendor == "AMD":
            vendor.get_style_context().add_class("amd")
        elif gpu.vendor == "Intel":
            vendor.get_style_context().add_class("intel")
        vendor.set_halign(Gtk.Align.START)
        info_box.pack_start(vendor, False, False, 4)
        
        header.pack_start(info_box, True, True, 0)
        card.pack_start(header, False, False, 0)
        
        stats_box = Gtk.Box(spacing=8)
        stats_box.set_halign(Gtk.Align.START)
        
        temp_stat = self._create_stat_box("Temperature", f"{gpu.temp}°C", gpu.temp, 100)
        stats_box.pack_start(temp_stat, False, False, 0)
        self.stat_widgets[f"temp_{index}"] = temp_stat
        
        usage_stat = self._create_stat_box("GPU Usage", f"{gpu.usage}%", gpu.usage, 100)
        stats_box.pack_start(usage_stat, False, False, 0)
        self.stat_widgets[f"usage_{index}"] = usage_stat
        
        power_stat = self._create_stat_box("Power", f"{gpu.power}W", gpu.power, gpu.power_limit if gpu.power_limit > 0 else 100)
        stats_box.pack_start(power_stat, False, False, 0)
        self.stat_widgets[f"power_{index}"] = power_stat
        
        core_stat = self._create_stat_box("Core Clock", f"{gpu.clock_core} MHz", 0, 100)
        stats_box.pack_start(core_stat, False, False, 0)
        self.stat_widgets[f"core_{index}"] = core_stat
        
        mem_stat = self._create_stat_box("Mem Clock", f"{gpu.clock_mem} MHz", 0, 100)
        stats_box.pack_start(mem_stat, False, False, 0)
        self.stat_widgets[f"mem_{index}"] = mem_stat
        
        fan_stat = self._create_stat_box("Fan Speed", f"{gpu.fan_speed}%", gpu.fan_speed, 100)
        stats_box.pack_start(fan_stat, False, False, 0)
        self.stat_widgets[f"fan_{index}"] = fan_stat
        
        card.pack_start(stats_box, False, False, 0)
        
        return card
    
    def _create_controls_card(self, index: int, gpu: GPUInfo) -> Gtk.Box:
        """Create hardware controls card for a GPU"""
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        card.get_style_context().add_class("card")
        
        title = Gtk.Label(label=f"GPU {index} Controls")
        title.get_style_context().add_class("card-title")
        title.set_halign(Gtk.Align.START)
        card.pack_start(title, False, False, 8)
        
        warning = Gtk.Label(label="⚠ Modifying GPU settings may require administrator privileges and can affect system stability")
        warning.get_style_context().add_class("warning-label")
        warning.set_halign(Gtk.Align.START)
        card.pack_start(warning, False, False, 4)
        
        controls_grid = Gtk.Grid()
        controls_grid.set_row_spacing(12)
        controls_grid.set_column_spacing(20)
        controls_grid.set_margin_top(12)
        
        row = 0
        
        if gpu.supports_power_control and gpu.power_limit_max > 0:
            power_label = Gtk.Label(label="Power Limit (W):")
            power_label.get_style_context().add_class("slider-label")
            power_label.set_halign(Gtk.Align.START)
            controls_grid.attach(power_label, 0, row, 1, 1)
            
            power_adj = Gtk.Adjustment(
                value=gpu.power_limit if gpu.power_limit > 0 else gpu.power_limit_default,
                lower=gpu.power_limit_min if gpu.power_limit_min > 0 else 50,
                upper=gpu.power_limit_max if gpu.power_limit_max > 0 else 500,
                step_increment=5,
                page_increment=10
            )
            power_scale = Gtk.Scale(orientation=Gtk.Orientation.HORIZONTAL, adjustment=power_adj)
            power_scale.set_digits(0)
            power_scale.set_size_request(200, -1)
            power_scale.set_value_pos(Gtk.PositionType.RIGHT)
            controls_grid.attach(power_scale, 1, row, 1, 1)
            
            power_btn = Gtk.Button(label="Apply")
            power_btn.get_style_context().add_class("apply-btn")
            power_btn.connect("clicked", self._on_power_limit_apply, index, gpu, power_scale)
            controls_grid.attach(power_btn, 2, row, 1, 1)
            
            row += 1
        
        if gpu.supports_fan_control:
            fan_label = Gtk.Label(label="Fan Control:")
            fan_label.get_style_context().add_class("slider-label")
            fan_label.set_halign(Gtk.Align.START)
            controls_grid.attach(fan_label, 0, row, 1, 1)
            
            fan_box = Gtk.Box(spacing=8)
            
            fan_auto = Gtk.RadioButton.new_with_label(None, "Auto")
            fan_auto.set_active(gpu.fan_mode == "auto")
            fan_box.pack_start(fan_auto, False, False, 0)
            
            fan_manual = Gtk.RadioButton.new_with_label_from_widget(fan_auto, "Manual")
            fan_box.pack_start(fan_manual, False, False, 0)
            
            fan_adj = Gtk.Adjustment(value=gpu.fan_speed, lower=0, upper=100, step_increment=5, page_increment=10)
            fan_scale = Gtk.Scale(orientation=Gtk.Orientation.HORIZONTAL, adjustment=fan_adj)
            fan_scale.set_digits(0)
            fan_scale.set_size_request(150, -1)
            fan_scale.set_value_pos(Gtk.PositionType.RIGHT)
            fan_box.pack_start(fan_scale, True, True, 0)
            
            controls_grid.attach(fan_box, 1, row, 1, 1)
            
            fan_btn = Gtk.Button(label="Apply")
            fan_btn.get_style_context().add_class("apply-btn")
            fan_btn.connect("clicked", self._on_fan_apply, index, gpu, fan_auto, fan_scale)
            controls_grid.attach(fan_btn, 2, row, 1, 1)
            
            row += 1
        
        if gpu.supports_overclock:
            oc_label = Gtk.Label(label="Core Clock Offset (MHz):")
            oc_label.get_style_context().add_class("slider-label")
            oc_label.set_halign(Gtk.Align.START)
            controls_grid.attach(oc_label, 0, row, 1, 1)
            
            core_adj = Gtk.Adjustment(value=0, lower=-500, upper=500, step_increment=10, page_increment=50)
            core_scale = Gtk.Scale(orientation=Gtk.Orientation.HORIZONTAL, adjustment=core_adj)
            core_scale.set_digits(0)
            core_scale.set_size_request(200, -1)
            core_scale.set_value_pos(Gtk.PositionType.RIGHT)
            core_scale.add_mark(0, Gtk.PositionType.BOTTOM, "0")
            controls_grid.attach(core_scale, 1, row, 1, 1)
            
            row += 1
            
            mem_label = Gtk.Label(label="Memory Clock Offset (MHz):")
            mem_label.get_style_context().add_class("slider-label")
            mem_label.set_halign(Gtk.Align.START)
            controls_grid.attach(mem_label, 0, row, 1, 1)
            
            mem_adj = Gtk.Adjustment(value=0, lower=-500, upper=1000, step_increment=10, page_increment=50)
            mem_scale = Gtk.Scale(orientation=Gtk.Orientation.HORIZONTAL, adjustment=mem_adj)
            mem_scale.set_digits(0)
            mem_scale.set_size_request(200, -1)
            mem_scale.set_value_pos(Gtk.PositionType.RIGHT)
            mem_scale.add_mark(0, Gtk.PositionType.BOTTOM, "0")
            controls_grid.attach(mem_scale, 1, row, 1, 1)
            
            oc_btn = Gtk.Button(label="Apply OC")
            oc_btn.get_style_context().add_class("apply-btn")
            oc_btn.connect("clicked", self._on_overclock_apply, index, gpu, core_scale, mem_scale)
            controls_grid.attach(oc_btn, 2, row, 1, 1)
            
            row += 1
        
        card.pack_start(controls_grid, False, False, 0)
        
        return card
    
    def _on_power_limit_apply(self, btn, index: int, gpu: GPUInfo, scale: Gtk.Scale):
        """Apply power limit setting"""
        power_watts = int(scale.get_value())
        
        if gpu.vendor == "NVIDIA":
            success, output = GPUController.set_nvidia_power_limit(gpu.gpu_index, power_watts)
        elif gpu.vendor == "AMD":
            success, output = GPUController.set_amd_power_limit(gpu.card_path, power_watts)
        else:
            success, output = False, "Unsupported GPU vendor"
        
        if success:
            gpu.power_limit = power_watts
            self._show_info_dialog("Power Limit", f"Power limit set to {power_watts}W")
        else:
            self._show_error(f"Failed to set power limit: {output}")
    
    def _on_fan_apply(self, btn, index: int, gpu: GPUInfo, auto_radio: Gtk.RadioButton, scale: Gtk.Scale):
        """Apply fan control setting"""
        is_auto = auto_radio.get_active()
        
        if gpu.vendor == "NVIDIA":
            if is_auto:
                success, output = GPUController.set_nvidia_fan_speed(gpu.gpu_index, 0)
            else:
                speed = int(scale.get_value())
                success, output = GPUController.set_nvidia_fan_speed(gpu.gpu_index, speed)
        elif gpu.vendor == "AMD":
            if is_auto:
                success, output = GPUController.set_amd_fan_mode(gpu.card_path, "auto")
            else:
                speed = int(scale.get_value())
                success, output = GPUController.set_amd_fan_speed(gpu.card_path, speed)
        else:
            success, output = False, "Unsupported GPU vendor"
        
        if success:
            gpu.fan_mode = "auto" if is_auto else "manual"
            self._show_info_dialog("Fan Control", f"Fan mode set to {'automatic' if is_auto else f'{int(scale.get_value())}%'}")
        else:
            self._show_error(f"Failed to set fan control: {output}")
    
    def _on_overclock_apply(self, btn, index: int, gpu: GPUInfo, core_scale: Gtk.Scale, mem_scale: Gtk.Scale):
        """Apply overclocking settings"""
        core_offset = int(core_scale.get_value())
        mem_offset = int(mem_scale.get_value())
        
        if gpu.vendor == "NVIDIA":
            success, output = GPUController.set_nvidia_clock_offset(gpu.gpu_index, core_offset, mem_offset)
        elif gpu.vendor == "AMD":
            success, output = GPUController.set_amd_clock_offset(gpu.card_path, core_offset, mem_offset)
        else:
            success, output = False, "Unsupported GPU vendor"
        
        if success:
            gpu.clock_core_offset = core_offset
            gpu.clock_mem_offset = mem_offset
            self._show_info_dialog("Overclocking", f"Clock offsets set:\nCore: {core_offset:+d} MHz\nMemory: {mem_offset:+d} MHz")
        else:
            self._show_error(f"Failed to apply overclock: {output}")
    
    def _create_stat_box(self, label: str, value: str, current: int, max_val: int) -> Gtk.Box:
        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=4)
        box.get_style_context().add_class("stat-box")
        box.set_size_request(100, -1)
        
        val_lbl = Gtk.Label(label=value)
        val_lbl.get_style_context().add_class("stat-value")
        box.pack_start(val_lbl, False, False, 0)
        box.value_label = val_lbl
        
        meter_bg = Gtk.Box()
        meter_bg.get_style_context().add_class("meter-bg")
        meter_bg.set_size_request(80, 6)
        
        meter_fill = Gtk.Box()
        meter_fill.get_style_context().add_class("meter-fill")
        if current > 80:
            meter_fill.get_style_context().add_class("hot")
        fill_width = int(80 * current / max_val) if max_val > 0 else 0
        meter_fill.set_size_request(max(0, min(80, fill_width)), 6)
        meter_bg.pack_start(meter_fill, False, False, 0)
        box.pack_start(meter_bg, False, False, 0)
        box.meter_fill = meter_fill
        box.max_val = max_val
        
        name_lbl = Gtk.Label(label=label)
        name_lbl.get_style_context().add_class("stat-label")
        box.pack_start(name_lbl, False, False, 0)
        
        return box
    
    def _create_profiles_card(self) -> Gtk.Box:
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        card.get_style_context().add_class("card")
        
        title = Gtk.Label(label="Power Profiles")
        title.get_style_context().add_class("card-title")
        title.set_halign(Gtk.Align.START)
        card.pack_start(title, False, False, 8)
        
        profiles_box = Gtk.Box(spacing=8)
        
        profiles = [
            ("Maximum Performance", "Max clocks, full power, aggressive fan curve"),
            ("Balanced", "Automatic power management for best efficiency"),
            ("Power Saving", "Reduced clocks, lower temps and power draw"),
            ("Quiet", "Fan curve optimized for minimal noise"),
        ]
        
        self.profile_btns = {}
        for name, desc in profiles:
            btn = Gtk.ToggleButton(label=name)
            btn.get_style_context().add_class("profile-btn")
            btn.set_tooltip_text(desc)
            btn.connect("toggled", self._on_profile_select, name)
            self.profile_btns[name] = btn
            profiles_box.pack_start(btn, False, False, 0)
        
        self.profile_btns["Balanced"].set_active(True)
        
        card.pack_start(profiles_box, False, False, 8)
        
        return card
    
    def _on_profile_select(self, btn, profile_name):
        if not btn.get_active():
            return
        
        for name, b in self.profile_btns.items():
            if name != profile_name:
                b.set_active(False)
        
        for gpu in self.gpus:
            self._apply_profile(gpu, profile_name)
    
    def _apply_profile(self, gpu: GPUInfo, profile_name: str):
        """Apply a power profile to a GPU"""
        if profile_name == "Maximum Performance":
            if gpu.vendor == "NVIDIA":
                if gpu.power_limit_max > 0:
                    GPUController.set_nvidia_power_limit(gpu.gpu_index, gpu.power_limit_max)
                GPUController.set_nvidia_fan_speed(gpu.gpu_index, 0)
            elif gpu.vendor == "AMD":
                GPUController.set_amd_performance_level(gpu.card_path, "high")
                GPUController.set_amd_fan_mode(gpu.card_path, "auto")
        
        elif profile_name == "Balanced":
            if gpu.vendor == "NVIDIA":
                if gpu.power_limit_default > 0:
                    GPUController.set_nvidia_power_limit(gpu.gpu_index, gpu.power_limit_default)
                GPUController.set_nvidia_fan_speed(gpu.gpu_index, 0)
            elif gpu.vendor == "AMD":
                GPUController.set_amd_performance_level(gpu.card_path, "auto")
                GPUController.set_amd_fan_mode(gpu.card_path, "auto")
        
        elif profile_name == "Power Saving":
            if gpu.vendor == "NVIDIA":
                if gpu.power_limit_min > 0:
                    GPUController.set_nvidia_power_limit(gpu.gpu_index, gpu.power_limit_min)
            elif gpu.vendor == "AMD":
                GPUController.set_amd_performance_level(gpu.card_path, "low")
        
        elif profile_name == "Quiet":
            if gpu.vendor == "NVIDIA":
                GPUController.set_nvidia_fan_speed(gpu.gpu_index, 40)
            elif gpu.vendor == "AMD":
                GPUController.set_amd_fan_speed(gpu.card_path, 40)
    
    def _create_tools_card(self) -> Gtk.Box:
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        card.get_style_context().add_class("card")
        
        title = Gtk.Label(label="GPU Tools")
        title.get_style_context().add_class("card-title")
        title.set_halign(Gtk.Align.START)
        card.pack_start(title, False, False, 8)
        
        tools_box = Gtk.Box(spacing=8)
        
        tools = [
            ("nvidia-settings", "NVIDIA Settings", self._launch_nvidia_settings),
            ("amdgpu_top", "AMD GPU Top", self._launch_amd_top),
            ("nvtop", "GPU Monitor", self._launch_nvtop),
            ("glxinfo", "OpenGL Info", self._show_glxinfo),
            ("vulkaninfo", "Vulkan Info", self._show_vulkaninfo),
            ("refresh", "Refresh GPUs", self._refresh_all_gpus),
        ]
        
        for cmd, name, callback in tools:
            btn = Gtk.Button(label=name)
            btn.get_style_context().add_class("profile-btn")
            btn.connect("clicked", callback)
            tools_box.pack_start(btn, False, False, 0)
        
        card.pack_start(tools_box, False, False, 8)
        
        return card
    
    def _refresh_all_gpus(self, btn):
        """Refresh all GPU information"""
        for gpu in self.gpus:
            self._refresh_gpu_info(gpu)
        self._update_stat_displays()
    
    def _update_stat_displays(self):
        """Update all stat display widgets"""
        for i, gpu in enumerate(self.gpus):
            if f"temp_{i}" in self.stat_widgets:
                widget = self.stat_widgets[f"temp_{i}"]
                widget.value_label.set_text(f"{gpu.temp}°C")
                if hasattr(widget, 'meter_fill'):
                    widget.meter_fill.set_size_request(int(80 * min(gpu.temp, 100) / 100), 6)
            
            if f"usage_{i}" in self.stat_widgets:
                widget = self.stat_widgets[f"usage_{i}"]
                widget.value_label.set_text(f"{gpu.usage}%")
                if hasattr(widget, 'meter_fill'):
                    widget.meter_fill.set_size_request(int(80 * gpu.usage / 100), 6)
            
            if f"power_{i}" in self.stat_widgets:
                widget = self.stat_widgets[f"power_{i}"]
                widget.value_label.set_text(f"{gpu.power}W")
                if hasattr(widget, 'meter_fill') and hasattr(widget, 'max_val') and widget.max_val > 0:
                    widget.meter_fill.set_size_request(int(80 * min(gpu.power, widget.max_val) / widget.max_val), 6)
            
            if f"core_{i}" in self.stat_widgets:
                widget = self.stat_widgets[f"core_{i}"]
                widget.value_label.set_text(f"{gpu.clock_core} MHz")
            
            if f"mem_{i}" in self.stat_widgets:
                widget = self.stat_widgets[f"mem_{i}"]
                widget.value_label.set_text(f"{gpu.clock_mem} MHz")
            
            if f"fan_{i}" in self.stat_widgets:
                widget = self.stat_widgets[f"fan_{i}"]
                widget.value_label.set_text(f"{gpu.fan_speed}%")
                if hasattr(widget, 'meter_fill'):
                    widget.meter_fill.set_size_request(int(80 * gpu.fan_speed / 100), 6)
    
    def _launch_nvidia_settings(self, btn):
        try:
            subprocess.Popen(["nvidia-settings"], start_new_session=True)
        except:
            self._show_error("nvidia-settings not found. Install the NVIDIA driver package.")
    
    def _launch_amd_top(self, btn):
        try:
            subprocess.Popen(["xterm", "-e", "amdgpu_top"], start_new_session=True)
        except:
            try:
                subprocess.Popen(["xterm", "-e", "radeontop"], start_new_session=True)
            except:
                self._show_error("amdgpu_top/radeontop not found. Install with: sudo apt install radeontop")
    
    def _launch_nvtop(self, btn):
        try:
            subprocess.Popen(["xterm", "-e", "nvtop"], start_new_session=True)
        except:
            self._show_error("nvtop not found. Install with: sudo apt install nvtop")
    
    def _show_glxinfo(self, btn):
        try:
            result = subprocess.run(["glxinfo", "-B"], capture_output=True, text=True)
            self._show_info_dialog("OpenGL Info", result.stdout)
        except:
            self._show_error("glxinfo not found. Install with: sudo apt install mesa-utils")
    
    def _show_vulkaninfo(self, btn):
        try:
            result = subprocess.run(["vulkaninfo", "--summary"], capture_output=True, text=True)
            self._show_info_dialog("Vulkan Info", result.stdout)
        except:
            self._show_error("vulkaninfo not found. Install with: sudo apt install vulkan-tools")
    
    def _show_error(self, message):
        dialog = Gtk.MessageDialog(
            transient_for=self,
            message_type=Gtk.MessageType.ERROR,
            buttons=Gtk.ButtonsType.OK,
            text="Error"
        )
        dialog.format_secondary_text(message)
        dialog.run()
        dialog.destroy()
    
    def _show_info_dialog(self, title, content):
        dialog = Gtk.Dialog(title=title, transient_for=self, flags=0)
        dialog.add_buttons(Gtk.STOCK_CLOSE, Gtk.ResponseType.CLOSE)
        dialog.set_default_size(600, 400)
        
        scroll = Gtk.ScrolledWindow()
        text = Gtk.TextView()
        text.get_buffer().set_text(content)
        text.set_editable(False)
        text.set_monospace(True)
        scroll.add(text)
        
        dialog.get_content_area().pack_start(scroll, True, True, 0)
        dialog.show_all()
        dialog.run()
        dialog.destroy()
    
    def _start_monitoring(self):
        def update():
            for gpu in self.gpus:
                self._refresh_gpu_info(gpu)
            self._update_stat_displays()
            return True
        GLib.timeout_add_seconds(2, update)


def main():
    if not GTK_AVAILABLE:
        print("Cannot start Aegis GPU Manager: GTK3 not available.", file=sys.stderr)
        sys.exit(1)
    win = AegisGPUManager()
    win.connect("destroy", Gtk.main_quit)
    win.show_all()
    Gtk.main()


if __name__ == "__main__":
    main()
