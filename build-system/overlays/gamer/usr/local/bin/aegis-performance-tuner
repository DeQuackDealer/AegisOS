#!/usr/bin/env python3
"""
Aegis Performance Tuner - Gaming System Optimization Tool
Real-time system tuning for optimal gaming performance

Features:
- CPU governor management (performance/powersave/schedutil)
- GPU overclocking and power management (NVIDIA/AMD)
- Memory optimization and ZRAM configuration
- I/O scheduler tuning for games on SSD/HDD
- Network latency optimization
- Process priority management
- GameMode integration
- One-click gaming profiles
- Real-time system monitoring

Copyright (c) 2024 Aegis OS Team
License: GPL-3.0
"""

import os
import sys
import json
import subprocess
import argparse
import shutil
import threading
import time
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Optional, Any, Tuple
from dataclasses import dataclass, field, asdict
from enum import Enum

try:
    import tkinter as tk
    from tkinter import ttk, messagebox
    TKINTER_AVAILABLE = True
except ImportError:
    TKINTER_AVAILABLE = False

VERSION = "1.0.0"
APP_NAME = "Aegis Performance Tuner"
CONFIG_DIR = Path.home() / ".config/aegis/performance-tuner"
CONFIG_FILE = CONFIG_DIR / "config.json"
PROFILES_DIR = CONFIG_DIR / "profiles"


class CPUGovernor(Enum):
    PERFORMANCE = "performance"
    POWERSAVE = "powersave"
    SCHEDUTIL = "schedutil"
    ONDEMAND = "ondemand"
    CONSERVATIVE = "conservative"


class GPUVendor(Enum):
    NVIDIA = "nvidia"
    AMD = "amd"
    INTEL = "intel"
    UNKNOWN = "unknown"


@dataclass
class SystemInfo:
    cpu_model: str = ""
    cpu_cores: int = 0
    cpu_threads: int = 0
    cpu_max_freq_mhz: int = 0
    ram_total_gb: float = 0.0
    gpu_vendor: str = "unknown"
    gpu_model: str = ""
    gpu_vram_mb: int = 0
    current_governor: str = ""
    gamemode_available: bool = False
    root_access: bool = False


@dataclass
class PerformanceProfile:
    name: str
    description: str = ""
    cpu_governor: str = "performance"
    cpu_boost: bool = True
    gpu_power_mode: str = "max"
    gpu_overclock_core: int = 0
    gpu_overclock_mem: int = 0
    io_scheduler: str = "mq-deadline"
    swappiness: int = 10
    transparent_hugepages: str = "madvise"
    network_low_latency: bool = True
    process_niceness: int = -5
    gamemode_enabled: bool = True
    mangohud_enabled: bool = False
    disable_compositor: bool = True
    mouse_polling_rate: int = 1000


DEFAULT_PROFILES = {
    "gaming": PerformanceProfile(
        name="Gaming",
        description="Maximum performance for gaming",
        cpu_governor="performance",
        cpu_boost=True,
        gpu_power_mode="max",
        swappiness=10,
        network_low_latency=True,
        gamemode_enabled=True
    ),
    "balanced": PerformanceProfile(
        name="Balanced",
        description="Balance between performance and power",
        cpu_governor="schedutil",
        cpu_boost=True,
        gpu_power_mode="auto",
        swappiness=30,
        network_low_latency=False,
        gamemode_enabled=False
    ),
    "powersave": PerformanceProfile(
        name="Power Save",
        description="Maximum battery life",
        cpu_governor="powersave",
        cpu_boost=False,
        gpu_power_mode="low",
        swappiness=60,
        network_low_latency=False,
        gamemode_enabled=False
    ),
    "streaming": PerformanceProfile(
        name="Streaming",
        description="Optimized for game streaming",
        cpu_governor="performance",
        cpu_boost=True,
        gpu_power_mode="max",
        swappiness=10,
        network_low_latency=True,
        gamemode_enabled=True,
        mangohud_enabled=True
    ),
    "competitive": PerformanceProfile(
        name="Competitive",
        description="Ultra-low latency for esports",
        cpu_governor="performance",
        cpu_boost=True,
        gpu_power_mode="max",
        swappiness=1,
        network_low_latency=True,
        process_niceness=-10,
        disable_compositor=True,
        mouse_polling_rate=1000
    )
}


class SystemDetector:
    @staticmethod
    def get_system_info() -> SystemInfo:
        info = SystemInfo()
        try:
            with open("/proc/cpuinfo") as f:
                cpuinfo = f.read()
            for line in cpuinfo.split('\n'):
                if line.startswith("model name"):
                    info.cpu_model = line.split(':')[1].strip()
                    break
            info.cpu_cores = os.cpu_count() or 1
            try:
                result = subprocess.run(["nproc", "--all"], capture_output=True, text=True)
                info.cpu_threads = int(result.stdout.strip())
            except:
                info.cpu_threads = info.cpu_cores
            freq_path = Path("/sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq")
            if freq_path.exists():
                info.cpu_max_freq_mhz = int(freq_path.read_text().strip()) // 1000
            with open("/proc/meminfo") as f:
                for line in f:
                    if line.startswith("MemTotal"):
                        kb = int(line.split()[1])
                        info.ram_total_gb = kb / (1024 * 1024)
                        break
            governor_path = Path("/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor")
            if governor_path.exists():
                info.current_governor = governor_path.read_text().strip()
            if shutil.which("nvidia-smi"):
                info.gpu_vendor = "nvidia"
                result = subprocess.run(
                    ["nvidia-smi", "--query-gpu=name,memory.total", "--format=csv,noheader,nounits"],
                    capture_output=True, text=True
                )
                if result.returncode == 0:
                    parts = result.stdout.strip().split(',')
                    info.gpu_model = parts[0].strip()
                    info.gpu_vram_mb = int(parts[1].strip()) if len(parts) > 1 else 0
            else:
                drm_path = Path("/sys/class/drm")
                for card in drm_path.glob("card[0-9]*"):
                    vendor_file = card / "device/vendor"
                    if vendor_file.exists():
                        vendor_id = vendor_file.read_text().strip()
                        if vendor_id == "0x1002":
                            info.gpu_vendor = "amd"
                        elif vendor_id == "0x8086":
                            info.gpu_vendor = "intel"
            info.gamemode_available = shutil.which("gamemoded") is not None
            info.root_access = os.geteuid() == 0
        except Exception as e:
            print(f"Error detecting system: {e}", file=sys.stderr)
        return info


class PerformanceTunerService:
    def __init__(self):
        CONFIG_DIR.mkdir(parents=True, exist_ok=True)
        PROFILES_DIR.mkdir(parents=True, exist_ok=True)
        self.system_info = SystemDetector.get_system_info()
        self.profiles = self._load_profiles()
        self.current_profile: Optional[str] = None
        self._load_config()

    def _load_profiles(self) -> Dict[str, PerformanceProfile]:
        profiles = dict(DEFAULT_PROFILES)
        for profile_file in PROFILES_DIR.glob("*.json"):
            try:
                with open(profile_file) as f:
                    data = json.load(f)
                    profiles[profile_file.stem] = PerformanceProfile(**data)
            except Exception:
                pass
        return profiles

    def _load_config(self):
        if CONFIG_FILE.exists():
            try:
                with open(CONFIG_FILE) as f:
                    data = json.load(f)
                    self.current_profile = data.get("current_profile")
            except Exception:
                pass

    def _save_config(self):
        with open(CONFIG_FILE, 'w') as f:
            json.dump({"current_profile": self.current_profile}, f, indent=2)

    def save_profile(self, name: str, profile: PerformanceProfile):
        self.profiles[name] = profile
        with open(PROFILES_DIR / f"{name}.json", 'w') as f:
            json.dump(asdict(profile), f, indent=2)

    def apply_profile(self, profile_name: str) -> Tuple[bool, List[str]]:
        if profile_name not in self.profiles:
            return False, [f"Profile '{profile_name}' not found"]

        profile = self.profiles[profile_name]
        results = []
        success = True

        result = self._set_cpu_governor(profile.cpu_governor)
        results.append(result)
        if "Error" in result:
            success = False

        result = self._set_cpu_boost(profile.cpu_boost)
        results.append(result)

        if self.system_info.gpu_vendor != "unknown":
            result = self._set_gpu_power_mode(profile.gpu_power_mode)
            results.append(result)

        result = self._set_swappiness(profile.swappiness)
        results.append(result)

        if profile.network_low_latency:
            result = self._enable_low_latency_network()
            results.append(result)

        if profile.gamemode_enabled and self.system_info.gamemode_available:
            results.append("GameMode: Will be activated on game launch")

        if profile.disable_compositor:
            result = self._disable_compositor()
            results.append(result)

        self.current_profile = profile_name
        self._save_config()

        return success, results

    def _set_cpu_governor(self, governor: str) -> str:
        try:
            cpu_path = Path("/sys/devices/system/cpu")
            for cpu in cpu_path.glob("cpu[0-9]*"):
                gov_file = cpu / "cpufreq/scaling_governor"
                if gov_file.exists():
                    if self.system_info.root_access:
                        gov_file.write_text(governor)
                    else:
                        subprocess.run(
                            ["pkexec", "bash", "-c", f"echo {governor} > {gov_file}"],
                            capture_output=True
                        )
            self.system_info.current_governor = governor
            return f"CPU Governor: Set to {governor}"
        except Exception as e:
            return f"CPU Governor: Error - {e}"

    def _set_cpu_boost(self, enabled: bool) -> str:
        boost_paths = [
            Path("/sys/devices/system/cpu/cpufreq/boost"),
            Path("/sys/devices/system/cpu/intel_pstate/no_turbo")
        ]
        for path in boost_paths:
            if path.exists():
                try:
                    value = "1" if enabled else "0"
                    if "no_turbo" in str(path):
                        value = "0" if enabled else "1"
                    if self.system_info.root_access:
                        path.write_text(value)
                    else:
                        subprocess.run(
                            ["pkexec", "bash", "-c", f"echo {value} > {path}"],
                            capture_output=True
                        )
                    return f"CPU Boost: {'Enabled' if enabled else 'Disabled'}"
                except Exception as e:
                    return f"CPU Boost: Error - {e}"
        return "CPU Boost: Not available"

    def _set_gpu_power_mode(self, mode: str) -> str:
        if self.system_info.gpu_vendor == "nvidia":
            try:
                if mode == "max":
                    subprocess.run(
                        ["nvidia-settings", "-a", "[gpu:0]/GpuPowerMizerMode=1"],
                        capture_output=True
                    )
                elif mode == "low":
                    subprocess.run(
                        ["nvidia-settings", "-a", "[gpu:0]/GpuPowerMizerMode=0"],
                        capture_output=True
                    )
                return f"GPU Power Mode: Set to {mode}"
            except Exception as e:
                return f"GPU Power Mode: Error - {e}"
        elif self.system_info.gpu_vendor == "amd":
            try:
                power_profile = "high" if mode == "max" else "low" if mode == "low" else "auto"
                for card in Path("/sys/class/drm").glob("card[0-9]*"):
                    profile_path = card / "device/power_dpm_force_performance_level"
                    if profile_path.exists():
                        if self.system_info.root_access:
                            profile_path.write_text(power_profile)
                        else:
                            subprocess.run(
                                ["pkexec", "bash", "-c", f"echo {power_profile} > {profile_path}"],
                                capture_output=True
                            )
                return f"GPU Power Mode: Set to {mode}"
            except Exception as e:
                return f"GPU Power Mode: Error - {e}"
        return "GPU Power Mode: Unknown GPU vendor"

    def _set_swappiness(self, value: int) -> str:
        try:
            if self.system_info.root_access:
                with open("/proc/sys/vm/swappiness", 'w') as f:
                    f.write(str(value))
            else:
                subprocess.run(
                    ["pkexec", "sysctl", f"vm.swappiness={value}"],
                    capture_output=True
                )
            return f"Swappiness: Set to {value}"
        except Exception as e:
            return f"Swappiness: Error - {e}"

    def _enable_low_latency_network(self) -> str:
        try:
            sysctls = [
                "net.ipv4.tcp_low_latency=1",
                "net.ipv4.tcp_fastopen=3",
                "net.core.netdev_budget=600",
            ]
            for sysctl in sysctls:
                if self.system_info.root_access:
                    subprocess.run(["sysctl", "-w", sysctl], capture_output=True)
                else:
                    subprocess.run(["pkexec", "sysctl", "-w", sysctl], capture_output=True)
            return "Network: Low latency mode enabled"
        except Exception as e:
            return f"Network: Error - {e}"

    def _disable_compositor(self) -> str:
        try:
            result = subprocess.run(["xfconf-query", "-c", "xfwm4", "-p", "/general/use_compositing", "-s", "false"],
                                   capture_output=True)
            if result.returncode == 0:
                return "Compositor: Disabled"
        except:
            pass
        try:
            result = subprocess.run(["kwin", "--replace", "&"], capture_output=True, shell=True)
        except:
            pass
        return "Compositor: Attempted to disable"

    def get_current_stats(self) -> Dict[str, Any]:
        stats = {
            "cpu_governor": self.system_info.current_governor,
            "cpu_freq_mhz": [],
            "cpu_usage_pct": 0,
            "ram_used_gb": 0,
            "ram_total_gb": self.system_info.ram_total_gb,
            "gpu_temp_c": 0,
            "gpu_usage_pct": 0,
            "gpu_vram_used_mb": 0
        }
        try:
            for cpu in Path("/sys/devices/system/cpu").glob("cpu[0-9]*"):
                freq_file = cpu / "cpufreq/scaling_cur_freq"
                if freq_file.exists():
                    freq = int(freq_file.read_text().strip()) // 1000
                    stats["cpu_freq_mhz"].append(freq)
        except:
            pass
        try:
            with open("/proc/meminfo") as f:
                meminfo = {}
                for line in f:
                    parts = line.split()
                    meminfo[parts[0].rstrip(':')] = int(parts[1])
            used = meminfo["MemTotal"] - meminfo["MemAvailable"]
            stats["ram_used_gb"] = used / (1024 * 1024)
        except:
            pass
        if self.system_info.gpu_vendor == "nvidia":
            try:
                result = subprocess.run(
                    ["nvidia-smi", "--query-gpu=temperature.gpu,utilization.gpu,memory.used",
                     "--format=csv,noheader,nounits"],
                    capture_output=True, text=True
                )
                if result.returncode == 0:
                    parts = result.stdout.strip().split(',')
                    stats["gpu_temp_c"] = int(parts[0].strip())
                    stats["gpu_usage_pct"] = int(parts[1].strip())
                    stats["gpu_vram_used_mb"] = int(parts[2].strip())
            except:
                pass
        return stats

    def get_status(self) -> Dict[str, Any]:
        return {
            "version": VERSION,
            "system": asdict(self.system_info),
            "current_profile": self.current_profile,
            "available_profiles": list(self.profiles.keys()),
            "stats": self.get_current_stats()
        }


class PerformanceTunerGUI:
    def __init__(self, service: PerformanceTunerService):
        self.service = service
        self.root = None
        self.monitoring = False

    def run(self):
        if not TKINTER_AVAILABLE:
            print("Error: Tkinter not available")
            sys.exit(1)

        self.root = tk.Tk()
        self.root.title(f"{APP_NAME} v{VERSION}")
        self.root.geometry("800x600")
        self.root.configure(bg='#0d1117')

        style = ttk.Style()
        style.theme_use('clam')
        style.configure('TFrame', background='#0d1117')
        style.configure('TLabel', background='#0d1117', foreground='#c9d1d9')
        style.configure('Header.TLabel', font=('Segoe UI', 18, 'bold'), foreground='#58a6ff')
        style.configure('Profile.TLabel', font=('Segoe UI', 12, 'bold'), foreground='#8b949e')
        style.configure('Stat.TLabel', font=('Segoe UI', 11), foreground='#c9d1d9')
        style.configure('TButton', padding=10, font=('Segoe UI', 10))
        style.configure('Apply.TButton', padding=12, font=('Segoe UI', 11, 'bold'))

        self._create_widgets()
        self._start_monitoring()
        self.root.protocol("WM_DELETE_WINDOW", self._on_close)
        self.root.mainloop()

    def _create_widgets(self):
        main = ttk.Frame(self.root, padding=15)
        main.pack(fill=tk.BOTH, expand=True)

        header = ttk.Frame(main)
        header.pack(fill=tk.X, pady=(0, 15))

        ttk.Label(header, text="‚ö° Aegis Performance Tuner", style='Header.TLabel').pack(side=tk.LEFT)

        system = self.service.system_info
        info_text = f"{system.cpu_model[:40]}... | {system.ram_total_gb:.1f} GB RAM"
        if system.gpu_model:
            info_text += f" | {system.gpu_model[:20]}..."
        ttk.Label(header, text=info_text, foreground='#8b949e').pack(side=tk.RIGHT)

        content = ttk.Frame(main)
        content.pack(fill=tk.BOTH, expand=True)

        profiles_frame = ttk.LabelFrame(content, text="Performance Profiles", padding=10)
        profiles_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 10))

        self.profile_var = tk.StringVar(value=self.service.current_profile or "balanced")

        for name, profile in self.service.profiles.items():
            frame = ttk.Frame(profiles_frame)
            frame.pack(fill=tk.X, pady=5)

            rb = ttk.Radiobutton(frame, text=profile.name, value=name, variable=self.profile_var)
            rb.pack(side=tk.LEFT)

            ttk.Label(frame, text=profile.description, foreground='#8b949e').pack(side=tk.LEFT, padx=10)

            if name == self.service.current_profile:
                ttk.Label(frame, text="‚úì Active", foreground='#3fb950').pack(side=tk.RIGHT)

        btn_frame = ttk.Frame(profiles_frame)
        btn_frame.pack(fill=tk.X, pady=15)

        apply_btn = ttk.Button(btn_frame, text="‚ö° Apply Profile", style='Apply.TButton',
                              command=self._apply_profile)
        apply_btn.pack(fill=tk.X)

        stats_frame = ttk.LabelFrame(content, text="System Monitor", padding=10, width=280)
        stats_frame.pack(side=tk.RIGHT, fill=tk.Y)
        stats_frame.pack_propagate(False)

        self.cpu_governor_label = ttk.Label(stats_frame, text="CPU Governor: --", style='Stat.TLabel')
        self.cpu_governor_label.pack(anchor=tk.W, pady=2)

        self.cpu_freq_label = ttk.Label(stats_frame, text="CPU Freq: -- MHz", style='Stat.TLabel')
        self.cpu_freq_label.pack(anchor=tk.W, pady=2)

        self.cpu_usage_label = ttk.Label(stats_frame, text="CPU Usage: --%", style='Stat.TLabel')
        self.cpu_usage_label.pack(anchor=tk.W, pady=2)

        ttk.Separator(stats_frame, orient=tk.HORIZONTAL).pack(fill=tk.X, pady=10)

        self.ram_label = ttk.Label(stats_frame, text="RAM: -- / -- GB", style='Stat.TLabel')
        self.ram_label.pack(anchor=tk.W, pady=2)

        ttk.Separator(stats_frame, orient=tk.HORIZONTAL).pack(fill=tk.X, pady=10)

        self.gpu_label = ttk.Label(stats_frame, text="GPU: --", style='Stat.TLabel')
        self.gpu_label.pack(anchor=tk.W, pady=2)

        self.gpu_temp_label = ttk.Label(stats_frame, text="GPU Temp: --¬∞C", style='Stat.TLabel')
        self.gpu_temp_label.pack(anchor=tk.W, pady=2)

        self.gpu_usage_label = ttk.Label(stats_frame, text="GPU Usage: --%", style='Stat.TLabel')
        self.gpu_usage_label.pack(anchor=tk.W, pady=2)

        self.gpu_vram_label = ttk.Label(stats_frame, text="VRAM: -- MB", style='Stat.TLabel')
        self.gpu_vram_label.pack(anchor=tk.W, pady=2)

        ttk.Separator(stats_frame, orient=tk.HORIZONTAL).pack(fill=tk.X, pady=10)

        gamemode_status = "‚úì Available" if self.service.system_info.gamemode_available else "‚úó Not installed"
        ttk.Label(stats_frame, text=f"GameMode: {gamemode_status}", style='Stat.TLabel').pack(anchor=tk.W, pady=2)

        quick_frame = ttk.LabelFrame(main, text="Quick Actions", padding=10)
        quick_frame.pack(fill=tk.X, pady=(15, 0))

        actions = [
            ("üéÆ Gaming Mode", lambda: self._quick_apply("gaming")),
            ("‚öñÔ∏è Balanced", lambda: self._quick_apply("balanced")),
            ("üîã Power Save", lambda: self._quick_apply("powersave")),
            ("üì∫ Streaming", lambda: self._quick_apply("streaming")),
            ("üèÜ Competitive", lambda: self._quick_apply("competitive")),
        ]

        for text, cmd in actions:
            ttk.Button(quick_frame, text=text, command=cmd).pack(side=tk.LEFT, padx=5)

    def _apply_profile(self):
        profile_name = self.profile_var.get()
        success, results = self.service.apply_profile(profile_name)

        result_text = "\n".join(results)
        if success:
            messagebox.showinfo("Profile Applied", f"Applied '{profile_name}' profile:\n\n{result_text}")
        else:
            messagebox.showwarning("Partial Success", f"Some settings may require root:\n\n{result_text}")

    def _quick_apply(self, profile_name: str):
        self.profile_var.set(profile_name)
        self._apply_profile()

    def _start_monitoring(self):
        self.monitoring = True
        thread = threading.Thread(target=self._monitor_loop, daemon=True)
        thread.start()

    def _monitor_loop(self):
        while self.monitoring:
            try:
                stats = self.service.get_current_stats()
                self.root.after(0, lambda s=stats: self._update_stats(s))
            except Exception:
                pass
            time.sleep(1)

    def _update_stats(self, stats: Dict):
        self.cpu_governor_label.config(text=f"CPU Governor: {stats['cpu_governor']}")
        if stats['cpu_freq_mhz']:
            avg_freq = sum(stats['cpu_freq_mhz']) // len(stats['cpu_freq_mhz'])
            self.cpu_freq_label.config(text=f"CPU Freq: {avg_freq} MHz")
        self.ram_label.config(text=f"RAM: {stats['ram_used_gb']:.1f} / {stats['ram_total_gb']:.1f} GB")
        if stats['gpu_temp_c']:
            self.gpu_temp_label.config(text=f"GPU Temp: {stats['gpu_temp_c']}¬∞C")
            self.gpu_usage_label.config(text=f"GPU Usage: {stats['gpu_usage_pct']}%")
            self.gpu_vram_label.config(text=f"VRAM: {stats['gpu_vram_used_mb']} MB")

    def _on_close(self):
        self.monitoring = False
        self.root.destroy()


def main():
    parser = argparse.ArgumentParser(description=f"{APP_NAME} - Gaming system optimization")
    parser.add_argument('--gui', action='store_true', help='Launch GUI mode')
    parser.add_argument('--apply', metavar='PROFILE', help='Apply a performance profile')
    parser.add_argument('--list', action='store_true', help='List available profiles')
    parser.add_argument('--status', action='store_true', help='Show current status as JSON')
    parser.add_argument('--stats', action='store_true', help='Show current system stats')
    parser.add_argument('--governor', metavar='GOV', help='Set CPU governor directly')
    parser.add_argument('--gaming', action='store_true', help='Apply gaming profile')
    parser.add_argument('--balanced', action='store_true', help='Apply balanced profile')
    parser.add_argument('--powersave', action='store_true', help='Apply powersave profile')
    parser.add_argument('--version', action='version', version=f'{APP_NAME} v{VERSION}')

    args = parser.parse_args()
    service = PerformanceTunerService()

    if args.apply:
        success, results = service.apply_profile(args.apply)
        for r in results:
            print(r)
        sys.exit(0 if success else 1)
    elif args.list:
        print("Available profiles:")
        for name, profile in service.profiles.items():
            active = " (active)" if name == service.current_profile else ""
            print(f"  - {name}: {profile.description}{active}")
    elif args.status:
        print(json.dumps(service.get_status(), indent=2))
    elif args.stats:
        stats = service.get_current_stats()
        print(f"CPU Governor: {stats['cpu_governor']}")
        if stats['cpu_freq_mhz']:
            print(f"CPU Frequency: {sum(stats['cpu_freq_mhz'])//len(stats['cpu_freq_mhz'])} MHz avg")
        print(f"RAM: {stats['ram_used_gb']:.1f} / {stats['ram_total_gb']:.1f} GB")
        if stats['gpu_temp_c']:
            print(f"GPU: {stats['gpu_temp_c']}¬∞C, {stats['gpu_usage_pct']}% usage")
    elif args.governor:
        result = service._set_cpu_governor(args.governor)
        print(result)
    elif args.gaming:
        success, results = service.apply_profile("gaming")
        for r in results:
            print(r)
    elif args.balanced:
        success, results = service.apply_profile("balanced")
        for r in results:
            print(r)
    elif args.powersave:
        success, results = service.apply_profile("powersave")
        for r in results:
            print(r)
    elif args.gui or not any([args.apply, args.list, args.status, args.stats, 
                               args.governor, args.gaming, args.balanced, args.powersave]):
        if TKINTER_AVAILABLE:
            gui = PerformanceTunerGUI(service)
            gui.run()
        else:
            print("GUI requires tkinter. Use --help for CLI options.")
            sys.exit(1)


if __name__ == "__main__":
    main()
