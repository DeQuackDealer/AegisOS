#!/bin/bash
# Aegis Desktop Style - Windows 10-like Customization
# Configures XFCE panel, themes, and transparency

CONFIG_DIR="$HOME/.config/aegis/desktop"
XFCE_PANEL="$HOME/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-panel.xml"

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

mkdir -p "$CONFIG_DIR"

show_banner() {
    echo -e "${BLUE}"
    echo "╔══════════════════════════════════════════════════════╗"
    echo "║     AEGIS DESKTOP STYLE CONFIGURATION                ║"
    echo "╚══════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

set_transparency() {
    local level="$1"
    
    case "$level" in
        none)
            ALPHA="100"
            ;;
        low)
            ALPHA="90"
            ;;
        medium)
            ALPHA="75"
            ;;
        high)
            ALPHA="50"
            ;;
        glass)
            ALPHA="30"
            ;;
        *)
            echo "Unknown transparency level: $level"
            echo "Options: none, low, medium, high, glass"
            return 1
            ;;
    esac
    
    xfconf-query -c xfce4-panel -p /panels/panel-1/background-alpha -s "$ALPHA" 2>/dev/null
    xfconf-query -c xfce4-panel -p /panels/panel-2/background-alpha -s "$ALPHA" 2>/dev/null
    
    if command -v picom &> /dev/null; then
        OPACITY=$(echo "scale=2; $ALPHA / 100" | bc)
        
        cat > "$HOME/.config/picom.conf" << EOF
backend = "glx";
vsync = true;
inactive-opacity = 1.0;
active-opacity = 1.0;
frame-opacity = 1.0;
inactive-opacity-override = false;
blur-method = "dual_kawase";
blur-strength = 5;
corner-radius = 8;
rounded-corners-exclude = [
    "class_g = 'Polybar'",
    "class_g = 'xfce4-panel'"
];
EOF
        pkill picom
        picom --daemon &
    fi
    
    echo "$level" > "$CONFIG_DIR/transparency"
    echo -e "${GREEN}Transparency set to: $level${NC}"
}

apply_theme() {
    local theme="$1"
    
    case "$theme" in
        win10-light)
            GTK_THEME="Arc"
            ICON_THEME="Papirus"
            WM_THEME="Arc"
            ;;
        win10-dark)
            GTK_THEME="Arc-Dark"
            ICON_THEME="Papirus-Dark"
            WM_THEME="Arc-Dark"
            ;;
        aegis-blue)
            GTK_THEME="Arc-Dark"
            ICON_THEME="Papirus-Dark"
            WM_THEME="Arc-Dark"
            ;;
        aegis-gaming)
            GTK_THEME="Arc-Darker"
            ICON_THEME="Papirus-Dark"
            WM_THEME="Arc-Darker"
            ;;
        *)
            echo "Unknown theme: $theme"
            echo "Options: win10-light, win10-dark, aegis-blue, aegis-gaming"
            return 1
            ;;
    esac
    
    xfconf-query -c xsettings -p /Net/ThemeName -s "$GTK_THEME" 2>/dev/null
    xfconf-query -c xsettings -p /Net/IconThemeName -s "$ICON_THEME" 2>/dev/null
    xfconf-query -c xfwm4 -p /general/theme -s "$WM_THEME" 2>/dev/null
    
    gsettings set org.gnome.desktop.interface gtk-theme "$GTK_THEME" 2>/dev/null
    gsettings set org.gnome.desktop.interface icon-theme "$ICON_THEME" 2>/dev/null
    
    echo "$theme" > "$CONFIG_DIR/theme"
    echo -e "${GREEN}Theme applied: $theme${NC}"
}

setup_win10_panel() {
    echo -e "${BLUE}Configuring Windows 10-style taskbar...${NC}"
    
    xfconf-query -c xfce4-panel -p /panels/panel-1/position -s "p=8;x=0;y=0" 2>/dev/null
    xfconf-query -c xfce4-panel -p /panels/panel-1/position-locked -s true 2>/dev/null
    xfconf-query -c xfce4-panel -p /panels/panel-1/size -s 40 2>/dev/null
    xfconf-query -c xfce4-panel -p /panels/panel-1/length -s 100 2>/dev/null
    xfconf-query -c xfce4-panel -p /panels/panel-1/length-adjust -s false 2>/dev/null
    
    xfconf-query -c xfce4-panel -p /panels/panel-1/background-style -s 1 2>/dev/null
    xfconf-query -c xfce4-panel -p /panels/panel-1/background-rgba -s 0.06,0.09,0.16,0.95 2>/dev/null
    
    xfce4-panel -r 2>/dev/null
    
    echo -e "${GREEN}Windows 10-style taskbar configured!${NC}"
}

setup_daily_driver() {
    echo -e "${BLUE}Setting up daily driver experience...${NC}"
    
    xfconf-query -c xfce4-desktop -p /desktop-icons/file-icons/show-home -s true 2>/dev/null
    xfconf-query -c xfce4-desktop -p /desktop-icons/file-icons/show-trash -s true 2>/dev/null
    xfconf-query -c xfce4-desktop -p /desktop-icons/file-icons/show-filesystem -s true 2>/dev/null
    
    xfconf-query -c xfwm4 -p /general/snap_to_border -s true 2>/dev/null
    xfconf-query -c xfwm4 -p /general/snap_to_windows -s true 2>/dev/null
    xfconf-query -c xfwm4 -p /general/wrap_windows -s false 2>/dev/null
    xfconf-query -c xfwm4 -p /general/tile_on_move -s true 2>/dev/null
    
    xfconf-query -c xfce4-keyboard-shortcuts -p "/commands/custom/<Super>e" -s "thunar" 2>/dev/null
    xfconf-query -c xfce4-keyboard-shortcuts -p "/commands/custom/<Super>r" -s "xfce4-appfinder" 2>/dev/null
    xfconf-query -c xfce4-keyboard-shortcuts -p "/commands/custom/<Super>l" -s "xflock4" 2>/dev/null
    xfconf-query -c xfce4-keyboard-shortcuts -p "/commands/custom/<Super>d" -s "xfce4-popup-whiskermenu" 2>/dev/null
    xfconf-query -c xfce4-keyboard-shortcuts -p "/commands/custom/Print" -s "xfce4-screenshooter" 2>/dev/null
    
    xfconf-query -c thunar -p /misc-single-click -s false 2>/dev/null
    xfconf-query -c thunar -p /misc-show-delete-action -s true 2>/dev/null
    
    echo -e "${GREEN}Daily driver experience configured!${NC}"
}

show_menu() {
    show_banner
    echo "1) Set Theme"
    echo "2) Set Taskbar Transparency"
    echo "3) Windows 10 Style Layout"
    echo "4) Daily Driver Setup"
    echo "5) Exit"
    echo ""
    read -p "Select option: " choice
    
    case "$choice" in
        1)
            echo ""
            echo "Available themes:"
            echo "  win10-light  - Windows 10 Light"
            echo "  win10-dark   - Windows 10 Dark"
            echo "  aegis-blue   - Aegis Blue"
            echo "  aegis-gaming - Gaming Dark"
            echo ""
            read -p "Enter theme name: " theme
            apply_theme "$theme"
            ;;
        2)
            echo ""
            echo "Transparency levels: none, low, medium, high, glass"
            read -p "Enter level: " level
            set_transparency "$level"
            ;;
        3)
            setup_win10_panel
            ;;
        4)
            setup_daily_driver
            ;;
        5)
            exit 0
            ;;
    esac
    
    echo ""
    show_menu
}

case "${1:-}" in
    theme)
        apply_theme "${2:-win10-dark}"
        ;;
    transparency)
        set_transparency "${2:-medium}"
        ;;
    win10)
        setup_win10_panel
        ;;
    daily)
        setup_daily_driver
        ;;
    all)
        apply_theme "win10-dark"
        set_transparency "medium"
        setup_win10_panel
        setup_daily_driver
        ;;
    --help|-h)
        echo "Aegis Desktop Style Configuration"
        echo ""
        echo "Usage: aegis-desktop-style [command] [args]"
        echo ""
        echo "Commands:"
        echo "  theme <name>          Set GTK/icon/WM theme"
        echo "  transparency <level>  Set taskbar transparency"
        echo "  win10                 Apply Windows 10 panel layout"
        echo "  daily                 Configure daily driver settings"
        echo "  all                   Apply all configurations"
        echo ""
        echo "Run without arguments for interactive menu."
        ;;
    *)
        show_menu
        ;;
esac
