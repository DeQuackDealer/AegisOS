#!/usr/bin/env python3
"""
Aegis OS Theme Manager v1.0.0
Windows 10-inspired theme management with GUI

Features:
  - Switch between Aegis-Win10 Light/Dark themes
  - Accent color customization
  - Font size adjustment
  - Desktop layout presets (Windows 10, Windows 11, macOS-like)
  - Apply changes live

Copyright (c) 2024 Aegis OS Team
License: GPL-3.0
"""

import os
import sys
import json
import subprocess
import re
import shutil
from pathlib import Path
from typing import Dict, List, Optional, Tuple, Any
from dataclasses import dataclass, field
from datetime import datetime

try:
    import gi
    gi.require_version('Gtk', '3.0')
    gi.require_version('Gdk', '3.0')
    from gi.repository import Gtk, Gdk, GLib, Gio, GdkPixbuf
    GTK_AVAILABLE = True
except ImportError:
    GTK_AVAILABLE = False

VERSION = "1.0.0"
APP_NAME = "Aegis Theme Manager"
APP_ID = "com.aegis-os.theme-manager"

CONFIG_DIR = Path.home() / ".config" / "aegis" / "theme-manager"
THEMES_DIR = Path("/usr/share/themes")
ICONS_DIR = Path("/usr/share/icons")
USER_THEMES_DIR = Path.home() / ".themes"
USER_ICONS_DIR = Path.home() / ".icons"
BACKUP_DIR = CONFIG_DIR / "backups"

XFCE_SETTINGS = {
    "xsettings": "/Net/ThemeName",
    "xfwm4": "/general/theme",
    "xfce4-desktop": "/desktop-icons/icon-size",
}

@dataclass
class AccentColor:
    """Represents an accent color option"""
    name: str
    color: str
    hover: str
    active: str

PRESET_ACCENTS = [
    AccentColor("Windows Blue", "#0078D7", "#1A86DC", "#006CC1"),
    AccentColor("Aegis Blue", "#4A90D9", "#5BA0E9", "#3A80C9"),
    AccentColor("Purple", "#881798", "#9927A8", "#771688"),
    AccentColor("Red", "#E81123", "#F12133", "#D80113"),
    AccentColor("Orange", "#F7630C", "#FF731C", "#E75300"),
    AccentColor("Green", "#107C10", "#208C20", "#006C00"),
    AccentColor("Teal", "#00B294", "#00C2A4", "#00A284"),
    AccentColor("Gold", "#FFB900", "#FFC910", "#EFA900"),
    AccentColor("Storm", "#4C4A48", "#5C5A58", "#3C3A38"),
]

@dataclass
class LayoutPreset:
    """Desktop layout preset configuration"""
    name: str
    description: str
    panel_position: str  # top, bottom
    panel_size: int
    taskbar_style: str  # windows10, windows11, macos
    start_position: str  # left, center
    clock_format: str
    icon_alignment: str  # left, right
    window_buttons: str  # O|HMC format

LAYOUT_PRESETS = {
    "windows10": LayoutPreset(
        name="Windows 10",
        description="Classic Windows 10 layout with bottom taskbar",
        panel_position="bottom",
        panel_size=40,
        taskbar_style="windows10",
        start_position="left",
        clock_format="%l:%M %p\n%m/%d/%Y",
        icon_alignment="right",
        window_buttons="O|HMC"
    ),
    "windows11": LayoutPreset(
        name="Windows 11",
        description="Centered taskbar like Windows 11",
        panel_position="bottom",
        panel_size=48,
        taskbar_style="windows11",
        start_position="center",
        clock_format="%l:%M %p\n%a %b %d",
        icon_alignment="right",
        window_buttons="|HMC"
    ),
    "macos": LayoutPreset(
        name="macOS-like",
        description="Top panel with dock-style layout",
        panel_position="top",
        panel_size=28,
        taskbar_style="macos",
        start_position="left",
        clock_format="%a %b %d  %l:%M %p",
        icon_alignment="left",
        window_buttons="CMH|"
    ),
    "classic": LayoutPreset(
        name="Classic",
        description="Traditional desktop layout",
        panel_position="bottom",
        panel_size=32,
        taskbar_style="classic",
        start_position="left",
        clock_format="%H:%M",
        icon_alignment="left",
        window_buttons="O|HMC"
    ),
}


class ThemeManager:
    """Core theme management functionality"""
    
    def __init__(self):
        self.config_dir = CONFIG_DIR
        self.config_file = self.config_dir / "settings.json"
        self.config = self._load_config()
        self._ensure_dirs()
        
    def _ensure_dirs(self):
        """Ensure required directories exist"""
        for d in [self.config_dir, BACKUP_DIR, USER_THEMES_DIR, USER_ICONS_DIR]:
            d.mkdir(parents=True, exist_ok=True)
            
    def _load_config(self) -> Dict:
        """Load configuration from file"""
        default_config = {
            "current_theme": "Aegis-Win10",
            "dark_mode": False,
            "accent_color": "#0078D7",
            "accent_name": "Windows Blue",
            "font_size": 10,
            "layout_preset": "windows10",
            "custom_colors": {},
            "last_backup": None
        }
        
        try:
            if self.config_file.exists():
                with open(self.config_file, 'r') as f:
                    loaded = json.load(f)
                    default_config.update(loaded)
        except Exception as e:
            print(f"Warning: Could not load config: {e}")
            
        return default_config
        
    def save_config(self):
        """Save current configuration"""
        self.config_dir.mkdir(parents=True, exist_ok=True)
        try:
            with open(self.config_file, 'w') as f:
                json.dump(self.config, f, indent=2)
        except Exception as e:
            print(f"Error saving config: {e}")
            
    def get_available_themes(self) -> List[str]:
        """Get list of available GTK themes"""
        themes = set()
        
        for themes_dir in [THEMES_DIR, USER_THEMES_DIR]:
            if themes_dir.exists():
                for theme_path in themes_dir.iterdir():
                    if theme_path.is_dir():
                        gtk3_path = theme_path / "gtk-3.0"
                        if gtk3_path.exists():
                            themes.add(theme_path.name)
                            
        return sorted(list(themes))
        
    def get_available_icon_themes(self) -> List[str]:
        """Get list of available icon themes"""
        themes = set()
        
        for icons_dir in [ICONS_DIR, USER_ICONS_DIR]:
            if icons_dir.exists():
                for theme_path in icons_dir.iterdir():
                    if theme_path.is_dir():
                        index_file = theme_path / "index.theme"
                        if index_file.exists():
                            themes.add(theme_path.name)
                            
        return sorted(list(themes))
        
    def apply_gtk_theme(self, theme_name: str) -> bool:
        """Apply GTK theme using xfconf"""
        try:
            subprocess.run([
                'xfconf-query', '-c', 'xsettings',
                '-p', '/Net/ThemeName', '-s', theme_name
            ], check=True, capture_output=True)
            
            subprocess.run([
                'xfconf-query', '-c', 'xfwm4',
                '-p', '/general/theme', '-s', theme_name
            ], capture_output=True)
            
            self.config['current_theme'] = theme_name
            self.save_config()
            return True
        except subprocess.CalledProcessError as e:
            print(f"Error applying theme: {e}")
            return False
        except FileNotFoundError:
            self._apply_theme_fallback(theme_name)
            return True
            
    def _apply_theme_fallback(self, theme_name: str):
        """Fallback method using gsettings"""
        try:
            subprocess.run([
                'gsettings', 'set', 'org.gnome.desktop.interface',
                'gtk-theme', theme_name
            ], capture_output=True)
        except Exception:
            pass
            
    def apply_icon_theme(self, theme_name: str) -> bool:
        """Apply icon theme"""
        try:
            subprocess.run([
                'xfconf-query', '-c', 'xsettings',
                '-p', '/Net/IconThemeName', '-s', theme_name
            ], check=True, capture_output=True)
            return True
        except Exception as e:
            print(f"Error applying icon theme: {e}")
            return False
            
    def toggle_dark_mode(self, enable: bool) -> bool:
        """Toggle between light and dark theme variants"""
        if enable:
            theme = "Aegis-Win10-Dark"
        else:
            theme = "Aegis-Win10"
            
        success = self.apply_gtk_theme(theme)
        if success:
            self.config['dark_mode'] = enable
            self.save_config()
        return success
        
    def apply_accent_color(self, color: AccentColor) -> bool:
        """Apply custom accent color to theme"""
        try:
            theme_base = "Aegis-Win10-Dark" if self.config['dark_mode'] else "Aegis-Win10"
            
            for themes_dir in [THEMES_DIR, USER_THEMES_DIR]:
                theme_path = themes_dir / theme_base / "gtk-3.0" / "gtk.css"
                if theme_path.exists():
                    self._update_accent_in_css(theme_path, color)
                    break
                    
            self.config['accent_color'] = color.color
            self.config['accent_name'] = color.name
            self.save_config()
            
            self._reload_gtk()
            return True
        except Exception as e:
            print(f"Error applying accent color: {e}")
            return False
            
    def _update_accent_in_css(self, css_path: Path, color: AccentColor):
        """Update accent colors in CSS file"""
        try:
            with open(css_path, 'r') as f:
                content = f.read()
                
            content = re.sub(
                r'@define-color accent_color #[0-9A-Fa-f]{6};',
                f'@define-color accent_color {color.color};',
                content
            )
            content = re.sub(
                r'@define-color accent_hover #[0-9A-Fa-f]{6};',
                f'@define-color accent_hover {color.hover};',
                content
            )
            content = re.sub(
                r'@define-color accent_active #[0-9A-Fa-f]{6};',
                f'@define-color accent_active {color.active};',
                content
            )
            
            with open(css_path, 'w') as f:
                f.write(content)
        except Exception as e:
            print(f"Error updating CSS: {e}")
            
    def apply_font_size(self, size: int) -> bool:
        """Apply font size setting"""
        try:
            subprocess.run([
                'xfconf-query', '-c', 'xsettings',
                '-p', '/Gtk/FontName', '-s', f'Noto Sans {size}'
            ], capture_output=True)
            
            self.config['font_size'] = size
            self.save_config()
            return True
        except Exception as e:
            print(f"Error applying font size: {e}")
            return False
            
    def apply_layout_preset(self, preset_name: str) -> bool:
        """Apply desktop layout preset"""
        if preset_name not in LAYOUT_PRESETS:
            return False
            
        preset = LAYOUT_PRESETS[preset_name]
        
        try:
            position = 8 if preset.panel_position == "bottom" else 4
            subprocess.run([
                'xfconf-query', '-c', 'xfce4-panel',
                '-p', '/panels/panel-1/position', '-s', f'p={position};x=0;y=0'
            ], capture_output=True)
            
            subprocess.run([
                'xfconf-query', '-c', 'xfce4-panel',
                '-p', '/panels/panel-1/size', '-s', str(preset.panel_size)
            ], capture_output=True)
            
            subprocess.run([
                'xfconf-query', '-c', 'xfwm4',
                '-p', '/general/button_layout', '-s', preset.window_buttons
            ], capture_output=True)
            
            self.config['layout_preset'] = preset_name
            self.save_config()
            return True
        except Exception as e:
            print(f"Error applying layout preset: {e}")
            return False
            
    def _reload_gtk(self):
        """Reload GTK settings"""
        try:
            subprocess.run(['xfce4-panel', '--restart'], capture_output=True)
        except Exception:
            pass
            
    def create_backup(self) -> Optional[str]:
        """Create backup of current theme settings"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_path = BACKUP_DIR / f"backup_{timestamp}.json"
        
        try:
            backup_data = {
                "timestamp": timestamp,
                "config": self.config.copy(),
                "xfce_settings": self._get_xfce_settings()
            }
            
            with open(backup_path, 'w') as f:
                json.dump(backup_data, f, indent=2)
                
            self.config['last_backup'] = str(backup_path)
            self.save_config()
            return str(backup_path)
        except Exception as e:
            print(f"Error creating backup: {e}")
            return None
            
    def _get_xfce_settings(self) -> Dict:
        """Get current XFCE settings"""
        settings = {}
        channels = ['xsettings', 'xfwm4', 'xfce4-panel', 'xfce4-desktop']
        
        for channel in channels:
            try:
                result = subprocess.run([
                    'xfconf-query', '-c', channel, '-l', '-v'
                ], capture_output=True, text=True)
                if result.returncode == 0:
                    settings[channel] = result.stdout
            except Exception:
                pass
                
        return settings
        
    def restore_backup(self, backup_path: str) -> bool:
        """Restore settings from backup"""
        try:
            with open(backup_path, 'r') as f:
                backup_data = json.load(f)
                
            if 'config' in backup_data:
                self.config.update(backup_data['config'])
                self.save_config()
                
                if 'current_theme' in self.config:
                    self.apply_gtk_theme(self.config['current_theme'])
                    
            return True
        except Exception as e:
            print(f"Error restoring backup: {e}")
            return False


class ThemeManagerWindow(Gtk.ApplicationWindow):
    """Main application window"""
    
    def __init__(self, app):
        super().__init__(application=app, title=APP_NAME)
        self.set_default_size(700, 550)
        self.set_position(Gtk.WindowPosition.CENTER)
        self.set_resizable(True)
        
        self.manager = ThemeManager()
        self._setup_header_bar()
        self._setup_ui()
        self._apply_custom_css()
        
    def _setup_header_bar(self):
        """Setup header bar"""
        header = Gtk.HeaderBar()
        header.set_show_close_button(True)
        header.set_title(APP_NAME)
        header.set_subtitle("Aegis OS")
        
        try:
            icon_path = Path("/usr/share/pixmaps/aegis-logo-128.png")
            if icon_path.exists():
                pixbuf = GdkPixbuf.Pixbuf.new_from_file_at_scale(
                    str(icon_path), 24, 24, True
                )
                icon = Gtk.Image.new_from_pixbuf(pixbuf)
                header.pack_start(icon)
        except Exception:
            pass
            
        about_btn = Gtk.Button.new_from_icon_name("help-about-symbolic", Gtk.IconSize.BUTTON)
        about_btn.set_tooltip_text("About")
        about_btn.connect("clicked", self._on_about_clicked)
        header.pack_end(about_btn)
        
        self.set_titlebar(header)
        
    def _setup_ui(self):
        """Setup main UI"""
        main_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        self.add(main_box)
        
        notebook = Gtk.Notebook()
        notebook.set_tab_pos(Gtk.PositionType.LEFT)
        main_box.pack_start(notebook, True, True, 0)
        
        notebook.append_page(
            self._create_themes_page(),
            self._create_tab_label("Themes", "preferences-desktop-theme-symbolic")
        )
        
        notebook.append_page(
            self._create_colors_page(),
            self._create_tab_label("Colors", "preferences-color-symbolic")
        )
        
        notebook.append_page(
            self._create_fonts_page(),
            self._create_tab_label("Fonts", "preferences-desktop-font-symbolic")
        )
        
        notebook.append_page(
            self._create_layout_page(),
            self._create_tab_label("Layout", "preferences-desktop-display-symbolic")
        )
        
        notebook.append_page(
            self._create_backup_page(),
            self._create_tab_label("Backup", "document-save-symbolic")
        )
        
    def _create_tab_label(self, text: str, icon_name: str) -> Gtk.Box:
        """Create a tab label with icon"""
        box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=8)
        box.set_margin_start(8)
        box.set_margin_end(8)
        box.set_margin_top(12)
        box.set_margin_bottom(12)
        
        icon = Gtk.Image.new_from_icon_name(icon_name, Gtk.IconSize.BUTTON)
        box.pack_start(icon, False, False, 0)
        
        label = Gtk.Label(label=text)
        label.set_xalign(0)
        box.pack_start(label, True, True, 0)
        
        box.show_all()
        return box
        
    def _create_themes_page(self) -> Gtk.ScrolledWindow:
        """Create themes selection page"""
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        
        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        box.set_margin_start(24)
        box.set_margin_end(24)
        box.set_margin_top(24)
        box.set_margin_bottom(24)
        scroll.add(box)
        
        title = Gtk.Label()
        title.set_markup("<span size='x-large' weight='bold'>Theme Selection</span>")
        title.set_xalign(0)
        box.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label(label="Choose your preferred theme variant")
        subtitle.set_xalign(0)
        subtitle.get_style_context().add_class("dim-label")
        box.pack_start(subtitle, False, False, 0)
        
        dark_frame = Gtk.Frame()
        dark_frame.set_shadow_type(Gtk.ShadowType.NONE)
        dark_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=16)
        dark_box.set_margin_start(12)
        dark_box.set_margin_end(12)
        dark_box.set_margin_top(16)
        dark_box.set_margin_bottom(16)
        
        dark_label_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=4)
        dark_title = Gtk.Label()
        dark_title.set_markup("<b>Dark Mode</b>")
        dark_title.set_xalign(0)
        dark_label_box.pack_start(dark_title, False, False, 0)
        
        dark_desc = Gtk.Label(label="Switch to dark theme for reduced eye strain")
        dark_desc.set_xalign(0)
        dark_desc.get_style_context().add_class("dim-label")
        dark_label_box.pack_start(dark_desc, False, False, 0)
        
        dark_box.pack_start(dark_label_box, True, True, 0)
        
        self.dark_switch = Gtk.Switch()
        self.dark_switch.set_active(self.manager.config.get('dark_mode', False))
        self.dark_switch.connect("notify::active", self._on_dark_mode_toggled)
        self.dark_switch.set_valign(Gtk.Align.CENTER)
        dark_box.pack_end(self.dark_switch, False, False, 0)
        
        dark_frame.add(dark_box)
        box.pack_start(dark_frame, False, False, 8)
        
        themes_label = Gtk.Label()
        themes_label.set_markup("<b>Available Themes</b>")
        themes_label.set_xalign(0)
        themes_label.set_margin_top(16)
        box.pack_start(themes_label, False, False, 0)
        
        themes_list = Gtk.ListBox()
        themes_list.set_selection_mode(Gtk.SelectionMode.SINGLE)
        themes_list.get_style_context().add_class("boxed-list")
        
        for theme in self.manager.get_available_themes():
            row = Gtk.ListBoxRow()
            row_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
            row_box.set_margin_start(12)
            row_box.set_margin_end(12)
            row_box.set_margin_top(8)
            row_box.set_margin_bottom(8)
            
            theme_label = Gtk.Label(label=theme)
            theme_label.set_xalign(0)
            row_box.pack_start(theme_label, True, True, 0)
            
            if theme == self.manager.config.get('current_theme'):
                check = Gtk.Image.new_from_icon_name("object-select-symbolic", Gtk.IconSize.BUTTON)
                row_box.pack_end(check, False, False, 0)
                
            row.add(row_box)
            row.theme_name = theme
            themes_list.add(row)
            
        themes_list.connect("row-activated", self._on_theme_selected)
        box.pack_start(themes_list, False, False, 0)
        
        icons_label = Gtk.Label()
        icons_label.set_markup("<b>Icon Themes</b>")
        icons_label.set_xalign(0)
        icons_label.set_margin_top(16)
        box.pack_start(icons_label, False, False, 0)
        
        icons_combo = Gtk.ComboBoxText()
        for icon_theme in self.manager.get_available_icon_themes():
            icons_combo.append_text(icon_theme)
        icons_combo.connect("changed", self._on_icon_theme_changed)
        box.pack_start(icons_combo, False, False, 0)
        
        return scroll
        
    def _create_colors_page(self) -> Gtk.ScrolledWindow:
        """Create accent colors page"""
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        
        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        box.set_margin_start(24)
        box.set_margin_end(24)
        box.set_margin_top(24)
        box.set_margin_bottom(24)
        scroll.add(box)
        
        title = Gtk.Label()
        title.set_markup("<span size='x-large' weight='bold'>Accent Colors</span>")
        title.set_xalign(0)
        box.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label(label="Choose your accent color for buttons, links, and highlights")
        subtitle.set_xalign(0)
        subtitle.get_style_context().add_class("dim-label")
        box.pack_start(subtitle, False, False, 0)
        
        colors_grid = Gtk.Grid()
        colors_grid.set_row_spacing(12)
        colors_grid.set_column_spacing(12)
        colors_grid.set_margin_top(16)
        
        current_accent = self.manager.config.get('accent_color', '#0078D7')
        
        for i, accent in enumerate(PRESET_ACCENTS):
            row = i // 3
            col = i % 3
            
            color_btn = Gtk.Button()
            color_btn.set_size_request(120, 60)
            color_btn.set_relief(Gtk.ReliefStyle.NONE)
            
            btn_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=4)
            btn_box.set_halign(Gtk.Align.CENTER)
            btn_box.set_valign(Gtk.Align.CENTER)
            
            color_area = Gtk.DrawingArea()
            color_area.set_size_request(80, 30)
            
            rgba = Gdk.RGBA()
            rgba.parse(accent.color)
            
            def draw_color(widget, cr, color=accent.color):
                rgba = Gdk.RGBA()
                rgba.parse(color)
                cr.set_source_rgba(rgba.red, rgba.green, rgba.blue, 1.0)
                cr.rectangle(0, 0, widget.get_allocated_width(), widget.get_allocated_height())
                cr.fill()
                
                if color == current_accent:
                    cr.set_source_rgba(1, 1, 1, 0.9)
                    cr.arc(widget.get_allocated_width() / 2, 
                           widget.get_allocated_height() / 2, 
                           8, 0, 2 * 3.14159)
                    cr.fill()
                    
            color_area.connect("draw", draw_color)
            btn_box.pack_start(color_area, False, False, 0)
            
            name_label = Gtk.Label(label=accent.name)
            name_label.set_max_width_chars(12)
            name_label.set_ellipsize(3)
            btn_box.pack_start(name_label, False, False, 0)
            
            color_btn.add(btn_box)
            color_btn.connect("clicked", self._on_accent_selected, accent)
            
            colors_grid.attach(color_btn, col, row, 1, 1)
            
        box.pack_start(colors_grid, False, False, 0)
        
        custom_label = Gtk.Label()
        custom_label.set_markup("<b>Custom Color</b>")
        custom_label.set_xalign(0)
        custom_label.set_margin_top(24)
        box.pack_start(custom_label, False, False, 0)
        
        custom_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
        
        self.color_button = Gtk.ColorButton()
        rgba = Gdk.RGBA()
        rgba.parse(current_accent)
        self.color_button.set_rgba(rgba)
        self.color_button.connect("color-set", self._on_custom_color_set)
        custom_box.pack_start(self.color_button, False, False, 0)
        
        apply_custom_btn = Gtk.Button(label="Apply Custom Color")
        apply_custom_btn.get_style_context().add_class("suggested-action")
        apply_custom_btn.connect("clicked", self._on_apply_custom_color)
        custom_box.pack_start(apply_custom_btn, False, False, 0)
        
        box.pack_start(custom_box, False, False, 0)
        
        return scroll
        
    def _create_fonts_page(self) -> Gtk.ScrolledWindow:
        """Create fonts settings page"""
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        
        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        box.set_margin_start(24)
        box.set_margin_end(24)
        box.set_margin_top(24)
        box.set_margin_bottom(24)
        scroll.add(box)
        
        title = Gtk.Label()
        title.set_markup("<span size='x-large' weight='bold'>Font Settings</span>")
        title.set_xalign(0)
        box.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label(label="Adjust font size for better readability")
        subtitle.set_xalign(0)
        subtitle.get_style_context().add_class("dim-label")
        box.pack_start(subtitle, False, False, 0)
        
        size_frame = Gtk.Frame()
        size_frame.set_shadow_type(Gtk.ShadowType.NONE)
        size_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=12)
        size_box.set_margin_start(12)
        size_box.set_margin_end(12)
        size_box.set_margin_top(16)
        size_box.set_margin_bottom(16)
        
        size_label = Gtk.Label()
        size_label.set_markup("<b>Font Size</b>")
        size_label.set_xalign(0)
        size_box.pack_start(size_label, False, False, 0)
        
        current_size = self.manager.config.get('font_size', 10)
        
        self.font_size_scale = Gtk.Scale.new_with_range(
            Gtk.Orientation.HORIZONTAL, 8, 16, 1
        )
        self.font_size_scale.set_value(current_size)
        self.font_size_scale.set_draw_value(True)
        self.font_size_scale.set_value_pos(Gtk.PositionType.RIGHT)
        self.font_size_scale.add_mark(8, Gtk.PositionType.BOTTOM, "Small")
        self.font_size_scale.add_mark(10, Gtk.PositionType.BOTTOM, "Default")
        self.font_size_scale.add_mark(12, Gtk.PositionType.BOTTOM, "Medium")
        self.font_size_scale.add_mark(14, Gtk.PositionType.BOTTOM, "Large")
        self.font_size_scale.add_mark(16, Gtk.PositionType.BOTTOM, "Larger")
        size_box.pack_start(self.font_size_scale, False, False, 0)
        
        preview_label = Gtk.Label()
        preview_label.set_markup("<b>Preview</b>")
        preview_label.set_xalign(0)
        preview_label.set_margin_top(16)
        size_box.pack_start(preview_label, False, False, 0)
        
        self.preview_text = Gtk.Label()
        self.preview_text.set_text("The quick brown fox jumps over the lazy dog.\nAaBbCcDdEeFfGg 0123456789")
        self.preview_text.set_xalign(0)
        self._update_font_preview(current_size)
        size_box.pack_start(self.preview_text, False, False, 0)
        
        self.font_size_scale.connect("value-changed", self._on_font_size_changed)
        
        size_frame.add(size_box)
        box.pack_start(size_frame, False, False, 8)
        
        apply_btn = Gtk.Button(label="Apply Font Settings")
        apply_btn.get_style_context().add_class("suggested-action")
        apply_btn.connect("clicked", self._on_apply_font_settings)
        box.pack_start(apply_btn, False, False, 16)
        
        return scroll
        
    def _create_layout_page(self) -> Gtk.ScrolledWindow:
        """Create desktop layout presets page"""
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        
        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        box.set_margin_start(24)
        box.set_margin_end(24)
        box.set_margin_top(24)
        box.set_margin_bottom(24)
        scroll.add(box)
        
        title = Gtk.Label()
        title.set_markup("<span size='x-large' weight='bold'>Desktop Layout</span>")
        title.set_xalign(0)
        box.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label(label="Choose a familiar desktop layout preset")
        subtitle.set_xalign(0)
        subtitle.get_style_context().add_class("dim-label")
        box.pack_start(subtitle, False, False, 0)
        
        current_layout = self.manager.config.get('layout_preset', 'windows10')
        
        presets_list = Gtk.ListBox()
        presets_list.set_selection_mode(Gtk.SelectionMode.SINGLE)
        presets_list.get_style_context().add_class("boxed-list")
        
        for preset_id, preset in LAYOUT_PRESETS.items():
            row = Gtk.ListBoxRow()
            row_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
            row_box.set_margin_start(12)
            row_box.set_margin_end(12)
            row_box.set_margin_top(12)
            row_box.set_margin_bottom(12)
            
            info_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=4)
            
            name_label = Gtk.Label()
            name_label.set_markup(f"<b>{preset.name}</b>")
            name_label.set_xalign(0)
            info_box.pack_start(name_label, False, False, 0)
            
            desc_label = Gtk.Label(label=preset.description)
            desc_label.set_xalign(0)
            desc_label.get_style_context().add_class("dim-label")
            info_box.pack_start(desc_label, False, False, 0)
            
            row_box.pack_start(info_box, True, True, 0)
            
            if preset_id == current_layout:
                check = Gtk.Image.new_from_icon_name("object-select-symbolic", Gtk.IconSize.BUTTON)
                row_box.pack_end(check, False, False, 0)
                
            row.add(row_box)
            row.preset_id = preset_id
            presets_list.add(row)
            
        presets_list.connect("row-activated", self._on_layout_selected)
        box.pack_start(presets_list, False, False, 0)
        
        apply_btn = Gtk.Button(label="Apply Layout")
        apply_btn.get_style_context().add_class("suggested-action")
        apply_btn.connect("clicked", self._on_apply_layout)
        box.pack_start(apply_btn, False, False, 16)
        
        note_label = Gtk.Label()
        note_label.set_markup(
            "<i>Note: Some layout changes may require logging out and back in to take full effect.</i>"
        )
        note_label.set_xalign(0)
        note_label.get_style_context().add_class("dim-label")
        note_label.set_line_wrap(True)
        box.pack_start(note_label, False, False, 0)
        
        return scroll
        
    def _create_backup_page(self) -> Gtk.ScrolledWindow:
        """Create backup/restore page"""
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        
        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=16)
        box.set_margin_start(24)
        box.set_margin_end(24)
        box.set_margin_top(24)
        box.set_margin_bottom(24)
        scroll.add(box)
        
        title = Gtk.Label()
        title.set_markup("<span size='x-large' weight='bold'>Backup &amp; Restore</span>")
        title.set_xalign(0)
        box.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label(label="Save and restore your theme settings")
        subtitle.set_xalign(0)
        subtitle.get_style_context().add_class("dim-label")
        box.pack_start(subtitle, False, False, 0)
        
        backup_btn = Gtk.Button(label="Create Backup")
        backup_btn.get_style_context().add_class("suggested-action")
        backup_btn.connect("clicked", self._on_create_backup)
        box.pack_start(backup_btn, False, False, 8)
        
        last_backup = self.manager.config.get('last_backup')
        if last_backup:
            last_backup_label = Gtk.Label()
            last_backup_label.set_markup(f"<i>Last backup: {Path(last_backup).name}</i>")
            last_backup_label.set_xalign(0)
            last_backup_label.get_style_context().add_class("dim-label")
            box.pack_start(last_backup_label, False, False, 0)
            
        restore_label = Gtk.Label()
        restore_label.set_markup("<b>Available Backups</b>")
        restore_label.set_xalign(0)
        restore_label.set_margin_top(16)
        box.pack_start(restore_label, False, False, 0)
        
        backups_list = Gtk.ListBox()
        backups_list.set_selection_mode(Gtk.SelectionMode.SINGLE)
        backups_list.get_style_context().add_class("boxed-list")
        
        if BACKUP_DIR.exists():
            for backup_file in sorted(BACKUP_DIR.glob("backup_*.json"), reverse=True)[:10]:
                row = Gtk.ListBoxRow()
                row_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
                row_box.set_margin_start(12)
                row_box.set_margin_end(12)
                row_box.set_margin_top(8)
                row_box.set_margin_bottom(8)
                
                file_label = Gtk.Label(label=backup_file.name)
                file_label.set_xalign(0)
                row_box.pack_start(file_label, True, True, 0)
                
                row.add(row_box)
                row.backup_path = str(backup_file)
                backups_list.add(row)
                
        self.backups_list = backups_list
        box.pack_start(backups_list, False, False, 0)
        
        restore_btn = Gtk.Button(label="Restore Selected Backup")
        restore_btn.connect("clicked", self._on_restore_backup)
        box.pack_start(restore_btn, False, False, 8)
        
        reset_frame = Gtk.Frame()
        reset_frame.set_shadow_type(Gtk.ShadowType.NONE)
        reset_frame.set_margin_top(24)
        
        reset_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=8)
        reset_box.set_margin_start(12)
        reset_box.set_margin_end(12)
        reset_box.set_margin_top(12)
        reset_box.set_margin_bottom(12)
        
        reset_label = Gtk.Label()
        reset_label.set_markup("<b>Reset to Defaults</b>")
        reset_label.set_xalign(0)
        reset_box.pack_start(reset_label, False, False, 0)
        
        reset_desc = Gtk.Label(label="Reset all theme settings to default values")
        reset_desc.set_xalign(0)
        reset_desc.get_style_context().add_class("dim-label")
        reset_box.pack_start(reset_desc, False, False, 0)
        
        reset_btn = Gtk.Button(label="Reset to Defaults")
        reset_btn.get_style_context().add_class("destructive-action")
        reset_btn.connect("clicked", self._on_reset_defaults)
        reset_box.pack_start(reset_btn, False, False, 8)
        
        reset_frame.add(reset_box)
        box.pack_start(reset_frame, False, False, 0)
        
        return scroll
        
    def _apply_custom_css(self):
        """Apply custom CSS styling to the application"""
        css = b"""
        .boxed-list {
            border: 1px solid @borders;
            border-radius: 6px;
            background: @theme_base_color;
        }
        
        .boxed-list row {
            border-bottom: 1px solid alpha(@borders, 0.5);
        }
        
        .boxed-list row:last-child {
            border-bottom: none;
        }
        """
        
        style_provider = Gtk.CssProvider()
        style_provider.load_from_data(css)
        
        Gtk.StyleContext.add_provider_for_screen(
            Gdk.Screen.get_default(),
            style_provider,
            Gtk.STYLE_PROVIDER_PRIORITY_APPLICATION
        )
        
    def _update_font_preview(self, size: int):
        """Update font preview with new size"""
        self.preview_text.modify_font(
            None
        )
        css = f"label {{ font-size: {size}pt; }}"
        style_provider = Gtk.CssProvider()
        style_provider.load_from_data(css.encode())
        self.preview_text.get_style_context().add_provider(
            style_provider,
            Gtk.STYLE_PROVIDER_PRIORITY_APPLICATION
        )
        
    def _on_dark_mode_toggled(self, switch, gparam):
        """Handle dark mode toggle"""
        enabled = switch.get_active()
        if self.manager.toggle_dark_mode(enabled):
            self._show_notification("Theme changed", 
                "Dark mode enabled" if enabled else "Light mode enabled")
                
    def _on_theme_selected(self, listbox, row):
        """Handle theme selection"""
        if hasattr(row, 'theme_name'):
            if self.manager.apply_gtk_theme(row.theme_name):
                self._show_notification("Theme applied", f"Applied {row.theme_name}")
                
    def _on_icon_theme_changed(self, combo):
        """Handle icon theme change"""
        theme = combo.get_active_text()
        if theme:
            self.manager.apply_icon_theme(theme)
            
    def _on_accent_selected(self, button, accent: AccentColor):
        """Handle accent color selection"""
        if self.manager.apply_accent_color(accent):
            self._show_notification("Accent color changed", f"Applied {accent.name}")
            
    def _on_custom_color_set(self, button):
        """Handle custom color selection"""
        pass
        
    def _on_apply_custom_color(self, button):
        """Apply custom color from color picker"""
        rgba = self.color_button.get_rgba()
        hex_color = "#{:02x}{:02x}{:02x}".format(
            int(rgba.red * 255),
            int(rgba.green * 255),
            int(rgba.blue * 255)
        )
        
        def lighten(color, amount=0.1):
            r = min(255, int(int(color[1:3], 16) * (1 + amount)))
            g = min(255, int(int(color[3:5], 16) * (1 + amount)))
            b = min(255, int(int(color[5:7], 16) * (1 + amount)))
            return f"#{r:02x}{g:02x}{b:02x}"
            
        def darken(color, amount=0.1):
            r = max(0, int(int(color[1:3], 16) * (1 - amount)))
            g = max(0, int(int(color[3:5], 16) * (1 - amount)))
            b = max(0, int(int(color[5:7], 16) * (1 - amount)))
            return f"#{r:02x}{g:02x}{b:02x}"
            
        custom_accent = AccentColor(
            "Custom",
            hex_color,
            lighten(hex_color),
            darken(hex_color)
        )
        
        if self.manager.apply_accent_color(custom_accent):
            self._show_notification("Custom color applied", f"Applied {hex_color}")
            
    def _on_font_size_changed(self, scale):
        """Handle font size slider change"""
        size = int(scale.get_value())
        self._update_font_preview(size)
        
    def _on_apply_font_settings(self, button):
        """Apply font settings"""
        size = int(self.font_size_scale.get_value())
        if self.manager.apply_font_size(size):
            self._show_notification("Font settings applied", f"Font size set to {size}pt")
            
    def _on_layout_selected(self, listbox, row):
        """Handle layout preset selection"""
        if hasattr(row, 'preset_id'):
            listbox.selected_preset = row.preset_id
            
    def _on_apply_layout(self, button):
        """Apply selected layout preset"""
        listbox = button.get_parent().get_children()[3]
        row = listbox.get_selected_row()
        if row and hasattr(row, 'preset_id'):
            if self.manager.apply_layout_preset(row.preset_id):
                preset = LAYOUT_PRESETS[row.preset_id]
                self._show_notification("Layout applied", f"Applied {preset.name} layout")
                
    def _on_create_backup(self, button):
        """Create a new backup"""
        backup_path = self.manager.create_backup()
        if backup_path:
            self._show_notification("Backup created", f"Saved to {Path(backup_path).name}")
        else:
            self._show_notification("Backup failed", "Could not create backup")
            
    def _on_restore_backup(self, button):
        """Restore selected backup"""
        row = self.backups_list.get_selected_row()
        if row and hasattr(row, 'backup_path'):
            dialog = Gtk.MessageDialog(
                transient_for=self,
                flags=0,
                message_type=Gtk.MessageType.QUESTION,
                buttons=Gtk.ButtonsType.YES_NO,
                text="Restore backup?"
            )
            dialog.format_secondary_text(
                f"This will restore settings from {Path(row.backup_path).name}. "
                "Current settings will be overwritten."
            )
            response = dialog.run()
            dialog.destroy()
            
            if response == Gtk.ResponseType.YES:
                if self.manager.restore_backup(row.backup_path):
                    self._show_notification("Backup restored", "Settings restored successfully")
                else:
                    self._show_notification("Restore failed", "Could not restore backup")
                    
    def _on_reset_defaults(self, button):
        """Reset to default settings"""
        dialog = Gtk.MessageDialog(
            transient_for=self,
            flags=0,
            message_type=Gtk.MessageType.WARNING,
            buttons=Gtk.ButtonsType.YES_NO,
            text="Reset to defaults?"
        )
        dialog.format_secondary_text(
            "This will reset all theme settings to their default values. "
            "This action cannot be undone."
        )
        response = dialog.run()
        dialog.destroy()
        
        if response == Gtk.ResponseType.YES:
            self.manager.apply_gtk_theme("Aegis-Win10")
            self.manager.toggle_dark_mode(False)
            self.manager.apply_font_size(10)
            self.manager.apply_layout_preset("windows10")
            default_accent = PRESET_ACCENTS[0]
            self.manager.apply_accent_color(default_accent)
            self._show_notification("Settings reset", "All settings restored to defaults")
            
    def _on_about_clicked(self, button):
        """Show about dialog"""
        about = Gtk.AboutDialog(transient_for=self)
        about.set_program_name(APP_NAME)
        about.set_version(VERSION)
        about.set_copyright("Copyright Â© 2024 Aegis OS Team")
        about.set_comments("Windows 10-inspired theme management for Aegis OS")
        about.set_website("https://aegis-os.com")
        about.set_website_label("Aegis OS Website")
        about.set_license_type(Gtk.License.GPL_3_0)
        
        try:
            icon_path = Path("/usr/share/pixmaps/aegis-logo-128.png")
            if icon_path.exists():
                pixbuf = GdkPixbuf.Pixbuf.new_from_file(str(icon_path))
                about.set_logo(pixbuf)
        except Exception:
            pass
            
        about.run()
        about.destroy()
        
    def _show_notification(self, title: str, message: str):
        """Show a notification"""
        try:
            subprocess.run([
                'notify-send',
                '-i', 'preferences-desktop-theme',
                title,
                message
            ], capture_output=True)
        except Exception:
            pass


class ThemeManagerApp(Gtk.Application):
    """Main application class"""
    
    def __init__(self):
        super().__init__(
            application_id=APP_ID,
            flags=Gio.ApplicationFlags.FLAGS_NONE
        )
        
    def do_activate(self):
        """Activate the application"""
        win = ThemeManagerWindow(self)
        win.show_all()
        
    def do_startup(self):
        """Startup the application"""
        Gtk.Application.do_startup(self)


def main():
    """Main entry point"""
    if not GTK_AVAILABLE:
        print("Error: GTK3 required. Install with: sudo pacman -S gtk3 python-gobject", file=sys.stderr)
        sys.exit(1)
        
    app = ThemeManagerApp()
    app.run(sys.argv)


if __name__ == "__main__":
    main()
