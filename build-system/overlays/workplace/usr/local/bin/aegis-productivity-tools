#!/usr/bin/env python3
"""
Aegis Productivity Tools - Time tracking and project management for Workplace edition
Features: Time tracking, project management, CRM integration, calendar sync

Provides GUI (GTK) and CLI modes with tier-based feature gating.
"""

import os
import sys
import json
import subprocess
import logging
import argparse
import webbrowser
from pathlib import Path
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any
from dataclasses import dataclass, asdict

TIER_LIMIT = "workplace"
VERSION = "1.5.0"
APP_NAME = "Aegis Productivity Tools"

CONFIG_FILE = "/etc/aegis/workplace-config.json"
LOG_FILE = "/var/log/aegis/productivity-tools.log"
DATA_DIR = Path.home() / ".config" / "aegis" / "productivity"

try:
    import gi
    gi.require_version('Gtk', '3.0')
    from gi.repository import Gtk, GLib
    GTK_AVAILABLE = True
except ImportError:
    GTK_AVAILABLE = False
    print("Error: GTK3 is required. Install with: sudo pacman -S gtk3 python-gobject", file=sys.stderr)


class LicenseTier:
    FREEMIUM = 1
    BASIC = 2
    WORKPLACE = 3
    GAMER = 4
    SERVER = 5


@dataclass
class TimeEntry:
    id: str
    project: str
    task: str
    start_time: str
    end_time: Optional[str]
    duration_minutes: int
    notes: str


@dataclass
class Project:
    id: str
    name: str
    description: str
    status: str
    created: str
    tasks: List[str]


PROJECT_MANAGEMENT_APPS = {
    "notion": {"name": "Notion", "url": "https://notion.so"},
    "asana": {"name": "Asana", "url": "https://app.asana.com"},
    "trello": {"name": "Trello", "url": "https://trello.com"},
    "monday": {"name": "Monday.com", "url": "https://monday.com"},
    "clickup": {"name": "ClickUp", "url": "https://app.clickup.com"},
    "jira": {"name": "Jira", "url": "https://atlassian.net"}
}


class AegisProductivityTools:
    def __init__(self, headless: bool = False):
        self.headless = headless
        self.version = VERSION
        self.config = {}
        self.license_tier = LicenseTier.FREEMIUM
        self.time_entries: List[TimeEntry] = []
        self.projects: List[Project] = []
        self.current_tracking: Optional[TimeEntry] = None
        
        self.setup_logging()
        self.load_license_tier()
        self.load_config()
        self.load_data()
        
    def setup_logging(self):
        log_dir = Path(LOG_FILE).parent
        try:
            log_dir.mkdir(parents=True, exist_ok=True)
        except PermissionError:
            pass
        
        try:
            logging.basicConfig(
                level=logging.INFO,
                format='%(asctime)s - %(levelname)s - [%(name)s] %(message)s',
                handlers=[
                    logging.FileHandler(LOG_FILE) if os.access(str(log_dir), os.W_OK) else logging.NullHandler(),
                    logging.StreamHandler() if not self.headless else logging.NullHandler()
                ]
            )
        except Exception:
            logging.basicConfig(level=logging.INFO, handlers=[logging.StreamHandler()])
        
        self.logger = logging.getLogger("AegisProductivityTools")
        self.logger.info(f"Starting {APP_NAME} v{VERSION}")
    
    def load_license_tier(self):
        license_file = Path("/etc/aegis/license.json")
        try:
            if license_file.exists():
                with open(license_file, 'r') as f:
                    license_data = json.load(f)
                edition = license_data.get('edition', 'freemium').lower()
                tier_map = {
                    'freemium': LicenseTier.FREEMIUM,
                    'basic': LicenseTier.BASIC,
                    'workplace': LicenseTier.WORKPLACE,
                }
                self.license_tier = tier_map.get(edition, LicenseTier.FREEMIUM)
            else:
                if Path("/etc/aegis-workplace-marker").exists():
                    self.license_tier = LicenseTier.WORKPLACE
        except Exception as e:
            self.logger.warning(f"Failed to load license tier: {e}")
    
    def is_feature_available(self, feature: str) -> bool:
        workplace_features = ["time_tracking", "project_management", "crm", "calendar_sync"]
        if feature in workplace_features:
            return self.license_tier >= LicenseTier.WORKPLACE
        return False
    
    def load_config(self):
        default_config = {
            "time_tracking": True,
            "project_management": True,
            "default_pm_app": "notion"
        }
        
        try:
            if Path(CONFIG_FILE).exists():
                with open(CONFIG_FILE, 'r') as f:
                    file_config = json.load(f)
                    if "features" in file_config and "productivity_tools" in file_config["features"]:
                        self.config = {**default_config, **file_config["features"]["productivity_tools"]}
                    else:
                        self.config = default_config
            else:
                self.config = default_config
        except Exception as e:
            self.logger.error(f"Error loading config: {e}")
            self.config = default_config
    
    def load_data(self):
        try:
            DATA_DIR.mkdir(parents=True, exist_ok=True)
            
            time_file = DATA_DIR / "time_entries.json"
            if time_file.exists():
                with open(time_file, 'r') as f:
                    data = json.load(f)
                    self.time_entries = [TimeEntry(**e) for e in data.get("entries", [])]
            
            projects_file = DATA_DIR / "projects.json"
            if projects_file.exists():
                with open(projects_file, 'r') as f:
                    data = json.load(f)
                    self.projects = [Project(**p) for p in data.get("projects", [])]
        except Exception as e:
            self.logger.error(f"Error loading data: {e}")
    
    def save_data(self):
        try:
            DATA_DIR.mkdir(parents=True, exist_ok=True)
            
            time_file = DATA_DIR / "time_entries.json"
            with open(time_file, 'w') as f:
                json.dump({"entries": [asdict(e) for e in self.time_entries]}, f, indent=2)
            
            projects_file = DATA_DIR / "projects.json"
            with open(projects_file, 'w') as f:
                json.dump({"projects": [asdict(p) for p in self.projects]}, f, indent=2)
        except Exception as e:
            self.logger.error(f"Error saving data: {e}")
    
    def start_time_tracking(self, project: str, task: str) -> Dict[str, Any]:
        if not self.is_feature_available("time_tracking"):
            return {"success": False, "error": "Time tracking requires Workplace edition"}
        
        if self.current_tracking:
            return {"success": False, "error": "Already tracking time"}
        
        entry = TimeEntry(
            id=datetime.now().strftime("%Y%m%d%H%M%S"),
            project=project,
            task=task,
            start_time=datetime.now().isoformat(),
            end_time=None,
            duration_minutes=0,
            notes=""
        )
        self.current_tracking = entry
        self.logger.info(f"Started tracking: {project}/{task}")
        return {"success": True, "entry_id": entry.id}
    
    def stop_time_tracking(self, notes: str = "") -> Dict[str, Any]:
        if not self.current_tracking:
            return {"success": False, "error": "No active tracking"}
        
        end_time = datetime.now()
        start_time = datetime.fromisoformat(self.current_tracking.start_time)
        duration = int((end_time - start_time).total_seconds() / 60)
        
        self.current_tracking.end_time = end_time.isoformat()
        self.current_tracking.duration_minutes = duration
        self.current_tracking.notes = notes
        
        self.time_entries.append(self.current_tracking)
        entry_id = self.current_tracking.id
        self.current_tracking = None
        
        self.save_data()
        self.logger.info(f"Stopped tracking: {duration} minutes")
        return {"success": True, "entry_id": entry_id, "duration_minutes": duration}
    
    def get_time_summary(self, days: int = 7) -> Dict[str, Any]:
        cutoff = datetime.now() - timedelta(days=days)
        recent_entries = [
            e for e in self.time_entries
            if datetime.fromisoformat(e.start_time) > cutoff
        ]
        
        total_minutes = sum(e.duration_minutes for e in recent_entries)
        by_project = {}
        for e in recent_entries:
            if e.project not in by_project:
                by_project[e.project] = 0
            by_project[e.project] += e.duration_minutes
        
        return {
            "period_days": days,
            "total_minutes": total_minutes,
            "total_hours": round(total_minutes / 60, 1),
            "entries_count": len(recent_entries),
            "by_project": by_project
        }
    
    def create_project(self, name: str, description: str = "") -> Dict[str, Any]:
        if not self.is_feature_available("project_management"):
            return {"success": False, "error": "Project management requires Workplace edition"}
        
        project = Project(
            id=datetime.now().strftime("%Y%m%d%H%M%S"),
            name=name,
            description=description,
            status="active",
            created=datetime.now().isoformat(),
            tasks=[]
        )
        self.projects.append(project)
        self.save_data()
        return {"success": True, "project_id": project.id}
    
    def list_projects(self) -> List[Dict[str, Any]]:
        return [asdict(p) for p in self.projects]
    
    def launch_pm_app(self, app_id: str) -> bool:
        if app_id not in PROJECT_MANAGEMENT_APPS:
            return False
        
        app = PROJECT_MANAGEMENT_APPS[app_id]
        try:
            webbrowser.open(app["url"])
            return True
        except Exception:
            return False
    
    def run_gui(self):
        if not GTK_AVAILABLE:
            print("GTK not available. Use --cli mode.")
            return self.run_cli()
        
        win = ProductivityToolsWindow(self)
        win.connect("destroy", Gtk.main_quit)
        win.show_all()
        Gtk.main()
    
    def run_cli(self):
        print(f"\n{'='*60}")
        print(f"  {APP_NAME} v{VERSION}")
        print(f"  License Tier: {'WORKPLACE+' if self.license_tier >= LicenseTier.WORKPLACE else 'LIMITED'}")
        print(f"{'='*60}\n")
        
        summary = self.get_time_summary()
        print(f"Time Summary (Last 7 days):")
        print(f"  Total: {summary['total_hours']} hours ({summary['entries_count']} entries)")
        print(f"  By Project:")
        for project, minutes in summary['by_project'].items():
            print(f"    {project}: {round(minutes/60, 1)} hours")
        
        print(f"\nProjects: {len(self.projects)}")
        for p in self.projects[:5]:
            print(f"  - {p.name} ({p.status})")


if GTK_AVAILABLE:
    class ProductivityToolsWindow(Gtk.Window):
        def __init__(self, app: AegisProductivityTools):
            super().__init__(title=f"{APP_NAME} v{VERSION}")
            self.app = app
            self.set_default_size(800, 600)
            self.set_border_width(10)
            self.setup_ui()
        
        def setup_ui(self):
            vbox = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
            self.add(vbox)
            
            header = Gtk.Label()
            header.set_markup(f"<big><b>{APP_NAME}</b></big>")
            vbox.pack_start(header, False, False, 10)
            
            notebook = Gtk.Notebook()
            vbox.pack_start(notebook, True, True, 0)
            
            notebook.append_page(self.create_time_tab(), Gtk.Label(label="Time Tracking"))
            notebook.append_page(self.create_projects_tab(), Gtk.Label(label="Projects"))
            notebook.append_page(self.create_apps_tab(), Gtk.Label(label="PM Apps"))
        
        def create_time_tab(self):
            box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
            box.set_margin_top(20)
            box.set_margin_start(20)
            
            self.track_btn = Gtk.Button(label="Start Tracking")
            self.track_btn.connect("clicked", self.on_toggle_tracking)
            self.track_btn.set_sensitive(self.app.license_tier >= LicenseTier.WORKPLACE)
            box.pack_start(self.track_btn, False, False, 10)
            
            summary = self.app.get_time_summary()
            summary_label = Gtk.Label(label=f"This week: {summary['total_hours']} hours")
            box.pack_start(summary_label, False, False, 10)
            
            return box
        
        def create_projects_tab(self):
            box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
            box.set_margin_top(20)
            box.set_margin_start(20)
            
            for project in self.app.projects:
                label = Gtk.Label(label=f"{project.name} ({project.status})")
                label.set_xalign(0)
                box.pack_start(label, False, False, 5)
            
            return box
        
        def create_apps_tab(self):
            box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
            box.set_margin_top(20)
            box.set_margin_start(20)
            
            for app_id, app_info in PROJECT_MANAGEMENT_APPS.items():
                hbox = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)
                label = Gtk.Label(label=app_info["name"])
                label.set_xalign(0)
                hbox.pack_start(label, True, True, 10)
                
                btn = Gtk.Button(label="Open")
                btn.connect("clicked", self.on_launch_app, app_id)
                hbox.pack_end(btn, False, False, 10)
                
                box.pack_start(hbox, False, False, 5)
            
            return box
        
        def on_toggle_tracking(self, button):
            if not self.app.current_tracking:
                self.app.start_time_tracking("Default", "Task")
                button.set_label("Stop Tracking")
            else:
                self.app.stop_time_tracking()
                button.set_label("Start Tracking")
        
        def on_launch_app(self, button, app_id):
            self.app.launch_pm_app(app_id)


def main():
    if not GTK_AVAILABLE:
        print(f"Cannot start {APP_NAME}: GTK3 not available.", file=sys.stderr)
        sys.exit(1)
    
    parser = argparse.ArgumentParser(description=f"{APP_NAME}")
    parser.add_argument("--gui", action="store_true", help="Launch GUI mode")
    parser.add_argument("--cli", action="store_true", help="Run in CLI mode")
    parser.add_argument("--start-tracking", nargs=2, metavar=("PROJECT", "TASK"), help="Start time tracking")
    parser.add_argument("--stop-tracking", action="store_true", help="Stop time tracking")
    parser.add_argument("--time-summary", type=int, metavar="DAYS", default=7, help="Get time summary")
    parser.add_argument("--list-projects", action="store_true", help="List projects")
    parser.add_argument("--version", action="version", version=f"{APP_NAME} {VERSION}")
    
    args = parser.parse_args()
    
    if args.start_tracking:
        app = AegisProductivityTools(headless=True)
        result = app.start_time_tracking(args.start_tracking[0], args.start_tracking[1])
        print(json.dumps(result, indent=2))
    elif args.stop_tracking:
        app = AegisProductivityTools(headless=True)
        result = app.stop_time_tracking()
        print(json.dumps(result, indent=2))
    elif args.list_projects:
        app = AegisProductivityTools(headless=True)
        print(json.dumps(app.list_projects(), indent=2))
    elif args.cli or not GTK_AVAILABLE:
        app = AegisProductivityTools(headless=False)
        app.run_cli()
    else:
        app = AegisProductivityTools(headless=False)
        app.run_gui()


if __name__ == "__main__":
    main()
