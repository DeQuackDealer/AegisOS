#!/usr/bin/env python3
"""
Aegis Getting Started - Onboarding wizard for new Aegis OS Basic users
Provides welcome experience, initial setup, feature tour, and help resources.

Version: 1.0.0
Edition: Basic
"""

import os
import sys
import json
import subprocess
import logging
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Optional, Any

VERSION = "1.0.0"
APP_NAME = "Aegis Getting Started"
EDITION = "Basic"

CONFIG_DIR = Path.home() / ".config" / "aegis"
ONBOARDING_STATE_FILE = CONFIG_DIR / "onboarding-state.json"
LOG_FILE = Path("/var/log/aegis/getting-started.log")

try:
    import gi
    gi.require_version('Gtk', '3.0')
    from gi.repository import Gtk, Gdk, GLib, GdkPixbuf, Pango
    GTK_AVAILABLE = True
except ImportError:
    GTK_AVAILABLE = False
    print("Error: GTK3 is required. Install with: sudo pacman -S gtk3 python-gobject", file=sys.stderr)

WELCOME_TEXT = """
Welcome to Aegis OS Basic Edition!

Aegis OS Basic is your productivity powerhouse, designed to help you 
work smarter and create better. This edition includes:

• Full Office Suite - LibreOffice for all your document needs
• Creative Tools - GIMP, Inkscape, and video editors
• Communication - Email, browsers, and video conferencing
• Cloud Storage - Sync your files across devices
• Security - Built-in protection for your data

Let's get you set up and ready to go!
"""

FEATURE_TOUR = [
    {
        "title": "Office Productivity",
        "description": "Create documents, spreadsheets, and presentations with LibreOffice. Fully compatible with Microsoft Office formats.",
        "icon": "libreoffice-startcenter",
        "apps": ["libreoffice-writer", "libreoffice-calc", "libreoffice-impress"]
    },
    {
        "title": "Web Browsing & Email",
        "description": "Firefox and Chromium for web browsing. Thunderbird for email management with calendar integration.",
        "icon": "web-browser",
        "apps": ["firefox", "chromium-browser", "thunderbird"]
    },
    {
        "title": "Creative Suite",
        "description": "Edit photos with GIMP, create vector graphics with Inkscape, and edit videos with Kdenlive.",
        "icon": "applications-graphics",
        "apps": ["gimp", "inkscape", "kdenlive"]
    },
    {
        "title": "Cloud & Sync",
        "description": "Keep your files synchronized with Nextcloud, Syncthing, and other cloud storage clients.",
        "icon": "folder-cloud",
        "apps": ["nextcloud-desktop", "syncthing-gtk"]
    },
    {
        "title": "System Tools",
        "description": "Manage your system with backup tools, disk utilities, and the Aegis System Care utility.",
        "icon": "preferences-system",
        "apps": ["aegis-system-care", "aegis-backup-suite", "gparted"]
    },
    {
        "title": "Security",
        "description": "Stay protected with ClamAV antivirus, UFW firewall, and encrypted storage options.",
        "icon": "security-high",
        "apps": ["aegis-security-suite", "gufw"]
    }
]

HELP_RESOURCES = [
    {"name": "Aegis OS Documentation", "url": "https://docs.aegis-os.com"},
    {"name": "Community Forums", "url": "https://community.aegis-os.com"},
    {"name": "Video Tutorials", "url": "https://learn.aegis-os.com"},
    {"name": "Support Portal", "url": "https://support.aegis-os.com"},
    {"name": "Report Issues", "url": "https://github.com/aegis-os/issues"}
]


class OnboardingState:
    def __init__(self):
        self.state = {
            "completed": False,
            "current_step": 0,
            "first_run": True,
            "setup_date": None,
            "preferences": {
                "theme": "default",
                "show_tips": True,
                "auto_updates": True
            },
            "accounts_configured": [],
            "features_explored": []
        }
        self.load()
    
    def load(self):
        try:
            if ONBOARDING_STATE_FILE.exists():
                with open(ONBOARDING_STATE_FILE, 'r') as f:
                    saved_state = json.load(f)
                    self.state.update(saved_state)
        except Exception:
            pass
    
    def save(self):
        try:
            CONFIG_DIR.mkdir(parents=True, exist_ok=True)
            with open(ONBOARDING_STATE_FILE, 'w') as f:
                json.dump(self.state, f, indent=2)
        except Exception:
            pass
    
    def mark_completed(self):
        self.state["completed"] = True
        self.state["setup_date"] = datetime.now().isoformat()
        self.state["first_run"] = False
        self.save()
    
    def set_preference(self, key: str, value: Any):
        self.state["preferences"][key] = value
        self.save()
    
    def add_configured_account(self, account_type: str):
        if account_type not in self.state["accounts_configured"]:
            self.state["accounts_configured"].append(account_type)
            self.save()
    
    def mark_feature_explored(self, feature: str):
        if feature not in self.state["features_explored"]:
            self.state["features_explored"].append(feature)
            self.save()


class SetupWizard:
    def __init__(self):
        self.state = OnboardingState()
        self.setup_logging()
    
    def setup_logging(self):
        try:
            LOG_FILE.parent.mkdir(parents=True, exist_ok=True)
            logging.basicConfig(
                level=logging.INFO,
                format='%(asctime)s - %(levelname)s - %(message)s',
                handlers=[
                    logging.FileHandler(LOG_FILE) if os.access(str(LOG_FILE.parent), os.W_OK) else logging.NullHandler()
                ]
            )
        except Exception:
            logging.basicConfig(level=logging.INFO)
        self.logger = logging.getLogger("AegisGettingStarted")
    
    def run_cli(self):
        print("\n" + "=" * 60)
        print(f"  Welcome to {APP_NAME}")
        print(f"  Aegis OS {EDITION} Edition")
        print("=" * 60)
        print(WELCOME_TEXT)
        
        if self.state.state["completed"]:
            print(f"\n✓ Setup completed on: {self.state.state['setup_date']}")
            print("\nWould you like to run the setup again? (y/n): ", end="")
            response = input().strip().lower()
            if response != 'y':
                self.show_help_resources_cli()
                return
        
        print("\n--- Initial Setup ---\n")
        
        print("1. Configure your preferences:")
        print("   Enable automatic updates? (y/n): ", end="")
        auto_updates = input().strip().lower() == 'y'
        self.state.set_preference("auto_updates", auto_updates)
        
        print("   Show daily tips? (y/n): ", end="")
        show_tips = input().strip().lower() == 'y'
        self.state.set_preference("show_tips", show_tips)
        
        print("\n2. Feature Tour:")
        for i, feature in enumerate(FEATURE_TOUR, 1):
            print(f"\n   [{i}] {feature['title']}")
            print(f"       {feature['description']}")
            print(f"       Apps: {', '.join(feature['apps'])}")
            self.state.mark_feature_explored(feature['title'])
        
        print("\n3. Configure accounts (optional):")
        print("   Would you like to set up email? (y/n): ", end="")
        if input().strip().lower() == 'y':
            print("   Launching Thunderbird...")
            self.launch_app("thunderbird")
            self.state.add_configured_account("email")
        
        print("   Would you like to set up cloud storage? (y/n): ", end="")
        if input().strip().lower() == 'y':
            print("   Launching Nextcloud client...")
            self.launch_app("nextcloud")
            self.state.add_configured_account("cloud_storage")
        
        self.show_help_resources_cli()
        
        self.state.mark_completed()
        print("\n✓ Setup complete! Enjoy using Aegis OS Basic!")
        print("  Run 'aegis-getting-started' anytime to access help resources.\n")
    
    def show_help_resources_cli(self):
        print("\n--- Help Resources ---\n")
        for resource in HELP_RESOURCES:
            print(f"  • {resource['name']}: {resource['url']}")
    
    def launch_app(self, app: str) -> bool:
        try:
            subprocess.Popen([app], start_new_session=True, 
                           stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            return True
        except Exception:
            return False


if GTK_AVAILABLE:
    class WelcomePage(Gtk.Box):
        def __init__(self, wizard):
            super().__init__(orientation=Gtk.Orientation.VERTICAL, spacing=20)
            self.wizard = wizard
            self.set_margin_top(40)
            self.set_margin_bottom(20)
            self.set_margin_start(40)
            self.set_margin_end(40)
            
            title = Gtk.Label()
            title.set_markup(f"<span size='xx-large' weight='bold'>Welcome to Aegis OS {EDITION}!</span>")
            self.pack_start(title, False, False, 0)
            
            subtitle = Gtk.Label()
            subtitle.set_markup("<span size='large'>Your productivity-focused Linux experience</span>")
            subtitle.set_margin_top(10)
            self.pack_start(subtitle, False, False, 0)
            
            desc = Gtk.Label()
            desc.set_text(WELCOME_TEXT.strip())
            desc.set_line_wrap(True)
            desc.set_max_width_chars(60)
            desc.set_justify(Gtk.Justification.CENTER)
            desc.set_margin_top(20)
            self.pack_start(desc, False, False, 0)
    
    class PreferencesPage(Gtk.Box):
        def __init__(self, wizard):
            super().__init__(orientation=Gtk.Orientation.VERTICAL, spacing=15)
            self.wizard = wizard
            self.set_margin_top(30)
            self.set_margin_start(40)
            self.set_margin_end(40)
            
            title = Gtk.Label()
            title.set_markup("<span size='x-large' weight='bold'>Initial Setup</span>")
            title.set_xalign(0)
            self.pack_start(title, False, False, 0)
            
            subtitle = Gtk.Label()
            subtitle.set_markup("Configure your preferences to get started")
            subtitle.set_xalign(0)
            self.pack_start(subtitle, False, False, 10)
            
            self.auto_updates_check = Gtk.CheckButton(label="Enable automatic system updates")
            self.auto_updates_check.set_active(True)
            self.pack_start(self.auto_updates_check, False, False, 5)
            
            self.tips_check = Gtk.CheckButton(label="Show daily productivity tips")
            self.tips_check.set_active(True)
            self.pack_start(self.tips_check, False, False, 5)
            
            theme_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)
            theme_label = Gtk.Label(label="Theme preference:")
            theme_box.pack_start(theme_label, False, False, 0)
            
            self.theme_combo = Gtk.ComboBoxText()
            self.theme_combo.append_text("Default")
            self.theme_combo.append_text("Dark")
            self.theme_combo.append_text("Light")
            self.theme_combo.set_active(0)
            theme_box.pack_start(self.theme_combo, False, False, 0)
            self.pack_start(theme_box, False, False, 10)
        
        def get_preferences(self) -> Dict:
            return {
                "auto_updates": self.auto_updates_check.get_active(),
                "show_tips": self.tips_check.get_active(),
                "theme": self.theme_combo.get_active_text().lower()
            }
    
    class FeatureTourPage(Gtk.Box):
        def __init__(self, wizard):
            super().__init__(orientation=Gtk.Orientation.VERTICAL, spacing=10)
            self.wizard = wizard
            self.set_margin_top(20)
            self.set_margin_start(30)
            self.set_margin_end(30)
            
            title = Gtk.Label()
            title.set_markup("<span size='x-large' weight='bold'>Feature Tour</span>")
            title.set_xalign(0)
            self.pack_start(title, False, False, 0)
            
            subtitle = Gtk.Label()
            subtitle.set_markup("Explore what Aegis OS Basic has to offer")
            subtitle.set_xalign(0)
            self.pack_start(subtitle, False, False, 5)
            
            scrolled = Gtk.ScrolledWindow()
            scrolled.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
            
            features_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
            
            for feature in FEATURE_TOUR:
                frame = Gtk.Frame()
                frame.set_shadow_type(Gtk.ShadowType.ETCHED_IN)
                
                feature_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=5)
                feature_box.set_margin_top(10)
                feature_box.set_margin_bottom(10)
                feature_box.set_margin_start(15)
                feature_box.set_margin_end(15)
                
                feature_title = Gtk.Label()
                feature_title.set_markup(f"<b>{feature['title']}</b>")
                feature_title.set_xalign(0)
                feature_box.pack_start(feature_title, False, False, 0)
                
                feature_desc = Gtk.Label(label=feature['description'])
                feature_desc.set_line_wrap(True)
                feature_desc.set_xalign(0)
                feature_box.pack_start(feature_desc, False, False, 0)
                
                apps_label = Gtk.Label()
                apps_label.set_markup(f"<small>Apps: {', '.join(feature['apps'])}</small>")
                apps_label.set_xalign(0)
                feature_box.pack_start(apps_label, False, False, 0)
                
                frame.add(feature_box)
                features_box.pack_start(frame, False, False, 0)
            
            scrolled.add(features_box)
            self.pack_start(scrolled, True, True, 0)
    
    class AccountsPage(Gtk.Box):
        def __init__(self, wizard):
            super().__init__(orientation=Gtk.Orientation.VERTICAL, spacing=15)
            self.wizard = wizard
            self.set_margin_top(30)
            self.set_margin_start(40)
            self.set_margin_end(40)
            
            title = Gtk.Label()
            title.set_markup("<span size='x-large' weight='bold'>Account Setup</span>")
            title.set_xalign(0)
            self.pack_start(title, False, False, 0)
            
            subtitle = Gtk.Label()
            subtitle.set_markup("Connect your accounts (optional - you can do this later)")
            subtitle.set_xalign(0)
            self.pack_start(subtitle, False, False, 10)
            
            accounts = [
                ("Email (Thunderbird)", "thunderbird", "Configure your email accounts"),
                ("Cloud Storage (Nextcloud)", "nextcloud", "Sync files with your cloud storage"),
                ("Calendar & Contacts", "gnome-calendar", "Set up your calendar and contacts"),
            ]
            
            for name, app, desc in accounts:
                box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=15)
                
                info_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=2)
                label = Gtk.Label()
                label.set_markup(f"<b>{name}</b>")
                label.set_xalign(0)
                info_box.pack_start(label, False, False, 0)
                
                desc_label = Gtk.Label(label=desc)
                desc_label.set_xalign(0)
                info_box.pack_start(desc_label, False, False, 0)
                
                box.pack_start(info_box, True, True, 0)
                
                btn = Gtk.Button(label="Configure")
                btn.connect("clicked", self.on_configure_clicked, app)
                box.pack_end(btn, False, False, 0)
                
                self.pack_start(box, False, False, 5)
        
        def on_configure_clicked(self, button, app):
            try:
                subprocess.Popen([app], start_new_session=True,
                               stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            except Exception:
                dialog = Gtk.MessageDialog(
                    transient_for=self.get_toplevel(),
                    flags=0,
                    message_type=Gtk.MessageType.ERROR,
                    buttons=Gtk.ButtonsType.OK,
                    text=f"Could not launch {app}"
                )
                dialog.run()
                dialog.destroy()
    
    class HelpResourcesPage(Gtk.Box):
        def __init__(self, wizard):
            super().__init__(orientation=Gtk.Orientation.VERTICAL, spacing=15)
            self.wizard = wizard
            self.set_margin_top(30)
            self.set_margin_start(40)
            self.set_margin_end(40)
            
            title = Gtk.Label()
            title.set_markup("<span size='x-large' weight='bold'>Help & Resources</span>")
            title.set_xalign(0)
            self.pack_start(title, False, False, 0)
            
            subtitle = Gtk.Label()
            subtitle.set_markup("Get help when you need it")
            subtitle.set_xalign(0)
            self.pack_start(subtitle, False, False, 10)
            
            for resource in HELP_RESOURCES:
                box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)
                
                label = Gtk.Label()
                label.set_markup(f"<b>{resource['name']}</b>")
                label.set_xalign(0)
                box.pack_start(label, True, True, 0)
                
                btn = Gtk.LinkButton(uri=resource['url'], label="Open")
                box.pack_end(btn, False, False, 0)
                
                self.pack_start(box, False, False, 5)
            
            complete_label = Gtk.Label()
            complete_label.set_markup("\n<span size='large'>You're all set! Click <b>Finish</b> to complete setup.</span>")
            complete_label.set_margin_top(20)
            self.pack_start(complete_label, False, False, 0)
    
    class OnboardingWindow(Gtk.Window):
        def __init__(self, wizard: SetupWizard):
            super().__init__(title=f"{APP_NAME} - Aegis OS {EDITION}")
            self.wizard = wizard
            self.current_page = 0
            
            self.set_default_size(700, 550)
            self.set_position(Gtk.WindowPosition.CENTER)
            self.set_border_width(10)
            
            main_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
            self.add(main_box)
            
            self.stack = Gtk.Stack()
            self.stack.set_transition_type(Gtk.StackTransitionType.SLIDE_LEFT_RIGHT)
            self.stack.set_transition_duration(300)
            
            self.welcome_page = WelcomePage(wizard)
            self.prefs_page = PreferencesPage(wizard)
            self.tour_page = FeatureTourPage(wizard)
            self.accounts_page = AccountsPage(wizard)
            self.help_page = HelpResourcesPage(wizard)
            
            self.stack.add_named(self.welcome_page, "welcome")
            self.stack.add_named(self.prefs_page, "preferences")
            self.stack.add_named(self.tour_page, "tour")
            self.stack.add_named(self.accounts_page, "accounts")
            self.stack.add_named(self.help_page, "help")
            
            main_box.pack_start(self.stack, True, True, 0)
            
            nav_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)
            nav_box.set_margin_top(10)
            
            self.skip_btn = Gtk.Button(label="Skip Setup")
            self.skip_btn.connect("clicked", self.on_skip)
            nav_box.pack_start(self.skip_btn, False, False, 0)
            
            self.progress_label = Gtk.Label(label="Step 1 of 5")
            nav_box.pack_start(self.progress_label, True, True, 0)
            
            self.back_btn = Gtk.Button(label="Back")
            self.back_btn.connect("clicked", self.on_back)
            self.back_btn.set_sensitive(False)
            nav_box.pack_end(self.back_btn, False, False, 0)
            
            self.next_btn = Gtk.Button(label="Next")
            self.next_btn.connect("clicked", self.on_next)
            self.next_btn.get_style_context().add_class("suggested-action")
            nav_box.pack_end(self.next_btn, False, False, 0)
            
            main_box.pack_end(nav_box, False, False, 0)
            
            self.pages = ["welcome", "preferences", "tour", "accounts", "help"]
        
        def update_navigation(self):
            self.progress_label.set_text(f"Step {self.current_page + 1} of {len(self.pages)}")
            self.back_btn.set_sensitive(self.current_page > 0)
            
            if self.current_page == len(self.pages) - 1:
                self.next_btn.set_label("Finish")
            else:
                self.next_btn.set_label("Next")
        
        def on_next(self, button):
            if self.current_page == 1:
                prefs = self.prefs_page.get_preferences()
                for key, value in prefs.items():
                    self.wizard.state.set_preference(key, value)
            
            if self.current_page < len(self.pages) - 1:
                self.current_page += 1
                self.stack.set_visible_child_name(self.pages[self.current_page])
                self.update_navigation()
            else:
                self.finish_setup()
        
        def on_back(self, button):
            if self.current_page > 0:
                self.current_page -= 1
                self.stack.set_visible_child_name(self.pages[self.current_page])
                self.update_navigation()
        
        def on_skip(self, button):
            dialog = Gtk.MessageDialog(
                transient_for=self,
                flags=0,
                message_type=Gtk.MessageType.QUESTION,
                buttons=Gtk.ButtonsType.YES_NO,
                text="Skip setup?"
            )
            dialog.format_secondary_text(
                "You can run this wizard again anytime from the applications menu."
            )
            response = dialog.run()
            dialog.destroy()
            
            if response == Gtk.ResponseType.YES:
                self.finish_setup()
        
        def finish_setup(self):
            self.wizard.state.mark_completed()
            self.wizard.logger.info("Onboarding completed")
            self.destroy()
            Gtk.main_quit()


def main():
    if not GTK_AVAILABLE:
        print(f"Cannot start {APP_NAME}: GTK3 not available.", file=sys.stderr)
        sys.exit(1)
    
    import argparse
    
    parser = argparse.ArgumentParser(description=f"{APP_NAME} - Onboarding wizard")
    parser.add_argument("--cli", action="store_true", help="Run in CLI mode")
    parser.add_argument("--reset", action="store_true", help="Reset onboarding state")
    parser.add_argument("--status", action="store_true", help="Show onboarding status")
    parser.add_argument("--version", action="version", version=f"{APP_NAME} {VERSION}")
    
    args = parser.parse_args()
    
    wizard = SetupWizard()
    
    if args.reset:
        wizard.state.state = {
            "completed": False,
            "current_step": 0,
            "first_run": True,
            "setup_date": None,
            "preferences": {},
            "accounts_configured": [],
            "features_explored": []
        }
        wizard.state.save()
        print("Onboarding state reset.")
        return
    
    if args.status:
        state = wizard.state.state
        print(f"Onboarding completed: {state['completed']}")
        print(f"Setup date: {state['setup_date'] or 'Not completed'}")
        print(f"Accounts configured: {', '.join(state['accounts_configured']) or 'None'}")
        return
    
    if args.cli or not GTK_AVAILABLE:
        wizard.run_cli()
    else:
        win = OnboardingWindow(wizard)
        win.connect("destroy", Gtk.main_quit)
        win.show_all()
        Gtk.main()


if __name__ == "__main__":
    main()
