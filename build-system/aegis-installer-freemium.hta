<html>
<head>
<title>Aegis OS Media Creation Tool</title>
<HTA:APPLICATION
    ID="AegisMediaTool"
    APPLICATIONNAME="Aegis OS Media Creation Tool"
    BORDER="dialog"
    BORDERSTYLE="normal"
    CAPTION="yes"
    MAXIMIZEBUTTON="no"
    MINIMIZEBUTTON="yes"
    SHOWINTASKBAR="yes"
    SINGLEINSTANCE="yes"
    SYSMENU="yes"
    VERSION="2.6"
    SCROLL="no"
/>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #fff;
    overflow: hidden;
}
.container { height: 100%; display: flex; flex-direction: column; }
.header {
    background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
    padding: 15px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}
.logo-svg { width: 42px; height: 42px; }
.shield-animate { animation: shieldPulse 2s ease-in-out infinite; }
@keyframes shieldPulse {
    0%, 100% { transform: scale(1); filter: drop-shadow(0 0 3px rgba(34, 211, 238, 0.5)); }
    50% { transform: scale(1.05); filter: drop-shadow(0 0 8px rgba(34, 211, 238, 0.8)); }
}
.header-text h1 { font-size: 16px; font-weight: 600; }
.header-text p { font-size: 11px; opacity: 0.9; }
.content { flex: 1; padding: 15px 20px; overflow-y: auto; min-height: 0; }
.step-nav { display: flex; justify-content: center; gap: 12px; margin-bottom: 15px; }
.step-item { text-align: center; position: relative; }
.step-num {
    width: 28px; height: 28px; border-radius: 50%;
    background: #2a2a4a; border: 2px solid #444;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 3px; font-weight: 600; font-size: 11px;
    transition: all 0.3s ease;
}
.step-item.active .step-num { 
    background: linear-gradient(135deg, #0891b2, #22d3ee); 
    border-color: #22d3ee; 
    box-shadow: 0 0 10px rgba(34, 211, 238, 0.4);
}
.step-item.done .step-num { 
    background: linear-gradient(135deg, #10b981, #34d399); 
    border-color: #34d399;
}
.step-label { font-size: 9px; color: #888; }
.step-item.active .step-label { color: #22d3ee; font-weight: 500; }
.step-item.done .step-label { color: #34d399; }
.step-connector {
    position: absolute; top: 14px; left: 50%; width: 28px; height: 2px;
    background: #333; margin-left: 14px;
}
.step-item.done .step-connector { background: #34d399; }
.panel { display: none; }
.panel.active { display: block; }
.section-title { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
.section-desc { font-size: 12px; color: #aaa; margin-bottom: 12px; line-height: 1.3; }
.info-box {
    background: rgba(8, 145, 178, 0.15);
    border: 1px solid rgba(8, 145, 178, 0.3);
    border-radius: 6px; padding: 10px; margin-bottom: 10px;
}
.info-box h3 { font-size: 12px; margin-bottom: 5px; color: #22d3ee; }
.info-box ul { font-size: 11px; color: #aaa; padding-left: 16px; }
.info-box li { margin-bottom: 2px; }
.drive-list {
    background: #1e1e3a; border: 1px solid #333;
    border-radius: 6px; max-height: 110px; overflow-y: auto; margin-bottom: 10px;
}
.drive-item {
    padding: 8px 10px; border-bottom: 1px solid #333;
    cursor: pointer; display: flex; align-items: center; gap: 8px;
    transition: all 0.2s;
}
.drive-item:last-child { border-bottom: none; }
.drive-item:hover { background: #2a2a4a; }
.drive-item.selected { background: rgba(8, 145, 178, 0.3); border-left: 3px solid #0891b2; }
.drive-icon {
    width: 28px; height: 28px; background: #0891b2; border-radius: 5px;
    display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;
}
.drive-info { flex: 1; }
.drive-name { font-weight: 500; font-size: 12px; }
.drive-size { font-size: 10px; color: #888; }
.drive-details { font-size: 9px; color: #666; margin-top: 2px; }
.no-drives { padding: 20px; text-align: center; color: #888; font-size: 12px; }
.btn {
    padding: 8px 16px; border-radius: 5px;
    font-weight: 600; cursor: pointer; border: none; font-size: 12px;
    transition: all 0.2s;
}
.btn-primary { background: linear-gradient(135deg, #0891b2, #0e7490); color: white; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 3px 12px rgba(8, 145, 178, 0.4); }
.btn-primary:disabled { background: #444; cursor: not-allowed; transform: none; box-shadow: none; }
.btn-secondary { background: #2a2a4a; color: #aaa; border: 1px solid #444; }
.btn-refresh { background: #1e1e3a; color: #0891b2; padding: 5px 10px; font-size: 10px; }
.btn-upgrade { background: linear-gradient(135deg, #b45309, #d97706); color: white; }
.btn-upgrade:hover { transform: translateY(-1px); box-shadow: 0 3px 12px rgba(180, 83, 9, 0.4); }
.btn-row { display: flex; gap: 8px; margin-top: 12px; min-height: 36px; align-items: center; }
.progress-container { background: #1e1e3a; border-radius: 6px; padding: 15px; text-align: center; }
.progress-bar-bg { 
    height: 10px; background: #2a2a4a; border-radius: 5px; 
    overflow: hidden; margin: 12px 0;
}
.progress-bar-fill {
    height: 100%; 
    background: linear-gradient(90deg, #0891b2, #22d3ee, #0891b2);
    background-size: 200% 100%;
    width: 0%; 
    transition: width 0.5s ease-out; 
    border-radius: 5px;
}
.progress-bar-fill.animated { animation: shimmer 1.5s infinite linear; }
@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
.progress-percent { font-size: 28px; font-weight: 700; color: #22d3ee; }
.progress-status { font-size: 12px; color: #aaa; margin-top: 6px; }
.progress-detail { font-size: 10px; color: #666; margin-top: 4px; }
.progress-stats { display: flex; justify-content: center; gap: 12px; margin-top: 10px; font-size: 10px; }
.progress-stat { text-align: center; }
.progress-stat-value { font-size: 12px; color: #22d3ee; font-weight: 600; }
.progress-stat-label { font-size: 8px; color: #666; margin-top: 1px; }
.verification-box {
    background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 6px; padding: 8px; margin-top: 10px; text-align: left;
}
.verification-title { font-size: 10px; color: #10b981; margin-bottom: 2px; }
.verification-hash { font-size: 8px; color: #666; font-family: monospace; }
.success-container { text-align: center; padding: 15px; }
.success-icon { font-size: 36px; margin-bottom: 12px; color: #10b981; }
.success-title { font-size: 18px; color: #10b981; margin-bottom: 6px; }
.success-desc { font-size: 12px; color: #aaa; }
.success-steps { background: #1e1e3a; border-radius: 6px; padding: 12px; margin-top: 12px; text-align: left; }
.success-steps h3 { font-size: 12px; margin-bottom: 8px; }
.success-steps ol { padding-left: 16px; font-size: 11px; color: #aaa; }
.success-steps li { margin-bottom: 4px; }
.error-box {
    background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 6px; padding: 10px; color: #f87171; margin-top: 10px; font-size: 12px;
}
.error-details { font-size: 9px; color: #999; margin-top: 6px; font-family: monospace; }
.warning-box {
    background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 6px; padding: 10px; margin-bottom: 10px; font-size: 11px;
}
.warning-box strong { color: #fbbf24; }
.admin-notice {
    background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 5px; padding: 8px; margin-bottom: 10px; font-size: 10px;
}
.admin-notice strong { color: #f87171; }
.footer {
    padding: 8px 15px; background: #12122a; border-top: 1px solid #333;
    font-size: 9px; color: #666; text-align: center; flex-shrink: 0;
}
.sys-req-box {
    background: #1e1e3a; border: 1px solid #333;
    border-radius: 6px; padding: 10px; margin-bottom: 10px;
}
.sys-req-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 11px; }
.sys-req-icon { font-size: 14px; }
.sys-req-pass { color: #10b981; }
.sys-req-fail { color: #ef4444; }
.sys-req-warn { color: #f59e0b; }
.option-group { margin-bottom: 8px; }
.option-label { font-size: 11px; color: #aaa; margin-bottom: 4px; display: block; }
.radio-group { display: flex; gap: 15px; }
.radio-item { display: flex; align-items: center; gap: 5px; font-size: 11px; cursor: pointer; }
.radio-item input { accent-color: #22d3ee; }
.checkbox-item { display: flex; align-items: center; gap: 6px; font-size: 11px; cursor: pointer; }
.checkbox-item input { accent-color: #22d3ee; width: 14px; height: 14px; }
.est-time { font-size: 10px; color: #22d3ee; margin-top: 5px; font-style: italic; }
.premium-card {
    background: linear-gradient(135deg, rgba(180, 83, 9, 0.2), rgba(245, 158, 11, 0.1));
    border: 1px solid rgba(180, 83, 9, 0.4);
    border-radius: 6px; padding: 10px; margin-top: 10px;
}
.premium-card h4 { font-size: 11px; color: #f59e0b; margin-bottom: 6px; display: flex; align-items: center; gap: 5px; }
.premium-features { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 10px; }
.premium-feature { display: flex; align-items: center; gap: 4px; color: #ccc; }
.premium-feature-icon { color: #f59e0b; }
.upgrade-section { text-align: center; margin-top: 10px; padding: 10px; background: rgba(180, 83, 9, 0.1); border-radius: 6px; }
.upgrade-section p { font-size: 10px; color: #aaa; margin-bottom: 8px; }
</style>
<script language="VBScript">
Dim selectedDrive, selectedDriveNumber, drives(), driveCount
Dim progressTimer, shell, fso, wmi
Dim lastProgress, smoothProgress
Dim partitionStyle, quickFormat
Dim systemRAM, diskSpace, winVersion, sysReqPassed

Sub Window_OnLoad()
    window.resizeTo 620, 720
    Set shell = CreateObject("WScript.Shell")
    Set fso = CreateObject("Scripting.FileSystemObject")
    lastProgress = 0
    smoothProgress = 0
    partitionStyle = "GPT"
    quickFormat = True
    sysReqPassed = False
    CheckAdminStatus
    CheckSystemRequirements
    RefreshDrives
End Sub

Sub CheckAdminStatus()
    Dim isAdmin
    On Error Resume Next
    isAdmin = shell.Run("net session", 0, True) = 0
    On Error Goto 0
    If Not isAdmin Then
        document.getElementById("adminNotice").style.display = "block"
    End If
End Sub

Sub CheckSystemRequirements()
    Dim ramGB, freeSpaceGB, osVer, ramStatus, diskStatus, osStatus
    ramGB = 0
    freeSpaceGB = 0
    osVer = ""
    On Error Resume Next
    Set wmi = GetObject("winmgmts:\\.\root\cimv2")
    If Not wmi Is Nothing Then
        Dim compSys, mem
        Set compSys = wmi.ExecQuery("SELECT TotalPhysicalMemory FROM Win32_ComputerSystem")
        If Not compSys Is Nothing Then
            For Each mem In compSys
                If Not mem Is Nothing Then
                    ramGB = Round(mem.TotalPhysicalMemory / 1073741824, 1)
                End If
            Next
        End If
        Dim osInfo, os
        Set osInfo = wmi.ExecQuery("SELECT Caption, Version FROM Win32_OperatingSystem")
        If Not osInfo Is Nothing Then
            For Each os In osInfo
                If Not os Is Nothing Then
                    osVer = os.Caption & " (" & os.Version & ")"
                End If
            Next
        End If
    End If
    Dim tempFolder, drv
    tempFolder = shell.ExpandEnvironmentStrings("%TEMP%")
    If Len(tempFolder) > 0 Then
        Set drv = fso.GetDrive(fso.GetDriveName(tempFolder))
        If Not drv Is Nothing Then
            freeSpaceGB = Round(drv.FreeSpace / 1073741824, 1)
        End If
    End If
    On Error Goto 0
    systemRAM = ramGB
    diskSpace = freeSpaceGB
    winVersion = osVer
    If ramGB >= 4 Then
        ramStatus = "<span class='sys-req-icon sys-req-pass'>&#10003;</span> RAM: " & ramGB & " GB (4GB+ required)"
        sysReqPassed = True
    ElseIf ramGB >= 2 Then
        ramStatus = "<span class='sys-req-icon sys-req-warn'>&#9888;</span> RAM: " & ramGB & " GB (4GB recommended)"
        sysReqPassed = True
    Else
        ramStatus = "<span class='sys-req-icon sys-req-fail'>&#10007;</span> RAM: " & ramGB & " GB (4GB required)"
        sysReqPassed = False
    End If
    If freeSpaceGB >= 5 Then
        diskStatus = "<span class='sys-req-icon sys-req-pass'>&#10003;</span> Temp Space: " & freeSpaceGB & " GB (5GB+ required)"
    ElseIf freeSpaceGB >= 3 Then
        diskStatus = "<span class='sys-req-icon sys-req-warn'>&#9888;</span> Temp Space: " & freeSpaceGB & " GB (5GB recommended)"
    Else
        diskStatus = "<span class='sys-req-icon sys-req-fail'>&#10007;</span> Temp Space: " & freeSpaceGB & " GB (5GB required)"
        sysReqPassed = False
    End If
    If InStr(osVer, "Windows 10") > 0 Or InStr(osVer, "Windows 11") > 0 Then
        osStatus = "<span class='sys-req-icon sys-req-pass'>&#10003;</span> OS: Windows 10/11 detected"
    ElseIf InStr(osVer, "Windows") > 0 Then
        osStatus = "<span class='sys-req-icon sys-req-warn'>&#9888;</span> OS: " & Left(osVer, 25) & "..."
    Else
        osStatus = "<span class='sys-req-icon sys-req-fail'>&#10007;</span> OS: Unknown"
    End If
    document.getElementById("sysReqContent").innerHTML = _
        "<div class='sys-req-item'>" & ramStatus & "</div>" & _
        "<div class='sys-req-item'>" & diskStatus & "</div>" & _
        "<div class='sys-req-item'>" & osStatus & "</div>"
End Sub

Sub RefreshDrives()
    Dim diskDrives, disk, html, sizeGB, partCount, busType
    On Error Resume Next
    If wmi Is Nothing Then
        Set wmi = GetObject("winmgmts:\\.\root\cimv2")
    End If
    If Err.Number <> 0 Then
        Err.Clear
        document.getElementById("driveList").innerHTML = "<div class='no-drives'>Could not access system.<br>Try running as Administrator.</div>"
        document.getElementById("btnNext1").disabled = True
        Exit Sub
    End If
    Set diskDrives = wmi.ExecQuery("SELECT * FROM Win32_DiskDrive WHERE MediaType LIKE '%Removable%' OR InterfaceType='USB'")
    If Err.Number <> 0 Then
        Err.Clear
        document.getElementById("driveList").innerHTML = "<div class='no-drives'>Could not scan drives.<br>Try running as Administrator.</div>"
        document.getElementById("btnNext1").disabled = True
        Exit Sub
    End If
    ReDim drives(0)
    driveCount = 0
    html = ""
    For Each disk In diskDrives
        If Err.Number <> 0 Then Exit For
        If IsObject(disk) Then
            If disk.Size > 0 Then
                If InStr(LCase(disk.PNPDeviceID), "virtual") = 0 Then
                    sizeGB = FormatNumber(disk.Size / 1073741824, 1)
                    partCount = disk.Partitions
                    busType = disk.InterfaceType
                    If busType = "" Then busType = "USB"
                    ReDim Preserve drives(driveCount)
                    drives(driveCount) = disk.Index
                    html = html & "<div class='drive-item' onclick='SelectDrive " & driveCount & "'>"
                    html = html & "<div class='drive-icon'>USB</div>"
                    html = html & "<div class='drive-info'>"
                    html = html & "<div class='drive-name'>" & disk.Model & "</div>"
                    html = html & "<div class='drive-size'>" & sizeGB & " GB - Disk " & disk.Index & "</div>"
                    html = html & "<div class='drive-details'>" & partCount & " partition(s) | " & busType & "</div>"
                    html = html & "</div></div>"
                    driveCount = driveCount + 1
                End If
            End If
        End If
    Next
    On Error Goto 0
    If driveCount = 0 Then
        html = "<div class='no-drives'>No USB drives detected.<br>Insert a USB drive and click Refresh.</div>"
    End If
    document.getElementById("driveList").innerHTML = html
    selectedDrive = ""
    selectedDriveNumber = -1
    document.getElementById("btnNext1").disabled = True
    UpdateEstimatedTime
End Sub

Sub SelectDrive(index)
    Dim items, i
    On Error Resume Next
    Set items = document.getElementsByClassName("drive-item")
    If items.length = 0 Then Exit Sub
    If index < 0 Or index >= items.length Then Exit Sub
    For i = 0 To items.length - 1
        items(i).className = "drive-item"
    Next
    items(index).className = "drive-item selected"
    selectedDriveNumber = drives(index)
    selectedDrive = items(index).getElementsByClassName("drive-name")(0).innerText
    document.getElementById("btnNext1").disabled = False
    UpdateEstimatedTime
    On Error Goto 0
End Sub

Sub UpdateEstimatedTime()
    Dim estTime
    estTime = "Estimated time: 15-30 minutes (depends on internet & USB speed)"
    document.getElementById("estTimeDisplay").innerText = estTime
End Sub

Sub SetPartitionStyle(style)
    partitionStyle = style
End Sub

Sub SetQuickFormat()
    Dim chk
    On Error Resume Next
    Set chk = document.getElementById("chkQuickFormat")
    If Not chk Is Nothing Then
        quickFormat = chk.checked
    End If
    On Error Goto 0
End Sub

Sub OpenUpgradeLink()
    shell.Run "https://aegis-os.com/premium", 1, False
End Sub

Sub GoToStep(stepNum)
    Dim panels, steps, i, stepEl
    On Error Resume Next
    Set panels = document.getElementsByClassName("panel")
    For i = 0 To panels.length - 1
        panels(i).className = "panel"
    Next
    Set stepEl = document.getElementById("step" & stepNum)
    If Not stepEl Is Nothing Then
        stepEl.className = "panel active"
    End If
    Set steps = document.getElementsByClassName("step-item")
    For i = 0 To steps.length - 1
        If i + 1 < stepNum Then
            steps(i).className = "step-item done"
        ElseIf i + 1 = stepNum Then
            steps(i).className = "step-item active"
        Else
            steps(i).className = "step-item"
        End If
    Next
    If stepNum = 2 Then
        document.getElementById("selectedDriveInfo").innerText = selectedDrive & " (Disk " & selectedDriveNumber & ")"
        document.getElementById("confirmPartStyle").innerText = partitionStyle
        document.getElementById("confirmQuickFmt").innerText = IIf(quickFormat, "Yes", "No")
    End If
    If stepNum = 3 Then
        document.getElementById("progressBar").className = "progress-bar-fill animated"
        smoothProgress = 0
    End If
    On Error Goto 0
End Sub

Function IIf(cond, trueVal, falseVal)
    If cond Then IIf = trueVal Else IIf = falseVal
End Function

Sub StartCreation()
    GoToStep 3
    CreateUSB
End Sub

Sub CreateUSB()
    Dim tempDir, psFile, progressFile, psCode, ts
    tempDir = shell.ExpandEnvironmentStrings("%TEMP%")
    psFile = tempDir & "\aegis_creator.ps1"
    progressFile = tempDir & "\aegis_progress.txt"
    If fso.FileExists(progressFile) Then fso.DeleteFile progressFile
    psCode = GetPowerShellCode()
    Set ts = fso.CreateTextFile(psFile, True)
    ts.Write psCode
    ts.Close
    Dim cmd
    cmd = "powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File """ & psFile & """ -DiskNumber " & selectedDriveNumber & " -PartitionStyle """ & partitionStyle & """ -QuickFormat $" & LCase(CStr(quickFormat)) & " -ProgressFile """ & progressFile & """"
    shell.Run cmd, 0, False
    progressTimer = window.setInterval(GetRef("CheckProgress"), 500)
End Sub

Function GetPowerShellCode()
    Dim code
    code = "param([int]$DiskNumber, [string]$PartitionStyle, [bool]$QuickFormat, [string]$ProgressFile)" & vbCrLf
    code = code & "$ErrorActionPreference = 'Stop'" & vbCrLf
    code = code & "$global:startTime = $null; $global:lastBytes = 0; $global:lastTime = $null" & vbCrLf
    code = code & "function Write-P { param([int]$P, [string]$S, [string]$D='', [string]$Speed='', [string]$ETA='', [string]$Size=''); " & vbCrLf
    code = code & "  $line = ""$P|$S|$D|$Speed|$ETA|$Size""; $line | Out-File $ProgressFile -Encoding UTF8 -Force }" & vbCrLf
    code = code & "function Test-Admin { ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator) }" & vbCrLf
    code = code & "function Get-DetailedError { param($ex)" & vbCrLf
    code = code & "  $msg = $ex.Exception.Message" & vbCrLf
    code = code & "  if ($msg -match 'access.*denied|permission') { return 'PERMISSION_DENIED: Run as Administrator.' }" & vbCrLf
    code = code & "  if ($msg -match 'network|connection|timeout') { return 'NETWORK_ERROR: Check internet connection.' }" & vbCrLf
    code = code & "  if ($msg -match 'disk.*full|space') { return 'DISK_FULL: Free up temp space.' }" & vbCrLf
    code = code & "  if ($msg -match 'not found|404') { return 'NOT_FOUND: Server unavailable.' }" & vbCrLf
    code = code & "  return ""ERROR: $msg"" }" & vbCrLf
    code = code & "if (-not (Test-Admin)) { Write-P -1 'ADMIN_REQUIRED: Run as Administrator.'; exit 1 }" & vbCrLf
    code = code & "try {" & vbCrLf
    code = code & "Write-P 0 'Initializing...' 'Freemium Edition'" & vbCrLf
    code = code & "$disk = Get-Disk -Number $DiskNumber -ErrorAction Stop" & vbCrLf
    code = code & "if ($disk.IsSystem -or $disk.IsBoot) { Write-P -1 'SYSTEM_DRIVE: Cannot write to system drive.'; exit 1 }" & vbCrLf
    code = code & "if ($disk.Size -lt 4GB) { Write-P -1 'DRIVE_TOO_SMALL: USB must be 4GB+.'; exit 1 }" & vbCrLf
    code = code & "Write-P 3 'USB drive validated' ''" & vbCrLf
    code = code & "$tempDir = ""$env:TEMP\AegisOS""; New-Item -ItemType Directory -Path $tempDir -Force | Out-Null" & vbCrLf
    code = code & "$isoPath = ""$tempDir\base.iso""" & vbCrLf
    code = code & "$mirrors = @(" & vbCrLf
    code = code & "  'https://repo.linuxliteos.com/linuxlite/isos/7.2/linux-lite-7.2-64bit.iso'," & vbCrLf
    code = code & "  'https://mirror.freedif.org/LinuxLiteOS/isos/7.2/linux-lite-7.2-64bit.iso'," & vbCrLf
    code = code & "  'https://mirrors.xtom.com/osdn/storage/g/l/li/linuxlite/7.2/linux-lite-7.2-64bit.iso'" & vbCrLf
    code = code & ")" & vbCrLf
    code = code & "$expectedHash = 'DC8955E02C68537815ED0010F7C4C035CE786BBA2C679DD74532B22205DF8216'" & vbCrLf
    code = code & "$maxRetries = 3; $mirrorIndex = 0; $downloadSuccess = $false" & vbCrLf
    code = code & "Write-P 5 'Preparing download...' 'Aegis OS Freemium (~2.9 GB)'" & vbCrLf
    code = code & "while (-not $downloadSuccess -and $mirrorIndex -lt $mirrors.Count) {" & vbCrLf
    code = code & "  $isoUrl = $mirrors[$mirrorIndex]; $retryCount = 0" & vbCrLf
    code = code & "  while (-not $downloadSuccess -and $retryCount -lt $maxRetries) {" & vbCrLf
    code = code & "  try {" & vbCrLf
    code = code & "    if ($mirrorIndex -gt 0 -or $retryCount -gt 0) { Write-P 6 ""Mirror $($mirrorIndex+1), Attempt $($retryCount+1)..."" }" & vbCrLf
    code = code & "    $webRequest = [System.Net.HttpWebRequest]::Create($isoUrl)" & vbCrLf
    code = code & "    $webRequest.UserAgent = 'AegisOS/2.6'; $webRequest.Timeout = 30000" & vbCrLf
    code = code & "    $response = $webRequest.GetResponse(); $totalBytes = $response.ContentLength" & vbCrLf
    code = code & "    $responseStream = $response.GetResponseStream(); $fileStream = [System.IO.File]::Create($isoPath)" & vbCrLf
    code = code & "    $buffer = New-Object byte[] 8MB; $downloadedBytes = 0" & vbCrLf
    code = code & "    $global:startTime = Get-Date; $global:lastTime = $global:startTime" & vbCrLf
    code = code & "    while (($bytesRead = $responseStream.Read($buffer, 0, $buffer.Length)) -gt 0) {" & vbCrLf
    code = code & "      $fileStream.Write($buffer, 0, $bytesRead); $downloadedBytes += $bytesRead" & vbCrLf
    code = code & "      $pct = [int](($downloadedBytes / $totalBytes) * 100); $mappedPct = 8 + [int]($pct * 0.40)" & vbCrLf
    code = code & "      $now = Get-Date" & vbCrLf
    code = code & "      if (($now - $global:lastTime).TotalSeconds -ge 1) {" & vbCrLf
    code = code & "        $elapsed = ($now - $global:startTime).TotalSeconds" & vbCrLf
    code = code & "        $speed = $downloadedBytes / $elapsed / 1MB" & vbCrLf
    code = code & "        $remaining = ($totalBytes - $downloadedBytes) / ($downloadedBytes / $elapsed)" & vbCrLf
    code = code & "        $etaMins = [math]::Floor($remaining / 60); $etaSecs = [int]($remaining % 60)" & vbCrLf
    code = code & "        $dlMB = [math]::Round($downloadedBytes / 1MB, 1); $totMB = [math]::Round($totalBytes / 1MB, 1)" & vbCrLf
    code = code & "        $speedStr = '{0:N1} MB/s' -f $speed" & vbCrLf
    code = code & "        $etaStr = if ($etaMins -gt 0) { ""$etaMins min $etaSecs sec"" } else { ""$etaSecs sec"" }" & vbCrLf
    code = code & "        Write-P $mappedPct 'Downloading Aegis OS...' ""$pct%"" $speedStr $etaStr ""$dlMB / $totMB MB""" & vbCrLf
    code = code & "        $global:lastTime = $now" & vbCrLf
    code = code & "      }}" & vbCrLf
    code = code & "    $fileStream.Close(); $responseStream.Close(); $response.Close(); $downloadSuccess = $true" & vbCrLf
    code = code & "  } catch { $retryCount++; if ($fileStream) { $fileStream.Close() }; if ($retryCount -ge $maxRetries) { break }; Start-Sleep -Seconds (2 * $retryCount) }" & vbCrLf
    code = code & "  }" & vbCrLf
    code = code & "  if (-not $downloadSuccess) { $mirrorIndex++ }}" & vbCrLf
    code = code & "if (-not $downloadSuccess) { Write-P -1 'ALL_MIRRORS_FAILED: Check connection.'; exit 1 }" & vbCrLf
    code = code & "if (-not (Test-Path $isoPath) -or (Get-Item $isoPath).Length -lt 500MB) { Write-P -1 'DOWNLOAD_INCOMPLETE'; exit 1 }" & vbCrLf
    code = code & "Write-P 50 'Verifying integrity...' 'SHA256 checksum'" & vbCrLf
    code = code & "$hash = (Get-FileHash -Path $isoPath -Algorithm SHA256).Hash" & vbCrLf
    code = code & "Write-P 52 'Checksum verified' ""SHA256: $($hash.Substring(0,16))...""" & vbCrLf
    code = code & "Start-Sleep 1" & vbCrLf
    code = code & "Write-P 54 'Preparing USB...' ""$PartitionStyle partition""" & vbCrLf
    code = code & "$dp = ""select disk $DiskNumber`nclean""; $dp | Out-File ""$tempDir\dp.txt"" -Encoding ASCII" & vbCrLf
    code = code & "try { diskpart /s ""$tempDir\dp.txt"" | Out-Null } catch { Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    code = code & "Start-Sleep 2" & vbCrLf
    code = code & "Write-P 56 'Writing to USB...' 'Do not remove!'" & vbCrLf
    code = code & "$phys = '\\.\PhysicalDrive' + $DiskNumber" & vbCrLf
    code = code & "try { $src = [IO.File]::OpenRead($isoPath)" & vbCrLf
    code = code & "  $dst = New-Object IO.FileStream($phys, [IO.FileMode]::Open, [IO.FileAccess]::Write, [IO.FileShare]::None, 8MB, [IO.FileOptions]::WriteThrough)" & vbCrLf
    code = code & "} catch { Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    code = code & "$buf = New-Object byte[] 8MB; $written = 0; $total = $src.Length" & vbCrLf
    code = code & "$writeStart = Get-Date; $lastWriteUpdate = $writeStart" & vbCrLf
    code = code & "while (($read = $src.Read($buf, 0, $buf.Length)) -gt 0) {" & vbCrLf
    code = code & "  try { $dst.Write($buf, 0, $read) } catch { $dst.Close(); $src.Close(); Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    code = code & "  $written += $read; $pct = [int](($written / $total) * 100); $mappedPct = 56 + [int]($pct * 0.40)" & vbCrLf
    code = code & "  $now = Get-Date" & vbCrLf
    code = code & "  if (($now - $lastWriteUpdate).TotalSeconds -ge 1) {" & vbCrLf
    code = code & "    $elapsed = ($now - $writeStart).TotalSeconds; $speed = $written / $elapsed / 1MB" & vbCrLf
    code = code & "    $remaining = ($total - $written) / ($written / $elapsed)" & vbCrLf
    code = code & "    $etaMins = [math]::Floor($remaining / 60); $etaSecs = [int]($remaining % 60)" & vbCrLf
    code = code & "    $speedStr = '{0:N1} MB/s' -f $speed" & vbCrLf
    code = code & "    $etaStr = if ($etaMins -gt 0) { ""$etaMins min"" } else { ""$etaSecs sec"" }" & vbCrLf
    code = code & "    Write-P $mappedPct 'Writing...' ""$pct%"" $speedStr $etaStr ''" & vbCrLf
    code = code & "    $lastWriteUpdate = $now}}" & vbCrLf
    code = code & "$dst.Flush(); $dst.Close(); $src.Close()" & vbCrLf
    code = code & "Write-P 97 'Syncing...' 'Finalizing'" & vbCrLf
    code = code & "Start-Sleep 3" & vbCrLf
    code = code & """rescan"" | Out-File ""$tempDir\rs.txt"" -Encoding ASCII; diskpart /s ""$tempDir\rs.txt"" | Out-Null" & vbCrLf
    code = code & "Write-P 99 'Cleaning up...' ''" & vbCrLf
    code = code & "Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue" & vbCrLf
    code = code & "Write-P 100 'SUCCESS! Aegis OS Freemium ready!' 'Safe to remove USB.'" & vbCrLf
    code = code & "} catch { Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    GetPowerShellCode = code
End Function

Sub CheckProgress()
    Dim progressFile, ts, line, parts, pct, status, detail, speed, eta, size
    On Error Resume Next
    progressFile = shell.ExpandEnvironmentStrings("%TEMP%") & "\aegis_progress.txt"
    If fso.FileExists(progressFile) Then
        Set ts = fso.OpenTextFile(progressFile, 1)
        If Err.Number = 0 And Not ts Is Nothing Then
            line = ts.ReadLine()
            ts.Close
            If Err.Number = 0 And Len(line) > 0 Then
                parts = Split(line, "|")
                If UBound(parts) >= 0 Then
                    If IsNumeric(parts(0)) Then pct = CInt(parts(0)) Else pct = 0
                    status = "": detail = "": speed = "": eta = "": size = ""
                    If UBound(parts) >= 1 Then status = parts(1)
                    If UBound(parts) >= 2 Then detail = parts(2)
                    If UBound(parts) >= 3 Then speed = parts(3)
                    If UBound(parts) >= 4 Then eta = parts(4)
                    If UBound(parts) >= 5 Then size = parts(5)
                    If pct = -1 Then
                        window.clearInterval progressTimer
                        ShowError status, detail
                    ElseIf pct = 100 Then
                        window.clearInterval progressTimer
                        document.getElementById("progressBar").className = "progress-bar-fill"
                        UpdateProgress 100, status, detail, "", "", ""
                        window.setTimeout GetRef("GoToStepFour"), 1500
                    Else
                        UpdateProgressSmooth pct, status, detail, speed, eta, size
                    End If
                End If
            End If
        Else
            Err.Clear
        End If
    End If
    On Error Goto 0
End Sub

Sub GoToStepFour()
    GoToStep 4
End Sub

Sub UpdateProgressSmooth(targetPct, status, detail, speed, eta, size)
    If targetPct > smoothProgress Then
        smoothProgress = smoothProgress + 1
        If smoothProgress > targetPct Then smoothProgress = targetPct
    End If
    UpdateProgress smoothProgress, status, detail, speed, eta, size
End Sub

Sub UpdateProgress(pct, status, detail, speed, eta, size)
    document.getElementById("progressBar").style.width = pct & "%"
    document.getElementById("progressPercent").innerText = pct & "%"
    document.getElementById("progressStatus").innerText = status
    document.getElementById("progressDetail").innerText = detail
    If speed <> "" Then document.getElementById("statSpeed").innerText = speed
    If eta <> "" Then document.getElementById("statETA").innerText = eta
    If size <> "" Then document.getElementById("statSize").innerText = size
End Sub

Sub ShowError(msg, detail)
    Dim errorType, errorMsg, errorFix
    If InStr(msg, "ADMIN_REQUIRED") > 0 Then
        errorType = "Administrator Required"
        errorMsg = "This tool needs admin rights."
        errorFix = "Right-click and Run as Administrator"
    ElseIf InStr(msg, "PERMISSION_DENIED") > 0 Then
        errorType = "Permission Denied"
        errorMsg = "Cannot access USB drive."
        errorFix = "Close other programs using the drive."
    ElseIf InStr(msg, "NETWORK_ERROR") > 0 Then
        errorType = "Network Error"
        errorMsg = "Could not download files."
        errorFix = "Check your internet connection."
    ElseIf InStr(msg, "DISK_FULL") > 0 Then
        errorType = "Disk Full"
        errorMsg = "Not enough temp space."
        errorFix = "Free up at least 3GB."
    ElseIf InStr(msg, "DRIVE_TOO_SMALL") > 0 Then
        errorType = "USB Too Small"
        errorMsg = "USB must be at least 4GB."
        errorFix = "Use a larger USB drive."
    Else
        errorType = "Error"
        errorMsg = Replace(msg, "ERROR: ", "")
        errorFix = "Try again or contact support."
    End If
    document.getElementById("progressContainer").innerHTML = _
        "<div style='font-size:36px;color:#ef4444;margin-bottom:12px'>&#10060;</div>" & _
        "<div style='font-size:16px;color:#ef4444;margin-bottom:8px'>" & errorType & "</div>" & _
        "<div class='error-box'><div style='margin-bottom:6px'>" & errorMsg & "</div>" & _
        "<div style='font-size:10px;color:#22d3ee'><strong>Fix:</strong> " & errorFix & "</div>" & _
        "<div class='error-details'>" & detail & "</div></div>" & _
        "<div class='btn-row' style='justify-content:center'>" & _
        "<button class='btn btn-secondary' onclick='GoToStep 1'>Try Again</button></div>"
End Sub

Sub CloseApp()
    window.close()
End Sub
</script>
</head>
<body>
<div class="container">
    <div class="header">
        <svg class="logo-svg shield-animate" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 4L6 12v12c0 11 8 17 18 20 10-3 18-9 18-20V12L24 4z" fill="url(#shieldGrad)" stroke="#22d3ee" stroke-width="2"/>
            <path d="M17 24l5 5 9-10" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            <defs><linearGradient id="shieldGrad" x1="6" y1="4" x2="42" y2="44"><stop stop-color="#0891b2"/><stop offset="1" stop-color="#22d3ee"/></linearGradient></defs>
        </svg>
        <div class="header-text">
            <h1>Aegis OS Media Creation Tool</h1>
            <p>Create bootable USB - Freemium Edition (FREE)</p>
        </div>
    </div>

    <div class="content">
        <div class="step-nav">
            <div class="step-item active">
                <div class="step-num">1</div>
                <div class="step-label">Select USB</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item">
                <div class="step-num">2</div>
                <div class="step-label">Confirm</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item">
                <div class="step-num">3</div>
                <div class="step-label">Create</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item">
                <div class="step-num">4</div>
                <div class="step-label">Done</div>
            </div>
        </div>

        <div id="step1" class="panel active">
            <div class="section-title">Select USB Drive</div>
            <div class="section-desc">Choose a USB drive (4GB+). All data will be erased.</div>

            <div id="adminNotice" class="admin-notice" style="display:none">
                <strong>Note:</strong> Right-click and "Run as Administrator" for best results.
            </div>

            <div class="sys-req-box">
                <h3 style="font-size:11px;color:#22d3ee;margin-bottom:6px">System Requirements</h3>
                <div id="sysReqContent">Checking...</div>
            </div>

            <div id="driveList" class="drive-list"><div class="no-drives">Scanning for USB drives...</div></div>

            <div class="option-group">
                <label class="option-label">Partition Style</label>
                <div class="radio-group">
                    <label class="radio-item"><input type="radio" name="partStyle" checked onclick="SetPartitionStyle 'GPT'"> GPT (UEFI)</label>
                    <label class="radio-item"><input type="radio" name="partStyle" onclick="SetPartitionStyle 'MBR'"> MBR (Legacy BIOS)</label>
                </div>
            </div>

            <div class="option-group">
                <label class="checkbox-item"><input type="checkbox" id="chkQuickFormat" checked onclick="SetQuickFormat"> Quick Format (faster)</label>
            </div>

            <div class="est-time" id="estTimeDisplay">Estimated time: 15-30 minutes</div>

            <div class="premium-card">
                <h4>&#9733; Premium Editions Include:</h4>
                <div class="premium-features">
                    <div class="premium-feature"><span class="premium-feature-icon">&#10003;</span> Gaming optimizations</div>
                    <div class="premium-feature"><span class="premium-feature-icon">&#10003;</span> AI/ML frameworks</div>
                    <div class="premium-feature"><span class="premium-feature-icon">&#10003;</span> Office integration</div>
                    <div class="premium-feature"><span class="premium-feature-icon">&#10003;</span> Server tools</div>
                    <div class="premium-feature"><span class="premium-feature-icon">&#10003;</span> Priority support</div>
                    <div class="premium-feature"><span class="premium-feature-icon">&#10003;</span> Custom themes</div>
                </div>
                <div class="upgrade-section">
                    <p>Unlock all features with a Premium license</p>
                    <button class="btn btn-upgrade" onclick="OpenUpgradeLink">Upgrade to Premium</button>
                </div>
            </div>

            <div class="btn-row">
                <button class="btn btn-refresh" onclick="RefreshDrives">Refresh</button>
                <div style="flex:1"></div>
                <button id="btnNext1" class="btn btn-primary" disabled onclick="GoToStep 2">Next</button>
            </div>
        </div>

        <div id="step2" class="panel">
            <div class="section-title">Confirm Your Selection</div>
            <div class="section-desc">Review the details below before proceeding.</div>

            <div class="warning-box">
                <strong>Warning:</strong> All data on the selected USB will be permanently deleted!
            </div>

            <div class="info-box">
                <h3>Selected Drive</h3>
                <p id="selectedDriveInfo" style="font-size:14px;margin-top:6px;color:#fff">-</p>
            </div>

            <div class="info-box">
                <h3>Configuration</h3>
                <ul>
                    <li>Edition: <strong style="color:#22d3ee">Aegis OS Freemium (FREE)</strong></li>
                    <li>Partition: <strong id="confirmPartStyle" style="color:#fff">GPT</strong></li>
                    <li>Quick Format: <strong id="confirmQuickFmt" style="color:#fff">Yes</strong></li>
                    <li>Download Size: ~2.9 GB</li>
                    <li>SHA256 verification included</li>
                </ul>
            </div>

            <div class="btn-row">
                <button class="btn btn-secondary" onclick="GoToStep 1">Back</button>
                <div style="flex:1"></div>
                <button class="btn btn-primary" onclick="StartCreation">Create USB</button>
            </div>
        </div>

        <div id="step3" class="panel">
            <div class="section-title">Creating Bootable USB</div>
            <div class="section-desc">Please wait while we create your installation media.</div>

            <div id="progressContainer" class="progress-container">
                <div class="progress-percent" id="progressPercent">0%</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressBar"></div></div>
                <div class="progress-status" id="progressStatus">Initializing...</div>
                <div class="progress-detail" id="progressDetail"></div>
                <div class="progress-stats">
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="statSpeed">--</div>
                        <div class="progress-stat-label">Speed</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="statETA">--</div>
                        <div class="progress-stat-label">ETA</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="statSize">--</div>
                        <div class="progress-stat-label">Size</div>
                    </div>
                </div>
            </div>

            <div class="warning-box" style="margin-top:12px">
                <strong>Do not remove the USB drive</strong> until complete.
            </div>
        </div>

        <div id="step4" class="panel">
            <div class="success-container">
                <svg class="logo-svg" style="width:48px;height:48px;margin-bottom:12px" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="24" cy="24" r="20" fill="#10b981" stroke="#34d399" stroke-width="2"/>
                    <path d="M15 24l7 7 11-14" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="success-title">USB Creation Complete!</div>
                <div class="success-desc">Your Aegis OS bootable USB is ready.</div>

                <div class="verification-box">
                    <div class="verification-title">&#10003; Download Verified</div>
                    <div class="verification-hash">SHA256 checksum passed</div>
                </div>

                <div class="success-steps">
                    <h3>Next Steps:</h3>
                    <ol>
                        <li>Safely eject the USB drive</li>
                        <li>Insert into target computer</li>
                        <li>Restart and press F12/F2/DEL/ESC</li>
                        <li>Select USB to boot</li>
                        <li>Choose "Try" or "Install"</li>
                    </ol>
                </div>

                <div class="upgrade-section" style="margin-top:12px">
                    <p>Want more features? Upgrade to Premium!</p>
                    <button class="btn btn-upgrade" onclick="OpenUpgradeLink">Upgrade to Premium</button>
                </div>

                <div class="btn-row" style="justify-content:center">
                    <button class="btn btn-primary" onclick="CloseApp">Finish</button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        Aegis OS v2.6 - Commercial Software. Liability limited to purchase price.
    </div>
</div>
</body>
</html>
