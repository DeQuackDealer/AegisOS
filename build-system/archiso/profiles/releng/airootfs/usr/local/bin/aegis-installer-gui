#!/usr/bin/env python3
"""
Aegis OS GTK3 GUI Installer
Modern, dark-themed installer with step-by-step wizard
"""

import gi
gi.require_version('Gtk', '3.0')
from gi.repository import Gtk, Gdk, GLib, Pango
import subprocess
import os
import re
import threading
import time
import shlex

AEGIS_BLUE = "#3b82f6"
AEGIS_ORANGE = "#ff6600"
AEGIS_DARK_BG = "#1a1a2e"
AEGIS_DARKER_BG = "#0f0f1a"
AEGIS_CARD_BG = "#252540"
AEGIS_TEXT = "#e0e0e0"
AEGIS_TEXT_DIM = "#888888"

CSS = f"""
window {{
    background-color: {AEGIS_DARK_BG};
}}

.main-container {{
    background-color: {AEGIS_DARK_BG};
}}

.header-bar {{
    background: linear-gradient(135deg, {AEGIS_DARKER_BG} 0%, {AEGIS_DARK_BG} 100%);
    border-bottom: 2px solid {AEGIS_BLUE};
    padding: 20px;
}}

.title-label {{
    color: {AEGIS_BLUE};
    font-size: 28px;
    font-weight: bold;
}}

.subtitle-label {{
    color: {AEGIS_TEXT_DIM};
    font-size: 14px;
}}

.step-indicator {{
    background-color: {AEGIS_CARD_BG};
    border-radius: 8px;
    padding: 15px;
    margin: 10px;
}}

.step-dot {{
    min-width: 12px;
    min-height: 12px;
    border-radius: 6px;
    background-color: {AEGIS_TEXT_DIM};
}}

.step-dot-active {{
    background-color: {AEGIS_BLUE};
}}

.step-dot-completed {{
    background-color: {AEGIS_ORANGE};
}}

.step-label {{
    color: {AEGIS_TEXT_DIM};
    font-size: 12px;
}}

.step-label-active {{
    color: {AEGIS_BLUE};
    font-weight: bold;
}}

.content-area {{
    background-color: {AEGIS_DARK_BG};
    padding: 30px;
}}

.card {{
    background-color: {AEGIS_CARD_BG};
    border-radius: 12px;
    padding: 25px;
    margin: 10px;
}}

.section-title {{
    color: {AEGIS_TEXT};
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 15px;
}}

.section-subtitle {{
    color: {AEGIS_TEXT_DIM};
    font-size: 14px;
    margin-bottom: 20px;
}}

.input-label {{
    color: {AEGIS_TEXT};
    font-size: 13px;
    margin-bottom: 5px;
}}

entry {{
    background-color: {AEGIS_DARKER_BG};
    color: {AEGIS_TEXT};
    border: 1px solid {AEGIS_TEXT_DIM};
    border-radius: 6px;
    padding: 10px;
    font-size: 14px;
}}

entry:focus {{
    border-color: {AEGIS_BLUE};
}}

.disk-row {{
    background-color: {AEGIS_DARKER_BG};
    border-radius: 8px;
    padding: 15px;
    margin: 5px 0;
    border: 2px solid transparent;
}}

.disk-row:hover {{
    border-color: {AEGIS_BLUE};
}}

.disk-row-selected {{
    border-color: {AEGIS_ORANGE};
    background-color: rgba(255, 102, 0, 0.1);
}}

.disk-name {{
    color: {AEGIS_TEXT};
    font-size: 16px;
    font-weight: bold;
}}

.disk-info {{
    color: {AEGIS_TEXT_DIM};
    font-size: 12px;
}}

.nav-button {{
    background-color: {AEGIS_CARD_BG};
    color: {AEGIS_TEXT};
    border: 1px solid {AEGIS_TEXT_DIM};
    border-radius: 8px;
    padding: 12px 30px;
    font-size: 14px;
    font-weight: bold;
}}

.nav-button:hover {{
    background-color: {AEGIS_TEXT_DIM};
    color: {AEGIS_DARKER_BG};
}}

.nav-button-primary {{
    background-color: {AEGIS_BLUE};
    color: white;
    border: none;
}}

.nav-button-primary:hover {{
    background-color: #2563eb;
}}

.nav-button-danger {{
    background-color: {AEGIS_ORANGE};
    color: white;
    border: none;
}}

.warning-label {{
    color: {AEGIS_ORANGE};
    font-size: 12px;
}}

.error-label {{
    color: #ef4444;
    font-size: 12px;
}}

.success-label {{
    color: #22c55e;
    font-size: 12px;
}}

.progress-bar {{
    background-color: {AEGIS_DARKER_BG};
    border-radius: 8px;
}}

.progress-bar progress {{
    background-color: {AEGIS_BLUE};
    border-radius: 8px;
}}

.log-view {{
    background-color: {AEGIS_DARKER_BG};
    color: {AEGIS_TEXT};
    font-family: monospace;
    font-size: 11px;
    border-radius: 8px;
    padding: 10px;
}}

.license-text {{
    background-color: {AEGIS_DARKER_BG};
    color: {AEGIS_TEXT};
    font-family: monospace;
    font-size: 11px;
    padding: 15px;
    border-radius: 8px;
}}

checkbutton {{
    color: {AEGIS_TEXT};
}}

combobox {{
    background-color: {AEGIS_DARKER_BG};
    color: {AEGIS_TEXT};
    border-radius: 6px;
}}

.completion-icon {{
    color: #22c55e;
    font-size: 72px;
}}

.edition-label {{
    color: {AEGIS_ORANGE};
    font-size: 16px;
    font-weight: bold;
}}

.license-valid {{
    color: #22c55e;
    font-weight: bold;
}}

.license-invalid {{
    color: #ef4444;
}}
"""

TIMEZONES = [
    "UTC",
    "America/New_York",
    "America/Chicago",
    "America/Denver",
    "America/Los_Angeles",
    "America/Toronto",
    "America/Vancouver",
    "America/Sao_Paulo",
    "America/Mexico_City",
    "Europe/London",
    "Europe/Paris",
    "Europe/Berlin",
    "Europe/Rome",
    "Europe/Madrid",
    "Europe/Moscow",
    "Europe/Istanbul",
    "Asia/Tokyo",
    "Asia/Shanghai",
    "Asia/Hong_Kong",
    "Asia/Singapore",
    "Asia/Seoul",
    "Asia/Kolkata",
    "Asia/Dubai",
    "Australia/Sydney",
    "Australia/Melbourne",
    "Pacific/Auckland",
]

LOCALES = [
    ("en_US.UTF-8", "English (US)"),
    ("en_GB.UTF-8", "English (UK)"),
    ("de_DE.UTF-8", "German"),
    ("fr_FR.UTF-8", "French"),
    ("es_ES.UTF-8", "Spanish"),
    ("it_IT.UTF-8", "Italian"),
    ("pt_BR.UTF-8", "Portuguese (Brazil)"),
    ("ru_RU.UTF-8", "Russian"),
    ("zh_CN.UTF-8", "Chinese (Simplified)"),
    ("ja_JP.UTF-8", "Japanese"),
    ("ko_KR.UTF-8", "Korean"),
]

LICENSE_KEY_PATTERN = r'^AEGIS-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$'

EDITION_PREFIXES = {
    "BASIC": "Basic Edition",
    "GAMER": "Gamer Edition",
    "AIDEV": "AI Developer Edition",
    "SERVER": "Server Edition",
    "WORK": "Workplace Edition",
    "PRO": "Pro Edition",
}

class AegisInstaller(Gtk.Window):
    def __init__(self):
        super().__init__(title="Aegis OS Installer")
        self.set_default_size(900, 700)
        self.set_position(Gtk.WindowPosition.CENTER)
        self.set_resizable(True)
        
        self.current_step = 0
        self.steps = [
            "Welcome",
            "License",
            "Disk Selection",
            "Region",
            "User Setup",
            "Install",
            "Complete"
        ]
        
        self.selected_disk = None
        self.hostname = "aegis"
        self.timezone = "UTC"
        self.locale = "en_US.UTF-8"
        self.license_key = ""
        self.license_validated = False
        self.is_freemium = False
        self.edition_name = "Freemium Edition"
        self.installation_complete = False
        self.username = ""
        self.password = ""
        self.display_name = ""
        
        self.apply_css()
        self.build_ui()
        
    def apply_css(self):
        css_provider = Gtk.CssProvider()
        css_provider.load_from_data(CSS.encode())
        Gtk.StyleContext.add_provider_for_screen(
            Gdk.Screen.get_default(),
            css_provider,
            Gtk.STYLE_PROVIDER_PRIORITY_APPLICATION
        )
        
    def build_ui(self):
        main_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        main_box.get_style_context().add_class("main-container")
        self.add(main_box)
        
        header = self.create_header()
        main_box.pack_start(header, False, False, 0)
        
        step_indicator = self.create_step_indicator()
        main_box.pack_start(step_indicator, False, False, 0)
        
        self.content_stack = Gtk.Stack()
        self.content_stack.set_transition_type(Gtk.StackTransitionType.SLIDE_LEFT_RIGHT)
        self.content_stack.set_transition_duration(300)
        
        self.content_stack.add_named(self.create_welcome_page(), "welcome")
        self.content_stack.add_named(self.create_license_page(), "license")
        self.content_stack.add_named(self.create_disk_page(), "disk")
        self.content_stack.add_named(self.create_region_page(), "region")
        self.content_stack.add_named(self.create_user_page(), "user")
        self.content_stack.add_named(self.create_install_page(), "install")
        self.content_stack.add_named(self.create_complete_page(), "complete")
        
        main_box.pack_start(self.content_stack, True, True, 0)
        
        nav_bar = self.create_navigation()
        main_box.pack_start(nav_bar, False, False, 0)
        
        self.update_step_indicator()
        
    def create_header(self):
        header = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL)
        header.get_style_context().add_class("header-bar")
        header.set_spacing(15)
        
        logo_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        logo_box.set_valign(Gtk.Align.CENTER)
        
        title = Gtk.Label(label="AEGIS OS")
        title.get_style_context().add_class("title-label")
        title.set_halign(Gtk.Align.START)
        logo_box.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label(label="Gaming OS ‚Ä¢ Installation Wizard")
        subtitle.get_style_context().add_class("subtitle-label")
        subtitle.set_halign(Gtk.Align.START)
        logo_box.pack_start(subtitle, False, False, 0)
        
        header.pack_start(logo_box, False, False, 0)
        
        boot_mode = "UEFI" if os.path.isdir("/sys/firmware/efi") else "BIOS"
        mode_label = Gtk.Label(label=f"Boot Mode: {boot_mode}")
        mode_label.get_style_context().add_class("subtitle-label")
        mode_label.set_halign(Gtk.Align.END)
        header.pack_end(mode_label, False, False, 0)
        
        return header
        
    def create_step_indicator(self):
        self.step_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL)
        self.step_box.get_style_context().add_class("step-indicator")
        self.step_box.set_halign(Gtk.Align.CENTER)
        self.step_box.set_spacing(10)
        
        self.step_dots = []
        self.step_labels = []
        
        for i, step in enumerate(self.steps):
            step_item = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
            step_item.set_spacing(5)
            step_item.set_halign(Gtk.Align.CENTER)
            
            dot = Gtk.DrawingArea()
            dot.set_size_request(12, 12)
            dot.get_style_context().add_class("step-dot")
            self.step_dots.append(dot)
            step_item.pack_start(dot, False, False, 0)
            
            label = Gtk.Label(label=step)
            label.get_style_context().add_class("step-label")
            self.step_labels.append(label)
            step_item.pack_start(label, False, False, 0)
            
            self.step_box.pack_start(step_item, False, False, 15)
            
            if i < len(self.steps) - 1:
                line = Gtk.DrawingArea()
                line.set_size_request(30, 2)
                line.set_valign(Gtk.Align.CENTER)
                self.step_box.pack_start(line, False, False, 0)
        
        return self.step_box
        
    def update_step_indicator(self):
        for i, (dot, label) in enumerate(zip(self.step_dots, self.step_labels)):
            dot.get_style_context().remove_class("step-dot-active")
            dot.get_style_context().remove_class("step-dot-completed")
            label.get_style_context().remove_class("step-label-active")
            
            if i < self.current_step:
                dot.get_style_context().add_class("step-dot-completed")
            elif i == self.current_step:
                dot.get_style_context().add_class("step-dot-active")
                label.get_style_context().add_class("step-label-active")
                
    def create_welcome_page(self):
        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        page.get_style_context().add_class("content-area")
        page.set_spacing(20)
        
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        card.get_style_context().add_class("card")
        card.set_spacing(15)
        card.set_valign(Gtk.Align.CENTER)
        
        title = Gtk.Label(label="Welcome to Aegis OS")
        title.get_style_context().add_class("section-title")
        title.set_halign(Gtk.Align.CENTER)
        card.pack_start(title, False, False, 0)
        
        edition = self.detect_edition()
        edition_label = Gtk.Label(label=f"Edition: {edition}")
        edition_label.get_style_context().add_class("section-subtitle")
        edition_label.set_halign(Gtk.Align.CENTER)
        card.pack_start(edition_label, False, False, 0)
        
        desc = Gtk.Label()
        desc.set_markup(
            "This wizard will guide you through installing <b>Aegis OS</b> on your computer.\n\n"
            "‚Ä¢ Optimized for gaming performance\n"
            "‚Ä¢ Windows-like interface with XFCE\n"
            "‚Ä¢ Pre-configured with gaming tools\n"
            "‚Ä¢ Easy to use and customize\n\n"
            "Click <b>Next</b> to continue with the installation."
        )
        desc.set_line_wrap(True)
        desc.set_halign(Gtk.Align.CENTER)
        desc.set_justify(Gtk.Justification.CENTER)
        card.pack_start(desc, False, False, 20)
        
        page.pack_start(card, True, True, 0)
        
        return page
        
    def detect_edition(self):
        if os.path.exists("/etc/aegis/edition"):
            try:
                with open("/etc/aegis/edition") as f:
                    return f.read().strip()
            except:
                pass
        if os.path.exists("/etc/aegis-freemium-marker"):
            return "Freemium Edition"
        return "Gaming Edition"
    
    def create_license_page(self):
        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        page.get_style_context().add_class("content-area")
        page.set_spacing(20)
        
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        card.get_style_context().add_class("card")
        card.set_spacing(15)
        
        title = Gtk.Label(label="License Key")
        title.get_style_context().add_class("section-title")
        title.set_halign(Gtk.Align.START)
        card.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label(label="Enter your license key to unlock premium features, or continue with the free edition.")
        subtitle.get_style_context().add_class("section-subtitle")
        subtitle.set_halign(Gtk.Align.START)
        subtitle.set_line_wrap(True)
        card.pack_start(subtitle, False, False, 0)
        
        license_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL)
        license_box.set_spacing(10)
        
        license_label = Gtk.Label(label="License Key:")
        license_label.get_style_context().add_class("input-label")
        license_box.pack_start(license_label, False, False, 0)
        
        self.license_entry = Gtk.Entry()
        self.license_entry.set_placeholder_text("AEGIS-XXXX-XXXX-XXXX-XXXX")
        self.license_entry.set_hexpand(True)
        self.license_entry.set_width_chars(30)
        self.license_entry.connect("changed", self.on_license_changed)
        license_box.pack_start(self.license_entry, True, True, 0)
        
        self.validate_btn = Gtk.Button(label="Validate")
        self.validate_btn.get_style_context().add_class("nav-button-primary")
        self.validate_btn.connect("clicked", self.on_validate_license)
        license_box.pack_start(self.validate_btn, False, False, 0)
        
        card.pack_start(license_box, False, False, 10)
        
        self.license_status_label = Gtk.Label()
        self.license_status_label.set_halign(Gtk.Align.START)
        card.pack_start(self.license_status_label, False, False, 0)
        
        self.edition_display = Gtk.Label()
        self.edition_display.get_style_context().add_class("edition-label")
        self.edition_display.set_halign(Gtk.Align.START)
        card.pack_start(self.edition_display, False, False, 5)
        
        format_hint = Gtk.Label()
        format_hint.set_markup("<small>Format: AEGIS-XXXX-XXXX-XXXX-XXXX (e.g., AEGIS-BASIC-1234-ABCD-5678)</small>")
        format_hint.get_style_context().add_class("section-subtitle")
        format_hint.set_halign(Gtk.Align.START)
        card.pack_start(format_hint, False, False, 10)
        
        page.pack_start(card, False, False, 0)
        
        freemium_card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        freemium_card.get_style_context().add_class("card")
        freemium_card.set_spacing(15)
        
        freemium_title = Gtk.Label(label="No License Key?")
        freemium_title.get_style_context().add_class("section-title")
        freemium_title.set_halign(Gtk.Align.START)
        freemium_card.pack_start(freemium_title, False, False, 0)
        
        freemium_desc = Gtk.Label()
        freemium_desc.set_markup(
            "You can continue with the <b>Freemium Edition</b> which includes:\n"
            "‚Ä¢ Full desktop environment\n"
            "‚Ä¢ Basic gaming optimizations\n"
            "‚Ä¢ Community support\n\n"
            "Premium features can be unlocked later by purchasing a license."
        )
        freemium_desc.set_line_wrap(True)
        freemium_desc.set_halign(Gtk.Align.START)
        freemium_card.pack_start(freemium_desc, False, False, 0)
        
        self.freemium_btn = Gtk.Button(label="Continue with Freemium Edition")
        self.freemium_btn.get_style_context().add_class("nav-button")
        self.freemium_btn.connect("clicked", self.on_freemium_selected)
        self.freemium_btn.set_halign(Gtk.Align.START)
        freemium_card.pack_start(self.freemium_btn, False, False, 10)
        
        page.pack_start(freemium_card, False, False, 0)
        
        return page
    
    def on_license_changed(self, widget):
        text = widget.get_text().upper()
        if text != widget.get_text():
            widget.set_text(text)
            widget.set_position(-1)
        self.license_validated = False
        self.is_freemium = False
        self.license_status_label.set_text("")
        self.edition_display.set_text("")
        self.update_navigation()
    
    def validate_license_format(self, key):
        return bool(re.match(LICENSE_KEY_PATTERN, key))
    
    def get_edition_from_key(self, key):
        if not key or len(key) < 6:
            return "Unknown Edition"
        parts = key.split("-")
        if len(parts) >= 2:
            prefix = parts[1]
            return EDITION_PREFIXES.get(prefix, f"{prefix} Edition")
        return "Unknown Edition"
    
    def on_validate_license(self, widget):
        key = self.license_entry.get_text().strip().upper()
        
        if self.validate_license_format(key):
            self.license_key = key
            self.license_validated = True
            self.is_freemium = False
            self.edition_name = self.get_edition_from_key(key)
            
            self.license_status_label.set_markup('<span color="#22c55e">‚úì License key format is valid</span>')
            self.edition_display.set_text(f"Edition: {self.edition_name}")
        else:
            self.license_validated = False
            self.license_key = ""
            self.license_status_label.set_markup('<span color="#ef4444">‚úó Invalid license key format</span>')
            self.edition_display.set_text("")
        
        self.update_navigation()
    
    def on_freemium_selected(self, widget):
        self.license_key = ""
        self.license_validated = False
        self.is_freemium = True
        self.edition_name = "Freemium Edition"
        
        self.license_status_label.set_markup('<span color="#22c55e">‚úì Freemium Edition selected</span>')
        self.edition_display.set_text("Edition: Freemium Edition")
        self.license_entry.set_text("")
        
        self.current_step = 2
        self.show_current_step()
        self.update_navigation()
    
    def create_disk_page(self):
        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        page.get_style_context().add_class("content-area")
        page.set_spacing(20)
        
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        card.get_style_context().add_class("card")
        card.set_spacing(15)
        
        title = Gtk.Label(label="Select Installation Disk")
        title.get_style_context().add_class("section-title")
        title.set_halign(Gtk.Align.START)
        card.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label(label="Choose the disk where Aegis OS will be installed. WARNING: All data on the selected disk will be erased!")
        subtitle.get_style_context().add_class("warning-label")
        subtitle.set_line_wrap(True)
        subtitle.set_halign(Gtk.Align.START)
        card.pack_start(subtitle, False, False, 0)
        
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        scroll.set_min_content_height(300)
        
        self.disk_list = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        self.disk_list.set_spacing(5)
        scroll.add(self.disk_list)
        card.pack_start(scroll, True, True, 0)
        
        refresh_btn = Gtk.Button(label="‚Üª Refresh Disk List")
        refresh_btn.get_style_context().add_class("nav-button")
        refresh_btn.connect("clicked", self.refresh_disks)
        refresh_btn.set_halign(Gtk.Align.START)
        card.pack_start(refresh_btn, False, False, 0)
        
        page.pack_start(card, True, True, 0)
        
        self.refresh_disks()
        
        return page
        
    def refresh_disks(self, widget=None):
        for child in self.disk_list.get_children():
            self.disk_list.remove(child)
            
        try:
            result = subprocess.run(
                ["lsblk", "-d", "-o", "NAME,SIZE,MODEL,TYPE", "-n"],
                capture_output=True, text=True
            )
            
            for line in result.stdout.strip().split('\n'):
                if not line or 'loop' in line or 'rom' in line.lower():
                    continue
                    
                parts = line.split()
                if len(parts) >= 2 and parts[-1] == 'disk':
                    name = parts[0]
                    size = parts[1] if len(parts) > 1 else "Unknown"
                    model = ' '.join(parts[2:-1]) if len(parts) > 3 else "Unknown"
                    
                    row = self.create_disk_row(name, size, model)
                    self.disk_list.pack_start(row, False, False, 0)
                    
            self.disk_list.show_all()
        except Exception as e:
            error_label = Gtk.Label(label=f"Error scanning disks: {str(e)}")
            error_label.get_style_context().add_class("error-label")
            self.disk_list.pack_start(error_label, False, False, 0)
            self.disk_list.show_all()
            
    def create_disk_row(self, name, size, model):
        event_box = Gtk.EventBox()
        
        row = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL)
        row.get_style_context().add_class("disk-row")
        row.set_spacing(15)
        
        icon = Gtk.Label(label="üíæ")
        icon.set_size_request(40, 40)
        row.pack_start(icon, False, False, 10)
        
        info_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        info_box.set_spacing(3)
        
        name_label = Gtk.Label(label=f"/dev/{name}")
        name_label.get_style_context().add_class("disk-name")
        name_label.set_halign(Gtk.Align.START)
        info_box.pack_start(name_label, False, False, 0)
        
        detail_label = Gtk.Label(label=f"{size} ‚Ä¢ {model}")
        detail_label.get_style_context().add_class("disk-info")
        detail_label.set_halign(Gtk.Align.START)
        info_box.pack_start(detail_label, False, False, 0)
        
        row.pack_start(info_box, True, True, 0)
        
        event_box.add(row)
        event_box.connect("button-press-event", self.on_disk_selected, name, row)
        event_box.disk_name = name
        event_box.disk_row = row
        
        return event_box
        
    def on_disk_selected(self, widget, event, name, row):
        for child in self.disk_list.get_children():
            child.disk_row.get_style_context().remove_class("disk-row-selected")
            
        row.get_style_context().add_class("disk-row-selected")
        self.selected_disk = name
        self.update_navigation()
        
    def create_region_page(self):
        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        page.get_style_context().add_class("content-area")
        page.set_spacing(20)
        
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        card.get_style_context().add_class("card")
        card.set_spacing(15)
        
        title = Gtk.Label(label="Region Settings")
        title.get_style_context().add_class("section-title")
        title.set_halign(Gtk.Align.START)
        card.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label(label="Select your timezone and language settings.")
        subtitle.get_style_context().add_class("section-subtitle")
        subtitle.set_halign(Gtk.Align.START)
        card.pack_start(subtitle, False, False, 0)
        
        grid = Gtk.Grid()
        grid.set_column_spacing(20)
        grid.set_row_spacing(15)
        
        tz_label = Gtk.Label(label="Timezone")
        tz_label.get_style_context().add_class("input-label")
        tz_label.set_halign(Gtk.Align.START)
        grid.attach(tz_label, 0, 0, 1, 1)
        
        self.tz_combo = Gtk.ComboBoxText()
        for tz in TIMEZONES:
            self.tz_combo.append_text(tz)
        self.tz_combo.set_active(0)
        self.tz_combo.set_hexpand(True)
        grid.attach(self.tz_combo, 0, 1, 1, 1)
        
        locale_label = Gtk.Label(label="Language / Locale")
        locale_label.get_style_context().add_class("input-label")
        locale_label.set_halign(Gtk.Align.START)
        grid.attach(locale_label, 1, 0, 1, 1)
        
        self.locale_combo = Gtk.ComboBoxText()
        for code, name in LOCALES:
            self.locale_combo.append_text(f"{name} ({code})")
        self.locale_combo.set_active(0)
        self.locale_combo.set_hexpand(True)
        self.locale_combo.connect("changed", self.on_region_changed)
        grid.attach(self.locale_combo, 1, 1, 1, 1)
        
        self.tz_combo.connect("changed", self.on_region_changed)
        
        hostname_label = Gtk.Label(label="Hostname")
        hostname_label.get_style_context().add_class("input-label")
        hostname_label.set_halign(Gtk.Align.START)
        grid.attach(hostname_label, 0, 2, 1, 1)
        
        self.hostname_entry = Gtk.Entry()
        self.hostname_entry.set_text("aegis")
        self.hostname_entry.set_placeholder_text("aegis")
        self.hostname_entry.set_hexpand(True)
        grid.attach(self.hostname_entry, 0, 3, 1, 1)
        
        card.pack_start(grid, True, True, 0)
        
        summary_title = Gtk.Label(label="Installation Summary")
        summary_title.get_style_context().add_class("section-title")
        summary_title.set_halign(Gtk.Align.START)
        summary_title.set_margin_top(30)
        card.pack_start(summary_title, False, False, 0)
        
        self.summary_label = Gtk.Label()
        self.summary_label.set_halign(Gtk.Align.START)
        self.summary_label.set_line_wrap(True)
        card.pack_start(self.summary_label, False, False, 0)
        
        page.pack_start(card, True, True, 0)
        
        return page
    
    def on_region_changed(self, widget):
        if self.current_step == 3:
            self.update_summary()
        
    def update_summary(self):
        if not self.selected_disk:
            self.summary_label.set_text("Please select a disk first.")
            return
            
        boot_mode = "UEFI" if os.path.isdir("/sys/firmware/efi") else "BIOS"
        hostname = self.hostname_entry.get_text().strip() or self.hostname or "aegis"
        timezone = self.tz_combo.get_active_text() or "UTC"
        locale = LOCALES[self.locale_combo.get_active()][0] if self.locale_combo.get_active() >= 0 else "en_US.UTF-8"
        
        license_info = self.license_key if self.license_key else "Freemium (No License)"
        
        summary = f"""
Edition: {self.edition_name}
License: {license_info}
Target Disk: /dev/{self.selected_disk}
Boot Mode: {boot_mode}
Hostname: {hostname}
Timezone: {timezone}
Locale: {locale}
"""
        self.summary_label.set_text(summary)
    
    def create_user_page(self):
        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        page.get_style_context().add_class("content-area")
        page.set_spacing(20)
        
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        card.get_style_context().add_class("card")
        card.set_spacing(15)
        
        title = Gtk.Label(label="Create Your Account")
        title.get_style_context().add_class("section-title")
        title.set_halign(Gtk.Align.START)
        card.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label(label="Set up your user account for Aegis OS.")
        subtitle.get_style_context().add_class("section-subtitle")
        subtitle.set_halign(Gtk.Align.START)
        card.pack_start(subtitle, False, False, 0)
        
        grid = Gtk.Grid()
        grid.set_column_spacing(20)
        grid.set_row_spacing(15)
        grid.set_margin_top(10)
        
        # Username
        user_label = Gtk.Label(label="Username")
        user_label.get_style_context().add_class("input-label")
        user_label.set_halign(Gtk.Align.START)
        grid.attach(user_label, 0, 0, 1, 1)
        
        self.username_entry = Gtk.Entry()
        self.username_entry.set_placeholder_text("Enter username (lowercase, no spaces)")
        self.username_entry.set_hexpand(True)
        self.username_entry.connect("changed", self.on_user_input_changed)
        grid.attach(self.username_entry, 0, 1, 1, 1)
        
        # Display Name
        display_label = Gtk.Label(label="Display Name (Optional)")
        display_label.get_style_context().add_class("input-label")
        display_label.set_halign(Gtk.Align.START)
        grid.attach(display_label, 1, 0, 1, 1)
        
        self.displayname_entry = Gtk.Entry()
        self.displayname_entry.set_placeholder_text("Your full name")
        self.displayname_entry.set_hexpand(True)
        grid.attach(self.displayname_entry, 1, 1, 1, 1)
        
        # Password
        pass_label = Gtk.Label(label="Password")
        pass_label.get_style_context().add_class("input-label")
        pass_label.set_halign(Gtk.Align.START)
        grid.attach(pass_label, 0, 2, 1, 1)
        
        self.password_entry = Gtk.Entry()
        self.password_entry.set_visibility(False)
        self.password_entry.set_placeholder_text("Enter password")
        self.password_entry.set_hexpand(True)
        self.password_entry.connect("changed", self.on_user_input_changed)
        grid.attach(self.password_entry, 0, 3, 1, 1)
        
        # Confirm Password
        confirm_label = Gtk.Label(label="Confirm Password")
        confirm_label.get_style_context().add_class("input-label")
        confirm_label.set_halign(Gtk.Align.START)
        grid.attach(confirm_label, 1, 2, 1, 1)
        
        self.confirm_entry = Gtk.Entry()
        self.confirm_entry.set_visibility(False)
        self.confirm_entry.set_placeholder_text("Confirm password")
        self.confirm_entry.set_hexpand(True)
        self.confirm_entry.connect("changed", self.on_user_input_changed)
        grid.attach(self.confirm_entry, 1, 3, 1, 1)
        
        card.pack_start(grid, False, False, 0)
        
        # Validation message
        self.user_validation_label = Gtk.Label()
        self.user_validation_label.set_halign(Gtk.Align.START)
        self.user_validation_label.set_margin_top(10)
        card.pack_start(self.user_validation_label, False, False, 0)
        
        # Summary
        summary_title = Gtk.Label(label="Account Summary")
        summary_title.get_style_context().add_class("section-title")
        summary_title.set_halign(Gtk.Align.START)
        summary_title.set_margin_top(20)
        card.pack_start(summary_title, False, False, 0)
        
        self.user_summary_label = Gtk.Label()
        self.user_summary_label.set_halign(Gtk.Align.START)
        self.user_summary_label.set_line_wrap(True)
        card.pack_start(self.user_summary_label, False, False, 0)
        
        page.pack_start(card, True, True, 0)
        
        return page
    
    def on_user_input_changed(self, widget):
        self.validate_user_input()
        self.update_navigation()
    
    def validate_user_input(self):
        username = self.username_entry.get_text().strip()
        password = self.password_entry.get_text()
        confirm = self.confirm_entry.get_text()
        
        errors = []
        
        if not username:
            errors.append("Username is required")
        elif not re.match(r'^[a-z][a-z0-9_-]{0,31}$', username):
            errors.append("Username must be lowercase, start with a letter, and contain only letters, numbers, - or _")
        
        if not password:
            errors.append("Password is required")
        elif len(password) < 4:
            errors.append("Password must be at least 4 characters")
        
        if password and confirm and password != confirm:
            errors.append("Passwords do not match")
        
        if errors:
            self.user_validation_label.set_markup(f"<span foreground='#ff6b6b'>{errors[0]}</span>")
            return False
        else:
            self.user_validation_label.set_markup("<span foreground='#51cf66'>Account details are valid</span>")
            return True
    
    def update_user_summary(self):
        username = self.username_entry.get_text().strip()
        display_name = self.displayname_entry.get_text().strip() or username
        
        boot_mode = "UEFI" if os.path.isdir("/sys/firmware/efi") else "BIOS"
        license_info = self.license_key if self.license_key else "Freemium (No License)"
        
        summary = f"""
Edition: {self.edition_name}
License: {license_info}
Target Disk: /dev/{self.selected_disk}
Boot Mode: {boot_mode}
Hostname: {self.hostname}
Timezone: {self.timezone}
Locale: {self.locale}

User Account: {username}
Display Name: {display_name}

‚ö†Ô∏è All data on /dev/{self.selected_disk} will be permanently erased!
"""
        self.user_summary_label.set_text(summary)
        
    def create_install_page(self):
        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        page.get_style_context().add_class("content-area")
        page.set_spacing(20)
        
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        card.get_style_context().add_class("card")
        card.set_spacing(15)
        
        title = Gtk.Label(label="Installing Aegis OS")
        title.get_style_context().add_class("section-title")
        title.set_halign(Gtk.Align.START)
        card.pack_start(title, False, False, 0)
        
        self.install_status = Gtk.Label(label="Preparing installation...")
        self.install_status.get_style_context().add_class("section-subtitle")
        self.install_status.set_halign(Gtk.Align.START)
        card.pack_start(self.install_status, False, False, 0)
        
        self.progress_bar = Gtk.ProgressBar()
        self.progress_bar.get_style_context().add_class("progress-bar")
        self.progress_bar.set_show_text(True)
        card.pack_start(self.progress_bar, False, False, 10)
        
        log_label = Gtk.Label(label="Installation Log")
        log_label.get_style_context().add_class("input-label")
        log_label.set_halign(Gtk.Align.START)
        card.pack_start(log_label, False, False, 0)
        
        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.AUTOMATIC, Gtk.PolicyType.AUTOMATIC)
        scroll.set_min_content_height(250)
        
        self.log_buffer = Gtk.TextBuffer()
        self.log_view = Gtk.TextView(buffer=self.log_buffer)
        self.log_view.set_editable(False)
        self.log_view.set_cursor_visible(False)
        self.log_view.get_style_context().add_class("log-view")
        scroll.add(self.log_view)
        card.pack_start(scroll, True, True, 0)
        
        page.pack_start(card, True, True, 0)
        
        return page
        
    def create_complete_page(self):
        page = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        page.get_style_context().add_class("content-area")
        page.set_spacing(20)
        
        card = Gtk.Box(orientation=Gtk.Orientation.VERTICAL)
        card.get_style_context().add_class("card")
        card.set_spacing(15)
        card.set_halign(Gtk.Align.CENTER)
        card.set_valign(Gtk.Align.CENTER)
        
        icon = Gtk.Label(label="‚úì")
        icon.get_style_context().add_class("completion-icon")
        icon.set_markup('<span font="72" color="#22c55e">‚úì</span>')
        card.pack_start(icon, False, False, 20)
        
        title = Gtk.Label(label="Installation Complete!")
        title.get_style_context().add_class("section-title")
        card.pack_start(title, False, False, 0)
        
        self.complete_message = Gtk.Label()
        self.complete_message.set_line_wrap(True)
        self.complete_message.set_justify(Gtk.Justification.CENTER)
        card.pack_start(self.complete_message, False, False, 0)
        
        button_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL)
        button_box.set_halign(Gtk.Align.CENTER)
        button_box.set_spacing(20)
        
        reboot_btn = Gtk.Button(label="üîÑ Reboot Now")
        reboot_btn.get_style_context().add_class("nav-button-primary")
        reboot_btn.connect("clicked", self.on_reboot)
        button_box.pack_start(reboot_btn, False, False, 0)
        
        close_btn = Gtk.Button(label="Close Installer")
        close_btn.get_style_context().add_class("nav-button")
        close_btn.connect("clicked", lambda w: Gtk.main_quit())
        button_box.pack_start(close_btn, False, False, 0)
        
        card.pack_start(button_box, False, False, 20)
        
        page.pack_start(card, True, True, 0)
        
        return page
        
    def on_reboot(self, widget):
        try:
            subprocess.run(["reboot"], check=False)
        except:
            pass
        Gtk.main_quit()
        
    def create_navigation(self):
        nav = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL)
        nav.set_spacing(10)
        nav.set_margin_start(30)
        nav.set_margin_end(30)
        nav.set_margin_top(15)
        nav.set_margin_bottom(15)
        
        self.back_btn = Gtk.Button(label="‚Üê Back")
        self.back_btn.get_style_context().add_class("nav-button")
        self.back_btn.connect("clicked", self.on_back)
        nav.pack_start(self.back_btn, False, False, 0)
        
        spacer = Gtk.Box()
        nav.pack_start(spacer, True, True, 0)
        
        self.cancel_btn = Gtk.Button(label="Cancel")
        self.cancel_btn.get_style_context().add_class("nav-button")
        self.cancel_btn.connect("clicked", self.on_cancel)
        nav.pack_start(self.cancel_btn, False, False, 0)
        
        self.next_btn = Gtk.Button(label="Next ‚Üí")
        self.next_btn.get_style_context().add_class("nav-button-primary")
        self.next_btn.connect("clicked", self.on_next)
        nav.pack_start(self.next_btn, False, False, 0)
        
        self.update_navigation()
        
        return nav
        
    def update_navigation(self):
        self.back_btn.set_sensitive(self.current_step > 0 and self.current_step < 5)
        
        self.next_btn.get_style_context().remove_class("nav-button-danger")
        self.next_btn.get_style_context().add_class("nav-button-primary")
        
        if self.current_step == 0:
            self.next_btn.set_sensitive(True)
            self.next_btn.set_label("Next ‚Üí")
        elif self.current_step == 1:
            self.next_btn.set_sensitive(self.license_validated or self.is_freemium)
            self.next_btn.set_label("Next ‚Üí")
        elif self.current_step == 2:
            self.next_btn.set_sensitive(self.selected_disk is not None)
            self.next_btn.set_label("Next ‚Üí")
        elif self.current_step == 3:
            self.next_btn.set_sensitive(True)
            self.next_btn.set_label("Next ‚Üí")
        elif self.current_step == 4:
            user_valid = self.validate_user_input()
            self.next_btn.set_sensitive(user_valid)
            self.next_btn.set_label("Install ‚Üí")
            self.next_btn.get_style_context().remove_class("nav-button-primary")
            self.next_btn.get_style_context().add_class("nav-button-danger")
        elif self.current_step >= 5:
            self.next_btn.set_sensitive(False)
            self.back_btn.set_sensitive(False)
            self.cancel_btn.set_sensitive(False)
            
    def on_back(self, widget):
        if self.current_step > 0:
            self.current_step -= 1
            self.show_current_step()
            
    def on_next(self, widget):
        if self.current_step < len(self.steps) - 1:
            if self.current_step == 3:
                self.timezone = self.tz_combo.get_active_text() or "UTC"
                self.locale = LOCALES[self.locale_combo.get_active()][0] if self.locale_combo.get_active() >= 0 else "en_US.UTF-8"
                self.hostname = self.hostname_entry.get_text().strip() or "aegis"
            elif self.current_step == 4:
                self.username = self.username_entry.get_text().strip()
                self.display_name = self.displayname_entry.get_text().strip() or self.username
                self.password = self.password_entry.get_text()
                
            self.current_step += 1
            self.show_current_step()
            
            if self.current_step == 4:
                self.update_user_summary()
            elif self.current_step == 5:
                self.start_installation()
                
    def on_cancel(self, widget):
        dialog = Gtk.MessageDialog(
            transient_for=self,
            flags=0,
            message_type=Gtk.MessageType.QUESTION,
            buttons=Gtk.ButtonsType.YES_NO,
            text="Cancel Installation?"
        )
        dialog.format_secondary_text("Are you sure you want to cancel the installation?")
        response = dialog.run()
        dialog.destroy()
        
        if response == Gtk.ResponseType.YES:
            Gtk.main_quit()
            
    def show_current_step(self):
        pages = ["welcome", "license", "disk", "region", "user", "install", "complete"]
        self.content_stack.set_visible_child_name(pages[self.current_step])
        self.update_step_indicator()
        self.update_navigation()
        
        if self.current_step == 2:
            self.refresh_disks()
        elif self.current_step == 4:
            self.update_user_summary()
        
    def log(self, message):
        GLib.idle_add(self._log_ui, message)
        
    def _log_ui(self, message):
        end_iter = self.log_buffer.get_end_iter()
        self.log_buffer.insert(end_iter, message + "\n")
        mark = self.log_buffer.create_mark(None, self.log_buffer.get_end_iter(), False)
        self.log_view.scroll_to_mark(mark, 0, False, 0, 0)
        
    def update_progress(self, fraction, status):
        GLib.idle_add(self._update_progress_ui, fraction, status)
        
    def _update_progress_ui(self, fraction, status):
        self.progress_bar.set_fraction(fraction)
        self.progress_bar.set_text(f"{int(fraction * 100)}%")
        self.install_status.set_text(status)
        
    def start_installation(self):
        thread = threading.Thread(target=self.run_installation, daemon=True)
        thread.start()
        
    def run_installation(self):
        try:
            self.do_installation()
        except Exception as e:
            self.log(f"ERROR: {str(e)}")
            GLib.idle_add(self.show_error_dialog, str(e))
            
    def show_error_dialog(self, error):
        dialog = Gtk.MessageDialog(
            transient_for=self,
            flags=0,
            message_type=Gtk.MessageType.ERROR,
            buttons=Gtk.ButtonsType.OK,
            text="Installation Failed"
        )
        dialog.format_secondary_text(f"An error occurred during installation:\n\n{error}")
        dialog.run()
        dialog.destroy()
        
    def run_cmd(self, cmd, desc=None):
        if desc:
            self.log(f"‚Üí {desc}")
        try:
            result = subprocess.run(
                cmd, shell=True, 
                capture_output=True, text=True,
                timeout=1800
            )
            if result.stdout.strip():
                for line in result.stdout.strip().split('\n')[-5:]:
                    self.log(f"  {line}")
            if result.returncode != 0 and result.stderr.strip():
                self.log(f"  Warning: {result.stderr.strip()[:200]}")
            return result.returncode == 0
        except subprocess.TimeoutExpired:
            self.log(f"  Command timed out")
            return False
        except Exception as e:
            self.log(f"  Error: {str(e)}")
            return False
            
    def do_installation(self):
        disk = self.selected_disk
        is_uefi = os.path.isdir("/sys/firmware/efi")
        is_nvme = disk.startswith("nvme")
        
        if is_nvme:
            boot_part = f"/dev/{disk}p1"
            root_part = f"/dev/{disk}p2" if is_uefi else f"/dev/{disk}p1"
        else:
            boot_part = f"/dev/{disk}1"
            root_part = f"/dev/{disk}2" if is_uefi else f"/dev/{disk}1"
            
        self.update_progress(0.05, "Partitioning disk...")
        self.log("=" * 50)
        self.log("Starting Aegis OS Installation")
        self.log("=" * 50)
        self.log(f"Edition: {self.edition_name}")
        self.log(f"License: {self.license_key if self.license_key else 'Freemium'}")
        self.log(f"Target: /dev/{disk}")
        self.log(f"Boot mode: {'UEFI' if is_uefi else 'BIOS'}")
        self.log(f"First-boot user: aegis (passwordless)")
        self.log("")
        
        if is_uefi:
            self.run_cmd(f"parted -s /dev/{disk} mklabel gpt", "Creating GPT partition table")
            self.run_cmd(f"parted -s /dev/{disk} mkpart ESP fat32 1MiB 513MiB", "Creating EFI partition")
            self.run_cmd(f"parted -s /dev/{disk} set 1 esp on", "Setting ESP flag")
            self.run_cmd(f"parted -s /dev/{disk} mkpart primary ext4 513MiB 100%", "Creating root partition")
        else:
            self.run_cmd(f"parted -s /dev/{disk} mklabel msdos", "Creating MBR partition table")
            self.run_cmd(f"parted -s /dev/{disk} mkpart primary ext4 1MiB 100%", "Creating root partition")
            self.run_cmd(f"parted -s /dev/{disk} set 1 boot on", "Setting boot flag")
            
        time.sleep(2)
        
        self.update_progress(0.10, "Formatting partitions...")
        if is_uefi:
            self.run_cmd(f"mkfs.fat -F32 {boot_part}", "Formatting EFI partition")
        self.run_cmd(f"mkfs.ext4 -F {root_part}", "Formatting root partition")
        
        self.update_progress(0.15, "Mounting partitions...")
        self.run_cmd(f"mount {root_part} /mnt", "Mounting root partition")
        if is_uefi:
            self.run_cmd("mkdir -p /mnt/boot/efi", "Creating EFI mount point")
            self.run_cmd(f"mount {boot_part} /mnt/boot/efi", "Mounting EFI partition")
            
        self.update_progress(0.20, "Installing base system (this may take a while)...")
        self.log("Installing base packages...")
        if not self.run_cmd("pacstrap -K /mnt base linux linux-firmware base-devel", "Installing base system"):
            self.log("ERROR: pacstrap failed. Cleaning up mounts...")
            try:
                subprocess.run(["umount", "-R", "/mnt"], capture_output=True, timeout=60)
            except:
                pass
            raise Exception("Failed to install base system. Please check:\n- Network connection\n- Mirror availability\n- Disk space\n\nMounts have been cleaned up. You can retry the installation.")
            
        self.update_progress(0.50, "Generating filesystem table...")
        self.run_cmd("genfstab -U /mnt >> /mnt/etc/fstab", "Generating fstab")
        
        self.update_progress(0.55, "Configuring system...")
        
        HOSTNAME = self.hostname
        TIMEZONE = self.timezone
        LOCALE = self.locale
        LICENSE_KEY = self.license_key
        EDITION = self.edition_name
        
        escaped_license = LICENSE_KEY.replace("'", "'\\''") if LICENSE_KEY else ""
        
        chroot_script = f'''#!/bin/bash
set -e

# Timezone and locale configuration
ln -sf /usr/share/zoneinfo/{TIMEZONE} /etc/localtime
hwclock --systohc

echo "{LOCALE} UTF-8" >> /etc/locale.gen
locale-gen
echo "LANG={LOCALE}" > /etc/locale.conf

# Hostname configuration
echo "{HOSTNAME}" > /etc/hostname

cat > /etc/hosts << HOSTS
127.0.0.1   localhost
::1         localhost
127.0.1.1   {HOSTNAME}.localdomain {HOSTNAME}
HOSTS

# Network manager
pacman -S --noconfirm networkmanager
systemctl enable NetworkManager

'''
        
        if is_uefi:
            chroot_script += f'''
# UEFI bootloader installation
pacman -S --noconfirm grub efibootmgr
grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=Aegis --removable
'''
        else:
            chroot_script += f'''
# BIOS/Legacy bootloader installation
pacman -S --noconfirm grub
grub-install --target=i386-pc /dev/{disk}
'''
        
        USERNAME = self.username
        DISPLAY_NAME = self.display_name
        PASSWORD = self.password
        
        chroot_script += f'''
grub-mkconfig -o /boot/grub/grub.cfg

# Create user account with password
useradd -m -G wheel,audio,video,storage,optical,games,input -s /bin/bash -c "{DISPLAY_NAME}" {USERNAME}
echo "{USERNAME}:{PASSWORD}" | chpasswd

# Configure sudo access for wheel group (password required for security)
sed -i 's/^# *%wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' /etc/sudoers
grep -q "^%wheel ALL=(ALL:ALL) ALL" /etc/sudoers || echo "%wheel ALL=(ALL:ALL) ALL" >> /etc/sudoers

# Desktop environment
pacman -S --noconfirm xfce4 xfce4-goodies lightdm lightdm-gtk-greeter
systemctl enable lightdm

# Configure LightDM for standard login (no autologin - secure by default)
mkdir -p /etc/lightdm
cat > /etc/lightdm/lightdm.conf << LIGHTDM_EOF
[LightDM]
run-directory=/run/lightdm

[Seat:*]
user-session=xfce
greeter-session=lightdm-gtk-greeter
greeter-hide-users=false
LIGHTDM_EOF

# Configure the greeter styling
cat > /etc/lightdm/lightdm-gtk-greeter.conf << GREETER_EOF
[greeter]
background=/usr/share/backgrounds/aegis-wallpaper.png
theme-name=Adwaita-dark
icon-theme-name=Adwaita
font-name=Sans 10
xft-antialias=true
xft-hintstyle=slight
indicators=~host;~spacer;~clock;~spacer;~session;~power
clock-format=%H:%M
default-user-image=#avatar-default
hide-user-image=false
GREETER_EOF

# Create AccountsService entry for user
mkdir -p /var/lib/AccountsService/users
cat > /var/lib/AccountsService/users/{USERNAME} << ACCOUNTS_EOF
[User]
SystemAccount=false
ACCOUNTS_EOF

# Save license key if provided
mkdir -p /etc/aegis
echo "{EDITION}" > /etc/aegis/edition
echo "{USERNAME}" > /etc/aegis/primary-user
'''
        
        if LICENSE_KEY:
            chroot_script += f'''
# Save license key to installed system
echo '{escaped_license}' > /etc/aegis/license.key
chmod 600 /etc/aegis/license.key
'''
        else:
            chroot_script += '''
# Freemium installation - no license key
echo "FREEMIUM" > /etc/aegis/license.key
chmod 644 /etc/aegis/license.key
'''
        
        chroot_script += f'''
# Mark system for OOBE (Out-of-Box Experience) on first boot
touch /etc/aegis/.needs-oobe

# Enable OOBE service for first-boot wizard if it exists
if [ -f /etc/systemd/system/aegis-oobe.service ]; then
    systemctl enable aegis-oobe.service
fi

echo "Configuration complete - system ready for first boot with OOBE"
'''
        
        self.run_cmd("mkdir -p /mnt/tmp", "Creating /mnt/tmp directory")
        
        with open("/mnt/tmp/aegis-setup.sh", "w") as f:
            f.write(chroot_script)
        os.chmod("/mnt/tmp/aegis-setup.sh", 0o755)
        
        self.update_progress(0.60, "Setting timezone and locale...")
        self.log("Running system configuration...")
        
        result = subprocess.run(
            ["arch-chroot", "/mnt", "/tmp/aegis-setup.sh"],
            capture_output=True, text=True, timeout=1800
        )
        
        if result.stdout:
            for line in result.stdout.strip().split('\n')[-10:]:
                self.log(f"  {line}")
                
        self.update_progress(0.85, "Installing Aegis components...")
        self.run_cmd("cp -r /etc/aegis /mnt/etc/ 2>/dev/null || true", "Copying Aegis config")
        self.run_cmd("cp /usr/local/bin/aegis-* /mnt/usr/local/bin/ 2>/dev/null || true", "Copying Aegis tools")
        
        # Copy OOBE service files to installed system
        self.run_cmd("mkdir -p /mnt/etc/systemd/system", "Creating systemd directory")
        self.run_cmd("cp /etc/systemd/system/aegis-*.service /mnt/etc/systemd/system/ 2>/dev/null || true", "Copying Aegis services")
        
        # Create OOBE service if it doesn't exist in live ISO
        oobe_service = """[Unit]
Description=Aegis OS Out of Box Experience (OOBE) Wizard
After=graphical.target display-manager.service
Wants=graphical.target
ConditionPathExists=!/etc/aegis/.oobe-complete

[Service]
Type=simple
ExecStartPre=/bin/sleep 5
ExecStart=/usr/local/bin/aegis-oobe-launcher
Restart=no
TimeoutStartSec=30
TimeoutStopSec=10

[Install]
WantedBy=graphical.target
"""
        with open("/mnt/etc/systemd/system/aegis-oobe.service", "w") as f:
            f.write(oobe_service)
        self.log("Created OOBE service file")
        
        # Create OOBE launcher script
        oobe_launcher = """#!/bin/bash
# Aegis OOBE Launcher - finds logged in user and runs OOBE

OOBE_MARKER="/etc/aegis/.oobe-complete"

if [ -f "$OOBE_MARKER" ]; then
    exit 0
fi

# Find the logged-in user
DISPLAY_USER=""
for user_home in /home/*; do
    if [ -d "$user_home" ]; then
        username=$(basename "$user_home")
        if [ -f "$user_home/.Xauthority" ]; then
            DISPLAY_USER="$username"
            break
        fi
    fi
done

if [ -z "$DISPLAY_USER" ]; then
    DISPLAY_USER=$(who | grep -E '\\(:0\\)|\\(tty' | head -1 | awk '{print $1}')
fi

if [ -z "$DISPLAY_USER" ]; then
    DISPLAY_USER=$(ls /home/ 2>/dev/null | head -1)
fi

if [ -z "$DISPLAY_USER" ]; then
    DISPLAY_USER="aegis"
fi

USER_HOME="/home/$DISPLAY_USER"
XAUTH="$USER_HOME/.Xauthority"

export DISPLAY=":0"
export XAUTHORITY="$XAUTH"
export HOME="$USER_HOME"
export USER="$DISPLAY_USER"

exec sudo -u "$DISPLAY_USER" DISPLAY=":0" XAUTHORITY="$XAUTH" HOME="$USER_HOME" /usr/local/bin/aegis-oobe
"""
        with open("/mnt/usr/local/bin/aegis-oobe-launcher", "w") as f:
            f.write(oobe_launcher)
        os.chmod("/mnt/usr/local/bin/aegis-oobe-launcher", 0o755)
        self.log("Created OOBE launcher script")
        
        # Enable OOBE service in chroot
        subprocess.run(["arch-chroot", "/mnt", "systemctl", "enable", "aegis-oobe.service"], capture_output=True)
        self.log("Enabled OOBE service")
        
        self.update_progress(0.95, "Finishing installation...")
        os.remove("/mnt/tmp/aegis-setup.sh")
        self.run_cmd("umount -R /mnt", "Unmounting filesystems")
        
        self.update_progress(1.0, "Installation complete!")
        self.log("")
        self.log("=" * 50)
        self.log("Installation completed successfully!")
        self.log("=" * 50)
        self.log(f"Edition: {self.edition_name}")
        self.log(f"User Account: {self.username}")
        self.log("Please remove installation media and reboot.")
        self.log("Log in with your username and password.")
        
        self.installation_complete = True
        GLib.idle_add(self.show_completion)
        
    def show_completion(self):
        license_info = ""
        if self.license_key:
            license_info = f"License Key: {self.license_key}\n"
        else:
            license_info = "Edition: Freemium\n"
            
        self.complete_message.set_text(
            f"Aegis OS has been successfully installed.\n\n"
            f"Edition: {self.edition_name}\n"
            f"{license_info}"
            f"Username: {self.username}\n"
            f"Hostname: {self.hostname}\n\n"
            f"On first boot, log in with your username and password.\n"
            f"A setup wizard will help you configure your system.\n\n"
            f"Please remove the installation media and reboot your computer."
        )
        self.current_step = 6
        self.show_current_step()

def check_root():
    if os.geteuid() != 0:
        dialog = Gtk.MessageDialog(
            flags=0,
            message_type=Gtk.MessageType.ERROR,
            buttons=Gtk.ButtonsType.OK,
            text="Root Required"
        )
        dialog.format_secondary_text(
            "The Aegis OS Installer must be run as root.\n\n"
            "Please run: sudo aegis-installer-gui"
        )
        dialog.run()
        dialog.destroy()
        return False
    return True

def main():
    if not check_root():
        return 1
        
    win = AegisInstaller()
    win.connect("destroy", Gtk.main_quit)
    win.show_all()
    Gtk.main()
    return 0

if __name__ == "__main__":
    exit(main())
