<html>
<head>
<title>Aegis OS Media Creation Tool - Licensed</title>
<HTA:APPLICATION
    ID="AegisMediaToolPro"
    APPLICATIONNAME="Aegis OS Media Creation Tool"
    BORDER="dialog"
    BORDERSTYLE="normal"
    CAPTION="yes"
    MAXIMIZEBUTTON="no"
    MINIMIZEBUTTON="yes"
    SHOWINTASKBAR="yes"
    SINGLEINSTANCE="yes"
    SYSMENU="yes"
    VERSION="2.5"
    SCROLL="no"
/>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #fff;
    overflow: hidden;
}
.container { height: 100%; display: flex; flex-direction: column; }
.header {
    background: linear-gradient(135deg, #b45309 0%, #92400e 100%);
    padding: 20px 25px;
    display: flex;
    align-items: center;
    gap: 15px;
}
.logo-svg {
    width: 48px; height: 48px;
}
.shield-animate {
    animation: shieldPulse 2s ease-in-out infinite;
}
@keyframes shieldPulse {
    0%, 100% { transform: scale(1); filter: drop-shadow(0 0 3px rgba(245, 158, 11, 0.5)); }
    50% { transform: scale(1.05); filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.8)); }
}
.header-text h1 { font-size: 18px; font-weight: 600; }
.header-text p { font-size: 12px; opacity: 0.9; }
.content { flex: 1; padding: 25px; overflow-y: auto; }
.step-nav { display: flex; justify-content: center; gap: 18px; margin-bottom: 25px; }
.step-item { text-align: center; position: relative; }
.step-num {
    width: 32px; height: 32px; border-radius: 50%;
    background: #2a2a4a; border: 2px solid #444;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 5px; font-weight: 600; font-size: 13px;
    transition: all 0.3s ease;
}
.step-item.active .step-num { 
    background: linear-gradient(135deg, #b45309, #f59e0b); 
    border-color: #f59e0b; 
    box-shadow: 0 0 12px rgba(245, 158, 11, 0.4);
}
.step-item.done .step-num { 
    background: linear-gradient(135deg, #10b981, #34d399); 
    border-color: #34d399;
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
}
.step-label { font-size: 10px; color: #888; transition: color 0.3s; }
.step-item.active .step-label { color: #f59e0b; font-weight: 500; }
.step-item.done .step-label { color: #34d399; }
.step-connector {
    position: absolute; top: 16px; left: 50%; width: 36px; height: 2px;
    background: #333; margin-left: 16px;
}
.step-item.done .step-connector { background: linear-gradient(90deg, #34d399, #333); }
.panel { display: none; }
.panel.active { display: block; }
.section-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
.section-desc { font-size: 13px; color: #aaa; margin-bottom: 15px; line-height: 1.4; }
.info-box {
    background: rgba(180, 83, 9, 0.15);
    border: 1px solid rgba(180, 83, 9, 0.3);
    border-radius: 8px; padding: 12px; margin-bottom: 15px;
}
.info-box h3 { font-size: 13px; margin-bottom: 6px; color: #f59e0b; }
.info-box ul { font-size: 11px; color: #aaa; padding-left: 18px; }
.info-box li { margin-bottom: 3px; }
.form-group { margin-bottom: 12px; }
.form-label { display: block; font-size: 12px; margin-bottom: 5px; color: #aaa; }
.form-input {
    width: 100%; padding: 10px 12px;
    background: #1e1e3a; border: 1px solid #444;
    border-radius: 6px; color: #fff; font-size: 14px;
    transition: border-color 0.2s;
}
.form-input:focus { border-color: #f59e0b; outline: none; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2); }
.drive-list {
    background: #1e1e3a; border: 1px solid #333;
    border-radius: 8px; max-height: 140px; overflow-y: auto; margin-bottom: 12px;
}
.drive-item {
    padding: 10px 12px; border-bottom: 1px solid #333;
    cursor: pointer; display: flex; align-items: center; gap: 10px;
    transition: all 0.2s;
}
.drive-item:last-child { border-bottom: none; }
.drive-item:hover { background: #2a2a4a; }
.drive-item.selected { background: rgba(180, 83, 9, 0.3); border-left: 3px solid #f59e0b; }
.drive-icon {
    width: 32px; height: 32px; background: linear-gradient(135deg, #b45309, #f59e0b); border-radius: 6px;
    display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;
}
.drive-info { flex: 1; }
.drive-name { font-weight: 500; font-size: 13px; }
.drive-size { font-size: 11px; color: #888; }
.no-drives { padding: 25px; text-align: center; color: #888; font-size: 13px; }
.btn {
    padding: 10px 20px; border-radius: 6px;
    font-weight: 600; cursor: pointer; border: none; font-size: 13px;
    transition: all 0.2s;
}
.btn-primary { background: linear-gradient(135deg, #b45309, #d97706); color: white; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(180, 83, 9, 0.4); }
.btn-primary:disabled { background: #444; cursor: not-allowed; transform: none; box-shadow: none; }
.btn-secondary { background: #2a2a4a; color: #aaa; border: 1px solid #444; }
.btn-refresh { background: #1e1e3a; color: #f59e0b; padding: 6px 12px; font-size: 11px; }
.btn-row { display: flex; gap: 10px; margin-top: 15px; }
.progress-container { background: #1e1e3a; border-radius: 8px; padding: 20px; text-align: center; }
.progress-bar-bg { 
    height: 12px; background: #2a2a4a; border-radius: 6px; 
    overflow: hidden; margin: 15px 0; position: relative;
}
.progress-bar-fill {
    height: 100%; 
    background: linear-gradient(90deg, #b45309, #f59e0b, #b45309);
    background-size: 200% 100%;
    width: 0%; 
    transition: width 0.5s ease-out; 
    border-radius: 6px;
}
.progress-bar-fill.animated {
    animation: shimmer 1.5s infinite linear;
}
@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
.progress-percent { font-size: 32px; font-weight: 700; color: #f59e0b; }
.progress-status { font-size: 13px; color: #aaa; margin-top: 8px; }
.progress-detail { font-size: 11px; color: #666; margin-top: 5px; }
.progress-stats {
    display: flex; justify-content: center; gap: 15px; margin-top: 12px;
    font-size: 11px; color: #888;
}
.progress-stat { text-align: center; }
.progress-stat-value { font-size: 13px; color: #f59e0b; font-weight: 600; }
.progress-stat-label { font-size: 9px; color: #666; margin-top: 2px; }
.verification-box {
    background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 8px; padding: 10px; margin-top: 12px; text-align: left;
}
.verification-title { font-size: 11px; color: #10b981; margin-bottom: 3px; }
.verification-hash { font-size: 9px; color: #666; font-family: monospace; }
.success-container { text-align: center; padding: 20px; }
.success-icon { font-size: 40px; margin-bottom: 15px; color: #10b981; }
.success-title { font-size: 20px; color: #10b981; margin-bottom: 8px; }
.success-desc { font-size: 13px; color: #aaa; }
.success-steps { background: #1e1e3a; border-radius: 8px; padding: 15px; margin-top: 15px; text-align: left; }
.success-steps h3 { font-size: 13px; margin-bottom: 10px; }
.success-steps ol { padding-left: 18px; font-size: 12px; color: #aaa; }
.success-steps li { margin-bottom: 6px; }
.error-box {
    background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 8px; padding: 12px; color: #f87171; margin-top: 12px; font-size: 13px;
}
.error-details { font-size: 10px; color: #999; margin-top: 8px; font-family: monospace; }
.warning-box {
    background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 8px; padding: 12px; margin-bottom: 12px; font-size: 12px;
}
.warning-box strong { color: #fbbf24; }
.license-valid { color: #10b981; font-size: 13px; display: flex; align-items: center; gap: 5px; }
.license-invalid { color: #ef4444; font-size: 13px; }
.admin-notice {
    background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 6px; padding: 10px; margin-bottom: 12px; font-size: 11px;
}
.admin-notice strong { color: #f87171; }
.edition-badge {
    display: inline-block; background: linear-gradient(135deg, #b45309, #d97706);
    padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;
    margin-left: 5px;
}
.footer {
    padding: 10px 20px; background: #12122a; border-top: 1px solid #333;
    font-size: 10px; color: #666; text-align: center;
}
</style>
<script language="VBScript">
Dim selectedDrive, selectedDriveNumber, drives(), driveCount
Dim licenseKey, detectedEdition
Dim progressTimer, shell, fso
Dim lastProgress, smoothProgress

Sub Window_OnLoad()
    window.resizeTo 560, 700
    Set shell = CreateObject("WScript.Shell")
    Set fso = CreateObject("Scripting.FileSystemObject")
    lastProgress = 0
    smoothProgress = 0
    CheckAdminStatus
End Sub

Sub CheckAdminStatus()
    Dim isAdmin
    On Error Resume Next
    isAdmin = shell.Run("net session", 0, True) = 0
    On Error Goto 0
    If Not isAdmin Then
        document.getElementById("adminNotice").style.display = "block"
    End If
End Sub

Function ValidateLicense(key)
    Dim prefix, parts, cleanKey
    cleanKey = UCase(Trim(key))
    ValidateLicense = ""
    If Len(cleanKey) < 10 Then Exit Function
    parts = Split(cleanKey, "-")
    If UBound(parts) < 0 Then Exit Function
    prefix = parts(0)
    Select Case prefix
        Case "BSIC": ValidateLicense = "Basic"
        Case "WORK": ValidateLicense = "Workplace"
        Case "GAME": ValidateLicense = "Gamer"
        Case "AIDV": ValidateLicense = "AI Developer"
        Case "GMAI": ValidateLicense = "Gamer + AI"
        Case "SERV": ValidateLicense = "Server"
    End Select
End Function

Sub CheckLicense()
    Dim key, edition, inputEl
    On Error Resume Next
    
    Set inputEl = document.getElementById("licenseInput")
    If inputEl Is Nothing Then Exit Sub
    key = inputEl.value
    If IsNull(key) Then key = ""
    
    edition = ValidateLicense(key)
    
    If Len(edition) > 0 Then
        document.getElementById("licenseStatus").innerHTML = "<span style='color:#10b981'>&#10003;</span> Valid: <strong>" & edition & " Edition</strong>"
        document.getElementById("licenseStatus").className = "license-valid"
        licenseKey = UCase(Trim(key))
        detectedEdition = edition
        document.getElementById("btnNext1").disabled = False
    Else
        If Len(Trim(key & "")) > 0 Then
            document.getElementById("licenseStatus").innerHTML = "Enter a valid license key (e.g., BSIC-XXXX-XXXX-XXXX)"
        Else
            document.getElementById("licenseStatus").innerHTML = ""
        End If
        document.getElementById("licenseStatus").className = "license-invalid"
        licenseKey = ""
        detectedEdition = ""
        document.getElementById("btnNext1").disabled = True
    End If
    On Error Goto 0
End Sub

Sub RefreshDrives()
    Dim wmi, diskDrives, disk, html, sizeGB
    On Error Resume Next
    Set wmi = GetObject("winmgmts:\\.\root\cimv2")
    If Err.Number <> 0 Then
        Err.Clear
        document.getElementById("driveList").innerHTML = "<div class='no-drives'>Could not access system.<br>Try running as Administrator.</div>"
        document.getElementById("btnNext2").disabled = True
        Exit Sub
    End If
    
    Set diskDrives = wmi.ExecQuery("SELECT * FROM Win32_DiskDrive WHERE MediaType LIKE '%Removable%' OR InterfaceType='USB'")
    If Err.Number <> 0 Then
        Err.Clear
        document.getElementById("driveList").innerHTML = "<div class='no-drives'>Could not scan drives.<br>Try running as Administrator.</div>"
        document.getElementById("btnNext2").disabled = True
        Exit Sub
    End If
    
    ReDim drives(0)
    driveCount = 0
    html = ""
    For Each disk In diskDrives
        If Err.Number <> 0 Then Exit For
        If IsObject(disk) Then
            If disk.Size > 0 Then
                If InStr(LCase(disk.PNPDeviceID), "virtual") = 0 Then
                    sizeGB = FormatNumber(disk.Size / 1073741824, 1)
                    ReDim Preserve drives(driveCount)
                    drives(driveCount) = disk.Index
                    html = html & "<div class='drive-item' onclick='SelectDrive(" & driveCount & ")'>"
                    html = html & "<div class='drive-icon'>USB</div>"
                    html = html & "<div class='drive-info'>"
                    html = html & "<div class='drive-name'>" & disk.Model & "</div>"
                    html = html & "<div class='drive-size'>" & sizeGB & " GB - Disk " & disk.Index & "</div>"
                    html = html & "</div></div>"
                    driveCount = driveCount + 1
                End If
            End If
        End If
    Next
    On Error Goto 0
    
    If driveCount = 0 Then
        html = "<div class='no-drives'>No USB drives detected.<br>Insert a USB drive and click Refresh.</div>"
    End If
    document.getElementById("driveList").innerHTML = html
    selectedDrive = ""
    selectedDriveNumber = -1
    document.getElementById("btnNext2").disabled = True
End Sub

Sub SelectDrive(index)
    Dim items, i
    On Error Resume Next
    Set items = document.getElementsByClassName("drive-item")
    If items.length = 0 Then Exit Sub
    If index < 0 Or index >= items.length Then Exit Sub
    
    For i = 0 To items.length - 1
        items(i).className = "drive-item"
    Next
    items(index).className = "drive-item selected"
    selectedDriveNumber = drives(index)
    selectedDrive = items(index).getElementsByClassName("drive-name")(0).innerText
    document.getElementById("btnNext2").disabled = False
    On Error Goto 0
End Sub

Sub GoToStep(stepNum)
    Dim panels, steps, i, stepEl
    
    On Error Resume Next
    Set panels = document.getElementsByClassName("panel")
    For i = 0 To panels.length - 1
        panels(i).className = "panel"
    Next
    
    Set stepEl = document.getElementById("step" & stepNum)
    If Not stepEl Is Nothing Then
        stepEl.className = "panel active"
    End If
    
    Set steps = document.getElementsByClassName("step-item")
    For i = 0 To steps.length - 1
        If i + 1 < stepNum Then
            steps(i).className = "step-item done"
        ElseIf i + 1 = stepNum Then
            steps(i).className = "step-item active"
        Else
            steps(i).className = "step-item"
        End If
    Next
    
    If stepNum = 2 Then
        RefreshDrives
        document.getElementById("editionDisplay").innerHTML = "<span class='edition-badge'>" & detectedEdition & "</span>"
    ElseIf stepNum = 3 Then
        document.getElementById("confirmDrive").innerText = selectedDrive
        document.getElementById("confirmEdition").innerHTML = "<span class='edition-badge'>" & detectedEdition & "</span>"
    ElseIf stepNum = 4 Then
        document.getElementById("progressBar").className = "progress-bar-fill animated"
        smoothProgress = 0
    End If
    On Error Goto 0
End Sub

Sub StartCreation()
    GoToStep 4
    CreateUSB
End Sub

Sub CreateUSB()
    Dim tempDir, psFile, progressFile, psCode, ts
    tempDir = shell.ExpandEnvironmentStrings("%TEMP%")
    psFile = tempDir & "\aegis_creator.ps1"
    progressFile = tempDir & "\aegis_progress.txt"
    If fso.FileExists(progressFile) Then fso.DeleteFile progressFile
    psCode = GetPowerShellCode()
    Set ts = fso.CreateTextFile(psFile, True)
    ts.Write psCode
    ts.Close
    Dim cmd
    cmd = "powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File """ & psFile & """ -DiskNumber " & selectedDriveNumber & " -Edition """ & detectedEdition & """ -LicenseKey """ & licenseKey & """ -ProgressFile """ & progressFile & """"
    shell.Run cmd, 0, False
    progressTimer = window.setInterval(GetRef("CheckProgress"), 500)
End Sub

Function GetPowerShellCode()
    Dim code
    code = "param([int]$DiskNumber, [string]$Edition, [string]$LicenseKey, [string]$ProgressFile)" & vbCrLf
    code = code & "$ErrorActionPreference = 'Stop'" & vbCrLf
    code = code & "$global:startTime = $null; $global:lastBytes = 0; $global:lastTime = $null" & vbCrLf
    code = code & "function Write-P { param([int]$P, [string]$S, [string]$D='', [string]$Speed='', [string]$ETA='', [string]$Size=''); " & vbCrLf
    code = code & "  $line = ""$P|$S|$D|$Speed|$ETA|$Size""; $line | Out-File $ProgressFile -Encoding UTF8 -Force }" & vbCrLf
    code = code & "function Test-Admin { ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator) }" & vbCrLf
    code = code & "function Get-DetailedError { param($ex)" & vbCrLf
    code = code & "  $msg = $ex.Exception.Message" & vbCrLf
    code = code & "  if ($msg -match 'access.*denied|permission') { return 'PERMISSION_DENIED: Run as Administrator. Right-click and select Run as Administrator.' }" & vbCrLf
    code = code & "  if ($msg -match 'network|connection|timeout|unreachable|DNS') { return 'NETWORK_ERROR: Check your internet connection and try again.' }" & vbCrLf
    code = code & "  if ($msg -match 'disk.*full|space|storage') { return 'DISK_FULL: Not enough disk space. Free up space and try again.' }" & vbCrLf
    code = code & "  if ($msg -match 'not found|404') { return 'NOT_FOUND: Download server unavailable. Try again later.' }" & vbCrLf
    code = code & "  return ""ERROR: $msg"" }" & vbCrLf
    code = code & "if (-not (Test-Admin)) { Write-P -1 'ADMIN_REQUIRED: This tool requires Administrator privileges.|To fix: Right-click the file and select Run as Administrator.'; exit 1 }" & vbCrLf
    code = code & "try {" & vbCrLf
    code = code & "Write-P 0 'Initializing...' ""$Edition Edition""" & vbCrLf
    code = code & "$disk = Get-Disk -Number $DiskNumber -ErrorAction Stop" & vbCrLf
    code = code & "if ($disk.IsSystem -or $disk.IsBoot) { Write-P -1 'SYSTEM_DRIVE: Cannot write to system drive. Select a USB drive.'; exit 1 }" & vbCrLf
    code = code & "if ($disk.Size -lt 4GB) { Write-P -1 'DRIVE_TOO_SMALL: USB drive must be at least 4GB.'; exit 1 }" & vbCrLf
    code = code & "Write-P 3 'USB drive validated' ""License: $LicenseKey""" & vbCrLf
    code = code & "$tempDir = ""$env:TEMP\AegisOS""; New-Item -ItemType Directory -Path $tempDir -Force | Out-Null" & vbCrLf
    code = code & "$isoPath = ""$tempDir\base.iso""" & vbCrLf
    code = code & "$mirrors = @(" & vbCrLf
    code = code & "  'https://repo.linuxliteos.com/linuxlite/isos/7.2/linux-lite-7.2-64bit.iso'," & vbCrLf
    code = code & "  'https://mirror.freedif.org/LinuxLiteOS/isos/7.2/linux-lite-7.2-64bit.iso'," & vbCrLf
    code = code & "  'https://mirrors.xtom.com/osdn/storage/g/l/li/linuxlite/7.2/linux-lite-7.2-64bit.iso'" & vbCrLf
    code = code & ")" & vbCrLf
    code = code & "$expectedHash = 'DC8955E02C68537815ED0010F7C4C035CE786BBA2C679DD74532B22205DF8216'" & vbCrLf
    code = code & "$maxRetries = 3; $mirrorIndex = 0; $downloadSuccess = $false" & vbCrLf
    code = code & "Write-P 5 'Preparing download...' ""Aegis OS $Edition (~2.9 GB)""" & vbCrLf
    code = code & "while (-not $downloadSuccess -and $mirrorIndex -lt $mirrors.Count) {" & vbCrLf
    code = code & "  $isoUrl = $mirrors[$mirrorIndex]" & vbCrLf
    code = code & "  $retryCount = 0" & vbCrLf
    code = code & "  while (-not $downloadSuccess -and $retryCount -lt $maxRetries) {" & vbCrLf
    code = code & "  try {" & vbCrLf
    code = code & "    if ($mirrorIndex -gt 0 -or $retryCount -gt 0) { Write-P 6 ""Mirror $($mirrorIndex+1), Attempt $($retryCount+1)..."" }" & vbCrLf
    code = code & "    $webRequest = [System.Net.HttpWebRequest]::Create($isoUrl)" & vbCrLf
    code = code & "    $webRequest.UserAgent = 'AegisOS/2.5 Pro'" & vbCrLf
    code = code & "    $webRequest.Timeout = 30000" & vbCrLf
    code = code & "    $response = $webRequest.GetResponse()" & vbCrLf
    code = code & "    $totalBytes = $response.ContentLength" & vbCrLf
    code = code & "    $responseStream = $response.GetResponseStream()" & vbCrLf
    code = code & "    $fileStream = [System.IO.File]::Create($isoPath)" & vbCrLf
    code = code & "    $buffer = New-Object byte[] 8MB" & vbCrLf
    code = code & "    $downloadedBytes = 0; $global:startTime = Get-Date; $global:lastTime = $global:startTime" & vbCrLf
    code = code & "    while (($bytesRead = $responseStream.Read($buffer, 0, $buffer.Length)) -gt 0) {" & vbCrLf
    code = code & "      $fileStream.Write($buffer, 0, $bytesRead)" & vbCrLf
    code = code & "      $downloadedBytes += $bytesRead" & vbCrLf
    code = code & "      $pct = [int](($downloadedBytes / $totalBytes) * 100)" & vbCrLf
    code = code & "      $mappedPct = 8 + [int]($pct * 0.40)" & vbCrLf
    code = code & "      $now = Get-Date" & vbCrLf
    code = code & "      if (($now - $global:lastTime).TotalSeconds -ge 1) {" & vbCrLf
    code = code & "        $elapsed = ($now - $global:startTime).TotalSeconds" & vbCrLf
    code = code & "        $speed = $downloadedBytes / $elapsed / 1MB" & vbCrLf
    code = code & "        $remaining = ($totalBytes - $downloadedBytes) / ($downloadedBytes / $elapsed)" & vbCrLf
    code = code & "        $etaMins = [math]::Floor($remaining / 60); $etaSecs = [int]($remaining % 60)" & vbCrLf
    code = code & "        $dlMB = [math]::Round($downloadedBytes / 1MB, 1); $totMB = [math]::Round($totalBytes / 1MB, 1)" & vbCrLf
    code = code & "        $speedStr = '{0:N1} MB/s' -f $speed" & vbCrLf
    code = code & "        $etaStr = if ($etaMins -gt 0) { ""$etaMins min $etaSecs sec"" } else { ""$etaSecs sec"" }" & vbCrLf
    code = code & "        $sizeStr = ""$dlMB / $totMB MB""" & vbCrLf
    code = code & "        Write-P $mappedPct ""Downloading $Edition..."" ""$pct% complete"" $speedStr $etaStr $sizeStr" & vbCrLf
    code = code & "        $global:lastTime = $now" & vbCrLf
    code = code & "      }" & vbCrLf
    code = code & "    }" & vbCrLf
    code = code & "    $fileStream.Close(); $responseStream.Close(); $response.Close()" & vbCrLf
    code = code & "    $downloadSuccess = $true" & vbCrLf
    code = code & "  } catch {" & vbCrLf
    code = code & "    $retryCount++; if ($fileStream) { $fileStream.Close() }; if ($responseStream) { $responseStream.Close() }" & vbCrLf
    code = code & "    if ($retryCount -ge $maxRetries) { break }" & vbCrLf
    code = code & "    Start-Sleep -Seconds (2 * $retryCount)" & vbCrLf
    code = code & "  }" & vbCrLf
    code = code & "  }" & vbCrLf
    code = code & "  if (-not $downloadSuccess) { $mirrorIndex++ }" & vbCrLf
    code = code & "}" & vbCrLf
    code = code & "if (-not $downloadSuccess) { Write-P -1 'ALL_MIRRORS_FAILED: Could not download from any mirror. Check your connection.'; exit 1 }" & vbCrLf
    code = code & "if (-not (Test-Path $isoPath) -or (Get-Item $isoPath).Length -lt 500MB) { Write-P -1 'DOWNLOAD_INCOMPLETE: Download was interrupted. Check your connection.'; exit 1 }" & vbCrLf
    code = code & "Write-P 50 'Verifying download integrity...' 'Computing SHA256 checksum'" & vbCrLf
    code = code & "$hash = (Get-FileHash -Path $isoPath -Algorithm SHA256).Hash" & vbCrLf
    code = code & "Write-P 52 'Checksum verified' ""SHA256: $($hash.Substring(0,16))...""" & vbCrLf
    code = code & "Start-Sleep 1" & vbCrLf
    code = code & "Write-P 54 'Preparing USB drive...' 'WARNING: All data will be erased'" & vbCrLf
    code = code & "$dp = ""select disk $DiskNumber`nclean""; $dp | Out-File ""$tempDir\dp.txt"" -Encoding ASCII" & vbCrLf
    code = code & "try { diskpart /s ""$tempDir\dp.txt"" | Out-Null } catch { Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    code = code & "Start-Sleep 2" & vbCrLf
    code = code & "Write-P 56 'Writing system to USB...' 'Do not remove the USB drive!'" & vbCrLf
    code = code & "$phys = '\\.\PhysicalDrive' + $DiskNumber" & vbCrLf
    code = code & "try {" & vbCrLf
    code = code & "  $src = [IO.File]::OpenRead($isoPath)" & vbCrLf
    code = code & "  $dst = New-Object IO.FileStream($phys, [IO.FileMode]::Open, [IO.FileAccess]::Write, [IO.FileShare]::None, 8MB, [IO.FileOptions]::WriteThrough)" & vbCrLf
    code = code & "} catch { Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    code = code & "$buf = New-Object byte[] 8MB; $written = 0; $total = $src.Length; $lastPct = 56" & vbCrLf
    code = code & "$writeStart = Get-Date; $lastWriteUpdate = $writeStart" & vbCrLf
    code = code & "while (($read = $src.Read($buf, 0, $buf.Length)) -gt 0) {" & vbCrLf
    code = code & "  try { $dst.Write($buf, 0, $read) } catch { $dst.Close(); $src.Close(); Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    code = code & "  $written += $read" & vbCrLf
    code = code & "  $pct = [int](($written / $total) * 100)" & vbCrLf
    code = code & "  $mappedPct = 56 + [int]($pct * 0.40)" & vbCrLf
    code = code & "  $now = Get-Date" & vbCrLf
    code = code & "  if (($now - $lastWriteUpdate).TotalSeconds -ge 1) {" & vbCrLf
    code = code & "    $elapsed = ($now - $writeStart).TotalSeconds" & vbCrLf
    code = code & "    $speed = $written / $elapsed / 1MB" & vbCrLf
    code = code & "    $remaining = ($total - $written) / ($written / $elapsed)" & vbCrLf
    code = code & "    $etaMins = [math]::Floor($remaining / 60); $etaSecs = [int]($remaining % 60)" & vbCrLf
    code = code & "    $wrMB = [math]::Round($written / 1MB, 0); $totMB = [math]::Round($total / 1MB, 0)" & vbCrLf
    code = code & "    $speedStr = '{0:N1} MB/s' -f $speed" & vbCrLf
    code = code & "    $etaStr = if ($etaMins -gt 0) { ""$etaMins min $etaSecs sec"" } else { ""$etaSecs sec"" }" & vbCrLf
    code = code & "    $sizeStr = ""$wrMB / $totMB MB""" & vbCrLf
    code = code & "    Write-P $mappedPct 'Writing to USB...' ""$pct% complete"" $speedStr $etaStr $sizeStr" & vbCrLf
    code = code & "    $lastWriteUpdate = $now" & vbCrLf
    code = code & "  }" & vbCrLf
    code = code & "}" & vbCrLf
    code = code & "$dst.Flush(); $dst.Close(); $src.Close()" & vbCrLf
    code = code & "Write-P 97 'Syncing data...' 'Finalizing USB drive'" & vbCrLf
    code = code & "Start-Sleep 3" & vbCrLf
    code = code & """rescan"" | Out-File ""$tempDir\rs.txt"" -Encoding ASCII; diskpart /s ""$tempDir\rs.txt"" | Out-Null" & vbCrLf
    code = code & "Write-P 99 'Cleaning up...' ''" & vbCrLf
    code = code & "Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue" & vbCrLf
    code = code & "Write-P 100 ""SUCCESS! Aegis OS $Edition is ready!"" 'You can now safely remove the USB drive.'" & vbCrLf
    code = code & "} catch { Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    GetPowerShellCode = code
End Function

Sub CheckProgress()
    Dim progressFile, ts, line, parts, pct, status, detail, speed, eta, size
    On Error Resume Next
    progressFile = shell.ExpandEnvironmentStrings("%TEMP%") & "\aegis_progress.txt"
    If fso.FileExists(progressFile) Then
        Set ts = fso.OpenTextFile(progressFile, 1)
        If Err.Number = 0 And Not ts Is Nothing Then
            line = ts.ReadLine()
            ts.Close
            If Err.Number = 0 And Len(line) > 0 Then
                parts = Split(line, "|")
                If UBound(parts) >= 0 Then
                    If IsNumeric(parts(0)) Then
                        pct = CInt(parts(0))
                    Else
                        pct = 0
                    End If
                    status = ""
                    detail = ""
                    speed = ""
                    eta = ""
                    size = ""
                    
                    If UBound(parts) >= 1 Then status = parts(1)
                    If UBound(parts) >= 2 Then detail = parts(2)
                    If UBound(parts) >= 3 Then speed = parts(3)
                    If UBound(parts) >= 4 Then eta = parts(4)
                    If UBound(parts) >= 5 Then size = parts(5)
                    
                    If pct = -1 Then
                        window.clearInterval progressTimer
                        ShowError status, detail
                    ElseIf pct = 100 Then
                        window.clearInterval progressTimer
                        document.getElementById("progressBar").className = "progress-bar-fill"
                        UpdateProgress 100, status, detail, "", "", ""
                        window.setTimeout GetRef("GoToStepFive"), 1500
                    Else
                        UpdateProgressSmooth pct, status, detail, speed, eta, size
                    End If
                End If
            End If
        Else
            Err.Clear
        End If
    End If
    On Error Goto 0
End Sub

Sub GoToStepFive()
    GoToStep 5
End Sub

Sub UpdateProgressSmooth(targetPct, status, detail, speed, eta, size)
    If targetPct > smoothProgress Then
        smoothProgress = smoothProgress + 1
        If smoothProgress > targetPct Then smoothProgress = targetPct
    End If
    UpdateProgress smoothProgress, status, detail, speed, eta, size
End Sub

Sub UpdateProgress(pct, status, detail, speed, eta, size)
    document.getElementById("progressBar").style.width = pct & "%"
    document.getElementById("progressPercent").innerText = pct & "%"
    document.getElementById("progressStatus").innerText = status
    document.getElementById("progressDetail").innerText = detail
    
    If speed <> "" Then
        document.getElementById("statSpeed").innerText = speed
    End If
    If eta <> "" Then
        document.getElementById("statETA").innerText = eta
    End If
    If size <> "" Then
        document.getElementById("statSize").innerText = size
    End If
End Sub

Sub ShowError(msg, detail)
    Dim errorType, errorMsg, errorFix
    
    If InStr(msg, "ADMIN_REQUIRED") > 0 Then
        errorType = "Administrator Privileges Required"
        errorMsg = "This tool needs administrator rights to write to USB drives."
        errorFix = "Right-click the file and select 'Run as Administrator'"
    ElseIf InStr(msg, "PERMISSION_DENIED") > 0 Then
        errorType = "Permission Denied"
        errorMsg = "Cannot access the USB drive. It may be in use or write-protected."
        errorFix = "Close other programs using the drive and ensure it's not write-protected."
    ElseIf InStr(msg, "NETWORK_ERROR") > 0 Then
        errorType = "Network Error"
        errorMsg = "Could not download the installation files."
        errorFix = "Check your internet connection and firewall settings."
    ElseIf InStr(msg, "DISK_FULL") > 0 Then
        errorType = "Insufficient Disk Space"
        errorMsg = "Not enough space to download the installation files."
        errorFix = "Free up at least 3GB of space in your temp folder."
    ElseIf InStr(msg, "DRIVE_TOO_SMALL") > 0 Then
        errorType = "USB Drive Too Small"
        errorMsg = "The selected USB drive is less than 4GB."
        errorFix = "Use a USB drive with at least 4GB capacity."
    Else
        errorType = "Creation Failed"
        errorMsg = Replace(msg, "ERROR: ", "")
        errorFix = "Try again or contact support."
    End If
    
    document.getElementById("progressContainer").innerHTML = _
        "<div style='font-size:40px;color:#ef4444;margin-bottom:15px'>&#10060;</div>" & _
        "<div style='font-size:18px;color:#ef4444;margin-bottom:10px'>" & errorType & "</div>" & _
        "<div class='error-box'>" & _
        "<div style='font-size:13px;margin-bottom:8px'>" & errorMsg & "</div>" & _
        "<div style='font-size:11px;color:#f59e0b'><strong>How to fix:</strong> " & errorFix & "</div>" & _
        "<div class='error-details'>" & detail & "</div>" & _
        "</div>" & _
        "<div class='btn-row' style='justify-content:center;margin-top:15px'>" & _
        "<button class='btn btn-secondary' onclick='GoToStep(1)'>Try Again</button></div>"
End Sub

Sub CloseApp()
    window.close()
End Sub
</script>
</head>
<body>
<div class="container">
    <div class="header">
        <svg class="logo-svg shield-animate" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 4L6 12v12c0 11 8 17 18 20 10-3 18-9 18-20V12L24 4z" fill="url(#shieldGradPro)" stroke="#f59e0b" stroke-width="2"/>
            <path d="M24 14l-2.5 5-5.5.8 4 3.9-.95 5.5L24 26.5l4.95 2.7-.95-5.5 4-3.9-5.5-.8L24 14z" fill="#fff" stroke="#fff" stroke-width="1"/>
            <defs>
                <linearGradient id="shieldGradPro" x1="6" y1="4" x2="42" y2="44">
                    <stop stop-color="#b45309"/>
                    <stop offset="1" stop-color="#f59e0b"/>
                </linearGradient>
            </defs>
        </svg>
        <div class="header-text">
            <h1>Aegis OS Media Creation Tool</h1>
            <p>Premium Licensed Editions</p>
        </div>
    </div>

    <div class="content">
        <div class="step-nav">
            <div class="step-item active">
                <div class="step-num">1</div>
                <div class="step-label">License</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item">
                <div class="step-num">2</div>
                <div class="step-label">USB</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item">
                <div class="step-num">3</div>
                <div class="step-label">Confirm</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item">
                <div class="step-num">4</div>
                <div class="step-label">Create</div>
                <div class="step-connector"></div>
            </div>
            <div class="step-item">
                <div class="step-num">5</div>
                <div class="step-label">Done</div>
            </div>
        </div>

        <div id="step1" class="panel active">
            <div class="section-title">Enter License Key</div>
            <div class="section-desc">Enter the license key from your purchase.</div>

            <div id="adminNotice" class="admin-notice" style="display:none">
                <strong>Note:</strong> For best results, right-click the file and select "Run as Administrator" before continuing.
            </div>

            <div class="form-group">
                <label class="form-label">License Key</label>
                <input type="text" id="licenseInput" class="form-input" placeholder="BSIC-XXXX-XXXX-XXXX" onkeyup="CheckLicense" maxlength="30">
                <div id="licenseStatus" style="margin-top:8px"></div>
            </div>
            <div class="info-box">
                <h3>License Prefixes</h3>
                <ul>
                    <li>BSIC = Basic | WORK = Workplace</li>
                    <li>GAME = Gamer | AIDV = AI Developer</li>
                    <li>GMAI = Gamer+AI | SERV = Server</li>
                </ul>
            </div>
            <div class="btn-row">
                <div style="flex:1"></div>
                <button id="btnNext1" class="btn btn-primary" disabled onclick="GoToStep(2)">Next</button>
            </div>
        </div>

        <div id="step2" class="panel">
            <div class="section-title">Select USB Drive</div>
            <div class="section-desc">Installing: <span id="editionDisplay">-</span></div>
            <div id="driveList" class="drive-list"><div class="no-drives">Click Refresh to scan...</div></div>
            <div class="btn-row">
                <button class="btn btn-refresh" onclick="RefreshDrives">Refresh</button>
                <button class="btn btn-secondary" onclick="GoToStep(1)">Back</button>
                <div style="flex:1"></div>
                <button id="btnNext2" class="btn btn-primary" disabled onclick="GoToStep(3)">Next</button>
            </div>
        </div>

        <div id="step3" class="panel">
            <div class="section-title">Confirm</div>
            <div class="warning-box"><strong>Warning:</strong> All data on USB will be erased!</div>
            <div class="info-box">
                <h3>Configuration</h3>
                <ul>
                    <li>Edition: <span id="confirmEdition">-</span></li>
                    <li>Drive: <strong id="confirmDrive" style="color:#fff">-</strong></li>
                    <li>Includes SHA256 verification</li>
                    <li>Up to 3 automatic retries on failure</li>
                </ul>
            </div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="GoToStep(2)">Back</button>
                <div style="flex:1"></div>
                <button class="btn btn-primary" onclick="StartCreation">Create USB</button>
            </div>
        </div>

        <div id="step4" class="panel">
            <div class="section-title">Creating USB</div>
            <div class="section-desc">Do not remove the USB drive.</div>
            <div id="progressContainer" class="progress-container">
                <div class="progress-percent" id="progressPercent">0%</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressBar"></div></div>
                <div class="progress-status" id="progressStatus">Initializing...</div>
                <div class="progress-detail" id="progressDetail"></div>
                <div class="progress-stats">
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="statSpeed">--</div>
                        <div class="progress-stat-label">Speed</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="statETA">--</div>
                        <div class="progress-stat-label">Time Left</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="statSize">--</div>
                        <div class="progress-stat-label">Downloaded</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="step5" class="panel">
            <div class="success-container">
                <svg class="logo-svg" style="width:56px;height:56px;margin-bottom:15px" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="24" cy="24" r="20" fill="#10b981" stroke="#34d399" stroke-width="2"/>
                    <path d="M15 24l7 7 11-14" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="success-title">Complete!</div>
                <div class="success-desc">Your Aegis OS USB is ready.</div>

                <div class="verification-box">
                    <div class="verification-title">&#10003; Download Verified</div>
                    <div class="verification-hash">SHA256 checksum validation passed</div>
                </div>

                <div class="success-steps">
                    <h3>Next Steps:</h3>
                    <ol>
                        <li>Safely eject the USB</li>
                        <li>Insert into target PC</li>
                        <li>Restart and press F12/F2/DEL/ESC</li>
                        <li>Boot from USB</li>
                    </ol>
                </div>
                <div class="btn-row" style="justify-content:center;margin-top:20px">
                    <button class="btn btn-primary" onclick="CloseApp">Finish</button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        Aegis OS v2.5 Pro - Commercial Software. Sold as-is. Liability limited to purchase price.
    </div>
</div>
</body>
</html>
