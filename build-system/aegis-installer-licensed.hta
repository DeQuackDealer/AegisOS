<html>
<head>
<title>Aegis OS Media Creation Tool - Licensed</title>
<HTA:APPLICATION
    ID="AegisMediaToolPro"
    APPLICATIONNAME="Aegis OS Media Creation Tool"
    BORDER="thick"
    BORDERSTYLE="normal"
    CAPTION="yes"
    MAXIMIZEBUTTON="no"
    MINIMIZEBUTTON="yes"
    SHOWINTASKBAR="yes"
    SINGLEINSTANCE="yes"
    SYSMENU="yes"
    VERSION="3.0"
    SCROLL="no"
    INNERBORDER="no"
/>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #fff;
    height: 100vh;
    overflow: hidden;
    margin: 0;
}
.wizard {
    display: flex;
    flex-direction: column;
    height: 100vh;
}
.wizard-header {
    flex-shrink: 0;
    background: linear-gradient(135deg, #b45309 0%, #92400e 100%);
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.logo-svg { width: 36px; height: 36px; }
.shield-animate { animation: shieldPulse 2s ease-in-out infinite; }
@keyframes shieldPulse {
    0%, 100% { transform: scale(1); filter: drop-shadow(0 0 3px rgba(245, 158, 11, 0.5)); }
    50% { transform: scale(1.05); filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.8)); }
}
.header-text h1 { font-size: 14px; font-weight: 600; }
.header-text p { font-size: 10px; opacity: 0.9; }
.wizard-breadcrumb {
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    gap: 4px;
    padding: 4px 12px;
    background: #12122a;
    border-bottom: 1px solid #1f2a40;
}
.step-crumb {
    flex: 1;
    text-align: center;
    font-size: 9px;
    padding: 5px 3px;
    border-radius: 4px;
    background: #1a2438;
    color: #8ca0c8;
}
.step-crumb.active {
    background: linear-gradient(135deg, #b45309, #f59e0b);
    color: #fff;
    font-weight: 600;
}
.step-crumb.done { background: #0f1d33; color: #f59e0b; }
.wizard-content {
    flex: 1;
    overflow: hidden;
    position: relative;
    min-height: 0;
}
.slide {
    display: none;
    padding: 8px 12px;
    height: 100%;
    overflow: hidden;
}
.slide.active { display: flex; flex-direction: column; }
.wizard-footer {
    flex-shrink: 0;
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #333;
    background: #12122a;
}
.section-title { font-size: 13px; font-weight: 600; margin-bottom: 3px; }
.section-desc { font-size: 10px; color: #b0b0b0; margin-bottom: 6px; line-height: 1.3; }
.info-box {
    background: rgba(180, 83, 9, 0.15);
    border: 1px solid rgba(180, 83, 9, 0.3);
    border-radius: 5px;
    padding: 6px;
    margin-bottom: 6px;
}
.info-box h3 { font-size: 10px; margin-bottom: 4px; color: #f59e0b; }
.info-box ul { font-size: 9px; color: #b0b0b0; padding-left: 14px; margin: 0; }
.info-box li { margin-bottom: 1px; }
.form-group { margin-bottom: 8px; }
.form-label { display: block; font-size: 10px; margin-bottom: 3px; color: #aaa; }
.form-input {
    width: 100%; padding: 8px 10px;
    background: #1e1e3a; border: 1px solid #444;
    border-radius: 5px; color: #fff; font-size: 12px;
}
.form-input:focus { border-color: #f59e0b; outline: none; }
.drive-list {
    background: #1e1e3a;
    border: 1px solid #333;
    border-radius: 5px;
    max-height: 80px;
    overflow-y: auto;
    margin-bottom: 6px;
}
.drive-item {
    padding: 6px 8px;
    border-bottom: 1px solid #333;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}
.drive-item:last-child { border-bottom: none; }
.drive-item:hover { background: #2a2a4a; }
.drive-item.selected { background: rgba(180, 83, 9, 0.3); border-left: 3px solid #f59e0b; }
.drive-icon {
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, #b45309, #f59e0b);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    font-weight: bold;
}
.drive-info { flex: 1; }
.drive-name { font-weight: 500; font-size: 11px; }
.drive-size { font-size: 9px; color: #b0b0b0; }
.drive-details { font-size: 8px; color: #909090; }
.no-drives { padding: 15px; text-align: center; color: #888; font-size: 10px; }
.btn {
    padding: 8px 16px;
    border-radius: 5px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    font-size: 11px;
    transition: all 0.2s;
}
.btn-primary { background: linear-gradient(135deg, #b45309, #d97706); color: white; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 3px 12px rgba(180, 83, 9, 0.4); }
.btn-primary:disabled { background: #444; cursor: not-allowed; transform: none; box-shadow: none; }
.btn-secondary { background: #2a2a4a; color: #aaa; border: 1px solid #444; }
.btn-secondary:hover { background: #3a3a5a; }
.btn-refresh { background: #1e1e3a; color: #f59e0b; padding: 4px 8px; font-size: 9px; }
.btn-small { padding: 3px 8px; font-size: 9px; }
.btn-create { background: linear-gradient(135deg, #16a34a, #22c55e); padding: 10px 24px; font-size: 12px; }
.btn-create:hover { box-shadow: 0 3px 12px rgba(22, 197, 94, 0.4); }
.progress-container { background: #1e1e3a; border-radius: 5px; padding: 12px; text-align: center; }
.progress-bar-bg {
    height: 8px;
    background: #2a2a4a;
    border-radius: 4px;
    overflow: hidden;
    margin: 10px 0;
}
.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #b45309, #f59e0b, #b45309);
    background-size: 200% 100%;
    width: 0%;
    transition: width 0.5s ease-out;
    border-radius: 4px;
}
.progress-bar-fill.animated { animation: shimmer 1.5s infinite linear; }
@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
.progress-percent { font-size: 24px; font-weight: 700; color: #f59e0b; }
.progress-status { font-size: 11px; color: #aaa; margin-top: 4px; }
.progress-detail { font-size: 9px; color: #a0a0a0; margin-top: 2px; }
.progress-stats { display: flex; justify-content: center; gap: 12px; margin-top: 8px; font-size: 9px; }
.progress-stat { text-align: center; }
.progress-stat-value { font-size: 11px; color: #f59e0b; font-weight: 600; }
.progress-stat-label { font-size: 8px; color: #909090; margin-top: 1px; }
.success-container { text-align: center; padding: 10px; }
.success-icon { font-size: 32px; margin-bottom: 8px; color: #10b981; }
.success-title { font-size: 16px; color: #10b981; margin-bottom: 4px; }
.success-desc { font-size: 11px; color: #aaa; }
.success-steps { background: #1e1e3a; border-radius: 5px; padding: 10px; margin-top: 10px; text-align: left; }
.success-steps h3 { font-size: 11px; margin-bottom: 6px; }
.success-steps ol { padding-left: 14px; font-size: 10px; color: #aaa; margin: 0; }
.success-steps li { margin-bottom: 3px; }
.error-box {
    background: rgba(239, 68, 68, 0.15);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 5px;
    padding: 8px;
    color: #f87171;
    font-size: 11px;
}
.error-details { font-size: 9px; color: #999; margin-top: 4px; font-family: monospace; }
.warning-box {
    background: rgba(245, 158, 11, 0.15);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 5px;
    padding: 8px;
    margin-bottom: 8px;
    font-size: 10px;
}
.warning-box strong { color: #fbbf24; }
.admin-notice {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 4px;
    padding: 6px;
    margin-bottom: 8px;
    font-size: 9px;
}
.admin-notice strong { color: #f87171; }
.sys-req-box {
    background: #1e1e3a;
    border: 1px solid #333;
    border-radius: 5px;
    padding: 8px;
    margin-bottom: 8px;
}
.sys-req-item { display: flex; align-items: center; gap: 6px; padding: 2px 0; font-size: 10px; }
.sys-req-icon { font-size: 12px; }
.sys-req-pass { color: #10b981; }
.sys-req-fail { color: #ef4444; }
.sys-req-warn { color: #f59e0b; }
.option-group { margin-bottom: 8px; }
.option-label { font-size: 10px; color: #aaa; margin-bottom: 4px; display: block; }
.radio-group { display: flex; gap: 12px; }
.radio-item { display: flex; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; }
.radio-item input { accent-color: #f59e0b; }
.checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 10px; cursor: pointer; }
.checkbox-item input { accent-color: #f59e0b; width: 12px; height: 12px; }
.license-valid { color: #10b981; font-size: 11px; display: flex; align-items: center; gap: 4px; }
.license-invalid { color: #ef4444; font-size: 11px; }
.edition-badge {
    display: inline-block; background: linear-gradient(135deg, #b45309, #d97706);
    padding: 2px 6px; border-radius: 8px; font-size: 9px; font-weight: 600;
}
.feature-section { margin-bottom: 6px; }
.feature-section-title { font-size: 10px; color: #f59e0b; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
.feature-section-title .icon { font-size: 10px; }
.core-features {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 5px;
    padding: 6px;
    margin-bottom: 6px;
}
.core-feature-item { display: flex; align-items: center; gap: 5px; padding: 2px 0; font-size: 9px; color: #aaa; }
.core-feature-item .icon { color: #10b981; font-size: 10px; }
.optional-features {
    background: #1e1e3a;
    border: 1px solid #333;
    border-radius: 5px;
    padding: 6px;
    max-height: 100px;
    overflow-y: auto;
    flex: 1;
    min-height: 0;
}
.feature-card {
    display: flex;
    align-items: flex-start;
    gap: 6px;
    padding: 4px;
    border-bottom: 1px solid #333;
    transition: background 0.2s;
}
.feature-card:last-child { border-bottom: none; }
.feature-card:hover { background: rgba(180, 83, 9, 0.1); }
.feature-card input { margin-top: 1px; accent-color: #f59e0b; width: 12px; height: 12px; flex-shrink: 0; }
.feature-card-content { flex: 1; min-width: 0; }
.feature-card-name { font-size: 10px; font-weight: 500; color: #fff; }
.feature-card-desc { font-size: 8px; color: #b0b0b0; }
.feature-card-badge { font-size: 7px; background: rgba(180, 83, 9, 0.3); color: #f59e0b; padding: 1px 3px; border-radius: 2px; margin-left: 3px; }
.feature-actions { display: flex; gap: 4px; margin-bottom: 4px; }
.feature-count { font-size: 9px; color: #888; margin-top: 4px; }
.edition-features { display: none; }
.edition-features.visible { display: block; }
.confirm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
.confirm-item { background: #1e1e3a; border-radius: 5px; padding: 8px; }
.confirm-label { font-size: 9px; color: #888; margin-bottom: 2px; }
.confirm-value { font-size: 11px; color: #f59e0b; font-weight: 500; }
.feature-showcase {
    background: linear-gradient(135deg, rgba(180, 83, 9, 0.2), rgba(245, 158, 11, 0.1));
    border: 1px solid rgba(180, 83, 9, 0.4);
    border-radius: 5px;
    padding: 8px;
    margin-top: 8px;
}
.feature-showcase h4 { font-size: 10px; color: #f59e0b; margin-bottom: 4px; }
.feature-list { font-size: 9px; color: #ccc; padding-left: 14px; margin: 0; }
.feature-list li { margin-bottom: 2px; }
.hidden { display: none !important; }
</style>
<script language="VBScript">
Dim selectedDrive, selectedDriveNumber, drives(), driveCount
Dim licenseKey, detectedEdition
Dim progressTimer, shell, fso, wmi
Dim lastProgress, smoothProgress
Dim partitionStyle, quickFormat
Dim systemRAM, diskSpace, winVersion, sysReqPassed
Dim selectedFeatures
Dim hwid
Dim currentStep
Dim validationToken, serverUrl, isValidating

Const LICENSE_CACHE = "8cc68ef8c0df7e33:basic:basic|6cfdada10909d632:workplace:workplace|a1b2c3d4e5f67890:gamer:gamer|f0e1d2c3b4a59687:aidev:aidev|1234567890abcdef:gamer_ai:gamer_ai|fedcba0987654321:server:server"
Const CACHE_SALT = "PLACEHOLDER_SALT"

Function IsAdmin()
    On Error Resume Next
    IsAdmin = (CreateObject("WScript.Shell").Run("net session", 0, True) = 0)
    On Error Goto 0
End Function

Sub RestartAsAdmin()
    Dim shellApp, htaPath
    Set shellApp = CreateObject("Shell.Application")
    htaPath = document.location.pathname
    If Left(htaPath, 1) = "/" Then htaPath = Mid(htaPath, 2)
    htaPath = Replace(htaPath, "%20", " ")
    htaPath = Replace(htaPath, "%5C", "\\")
    shellApp.ShellExecute "mshta.exe", Chr(34) & htaPath & Chr(34), "", "runas", 1
    window.close
End Sub

Sub ShowAdminNotice()
    On Error Resume Next
    document.getElementById("adminNotice").style.display = "block"
    On Error Goto 0
End Sub

Sub CollectHWID()
    Dim computerName, cpuId, macAddr, diskSerial, combined
    On Error Resume Next
    computerName = CreateObject("WScript.Network").ComputerName
    If Len(computerName) = 0 Then computerName = "UNKNOWN"
    cpuId = "UNKNOWN"
    Set wmiTemp = GetObject("winmgmts:\\.\root\cimv2")
    If Not wmiTemp Is Nothing Then
        Set cpuQuery = wmiTemp.ExecQuery("SELECT ProcessorId FROM Win32_Processor")
        For Each cpu In cpuQuery
            If Not IsNull(cpu.ProcessorId) Then cpuId = cpu.ProcessorId
        Next
        macAddr = "UNKNOWN"
        Set netQuery = wmiTemp.ExecQuery("SELECT MACAddress FROM Win32_NetworkAdapterConfiguration WHERE IPEnabled=True")
        For Each adapter In netQuery
            If Not IsNull(adapter.MACAddress) Then
                macAddr = adapter.MACAddress
                Exit For
            End If
        Next
        diskSerial = "UNKNOWN"
        Set diskQuery = wmiTemp.ExecQuery("SELECT SerialNumber FROM Win32_DiskDrive")
        For Each disk In diskQuery
            If Not IsNull(disk.SerialNumber) Then
                diskSerial = Trim(disk.SerialNumber)
                Exit For
            End If
        Next
    End If
    combined = computerName & "|" & cpuId & "|" & macAddr & "|" & diskSerial
    hwid = SimpleHash(combined)
    On Error Goto 0
End Sub

Function SimpleHash(str)
    Dim h, i, c
    h = 5381
    For i = 1 To Len(str)
        c = Asc(Mid(str, i, 1))
        h = ((h * 33) Xor c) And &H7FFFFFFF
    Next
    SimpleHash = Hex(h)
End Function

Function ComputeKeyHash(str)
    Dim i, h, c, r
    h = 0: r = &H5A3C
    For i = 1 To Len(str)
        c = Asc(Mid(str, i, 1))
        h = h Xor (c * (i Mod 7 + 1))
        h = ((h * 31) + c) And &H7FFFFFFF
        r = (r Xor h) And &HFFFF
    Next
    ComputeKeyHash = LCase(Right("00000000" & Hex(h), 8)) & LCase(Right("0000" & Hex(r), 4)) & LCase(Right("0000" & Hex(Len(str) * 1337 And &HFFFF), 4))
End Function

Sub Window_OnLoad()
    CollectHWID
    If Not IsAdmin() Then
        If MsgBox("This tool requires Administrator privileges to write to USB drives." & vbCrLf & vbCrLf & _
                  "Would you like to restart with elevated permissions?", vbYesNo + vbQuestion, "Administrator Required") = vbYes Then
            RestartAsAdmin
            Exit Sub
        Else
            ShowAdminNotice
        End If
    End If
    window.resizeTo 720, 680
    Set shell = CreateObject("WScript.Shell")
    Set fso = CreateObject("Scripting.FileSystemObject")
    lastProgress = 0
    smoothProgress = 0
    partitionStyle = "GPT"
    quickFormat = True
    sysReqPassed = False
    selectedFeatures = "wallpaper,stream,security,backup"
    currentStep = 1
    detectedEdition = ""
    CheckSystemRequirements()
    UpdateFooterButtons()
End Sub

Sub CheckSystemRequirements()
    Dim ramGB, freeSpaceGB, osVer, ramStatus, diskStatus, osStatus
    ramGB = 0
    freeSpaceGB = 0
    osVer = ""
    On Error Resume Next
    Set wmi = GetObject("winmgmts:\\.\root\cimv2")
    If Not wmi Is Nothing Then
        Dim compSys, mem
        Set compSys = wmi.ExecQuery("SELECT TotalPhysicalMemory FROM Win32_ComputerSystem")
        If Not compSys Is Nothing Then
            For Each mem In compSys
                If Not mem Is Nothing Then
                    ramGB = Round(mem.TotalPhysicalMemory / 1073741824, 1)
                End If
            Next
        End If
        Dim osInfo, os
        Set osInfo = wmi.ExecQuery("SELECT Caption, Version FROM Win32_OperatingSystem")
        If Not osInfo Is Nothing Then
            For Each os In osInfo
                If Not os Is Nothing Then
                    osVer = os.Caption & " (" & os.Version & ")"
                End If
            Next
        End If
    End If
    Dim tempFolder, drv
    tempFolder = shell.ExpandEnvironmentStrings("%TEMP%")
    If Len(tempFolder) > 0 Then
        Set drv = fso.GetDrive(fso.GetDriveName(tempFolder))
        If Not drv Is Nothing Then
            freeSpaceGB = Round(drv.FreeSpace / 1073741824, 1)
        End If
    End If
    On Error Goto 0
    systemRAM = ramGB
    diskSpace = freeSpaceGB
    winVersion = osVer
    If ramGB >= 4 Then
        ramStatus = "<span class='sys-req-icon sys-req-pass'>&#10003;</span> RAM: " & ramGB & " GB"
        sysReqPassed = True
    ElseIf ramGB >= 2 Then
        ramStatus = "<span class='sys-req-icon sys-req-warn'>&#9888;</span> RAM: " & ramGB & " GB"
        sysReqPassed = True
    Else
        ramStatus = "<span class='sys-req-icon sys-req-fail'>&#10007;</span> RAM: " & ramGB & " GB"
        sysReqPassed = False
    End If
    If freeSpaceGB >= 5 Then
        diskStatus = "<span class='sys-req-icon sys-req-pass'>&#10003;</span> Space: " & freeSpaceGB & " GB"
    ElseIf freeSpaceGB >= 3 Then
        diskStatus = "<span class='sys-req-icon sys-req-warn'>&#9888;</span> Space: " & freeSpaceGB & " GB"
    Else
        diskStatus = "<span class='sys-req-icon sys-req-fail'>&#10007;</span> Space: " & freeSpaceGB & " GB"
        sysReqPassed = False
    End If
    If InStr(osVer, "Windows 10") > 0 Or InStr(osVer, "Windows 11") > 0 Then
        osStatus = "<span class='sys-req-icon sys-req-pass'>&#10003;</span> Win 10/11"
    ElseIf InStr(osVer, "Windows") > 0 Then
        osStatus = "<span class='sys-req-icon sys-req-warn'>&#9888;</span> Windows"
    Else
        osStatus = "<span class='sys-req-icon sys-req-fail'>&#10007;</span> Unknown OS"
    End If
    document.getElementById("sysReqContent").innerHTML = _
        "<div class='sys-req-item'>" & ramStatus & "</div>" & _
        "<div class='sys-req-item'>" & diskStatus & "</div>" & _
        "<div class='sys-req-item'>" & osStatus & "</div>"
End Sub

Sub CheckLicense()
    Dim key, prefix, hash, entries, entry, parts, edition, editionName
    On Error Resume Next
    key = UCase(Trim(document.getElementById("licenseInput").value))
    If Len(key) < 10 Then
        document.getElementById("licenseStatus").innerHTML = ""
        document.getElementById("featureShowcase").style.display = "none"
        detectedEdition = ""
        UpdateFooterButtons()
        Exit Sub
    End If
    prefix = Left(key, 4)
    Select Case prefix
        Case "BSIC": edition = "basic": editionName = "Basic"
        Case "WORK": edition = "workplace": editionName = "Workplace"
        Case "GAME": edition = "gamer": editionName = "Gamer"
        Case "AIDV": edition = "aidev": editionName = "AI Developer"
        Case "GMAI": edition = "gamer_ai": editionName = "Gamer+AI"
        Case "SERV": edition = "server": editionName = "Server"
        Case Else
            document.getElementById("licenseStatus").innerHTML = "<span class='license-invalid'>&#10007; Unknown license prefix</span>"
            document.getElementById("featureShowcase").style.display = "none"
            detectedEdition = ""
            UpdateFooterButtons()
            Exit Sub
    End Select
    hash = ComputeKeyHash(key)
    entries = Split(LICENSE_CACHE, "|")
    Dim found
    found = False
    For Each entry In entries
        parts = Split(entry, ":")
        If UBound(parts) >= 1 Then
            If parts(0) = hash And parts(1) = edition Then
                found = True
                Exit For
            End If
        End If
    Next
    If found Or InStr(key, "DEMO-TEST") > 0 Then
        document.getElementById("licenseStatus").innerHTML = "<span class='license-valid'>&#10003; Valid " & editionName & " License</span>"
        detectedEdition = edition
        licenseKey = key
        ShowEditionFeatures edition, editionName
    Else
        document.getElementById("licenseStatus").innerHTML = "<span class='license-invalid'>&#10007; License not found in cache</span>"
        document.getElementById("featureShowcase").style.display = "none"
        detectedEdition = ""
    End If
    UpdateFooterButtons()
    On Error Goto 0
End Sub

Sub ShowEditionFeatures(edition, editionName)
    Dim html
    html = "<li>Aegis Control Center</li><li>System Monitor</li><li>Update Manager</li>"
    Select Case edition
        Case "basic"
            html = html & "<li>Wallpaper Engine</li><li>Aegis Stream</li><li>Security Center</li><li>Backup Pro</li>"
        Case "gamer"
            html = html & "<li>Gaming Optimizer</li><li>FPS Boost</li><li>Streaming Tools</li><li>Discord Integration</li>"
        Case "aidev"
            html = html & "<li>AI Toolkit</li><li>GPU Compute Manager</li><li>ML Frameworks</li><li>Code Studio</li>"
        Case "workplace"
            html = html & "<li>Office Suite</li><li>VPN Client</li><li>Remote Desktop</li><li>Cloud Sync</li>"
        Case "server"
            html = html & "<li>Docker Manager</li><li>Kubernetes</li><li>VM Tools</li><li>Monitoring</li>"
        Case "gamer_ai"
            html = html & "<li>Gaming Optimizer</li><li>AI Toolkit</li><li>Streaming</li><li>ML Frameworks</li>"
    End Select
    document.getElementById("featureList").innerHTML = html
    document.getElementById("featureShowcase").style.display = "block"
End Sub

Sub ToggleFeature(featureId)
    Dim chk, features, i, newFeatures, found
    On Error Resume Next
    Set chk = document.getElementById("chk_" & featureId)
    If chk Is Nothing Then Exit Sub
    features = Split(selectedFeatures, ",")
    newFeatures = ""
    found = False
    For i = 0 To UBound(features)
        If features(i) = featureId Then
            found = True
            If chk.checked Then
                If Len(newFeatures) > 0 Then newFeatures = newFeatures & ","
                newFeatures = newFeatures & featureId
            End If
        Else
            If Len(features(i)) > 0 Then
                If Len(newFeatures) > 0 Then newFeatures = newFeatures & ","
                newFeatures = newFeatures & features(i)
            End If
        End If
    Next
    If Not found And chk.checked Then
        If Len(newFeatures) > 0 Then newFeatures = newFeatures & ","
        newFeatures = newFeatures & featureId
    End If
    selectedFeatures = newFeatures
    UpdateFeatureCount
    On Error Goto 0
End Sub

Sub SelectAllFeatures()
    Dim checkboxes, i
    On Error Resume Next
    Set checkboxes = document.querySelectorAll(".optional-features input[type='checkbox']")
    selectedFeatures = ""
    For i = 0 To checkboxes.length - 1
        checkboxes(i).checked = True
        Dim fid
        fid = Replace(checkboxes(i).id, "chk_", "")
        If Len(selectedFeatures) > 0 Then selectedFeatures = selectedFeatures & ","
        selectedFeatures = selectedFeatures & fid
    Next
    UpdateFeatureCount
    On Error Goto 0
End Sub

Sub DeselectAllFeatures()
    Dim checkboxes, i
    On Error Resume Next
    Set checkboxes = document.querySelectorAll(".optional-features input[type='checkbox']")
    For i = 0 To checkboxes.length - 1
        checkboxes(i).checked = False
    Next
    selectedFeatures = ""
    UpdateFeatureCount
    On Error Goto 0
End Sub

Sub UpdateFeatureCount()
    Dim count, features
    On Error Resume Next
    features = Split(selectedFeatures, ",")
    count = 0
    Dim i
    For i = 0 To UBound(features)
        If Len(features(i)) > 0 Then count = count + 1
    Next
    document.getElementById("featureCount").innerText = "3 core + " & count & " optional features"
    On Error Goto 0
End Sub

Sub RefreshDrives()
    Dim diskDrives, disk, html, sizeGB, partCount, busType
    On Error Resume Next
    If wmi Is Nothing Then
        Set wmi = GetObject("winmgmts:\\.\root\cimv2")
    End If
    If Err.Number <> 0 Then
        Err.Clear
        document.getElementById("driveList").innerHTML = "<div class='no-drives'>Could not access system.</div>"
        Exit Sub
    End If
    Set diskDrives = wmi.ExecQuery("SELECT * FROM Win32_DiskDrive WHERE MediaType LIKE '%Removable%' OR InterfaceType='USB'")
    ReDim drives(0)
    driveCount = 0
    html = ""
    For Each disk In diskDrives
        If Err.Number <> 0 Then Exit For
        If IsObject(disk) Then
            If disk.Size > 0 Then
                If InStr(LCase(disk.PNPDeviceID), "virtual") = 0 Then
                    sizeGB = FormatNumber(disk.Size / 1073741824, 1)
                    partCount = disk.Partitions
                    busType = disk.InterfaceType
                    If IsNull(busType) Or busType = "" Then busType = "USB"
                    Dim modelName
                    modelName = disk.Model
                    If IsNull(modelName) Or modelName = "" Then modelName = "USB Drive"
                    ReDim Preserve drives(driveCount)
                    drives(driveCount) = disk.Index
                    html = html & "<div class='drive-item' onclick='SelectDrive(" & driveCount & ")'>"
                    html = html & "<div class='drive-icon'>USB</div>"
                    html = html & "<div class='drive-info'>"
                    html = html & "<div class='drive-name'>" & modelName & "</div>"
                    html = html & "<div class='drive-size'>" & sizeGB & " GB - Disk " & disk.Index & "</div>"
                    html = html & "<div class='drive-details'>" & partCount & " partition(s) | " & busType & "</div>"
                    html = html & "</div></div>"
                    driveCount = driveCount + 1
                End If
            End If
        End If
    Next
    On Error Goto 0
    If driveCount = 0 Then
        html = "<div class='no-drives'>No USB drives detected.<br>Insert a USB drive and click Refresh.</div>"
    End If
    document.getElementById("driveList").innerHTML = html
    selectedDrive = ""
    selectedDriveNumber = -1
    UpdateFooterButtons()
End Sub

Sub SelectDrive(index)
    Dim items, i
    On Error Resume Next
    Set items = document.getElementsByClassName("drive-item")
    If items.length = 0 Then Exit Sub
    If index < 0 Or index >= items.length Then Exit Sub
    For i = 0 To items.length - 1
        items(i).className = "drive-item"
    Next
    items(index).className = "drive-item selected"
    selectedDriveNumber = drives(index)
    selectedDrive = items(index).getElementsByClassName("drive-name")(0).innerText
    UpdateFooterButtons()
    On Error Goto 0
End Sub

Sub SetPartitionStyle(style)
    partitionStyle = style
End Sub

Sub SetQuickFormat()
    Dim chk
    On Error Resume Next
    Set chk = document.getElementById("chkQuickFormat")
    If Not chk Is Nothing Then
        quickFormat = chk.checked
    End If
    On Error Goto 0
End Sub

Sub GoToStep(stepNum)
    Dim slides, steps, i, stepEl
    On Error Resume Next
    currentStep = stepNum
    Set slides = document.getElementsByClassName("slide")
    For i = 0 To slides.length - 1
        slides(i).className = "slide"
    Next
    Set stepEl = document.getElementById("step" & stepNum)
    If Not stepEl Is Nothing Then
        stepEl.className = "slide active"
    End If
    Set steps = document.getElementsByClassName("step-crumb")
    For i = 0 To steps.length - 1
        If i + 1 < stepNum Then
            steps(i).className = "step-crumb done"
        ElseIf i + 1 = stepNum Then
            steps(i).className = "step-crumb active"
        Else
            steps(i).className = "step-crumb"
        End If
    Next
    If stepNum = 2 Then
        ShowEditionSpecificFeatures()
    ElseIf stepNum = 3 Then
        RefreshDrives()
        document.getElementById("editionDisplay").innerHTML = "<span class='edition-badge'>" & GetEditionName() & "</span>"
    ElseIf stepNum = 4 Then
        document.getElementById("confirmDrive").innerText = selectedDrive
        document.getElementById("confirmEdition").innerHTML = "<span class='edition-badge'>" & GetEditionName() & "</span>"
        document.getElementById("confirmPartStyle").innerText = partitionStyle
        document.getElementById("confirmQuickFmt").innerText = IIf(quickFormat, "Yes", "No")
        document.getElementById("confirmFeatures").innerText = GetFeatureCountText()
    ElseIf stepNum = 5 Then
        document.getElementById("progressBar").style.width = "0%"
        document.getElementById("progressBar").className = "progress-bar-fill animated"
        document.getElementById("progressPercent").innerText = "0%"
        document.getElementById("progressStatus").innerText = "Starting..."
        document.getElementById("progressDetail").innerText = "Please wait"
        smoothProgress = 0
    End If
    UpdateFooterButtons()
    On Error Goto 0
End Sub

Function GetEditionName()
    Select Case detectedEdition
        Case "basic": GetEditionName = "Basic"
        Case "gamer": GetEditionName = "Gamer"
        Case "aidev": GetEditionName = "AI Developer"
        Case "workplace": GetEditionName = "Workplace"
        Case "server": GetEditionName = "Server"
        Case "gamer_ai": GetEditionName = "Gamer+AI"
        Case Else: GetEditionName = "Licensed"
    End Select
End Function

Sub ShowEditionSpecificFeatures()
    On Error Resume Next
    document.getElementById("gamerFeatures").className = "edition-features"
    document.getElementById("aiFeatures").className = "edition-features"
    document.getElementById("serverFeatures").className = "edition-features"
    Select Case detectedEdition
        Case "gamer", "gamer_ai"
            document.getElementById("gamerFeatures").className = "edition-features visible"
        Case "aidev", "gamer_ai"
            document.getElementById("aiFeatures").className = "edition-features visible"
        Case "server"
            document.getElementById("serverFeatures").className = "edition-features visible"
    End Select
    document.getElementById("featureEditionLabel").innerHTML = "<span class='edition-badge'>" & GetEditionName() & "</span>"
    On Error Goto 0
End Sub

Sub UpdateFooterButtons()
    Dim btnBack, btnNext
    On Error Resume Next
    Set btnBack = document.getElementById("btnBack")
    Set btnNext = document.getElementById("btnNext")
    If currentStep = 1 Then
        btnBack.className = "btn btn-secondary hidden"
        btnNext.innerText = "Next"
        btnNext.className = "btn btn-primary"
        btnNext.disabled = (Len(detectedEdition) = 0)
    ElseIf currentStep = 2 Then
        btnBack.className = "btn btn-secondary"
        btnNext.innerText = "Next"
        btnNext.className = "btn btn-primary"
        btnNext.disabled = False
    ElseIf currentStep = 3 Then
        btnBack.className = "btn btn-secondary"
        btnNext.innerText = "Next"
        btnNext.className = "btn btn-primary"
        btnNext.disabled = (selectedDriveNumber < 0)
    ElseIf currentStep = 4 Then
        btnBack.className = "btn btn-secondary"
        btnNext.innerText = "Create USB"
        btnNext.className = "btn btn-primary btn-create"
        btnNext.disabled = False
    ElseIf currentStep = 5 Then
        btnBack.className = "btn btn-secondary hidden"
        btnNext.innerText = "Creating..."
        btnNext.className = "btn btn-primary"
        btnNext.disabled = True
    ElseIf currentStep = 6 Then
        btnBack.className = "btn btn-secondary hidden"
        btnNext.innerText = "Close"
        btnNext.className = "btn btn-primary"
        btnNext.disabled = False
    End If
    On Error Goto 0
End Sub

Function GetFeatureCountText()
    Dim features, count, i
    features = Split(selectedFeatures, ",")
    count = 0
    For i = 0 To UBound(features)
        If Len(features(i)) > 0 Then count = count + 1
    Next
    GetFeatureCountText = "3 core + " & count & " optional"
End Function

Function IIf(cond, trueVal, falseVal)
    If cond Then IIf = trueVal Else IIf = falseVal
End Function

Sub OnBackClick()
    If currentStep > 1 And currentStep < 5 Then
        GoToStep(currentStep - 1)
    End If
End Sub

Sub OnNextClick()
    If currentStep = 1 Then
        If Len(detectedEdition) > 0 Then GoToStep(2)
    ElseIf currentStep = 2 Then
        GoToStep(3)
    ElseIf currentStep = 3 Then
        If selectedDriveNumber >= 0 Then GoToStep(4)
    ElseIf currentStep = 4 Then
        StartCreation()
    ElseIf currentStep = 6 Then
        CloseApp()
    End If
End Sub

Sub StartCreation()
    GoToStep(5)
    CreateUSB()
End Sub

Sub CreateUSB()
    Dim tempDir, psFile, progressFile, psCode, ts
    tempDir = shell.ExpandEnvironmentStrings("%TEMP%")
    psFile = tempDir & "\aegis_creator.ps1"
    progressFile = tempDir & "\aegis_progress.txt"
    If fso.FileExists(progressFile) Then fso.DeleteFile progressFile
    psCode = GetPowerShellCode()
    Set ts = fso.CreateTextFile(psFile, True)
    ts.Write psCode
    ts.Close
    Dim cmd
    cmd = "powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File """ & psFile & """ -DiskNumber " & selectedDriveNumber & " -Edition """ & GetEditionName() & """ -Features """ & selectedFeatures & """ -PartitionStyle """ & partitionStyle & """ -QuickFormat $" & LCase(CStr(quickFormat)) & " -ProgressFile """ & progressFile & """"
    progressTimer = window.setInterval(GetRef("CheckProgress"), 500)
    shell.Run cmd, 0, False
End Sub

Function GetPowerShellCode()
    Dim code, edName
    edName = GetEditionName()
    code = "param([int]$DiskNumber, [string]$Edition, [string]$Features, [string]$PartitionStyle, [bool]$QuickFormat, [string]$ProgressFile)" & vbCrLf
    code = code & "$ErrorActionPreference = 'Stop'" & vbCrLf
    code = code & "$global:startTime = $null; $global:lastBytes = 0; $global:lastTime = $null" & vbCrLf
    code = code & "function Write-P { param([int]$P, [string]$S, [string]$D='', [string]$Speed='', [string]$ETA='', [string]$Size=''); " & vbCrLf
    code = code & "  $line = ""$P|$S|$D|$Speed|$ETA|$Size""; $line | Out-File $ProgressFile -Encoding UTF8 -Force }" & vbCrLf
    code = code & "function Test-Admin { ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator) }" & vbCrLf
    code = code & "function Get-DetailedError { param($ex)" & vbCrLf
    code = code & "  $msg = $ex.Exception.Message" & vbCrLf
    code = code & "  if ($msg -match 'access.*denied|permission') { return 'PERMISSION_DENIED: Run as Administrator.' }" & vbCrLf
    code = code & "  if ($msg -match 'network|connection|timeout') { return 'NETWORK_ERROR: Check internet connection.' }" & vbCrLf
    code = code & "  if ($msg -match 'disk.*full|space') { return 'DISK_FULL: Free up temp space.' }" & vbCrLf
    code = code & "  if ($msg -match 'not found|404') { return 'NOT_FOUND: Server unavailable.' }" & vbCrLf
    code = code & "  return ""ERROR: $msg"" }" & vbCrLf
    code = code & "if (-not (Test-Admin)) { Write-P -1 'ADMIN_REQUIRED: Run as Administrator.'; exit 1 }" & vbCrLf
    code = code & "try {" & vbCrLf
    code = code & "Write-P 0 'Initializing...' ""$Edition Edition""" & vbCrLf
    code = code & "$disk = Get-Disk -Number $DiskNumber -ErrorAction Stop" & vbCrLf
    code = code & "if ($disk.IsSystem -or $disk.IsBoot) { Write-P -1 'SYSTEM_DRIVE: Cannot write to system drive.'; exit 1 }" & vbCrLf
    code = code & "if ($disk.Size -lt 4GB) { Write-P -1 'DRIVE_TOO_SMALL: USB must be 4GB+.'; exit 1 }" & vbCrLf
    code = code & "Write-P 3 'USB drive validated' ''" & vbCrLf
    code = code & "$tempDir = ""$env:TEMP\AegisOS""; New-Item -ItemType Directory -Path $tempDir -Force | Out-Null" & vbCrLf
    code = code & "$isoPath = ""$tempDir\base.iso""" & vbCrLf
    code = code & "$mirrors = @(" & vbCrLf
    code = code & "  'https://repo.linuxliteos.com/linuxlite/isos/7.2/linux-lite-7.2-64bit.iso'," & vbCrLf
    code = code & "  'https://mirror.freedif.org/LinuxLiteOS/isos/7.2/linux-lite-7.2-64bit.iso'," & vbCrLf
    code = code & "  'https://mirrors.xtom.com/osdn/storage/g/l/li/linuxlite/7.2/linux-lite-7.2-64bit.iso'" & vbCrLf
    code = code & ")" & vbCrLf
    code = code & "$expectedHash = 'DC8955E02C68537815ED0010F7C4C035CE786BBA2C679DD74532B22205DF8216'" & vbCrLf
    code = code & "$maxRetries = 3; $mirrorIndex = 0; $downloadSuccess = $false" & vbCrLf
    code = code & "Write-P 5 'Preparing download...' ""Aegis OS $Edition (~2.9 GB)""" & vbCrLf
    code = code & "while (-not $downloadSuccess -and $mirrorIndex -lt $mirrors.Count) {" & vbCrLf
    code = code & "  $isoUrl = $mirrors[$mirrorIndex]; $retryCount = 0" & vbCrLf
    code = code & "  while (-not $downloadSuccess -and $retryCount -lt $maxRetries) {" & vbCrLf
    code = code & "  try {" & vbCrLf
    code = code & "    if ($mirrorIndex -gt 0 -or $retryCount -gt 0) { Write-P 6 ""Mirror $($mirrorIndex+1), Attempt $($retryCount+1)..."" }" & vbCrLf
    code = code & "    $webRequest = [System.Net.HttpWebRequest]::Create($isoUrl)" & vbCrLf
    code = code & "    $webRequest.UserAgent = 'AegisOS/3.0'; $webRequest.Timeout = 30000" & vbCrLf
    code = code & "    $response = $webRequest.GetResponse(); $totalBytes = $response.ContentLength" & vbCrLf
    code = code & "    $responseStream = $response.GetResponseStream(); $fileStream = [System.IO.File]::Create($isoPath)" & vbCrLf
    code = code & "    $buffer = New-Object byte[] 8MB; $downloadedBytes = 0" & vbCrLf
    code = code & "    $global:startTime = Get-Date; $global:lastTime = $global:startTime" & vbCrLf
    code = code & "    while (($bytesRead = $responseStream.Read($buffer, 0, $buffer.Length)) -gt 0) {" & vbCrLf
    code = code & "      $fileStream.Write($buffer, 0, $bytesRead); $downloadedBytes += $bytesRead" & vbCrLf
    code = code & "      $pct = [int](($downloadedBytes / $totalBytes) * 100); $mappedPct = 8 + [int]($pct * 0.40)" & vbCrLf
    code = code & "      $now = Get-Date" & vbCrLf
    code = code & "      if (($now - $global:lastTime).TotalSeconds -ge 1) {" & vbCrLf
    code = code & "        $elapsed = ($now - $global:startTime).TotalSeconds" & vbCrLf
    code = code & "        $speed = $downloadedBytes / $elapsed / 1MB" & vbCrLf
    code = code & "        $remaining = ($totalBytes - $downloadedBytes) / ($downloadedBytes / $elapsed)" & vbCrLf
    code = code & "        $etaMins = [math]::Floor($remaining / 60); $etaSecs = [int]($remaining % 60)" & vbCrLf
    code = code & "        $dlMB = [math]::Round($downloadedBytes / 1MB, 1); $totMB = [math]::Round($totalBytes / 1MB, 1)" & vbCrLf
    code = code & "        $speedStr = '{0:N1} MB/s' -f $speed" & vbCrLf
    code = code & "        $etaStr = if ($etaMins -gt 0) { ""$etaMins min $etaSecs sec"" } else { ""$etaSecs sec"" }" & vbCrLf
    code = code & "        Write-P $mappedPct ""Downloading $Edition..."" ""$pct%"" $speedStr $etaStr ""$dlMB / $totMB MB""" & vbCrLf
    code = code & "        $global:lastTime = $now" & vbCrLf
    code = code & "      }}" & vbCrLf
    code = code & "    $fileStream.Close(); $responseStream.Close(); $response.Close(); $downloadSuccess = $true" & vbCrLf
    code = code & "  } catch { $retryCount++; if ($fileStream) { $fileStream.Close() }; if ($retryCount -ge $maxRetries) { break }; Start-Sleep -Seconds (2 * $retryCount) }" & vbCrLf
    code = code & "  }" & vbCrLf
    code = code & "  if (-not $downloadSuccess) { $mirrorIndex++ }}" & vbCrLf
    code = code & "if (-not $downloadSuccess) { Write-P -1 'ALL_MIRRORS_FAILED: Check connection.'; exit 1 }" & vbCrLf
    code = code & "if (-not (Test-Path $isoPath) -or (Get-Item $isoPath).Length -lt 500MB) { Write-P -1 'DOWNLOAD_INCOMPLETE'; exit 1 }" & vbCrLf
    code = code & "Write-P 50 'Verifying integrity...' 'SHA256 checksum'" & vbCrLf
    code = code & "$hash = (Get-FileHash -Path $isoPath -Algorithm SHA256).Hash" & vbCrLf
    code = code & "if ($hash -ne $expectedHash) { Write-P -1 ""CHECKSUM_FAILED""; exit 1 }" & vbCrLf
    code = code & "Write-P 52 'Checksum verified' ''" & vbCrLf
    code = code & "Write-P 54 'Preparing USB...' 'Taking disk offline'" & vbCrLf
    code = code & "$dp = ""select disk $DiskNumber`nattributes disk clear readonly`nclean`noffline disk`nexit""; $dp | Out-File ""$tempDir\dp.txt"" -Encoding ASCII" & vbCrLf
    code = code & "try { diskpart /s ""$tempDir\dp.txt"" | Out-Null } catch { Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    code = code & "Write-P 56 'Writing to USB...' 'Do not remove!'" & vbCrLf
    code = code & "$phys = '\\.\PhysicalDrive' + $DiskNumber" & vbCrLf
    code = code & "Start-Sleep -Seconds 2" & vbCrLf
    code = code & "$global:startTime = Get-Date" & vbCrLf
    code = code & "try { $src = [IO.File]::OpenRead($isoPath)" & vbCrLf
    code = code & "  $dst = New-Object IO.FileStream($phys, [IO.FileMode]::Open, [IO.FileAccess]::ReadWrite, [IO.FileShare]::None, 4MB)" & vbCrLf
    code = code & "  $dst.Seek(0, [IO.SeekOrigin]::Begin) | Out-Null" & vbCrLf
    code = code & "} catch { Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    code = code & "$buf = New-Object byte[] 4MB; $written = 0; $total = $src.Length" & vbCrLf
    code = code & "$writeStart = Get-Date; $lastWriteUpdate = $writeStart" & vbCrLf
    code = code & "while (($read = $src.Read($buf, 0, $buf.Length)) -gt 0) {" & vbCrLf
    code = code & "  try { $dst.Write($buf, 0, $read); $dst.Flush() } catch { $dst.Close(); $src.Close(); Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    code = code & "  $written += $read; $pct = [int](($written / $total) * 100); $mappedPct = 56 + [int]($pct * 0.40)" & vbCrLf
    code = code & "  $now = Get-Date" & vbCrLf
    code = code & "  if (($now - $lastWriteUpdate).TotalSeconds -ge 1) {" & vbCrLf
    code = code & "    $elapsed = ($now - $writeStart).TotalSeconds; $speed = $written / $elapsed / 1MB" & vbCrLf
    code = code & "    $remaining = ($total - $written) / ($written / $elapsed)" & vbCrLf
    code = code & "    $etaMins = [math]::Floor($remaining / 60); $etaSecs = [int]($remaining % 60)" & vbCrLf
    code = code & "    $speedStr = '{0:N1} MB/s' -f $speed" & vbCrLf
    code = code & "    $etaStr = if ($etaMins -gt 0) { ""$etaMins min"" } else { ""$etaSecs sec"" }" & vbCrLf
    code = code & "    Write-P $mappedPct 'Writing...' ""$pct%"" $speedStr $etaStr ''" & vbCrLf
    code = code & "    $lastWriteUpdate = $now}}" & vbCrLf
    code = code & "$dst.Flush(); $dst.Close(); $src.Close()" & vbCrLf
    code = code & "Write-P 95 'Verifying boot sector...' ''" & vbCrLf
    code = code & "Start-Sleep -Seconds 2" & vbCrLf
    code = code & "$verifyStream = New-Object IO.FileStream($phys, [IO.FileMode]::Open, [IO.FileAccess]::Read, [IO.FileShare]::ReadWrite)" & vbCrLf
    code = code & "$verifyBuf = New-Object byte[] 512; $verifyStream.Seek(0, [IO.SeekOrigin]::Begin) | Out-Null" & vbCrLf
    code = code & "$verifyStream.Read($verifyBuf, 0, 512) | Out-Null; $verifyStream.Close()" & vbCrLf
    code = code & "$srcVerify = [IO.File]::OpenRead($isoPath); $srcBuf = New-Object byte[] 512" & vbCrLf
    code = code & "$srcVerify.Read($srcBuf, 0, 512) | Out-Null; $srcVerify.Close()" & vbCrLf
    code = code & "if ([System.Linq.Enumerable]::SequenceEqual([byte[]]$verifyBuf, [byte[]]$srcBuf)) { Write-P 96 'Boot sector verified!' '' } else { Write-P -1 'VERIFY_FAILED'; exit 1 }" & vbCrLf
    code = code & "Write-P 97 'Syncing...' ''" & vbCrLf
    code = code & "$dp2 = ""select disk $DiskNumber`nonline disk`nexit""; $dp2 | Out-File ""$tempDir\dp2.txt"" -Encoding ASCII" & vbCrLf
    code = code & "try { diskpart /s ""$tempDir\dp2.txt"" | Out-Null } catch { }" & vbCrLf
    code = code & """rescan"" | Out-File ""$tempDir\rs.txt"" -Encoding ASCII; diskpart /s ""$tempDir\rs.txt"" | Out-Null" & vbCrLf
    code = code & "Write-P 99 'Cleaning up...' ''" & vbCrLf
    code = code & "Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue" & vbCrLf
    code = code & "Write-P 100 ""SUCCESS! Aegis OS $Edition ready!"" 'Safe to remove USB.'" & vbCrLf
    code = code & "} catch { Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    GetPowerShellCode = code
End Function

Sub CheckProgress()
    Dim progressFile, ts, line, parts, pct, status, detail, speed, eta, size
    On Error Resume Next
    progressFile = shell.ExpandEnvironmentStrings("%TEMP%") & "\aegis_progress.txt"
    If fso.FileExists(progressFile) Then
        Set ts = fso.OpenTextFile(progressFile, 1)
        If Err.Number = 0 And Not ts Is Nothing Then
            line = ts.ReadLine()
            ts.Close
            If Err.Number = 0 And Len(line) > 0 Then
                parts = Split(line, "|")
                If UBound(parts) >= 0 Then
                    If IsNumeric(parts(0)) Then pct = CInt(parts(0)) Else pct = 0
                    status = "": detail = "": speed = "": eta = "": size = ""
                    If UBound(parts) >= 1 Then status = parts(1)
                    If UBound(parts) >= 2 Then detail = parts(2)
                    If UBound(parts) >= 3 Then speed = parts(3)
                    If UBound(parts) >= 4 Then eta = parts(4)
                    If UBound(parts) >= 5 Then size = parts(5)
                    If pct = -1 Then
                        window.clearInterval progressTimer
                        ShowError status, detail
                    ElseIf pct = 100 Then
                        window.clearInterval progressTimer
                        document.getElementById("progressBar").className = "progress-bar-fill"
                        UpdateProgress 100, status, detail, "", "", ""
                        window.setTimeout GetRef("GoToStepSix"), 1500
                    Else
                        UpdateProgressSmooth pct, status, detail, speed, eta, size
                    End If
                End If
            End If
        Else
            Err.Clear
        End If
    End If
    On Error Goto 0
End Sub

Sub GoToStepSix()
    GoToStep(6)
End Sub

Sub UpdateProgressSmooth(targetPct, status, detail, speed, eta, size)
    Dim delta, step
    If targetPct > smoothProgress Then
        delta = targetPct - smoothProgress
        If delta > 10 Then
            step = Int(delta / 2)
        ElseIf delta > 5 Then
            step = 3
        Else
            step = 2
        End If
        smoothProgress = smoothProgress + step
        If smoothProgress > targetPct Then smoothProgress = targetPct
    End If
    UpdateProgress smoothProgress, status, detail, speed, eta, size
End Sub

Sub UpdateProgress(pct, status, detail, speed, eta, size)
    document.getElementById("progressBar").style.width = pct & "%"
    document.getElementById("progressPercent").innerText = pct & "%"
    document.getElementById("progressStatus").innerText = status
    document.getElementById("progressDetail").innerText = detail
    If speed <> "" Then document.getElementById("statSpeed").innerText = speed
    If eta <> "" Then document.getElementById("statETA").innerText = eta
    If size <> "" Then document.getElementById("statSize").innerText = size
End Sub

Sub ShowError(msg, detail)
    Dim errorType, errorMsg, errorFix
    If InStr(msg, "ADMIN_REQUIRED") > 0 Then
        errorType = "Administrator Required"
        errorMsg = "This tool needs admin rights."
        errorFix = "Right-click and Run as Administrator"
    ElseIf InStr(msg, "PERMISSION_DENIED") > 0 Then
        errorType = "Permission Denied"
        errorMsg = "Cannot access USB drive."
        errorFix = "Close other programs using the drive."
    ElseIf InStr(msg, "NETWORK_ERROR") > 0 Then
        errorType = "Network Error"
        errorMsg = "Could not download files."
        errorFix = "Check your internet connection."
    ElseIf InStr(msg, "DISK_FULL") > 0 Then
        errorType = "Disk Full"
        errorMsg = "Not enough temp space."
        errorFix = "Free up at least 3GB."
    ElseIf InStr(msg, "DRIVE_TOO_SMALL") > 0 Then
        errorType = "USB Too Small"
        errorMsg = "USB must be at least 4GB."
        errorFix = "Use a larger USB drive."
    Else
        errorType = "Error"
        errorMsg = Replace(msg, "ERROR: ", "")
        errorFix = "Try again or contact support."
    End If
    document.getElementById("progressContainer").innerHTML = _
        "<div style='font-size:32px;color:#ef4444;margin-bottom:8px'>&#10060;</div>" & _
        "<div style='font-size:14px;color:#ef4444;margin-bottom:6px'>" & errorType & "</div>" & _
        "<div class='error-box'><div style='margin-bottom:4px'>" & errorMsg & "</div>" & _
        "<div style='font-size:9px;color:#f59e0b'><strong>Fix:</strong> " & errorFix & "</div>" & _
        "<div class='error-details'>" & detail & "</div></div>"
    currentStep = 1
    UpdateFooterButtons()
    document.getElementById("btnBack").className = "btn btn-secondary"
    document.getElementById("btnBack").innerText = "Try Again"
End Sub

Sub CloseApp()
    window.close()
End Sub
</script>
</head>
<body>
<div class="wizard">
    <div class="wizard-header">
        <svg class="logo-svg shield-animate" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 4L6 12v12c0 11 8 17 18 20 10-3 18-9 18-20V12L24 4z" fill="url(#shieldGradPro)" stroke="#f59e0b" stroke-width="2"/>
            <path d="M24 14l-2.5 5-5.5.8 4 3.9-.95 5.5L24 26.5l4.95 2.7-.95-5.5 4-3.9-5.5-.8L24 14z" fill="#fff" stroke="#fff" stroke-width="1"/>
            <defs><linearGradient id="shieldGradPro" x1="6" y1="4" x2="42" y2="44"><stop stop-color="#b45309"/><stop offset="1" stop-color="#f59e0b"/></linearGradient></defs>
        </svg>
        <div class="header-text">
            <h1>Aegis OS Media Creation Tool</h1>
            <p>Premium Licensed Editions</p>
        </div>
    </div>

    <div class="wizard-breadcrumb">
        <div class="step-crumb active">1. License</div>
        <div class="step-crumb">2. Features</div>
        <div class="step-crumb">3. USB Drive</div>
        <div class="step-crumb">4. Confirm</div>
        <div class="step-crumb">5. Creating</div>
        <div class="step-crumb">6. Done</div>
    </div>

    <div class="wizard-content">
        <div id="step1" class="slide active">
            <div class="section-title">Enter License Key</div>
            <div class="section-desc">Enter your license key to unlock the premium edition.</div>

            <div id="adminNotice" class="admin-notice" style="display:none">
                <strong>Note:</strong> Run as Administrator for best results.
            </div>

            <div class="sys-req-box">
                <div style="font-size:9px;color:#f59e0b;margin-bottom:4px;font-weight:600">System Check</div>
                <div id="sysReqContent" style="display:flex;gap:12px;">Checking...</div>
            </div>

            <div class="form-group">
                <label class="form-label">License Key</label>
                <input type="text" id="licenseInput" class="form-input" placeholder="BSIC-XXXX-XXXX-XXXX" onkeyup="CheckLicense()" maxlength="30" style="text-transform:uppercase">
                <div id="licenseStatus" style="margin-top:6px"></div>
            </div>
            
            <div class="info-box">
                <h3>License Prefixes</h3>
                <ul>
                    <li>BSIC = Basic | WORK = Workplace</li>
                    <li>GAME = Gamer | AIDV = AI Developer</li>
                    <li>GMAI = Gamer+AI | SERV = Server</li>
                </ul>
                <div style="font-size:9px;color:#888;margin-top:4px">Demo: BSIC-DEMO-TEST-2024</div>
            </div>

            <div id="featureShowcase" class="feature-showcase" style="display:none">
                <h4>&#9733; Edition Features</h4>
                <ul class="feature-list" id="featureList"></ul>
            </div>
        </div>

        <div id="step2" class="slide">
            <div class="section-title">Select Features</div>
            <div class="section-desc">Choose tools to install: <span id="featureEditionLabel"></span></div>

            <div class="feature-section">
                <div class="feature-section-title"><span class="icon">&#128274;</span> Core Features (Always Installed)</div>
                <div class="core-features">
                    <div class="core-feature-item"><span class="icon">&#10003;</span> Control Center</div>
                    <div class="core-feature-item"><span class="icon">&#10003;</span> System Monitor</div>
                    <div class="core-feature-item"><span class="icon">&#10003;</span> Update Manager</div>
                </div>
            </div>

            <div class="feature-section" style="flex:1;display:flex;flex-direction:column;min-height:0;">
                <div class="feature-section-title"><span class="icon">&#9881;</span> Optional Features</div>
                <div class="feature-actions">
                    <button class="btn btn-secondary btn-small" onclick="SelectAllFeatures()">All</button>
                    <button class="btn btn-secondary btn-small" onclick="DeselectAllFeatures()">None</button>
                </div>
                <div class="optional-features">
                    <div class="feature-card">
                        <input type="checkbox" id="chk_wallpaper" checked onclick="ToggleFeature('wallpaper')">
                        <div class="feature-card-content">
                            <div class="feature-card-name">Wallpaper Engine</div>
                            <div class="feature-card-desc">Animated wallpapers with AI</div>
                        </div>
                    </div>
                    <div class="feature-card">
                        <input type="checkbox" id="chk_stream" checked onclick="ToggleFeature('stream')">
                        <div class="feature-card-content">
                            <div class="feature-card-name">Aegis Stream</div>
                            <div class="feature-card-desc">Local game streaming</div>
                        </div>
                    </div>
                    <div class="feature-card">
                        <input type="checkbox" id="chk_security" checked onclick="ToggleFeature('security')">
                        <div class="feature-card-content">
                            <div class="feature-card-name">Security Center</div>
                            <div class="feature-card-desc">Firewall and antivirus</div>
                        </div>
                    </div>
                    <div class="feature-card">
                        <input type="checkbox" id="chk_backup" checked onclick="ToggleFeature('backup')">
                        <div class="feature-card-content">
                            <div class="feature-card-name">Backup Pro</div>
                            <div class="feature-card-desc">Scheduled cloud backups</div>
                        </div>
                    </div>
                    <div id="gamerFeatures" class="edition-features">
                        <div class="feature-card">
                            <input type="checkbox" id="chk_gaming" checked onclick="ToggleFeature('gaming')">
                            <div class="feature-card-content">
                                <div class="feature-card-name">Gaming Optimizer <span class="feature-card-badge">Gamer</span></div>
                                <div class="feature-card-desc">FPS boost, latency reduction</div>
                            </div>
                        </div>
                    </div>
                    <div id="aiFeatures" class="edition-features">
                        <div class="feature-card">
                            <input type="checkbox" id="chk_ai" checked onclick="ToggleFeature('ai')">
                            <div class="feature-card-content">
                                <div class="feature-card-name">AI Toolkit <span class="feature-card-badge">AI Dev</span></div>
                                <div class="feature-card-desc">ML frameworks, GPU compute</div>
                            </div>
                        </div>
                    </div>
                    <div id="serverFeatures" class="edition-features">
                        <div class="feature-card">
                            <input type="checkbox" id="chk_server" checked onclick="ToggleFeature('server')">
                            <div class="feature-card-content">
                                <div class="feature-card-name">Server Tools <span class="feature-card-badge">Server</span></div>
                                <div class="feature-card-desc">Docker, K8s, VM management</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="featureCount" class="feature-count">3 core + 4 optional features</div>
            </div>
        </div>

        <div id="step3" class="slide">
            <div class="section-title">Select USB Drive</div>
            <div class="section-desc">Installing: <span id="editionDisplay">-</span></div>

            <div class="warning-box">
                <strong>&#9888; Warning:</strong> All data on the selected drive will be erased.
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <span style="font-size:10px;color:#aaa;">Available USB Drives:</span>
                <button class="btn btn-refresh" onclick="RefreshDrives()">&#8635; Refresh</button>
            </div>

            <div id="driveList" class="drive-list">
                <div class="no-drives">Click Refresh to scan for USB drives.</div>
            </div>

            <div class="option-group">
                <span class="option-label">Partition Style:</span>
                <div class="radio-group">
                    <label class="radio-item"><input type="radio" name="partStyle" checked onclick="SetPartitionStyle('GPT')"> GPT (UEFI)</label>
                    <label class="radio-item"><input type="radio" name="partStyle" onclick="SetPartitionStyle('MBR')"> MBR (Legacy)</label>
                </div>
            </div>

            <label class="checkbox-item">
                <input type="checkbox" id="chkQuickFormat" checked onclick="SetQuickFormat()">
                Quick Format (faster)
            </label>
        </div>

        <div id="step4" class="slide">
            <div class="section-title">Confirm Settings</div>
            <div class="section-desc">Review before creating the USB.</div>

            <div class="warning-box">
                <strong>&#9888; Final Warning:</strong> This will erase all data on the USB!
            </div>

            <div class="confirm-grid">
                <div class="confirm-item">
                    <div class="confirm-label">Target Drive</div>
                    <div class="confirm-value" id="confirmDrive">-</div>
                </div>
                <div class="confirm-item">
                    <div class="confirm-label">Edition</div>
                    <div class="confirm-value" id="confirmEdition">-</div>
                </div>
                <div class="confirm-item">
                    <div class="confirm-label">Partition Style</div>
                    <div class="confirm-value" id="confirmPartStyle">GPT</div>
                </div>
                <div class="confirm-item">
                    <div class="confirm-label">Quick Format</div>
                    <div class="confirm-value" id="confirmQuickFmt">Yes</div>
                </div>
            </div>

            <div class="confirm-item" style="margin-bottom:8px;">
                <div class="confirm-label">Features</div>
                <div class="confirm-value" id="confirmFeatures">3 core + 4 optional</div>
            </div>

            <div class="info-box">
                <h3>What happens next:</h3>
                <ul>
                    <li>Download Aegis OS (~2.9 GB)</li>
                    <li>Verify file integrity (SHA256)</li>
                    <li>Write bootable image to USB</li>
                    <li>Estimated time: 15-30 minutes</li>
                </ul>
            </div>
        </div>

        <div id="step5" class="slide">
            <div class="section-title">Creating Bootable USB</div>
            <div class="section-desc">Do not remove the USB drive during this process.</div>

            <div id="progressContainer" class="progress-container">
                <div class="progress-percent" id="progressPercent">0%</div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill animated" id="progressBar"></div>
                </div>
                <div class="progress-status" id="progressStatus">Starting...</div>
                <div class="progress-detail" id="progressDetail">Please wait</div>
                <div class="progress-stats">
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="statSpeed">--</div>
                        <div class="progress-stat-label">Speed</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="statETA">--</div>
                        <div class="progress-stat-label">Remaining</div>
                    </div>
                    <div class="progress-stat">
                        <div class="progress-stat-value" id="statSize">--</div>
                        <div class="progress-stat-label">Size</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="step6" class="slide">
            <div class="success-container">
                <div class="success-icon">&#10004;</div>
                <div class="success-title">USB Created Successfully!</div>
                <div class="success-desc">Your Aegis OS bootable USB is ready.</div>

                <div class="success-steps">
                    <h3>Next Steps:</h3>
                    <ol>
                        <li>Safely eject the USB drive</li>
                        <li>Insert into target computer</li>
                        <li>Boot from USB (F12/F2/DEL at startup)</li>
                        <li>Follow on-screen installation</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="wizard-footer">
        <button id="btnBack" class="btn btn-secondary hidden" onclick="OnBackClick()">Back</button>
        <button id="btnNext" class="btn btn-primary" onclick="OnNextClick()" disabled>Next</button>
    </div>
</div>
</body>
</html>
