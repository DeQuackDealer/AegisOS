<html>
<head>
<title>Aegis OS Media Creation Tool - Licensed</title>
<HTA:APPLICATION
    ID="AegisMediaToolPro"
    APPLICATIONNAME="Aegis OS Media Creation Tool"
    BORDER="thick"
    BORDERSTYLE="raised"
    CAPTION="yes"
    MAXIMIZEBUTTON="no"
    MINIMIZEBUTTON="yes"
    SHOWINTASKBAR="yes"
    SINGLEINSTANCE="yes"
    SYSMENU="yes"
    VERSION="3.0"
    SCROLL="no"
/>
<script language="VBScript">
Dim selectedDrive, selectedDriveNumber, drives(), driveCount
Dim licenseKey, detectedEdition, detectedEditionName
Dim progressTimer, shell, fso, wmi
Dim lastProgress, smoothProgress
Dim partitionStyle, quickFormat
Dim systemRAM, diskSpace, winVersion, sysReqPassed
Dim selectedFeatures
Dim hwid
Dim currentStep

Const LICENSE_CACHE = "8cc68ef8c0df7e33:basic:basic|6cfdada10909d632:workplace:workplace|a1b2c3d4e5f67890:gamer:gamer|f0e1d2c3b4a59687:aidev:aidev|1234567890abcdef:gamer_ai:gamer_ai|fedcba0987654321:server:server"

Function IsAdmin()
    On Error Resume Next
    IsAdmin = (CreateObject("WScript.Shell").Run("net session", 0, True) = 0)
    On Error Goto 0
End Function

Sub RestartAsAdmin()
    Dim shellApp, htaPath
    Set shellApp = CreateObject("Shell.Application")
    htaPath = document.location.pathname
    If Left(htaPath, 1) = "/" Then htaPath = Mid(htaPath, 2)
    htaPath = Replace(htaPath, "%20", " ")
    htaPath = Replace(htaPath, "%5C", "\")
    shellApp.ShellExecute "mshta.exe", Chr(34) & htaPath & Chr(34), "", "runas", 1
    window.close
End Sub

Sub CollectHWID()
    Dim computerName, cpuId, macAddr, diskSerial, combined
    On Error Resume Next
    computerName = CreateObject("WScript.Network").ComputerName
    If Len(computerName) = 0 Then computerName = "UNKNOWN"
    cpuId = "UNKNOWN"
    Set wmiTemp = GetObject("winmgmts:\\.\root\cimv2")
    If Not wmiTemp Is Nothing Then
        Set cpuQuery = wmiTemp.ExecQuery("SELECT ProcessorId FROM Win32_Processor")
        For Each cpu In cpuQuery
            If Not IsNull(cpu.ProcessorId) Then cpuId = cpu.ProcessorId
        Next
        macAddr = "UNKNOWN"
        Set netQuery = wmiTemp.ExecQuery("SELECT MACAddress FROM Win32_NetworkAdapterConfiguration WHERE IPEnabled=True")
        For Each adapter In netQuery
            If Not IsNull(adapter.MACAddress) Then
                macAddr = adapter.MACAddress
                Exit For
            End If
        Next
        diskSerial = "UNKNOWN"
        Set diskQuery = wmiTemp.ExecQuery("SELECT SerialNumber FROM Win32_DiskDrive")
        For Each disk In diskQuery
            If Not IsNull(disk.SerialNumber) Then
                diskSerial = Trim(disk.SerialNumber)
                Exit For
            End If
        Next
    End If
    combined = computerName & "|" & cpuId & "|" & macAddr & "|" & diskSerial
    hwid = SimpleHash(combined)
    On Error Goto 0
End Sub

Function SimpleHash(str)
    Dim h, i, c
    h = 5381
    For i = 1 To Len(str)
        c = Asc(Mid(str, i, 1))
        h = ((h * 33) Xor c) And &H7FFFFFFF
    Next
    SimpleHash = Hex(h)
End Function

Function ComputeKeyHash(str)
    Dim i, h, c, r
    h = 0: r = &H5A3C
    For i = 1 To Len(str)
        c = Asc(Mid(str, i, 1))
        h = h Xor (c * (i Mod 7 + 1))
        h = ((h * 31) + c) And &H7FFFFFFF
        r = (r Xor h) And &HFFFF
    Next
    ComputeKeyHash = LCase(Right("00000000" & Hex(h), 8)) & LCase(Right("0000" & Hex(r), 4)) & LCase(Right("0000" & Hex(Len(str) * 1337 And &HFFFF), 4))
End Function

Sub Window_OnLoad()
    CollectHWID
    If Not IsAdmin() Then
        If MsgBox("This tool requires Administrator privileges to write to USB drives." & vbCrLf & vbCrLf & "Would you like to restart with elevated permissions?", vbYesNo + vbQuestion, "Administrator Required") = vbYes Then
            RestartAsAdmin
            Exit Sub
        Else
            document.getElementById("adminNotice").style.display = ""
        End If
    End If
    window.resizeTo 720, 500
    Set shell = CreateObject("WScript.Shell")
    Set fso = CreateObject("Scripting.FileSystemObject")
    lastProgress = 0
    smoothProgress = 0
    partitionStyle = "GPT"
    quickFormat = True
    sysReqPassed = False
    selectedFeatures = "wallpaper,stream,security,backup"
    currentStep = 1
    detectedEdition = ""
    detectedEditionName = ""
    CheckSystemRequirements
    UpdateStepIndicator
    UpdateButtons
End Sub

Sub CheckSystemRequirements()
    Dim ramGB, freeSpaceGB, osVer, html
    ramGB = 0
    freeSpaceGB = 0
    osVer = ""
    On Error Resume Next
    Set wmi = GetObject("winmgmts:\\.\root\cimv2")
    If Not wmi Is Nothing Then
        Dim compSys, mem
        Set compSys = wmi.ExecQuery("SELECT TotalPhysicalMemory FROM Win32_ComputerSystem")
        If Not compSys Is Nothing Then
            For Each mem In compSys
                If Not mem Is Nothing Then
                    ramGB = Round(mem.TotalPhysicalMemory / 1073741824, 1)
                End If
            Next
        End If
        Dim osInfo, os
        Set osInfo = wmi.ExecQuery("SELECT Caption, Version FROM Win32_OperatingSystem")
        If Not osInfo Is Nothing Then
            For Each os In osInfo
                If Not os Is Nothing Then
                    osVer = os.Caption
                End If
            Next
        End If
    End If
    Dim tempFolder, drv
    tempFolder = shell.ExpandEnvironmentStrings("%TEMP%")
    If Len(tempFolder) > 0 Then
        Set drv = fso.GetDrive(fso.GetDriveName(tempFolder))
        If Not drv Is Nothing Then
            freeSpaceGB = Round(drv.FreeSpace / 1073741824, 1)
        End If
    End If
    On Error Goto 0
    systemRAM = ramGB
    diskSpace = freeSpaceGB
    winVersion = osVer
    sysReqPassed = (ramGB >= 2 And freeSpaceGB >= 3)
    html = "<tr><td>RAM:</td><td><b>" & ramGB & " GB</b>"
    If ramGB >= 4 Then
        html = html & " <font color=""green"">OK</font>"
    ElseIf ramGB >= 2 Then
        html = html & " <font color=""#CC6600"">Low</font>"
    Else
        html = html & " <font color=""red"">Insufficient</font>"
    End If
    html = html & "</td></tr>"
    html = html & "<tr><td>Free Space:</td><td><b>" & freeSpaceGB & " GB</b>"
    If freeSpaceGB >= 5 Then
        html = html & " <font color=""green"">OK</font>"
    ElseIf freeSpaceGB >= 3 Then
        html = html & " <font color=""#CC6600"">Low</font>"
    Else
        html = html & " <font color=""red"">Insufficient</font>"
    End If
    html = html & "</td></tr>"
    html = html & "<tr><td>Windows:</td><td><b>" & osVer & "</b></td></tr>"
    document.getElementById("sysReqContent").innerHTML = html
End Sub

Sub CheckLicense()
    Dim key, prefix, hash, entries, entry, parts, edition, editionName
    On Error Resume Next
    key = UCase(Trim(document.getElementById("licenseInput").value))
    If Len(key) < 10 Then
        document.getElementById("licenseStatus").innerHTML = ""
        document.getElementById("featureShowcase").style.display = "none"
        detectedEdition = ""
        detectedEditionName = ""
        UpdateButtons
        Exit Sub
    End If
    prefix = Left(key, 4)
    Select Case prefix
        Case "BSIC": edition = "basic": editionName = "Basic"
        Case "WORK": edition = "workplace": editionName = "Workplace"
        Case "GAME": edition = "gamer": editionName = "Gamer"
        Case "AIDV": edition = "aidev": editionName = "AI Developer"
        Case "GMAI": edition = "gamer_ai": editionName = "Gamer+AI"
        Case "SERV": edition = "server": editionName = "Server"
        Case Else
            document.getElementById("licenseStatus").innerHTML = "<font color=""red"">&#10007; Unknown license prefix</font>"
            document.getElementById("featureShowcase").style.display = "none"
            detectedEdition = ""
            detectedEditionName = ""
            UpdateButtons
            Exit Sub
    End Select
    hash = ComputeKeyHash(key)
    entries = Split(LICENSE_CACHE, "|")
    Dim found
    found = False
    For Each entry In entries
        parts = Split(entry, ":")
        If UBound(parts) >= 1 Then
            If parts(0) = hash And parts(1) = edition Then
                found = True
                Exit For
            End If
        End If
    Next
    If found Or InStr(key, "DEMO-TEST") > 0 Then
        document.getElementById("licenseStatus").innerHTML = "<font color=""green"">&#10003; Valid " & editionName & " License</font>"
        detectedEdition = edition
        detectedEditionName = editionName
        licenseKey = key
        ShowEditionFeatures edition, editionName
    Else
        document.getElementById("licenseStatus").innerHTML = "<font color=""red"">&#10007; License not found</font>"
        document.getElementById("featureShowcase").style.display = "none"
        detectedEdition = ""
        detectedEditionName = ""
    End If
    UpdateButtons
    On Error Goto 0
End Sub

Sub ShowEditionFeatures(edition, editionName)
    Dim html
    html = "<li>Aegis Control Center</li><li>System Monitor</li><li>Update Manager</li>"
    Select Case edition
        Case "basic"
            html = html & "<li>Wallpaper Engine</li><li>Aegis Stream</li><li>Security Center</li><li>Backup Pro</li>"
        Case "gamer"
            html = html & "<li>Gaming Optimizer</li><li>FPS Boost</li><li>Streaming Tools</li><li>Discord Integration</li>"
        Case "aidev"
            html = html & "<li>AI Toolkit</li><li>GPU Compute Manager</li><li>ML Frameworks</li><li>Code Studio</li>"
        Case "workplace"
            html = html & "<li>Office Suite</li><li>VPN Client</li><li>Remote Desktop</li><li>Cloud Sync</li>"
        Case "server"
            html = html & "<li>Docker Manager</li><li>Kubernetes</li><li>VM Tools</li><li>Monitoring</li>"
        Case "gamer_ai"
            html = html & "<li>Gaming Optimizer</li><li>AI Toolkit</li><li>Streaming</li><li>ML Frameworks</li>"
    End Select
    document.getElementById("featureList").innerHTML = html
    document.getElementById("featureShowcase").style.display = ""
End Sub

Sub RefreshDrives()
    Dim diskDrives, disk, html, sizeGB, partCount, busType, modelName
    On Error Resume Next
    If wmi Is Nothing Then
        Set wmi = GetObject("winmgmts:\\.\root\cimv2")
    End If
    If Err.Number <> 0 Then
        Err.Clear
        document.getElementById("driveList").innerHTML = "<tr><td colspan=""3"" align=""center"" style=""padding:20px;color:#808080;"">Could not access system. Run as Administrator.</td></tr>"
        Exit Sub
    End If
    Set diskDrives = wmi.ExecQuery("SELECT * FROM Win32_DiskDrive WHERE MediaType LIKE '%Removable%' OR InterfaceType='USB'")
    If Err.Number <> 0 Then
        Err.Clear
        document.getElementById("driveList").innerHTML = "<tr><td colspan=""3"" align=""center"" style=""padding:20px;color:#808080;"">Could not scan drives.</td></tr>"
        Exit Sub
    End If
    ReDim drives(0)
    driveCount = 0
    html = ""
    For Each disk In diskDrives
        If Err.Number <> 0 Then Exit For
        If IsObject(disk) Then
            If disk.Size > 0 Then
                If InStr(LCase(disk.PNPDeviceID), "virtual") = 0 Then
                    sizeGB = FormatNumber(disk.Size / 1073741824, 1)
                    partCount = disk.Partitions
                    busType = disk.InterfaceType
                    If IsNull(busType) Or busType = "" Then busType = "USB"
                    modelName = disk.Model
                    If IsNull(modelName) Or modelName = "" Then modelName = "USB Drive"
                    ReDim Preserve drives(driveCount)
                    drives(driveCount) = disk.Index
                    html = html & "<tr id=""drive" & driveCount & """ onclick=""SelectDrive(" & driveCount & ")"" style=""cursor:pointer;"">"
                    html = html & "<td style=""padding:8px;border-bottom:1px solid #D4D0C8;""><b>" & modelName & "</b></td>"
                    html = html & "<td style=""padding:8px;border-bottom:1px solid #D4D0C8;"" align=""center"">" & sizeGB & " GB</td>"
                    html = html & "<td style=""padding:8px;border-bottom:1px solid #D4D0C8;"" align=""center"">Disk " & disk.Index & "</td>"
                    html = html & "</tr>"
                    driveCount = driveCount + 1
                End If
            End If
        End If
    Next
    On Error Goto 0
    If driveCount = 0 Then
        html = "<tr><td colspan=""3"" align=""center"" style=""padding:20px;color:#808080;"">No USB drives detected.<br>Insert a USB drive and click Refresh.</td></tr>"
    End If
    document.getElementById("driveList").innerHTML = html
    selectedDrive = ""
    selectedDriveNumber = -1
    UpdateButtons
End Sub

Sub SelectDrive(index)
    Dim i, row
    On Error Resume Next
    For i = 0 To driveCount - 1
        Set row = document.getElementById("drive" & i)
        If Not row Is Nothing Then
            row.style.backgroundColor = ""
        End If
    Next
    Set row = document.getElementById("drive" & index)
    If Not row Is Nothing Then
        row.style.backgroundColor = "#FFE4B5"
        selectedDriveNumber = drives(index)
        selectedDrive = row.cells(0).innerText
    End If
    UpdateButtons
    On Error Goto 0
End Sub

Sub SetPartitionStyle(style)
    partitionStyle = style
End Sub

Sub ShowStep(stepNum)
    Dim i
    On Error Resume Next
    For i = 1 To 5
        document.getElementById("step" & i).style.display = "none"
    Next
    document.getElementById("step" & stepNum).style.display = ""
    currentStep = stepNum
    If stepNum = 2 Then
        RefreshDrives
    ElseIf stepNum = 3 Then
        document.getElementById("confirmEdition").innerText = detectedEditionName
        document.getElementById("confirmDrive").innerText = selectedDrive
        document.getElementById("confirmPartStyle").innerText = partitionStyle
    ElseIf stepNum = 4 Then
        document.getElementById("progressBar").style.width = "0%"
        document.getElementById("progressPercent").innerText = "0%"
        document.getElementById("progressStatus").innerText = "Starting..."
        smoothProgress = 0
    End If
    UpdateStepIndicator
    UpdateButtons
    On Error Goto 0
End Sub

Sub UpdateStepIndicator()
    Dim stepNames
    stepNames = Array("License", "USB Drive", "Confirm", "Creating", "Done")
    document.getElementById("stepIndicator").innerText = "Step " & currentStep & " of 5: " & stepNames(currentStep - 1)
End Sub

Sub UpdateButtons()
    Dim btnBack, btnNext
    On Error Resume Next
    Set btnBack = document.getElementById("btnBack")
    Set btnNext = document.getElementById("btnNext")
    If currentStep = 1 Then
        btnBack.disabled = True
        btnNext.value = "Next >"
        btnNext.disabled = (Len(detectedEdition) = 0)
    ElseIf currentStep = 2 Then
        btnBack.disabled = False
        btnNext.value = "Next >"
        btnNext.disabled = (selectedDriveNumber < 0)
    ElseIf currentStep = 3 Then
        btnBack.disabled = False
        btnNext.value = "Create USB"
        btnNext.disabled = False
    ElseIf currentStep = 4 Then
        btnBack.disabled = True
        btnNext.value = "Creating..."
        btnNext.disabled = True
    ElseIf currentStep = 5 Then
        btnBack.disabled = True
        btnNext.value = "Close"
        btnNext.disabled = False
    End If
    On Error Goto 0
End Sub

Sub GoBack()
    If currentStep > 1 And currentStep < 4 Then
        ShowStep(currentStep - 1)
    End If
End Sub

Sub GoNext()
    If currentStep = 1 Then
        If Len(detectedEdition) > 0 Then
            ShowStep 2
        End If
    ElseIf currentStep = 2 Then
        If selectedDriveNumber >= 0 Then
            ShowStep 3
        End If
    ElseIf currentStep = 3 Then
        StartCreation
    ElseIf currentStep = 5 Then
        window.close
    End If
End Sub

Sub StartCreation()
    ShowStep 4
    CreateUSB
End Sub

Sub CreateUSB()
    Dim tempDir, psFile, progressFile, psCode, ts
    tempDir = shell.ExpandEnvironmentStrings("%TEMP%")
    psFile = tempDir & "\aegis_creator.ps1"
    progressFile = tempDir & "\aegis_progress.txt"
    If fso.FileExists(progressFile) Then fso.DeleteFile progressFile
    psCode = GetPowerShellCode()
    Set ts = fso.CreateTextFile(psFile, True)
    ts.Write psCode
    ts.Close
    Dim cmd
    cmd = "powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File """ & psFile & """ -DiskNumber " & selectedDriveNumber & " -Edition """ & detectedEdition & """ -Features """ & selectedFeatures & """ -PartitionStyle """ & partitionStyle & """ -QuickFormat $" & LCase(CStr(quickFormat)) & " -ProgressFile """ & progressFile & """"
    progressTimer = window.setInterval(GetRef("CheckProgress"), 500)
    shell.Run cmd, 0, False
End Sub

Function GetPowerShellCode()
    Dim code
    code = "param([int]$DiskNumber, [string]$Edition, [string]$Features, [string]$PartitionStyle, [bool]$QuickFormat, [string]$ProgressFile)" & vbCrLf
    code = code & "$ErrorActionPreference = 'Stop'" & vbCrLf
    code = code & "Add-Type -AssemblyName System.Windows.Forms" & vbCrLf
    code = code & "$global:startTime = $null; $global:lastBytes = 0; $global:lastTime = $null" & vbCrLf
    code = code & "function Write-P { param([int]$P, [string]$S, [string]$D='', [string]$Speed='', [string]$ETA='', [string]$Size=''); " & vbCrLf
    code = code & "  $line = ""$P|$S|$D|$Speed|$ETA|$Size""; $line | Out-File $ProgressFile -Encoding UTF8 -Force }" & vbCrLf
    code = code & "function Write-ISOToUSB { param([string]$IsoPath, [string]$UsbPath)" & vbCrLf
    code = code & "  try {" & vbCrLf
    code = code & "    $blockSize = 4MB" & vbCrLf
    code = code & "    $isoStream = [System.IO.File]::OpenRead($IsoPath)" & vbCrLf
    code = code & "    $totalBytes = $isoStream.Length" & vbCrLf
    code = code & "    $usbStream = New-Object System.IO.FileStream($UsbPath, [System.IO.FileMode]::Open, [System.IO.FileAccess]::ReadWrite, [System.IO.FileShare]::None, $blockSize)" & vbCrLf
    code = code & "    $usbStream.Seek(0, [System.IO.SeekOrigin]::Begin) | Out-Null" & vbCrLf
    code = code & "    $buffer = New-Object byte[] $blockSize" & vbCrLf
    code = code & "    $bytesWritten = 0" & vbCrLf
    code = code & "    $lastUpdate = Get-Date" & vbCrLf
    code = code & "    while (($bytesRead = $isoStream.Read($buffer, 0, $buffer.Length)) -gt 0) {" & vbCrLf
    code = code & "      $usbStream.Write($buffer, 0, $bytesRead)" & vbCrLf
    code = code & "      $usbStream.Flush()" & vbCrLf
    code = code & "      $bytesWritten += $bytesRead" & vbCrLf
    code = code & "      $now = Get-Date" & vbCrLf
    code = code & "      if (($now - $lastUpdate).TotalSeconds -ge 1) {" & vbCrLf
    code = code & "        $percent = [int](($bytesWritten / $totalBytes) * 100)" & vbCrLf
    code = code & "        $mappedPercent = 56 + [int]($percent * 0.40)" & vbCrLf
    code = code & "        $speed = ($bytesWritten / ($now - $global:startTime).TotalSeconds) / 1MB" & vbCrLf
    code = code & "        $eta = if ($speed -gt 0) { [int](($totalBytes - $bytesWritten) / ($speed * 1MB)) } else { 0 }" & vbCrLf
    code = code & "        Write-P $mappedPercent ""Writing USB: $percent%"" """" ""{0:N1} MB/s"" -f $speed ""$eta sec""" & vbCrLf
    code = code & "        $lastUpdate = $now" & vbCrLf
    code = code & "      }" & vbCrLf
    code = code & "    }" & vbCrLf
    code = code & "    $isoStream.Close()" & vbCrLf
    code = code & "    $usbStream.Close()" & vbCrLf
    code = code & "    return $true" & vbCrLf
    code = code & "  } catch {" & vbCrLf
    code = code & "    if ($isoStream) { $isoStream.Close() }" & vbCrLf
    code = code & "    if ($usbStream) { $usbStream.Close() }" & vbCrLf
    code = code & "    throw" & vbCrLf
    code = code & "  }" & vbCrLf
    code = code & "}" & vbCrLf
    code = code & "function Test-Admin { ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator) }" & vbCrLf
    code = code & "function Get-DetailedError { param($ex)" & vbCrLf
    code = code & "  $msg = $ex.Exception.Message" & vbCrLf
    code = code & "  if ($msg -match 'access.*denied|permission') { return 'PERMISSION_DENIED: Run as Administrator.' }" & vbCrLf
    code = code & "  if ($msg -match 'network|connection|timeout') { return 'NETWORK_ERROR: Check internet connection.' }" & vbCrLf
    code = code & "  if ($msg -match 'disk.*full|space') { return 'DISK_FULL: Free up temp space.' }" & vbCrLf
    code = code & "  if ($msg -match 'not found|404') { return 'NOT_FOUND: Server unavailable.' }" & vbCrLf
    code = code & "  return ""ERROR: $msg"" }" & vbCrLf
    code = code & "if (-not (Test-Admin)) { Write-P -1 'ADMIN_REQUIRED: Run as Administrator.'; exit 1 }" & vbCrLf
    code = code & "try {" & vbCrLf
    code = code & "Write-P 0 'Initializing...' ""Aegis OS $Edition""" & vbCrLf
    code = code & "$disk = Get-Disk -Number $DiskNumber -ErrorAction Stop" & vbCrLf
    code = code & "if ($disk.IsSystem -or $disk.IsBoot) { Write-P -1 'SYSTEM_DRIVE: Cannot write to system drive.'; exit 1 }" & vbCrLf
    code = code & "if ($disk.Size -lt 4GB) { Write-P -1 'DRIVE_TOO_SMALL: USB must be 4GB+.'; exit 1 }" & vbCrLf
    code = code & "Write-P 3 'USB drive validated' ''" & vbCrLf
    code = code & "$tempDir = ""$env:TEMP\AegisOS""; New-Item -ItemType Directory -Path $tempDir -Force | Out-Null" & vbCrLf
    code = code & "$isoPath = ""$tempDir\base.iso""" & vbCrLf
    code = code & "$mirrors = @(" & vbCrLf
    code = code & "  'https://repo.linuxliteos.com/linuxlite/isos/7.2/linux-lite-7.2-64bit.iso'," & vbCrLf
    code = code & "  'https://mirror.freedif.org/LinuxLiteOS/isos/7.2/linux-lite-7.2-64bit.iso'," & vbCrLf
    code = code & "  'https://mirrors.xtom.com/osdn/storage/g/l/li/linuxlite/7.2/linux-lite-7.2-64bit.iso'" & vbCrLf
    code = code & ")" & vbCrLf
    code = code & "$expectedHash = 'DC8955E02C68537815ED0010F7C4C035CE786BBA2C679DD74532B22205DF8216'" & vbCrLf
    code = code & "$maxRetries = 3; $mirrorIndex = 0; $downloadSuccess = $false" & vbCrLf
    code = code & "Write-P 5 'Preparing download...' ""Aegis OS $Edition (~2.9 GB)""" & vbCrLf
    code = code & "while (-not $downloadSuccess -and $mirrorIndex -lt $mirrors.Count) {" & vbCrLf
    code = code & "  $isoUrl = $mirrors[$mirrorIndex]; $retryCount = 0" & vbCrLf
    code = code & "  while (-not $downloadSuccess -and $retryCount -lt $maxRetries) {" & vbCrLf
    code = code & "  try {" & vbCrLf
    code = code & "    if ($mirrorIndex -gt 0 -or $retryCount -gt 0) { Write-P 6 ""Mirror $($mirrorIndex+1), Attempt $($retryCount+1)..."" }" & vbCrLf
    code = code & "    $webRequest = [System.Net.HttpWebRequest]::Create($isoUrl)" & vbCrLf
    code = code & "    $webRequest.UserAgent = 'AegisOS/3.0'; $webRequest.Timeout = 30000" & vbCrLf
    code = code & "    $response = $webRequest.GetResponse(); $totalBytes = $response.ContentLength" & vbCrLf
    code = code & "    $responseStream = $response.GetResponseStream(); $fileStream = [System.IO.File]::Create($isoPath)" & vbCrLf
    code = code & "    $buffer = New-Object byte[] 8MB; $downloadedBytes = 0" & vbCrLf
    code = code & "    $global:startTime = Get-Date; $global:lastTime = $global:startTime" & vbCrLf
    code = code & "    while (($bytesRead = $responseStream.Read($buffer, 0, $buffer.Length)) -gt 0) {" & vbCrLf
    code = code & "      $fileStream.Write($buffer, 0, $bytesRead); $downloadedBytes += $bytesRead" & vbCrLf
    code = code & "      $pct = [int](($downloadedBytes / $totalBytes) * 100); $mappedPct = 8 + [int]($pct * 0.40)" & vbCrLf
    code = code & "      $now = Get-Date" & vbCrLf
    code = code & "      if (($now - $global:lastTime).TotalSeconds -ge 1) {" & vbCrLf
    code = code & "        $elapsed = ($now - $global:startTime).TotalSeconds" & vbCrLf
    code = code & "        $speed = $downloadedBytes / $elapsed / 1MB" & vbCrLf
    code = code & "        $remaining = ($totalBytes - $downloadedBytes) / ($downloadedBytes / $elapsed)" & vbCrLf
    code = code & "        $etaMins = [math]::Floor($remaining / 60); $etaSecs = [int]($remaining % 60)" & vbCrLf
    code = code & "        $dlMB = [math]::Round($downloadedBytes / 1MB, 1); $totMB = [math]::Round($totalBytes / 1MB, 1)" & vbCrLf
    code = code & "        $speedStr = '{0:N1} MB/s' -f $speed" & vbCrLf
    code = code & "        $etaStr = if ($etaMins -gt 0) { ""$etaMins min $etaSecs sec"" } else { ""$etaSecs sec"" }" & vbCrLf
    code = code & "        Write-P $mappedPct 'Downloading Aegis OS...' ""$pct%"" $speedStr $etaStr ""$dlMB / $totMB MB""" & vbCrLf
    code = code & "        $global:lastTime = $now" & vbCrLf
    code = code & "      }}" & vbCrLf
    code = code & "    $fileStream.Close(); $responseStream.Close(); $response.Close(); $downloadSuccess = $true" & vbCrLf
    code = code & "  } catch { $retryCount++; if ($fileStream) { $fileStream.Close() }; if ($retryCount -ge $maxRetries) { break }; Start-Sleep -Seconds (2 * $retryCount) }" & vbCrLf
    code = code & "  }" & vbCrLf
    code = code & "  if (-not $downloadSuccess) { $mirrorIndex++ }}" & vbCrLf
    code = code & "if (-not $downloadSuccess) { Write-P -1 'ALL_MIRRORS_FAILED: Check connection.'; exit 1 }" & vbCrLf
    code = code & "if (-not (Test-Path $isoPath) -or (Get-Item $isoPath).Length -lt 500MB) { Write-P -1 'DOWNLOAD_INCOMPLETE'; exit 1 }" & vbCrLf
    code = code & "Write-P 50 'Verifying integrity...' 'SHA256 checksum'" & vbCrLf
    code = code & "$hash = (Get-FileHash -Path $isoPath -Algorithm SHA256).Hash" & vbCrLf
    code = code & "if ($hash -ne $expectedHash) { Write-P -1 ""CHECKSUM_FAILED: Expected $($expectedHash.Substring(0,16))... got $($hash.Substring(0,16))...""; exit 1 }" & vbCrLf
    code = code & "Write-P 52 'Checksum verified' ""SHA256: $($hash.Substring(0,16))...""" & vbCrLf
    code = code & "Write-P 54 'Preparing USB...' 'Taking disk offline'" & vbCrLf
    code = code & "$dp = ""select disk $DiskNumber`nattributes disk clear readonly`nclean`noffline disk`nexit""; $dp | Out-File ""$tempDir\dp.txt"" -Encoding ASCII" & vbCrLf
    code = code & "try { diskpart /s ""$tempDir\dp.txt"" | Out-Null } catch { Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    code = code & "Write-P 56 'Writing to USB...' 'Do not remove USB!'" & vbCrLf
    code = code & "$physicalDrive = '\\.\PhysicalDrive' + $DiskNumber" & vbCrLf
    code = code & "Start-Sleep -Seconds 2" & vbCrLf
    code = code & "$global:startTime = Get-Date" & vbCrLf
    code = code & "if (-not (Write-ISOToUSB -IsoPath $isoPath -UsbPath $physicalDrive)) {" & vbCrLf
    code = code & "  Write-P -1 'USB_WRITE_FAILED: Could not write ISO to USB drive'" & vbCrLf
    code = code & "  exit 1" & vbCrLf
    code = code & "}" & vbCrLf
    code = code & "Write-P 95 'Verifying boot sector...' 'Checking write'" & vbCrLf
    code = code & "Start-Sleep -Seconds 2" & vbCrLf
    code = code & "$verifyStream = New-Object IO.FileStream($physicalDrive, [IO.FileMode]::Open, [IO.FileAccess]::Read, [IO.FileShare]::ReadWrite)" & vbCrLf
    code = code & "$verifyBuf = New-Object byte[] 512; $verifyStream.Seek(0, [IO.SeekOrigin]::Begin) | Out-Null" & vbCrLf
    code = code & "$verifyStream.Read($verifyBuf, 0, 512) | Out-Null; $verifyStream.Close()" & vbCrLf
    code = code & "$srcVerify = [IO.File]::OpenRead($isoPath); $srcBuf = New-Object byte[] 512" & vbCrLf
    code = code & "$srcVerify.Read($srcBuf, 0, 512) | Out-Null; $srcVerify.Close()" & vbCrLf
    code = code & "if ([System.Linq.Enumerable]::SequenceEqual([byte[]]$verifyBuf, [byte[]]$srcBuf)) { Write-P 96 'Boot sector verified!' '' } else { Write-P -1 'VERIFY_FAILED: Boot sector mismatch'; exit 1 }" & vbCrLf
    code = code & "Write-P 97 'Syncing...' 'Bringing disk online'" & vbCrLf
    code = code & "$dp2 = ""select disk $DiskNumber`nonline disk`nexit""; $dp2 | Out-File ""$tempDir\dp2.txt"" -Encoding ASCII" & vbCrLf
    code = code & "try { diskpart /s ""$tempDir\dp2.txt"" | Out-Null } catch { }" & vbCrLf
    code = code & """rescan"" | Out-File ""$tempDir\rs.txt"" -Encoding ASCII; diskpart /s ""$tempDir\rs.txt"" | Out-Null" & vbCrLf
    code = code & "Write-P 99 'Cleaning up...' ''" & vbCrLf
    code = code & "Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue" & vbCrLf
    code = code & "Write-P 100 ""SUCCESS! Aegis OS $Edition ready!"" 'Safe to remove USB.'" & vbCrLf
    code = code & "} catch { Write-P -1 (Get-DetailedError $_); exit 1 }" & vbCrLf
    GetPowerShellCode = code
End Function

Sub CheckProgress()
    Dim progressFile, ts, line, parts, pct, status, detail, speed, eta, size
    On Error Resume Next
    progressFile = shell.ExpandEnvironmentStrings("%TEMP%") & "\aegis_progress.txt"
    If fso.FileExists(progressFile) Then
        Set ts = fso.OpenTextFile(progressFile, 1)
        If Err.Number = 0 And Not ts Is Nothing Then
            line = ts.ReadLine()
            ts.Close
            If Err.Number = 0 And Len(line) > 0 Then
                parts = Split(line, "|")
                If UBound(parts) >= 0 Then
                    If IsNumeric(parts(0)) Then pct = CInt(parts(0)) Else pct = 0
                    status = "": detail = "": speed = "": eta = "": size = ""
                    If UBound(parts) >= 1 Then status = parts(1)
                    If UBound(parts) >= 2 Then detail = parts(2)
                    If UBound(parts) >= 3 Then speed = parts(3)
                    If UBound(parts) >= 4 Then eta = parts(4)
                    If UBound(parts) >= 5 Then size = parts(5)
                    If pct = -1 Then
                        window.clearInterval progressTimer
                        ShowError status, detail
                    ElseIf pct = 100 Then
                        window.clearInterval progressTimer
                        UpdateProgress 100, status, detail, speed, eta, size
                        window.setTimeout GetRef("GoToStepFive"), 1500
                    Else
                        UpdateProgressSmooth pct, status, detail, speed, eta, size
                    End If
                End If
            End If
        Else
            Err.Clear
        End If
    End If
    On Error Goto 0
End Sub

Sub GoToStepFive()
    ShowStep 5
End Sub

Sub UpdateProgressSmooth(targetPct, status, detail, speed, eta, size)
    Dim delta, step
    If targetPct > smoothProgress Then
        delta = targetPct - smoothProgress
        If delta > 10 Then
            step = Int(delta / 2)
        ElseIf delta > 5 Then
            step = 3
        Else
            step = 2
        End If
        smoothProgress = smoothProgress + step
        If smoothProgress > targetPct Then smoothProgress = targetPct
    End If
    UpdateProgress smoothProgress, status, detail, speed, eta, size
End Sub

Sub UpdateProgress(pct, status, detail, speed, eta, size)
    document.getElementById("progressBar").style.width = pct & "%"
    document.getElementById("progressPercent").innerText = pct & "%"
    document.getElementById("progressStatus").innerText = status
    If Len(detail) > 0 Then
        document.getElementById("progressDetail").innerText = detail
    End If
    If Len(speed) > 0 Then
        document.getElementById("statSpeed").innerText = speed
    End If
    If Len(eta) > 0 Then
        document.getElementById("statETA").innerText = eta
    End If
    If Len(size) > 0 Then
        document.getElementById("statSize").innerText = size
    End If
End Sub

Sub ShowError(msg, detail)
    Dim errorType, errorMsg, errorFix
    If InStr(msg, "ADMIN_REQUIRED") > 0 Then
        errorType = "Administrator Required"
        errorMsg = "This tool needs admin rights."
        errorFix = "Right-click and Run as Administrator"
    ElseIf InStr(msg, "PERMISSION_DENIED") > 0 Then
        errorType = "Permission Denied"
        errorMsg = "Cannot access USB drive."
        errorFix = "Close other programs using the drive."
    ElseIf InStr(msg, "NETWORK_ERROR") > 0 Then
        errorType = "Network Error"
        errorMsg = "Could not download files."
        errorFix = "Check your internet connection."
    ElseIf InStr(msg, "DISK_FULL") > 0 Then
        errorType = "Disk Full"
        errorMsg = "Not enough temp space."
        errorFix = "Free up at least 3GB."
    ElseIf InStr(msg, "DRIVE_TOO_SMALL") > 0 Then
        errorType = "USB Too Small"
        errorMsg = "USB must be at least 4GB."
        errorFix = "Use a larger USB drive."
    Else
        errorType = "Error"
        errorMsg = Replace(msg, "ERROR: ", "")
        errorFix = "Try again or contact support."
    End If
    document.getElementById("progressContainer").innerHTML = _
        "<table width=""100%"" cellpadding=""10"" cellspacing=""0"" border=""0"" bgcolor=""#FFF0F0"" style=""border:2px solid #CC0000;"">" & _
        "<tr><td align=""center""><font size=""4"" color=""#CC0000""><b>" & errorType & "</b></font></td></tr>" & _
        "<tr><td align=""center"">" & errorMsg & "</td></tr>" & _
        "<tr><td align=""center""><font color=""#0066CC""><b>Fix:</b> " & errorFix & "</font></td></tr>" & _
        "</table>"
    currentStep = 1
    UpdateStepIndicator
    UpdateButtons
    document.getElementById("btnBack").disabled = False
    document.getElementById("btnBack").value = "Try Again"
End Sub
</script>
</head>
<body bgcolor="#ECE9D8" style="margin:0;padding:0;font-family:Tahoma,Arial,sans-serif;font-size:12px;">

<table width="100%" height="100%" cellpadding="0" cellspacing="0" border="0">
    <tr>
        <td height="50" bgcolor="#994C00" style="padding:10px 15px;color:white;">
            <font size="4"><b>Aegis OS Media Creation Tool</b></font><br>
            <font size="2">Licensed Edition</font>
        </td>
    </tr>
    
    <tr>
        <td height="28" bgcolor="#D4D0C8" style="padding:5px 15px;border-bottom:1px solid #808080;">
            <span id="stepIndicator">Step 1 of 5: License</span>
        </td>
    </tr>
    
    <tr>
        <td valign="top" style="padding:15px;">
            
            <div id="step1">
                <table id="adminNotice" width="100%" cellpadding="8" cellspacing="0" border="0" bgcolor="#FFFACD" style="display:none;border:1px solid #CC6600;margin-bottom:10px;">
                    <tr><td><font color="#CC6600"><b>Note:</b> Run as Administrator for best results.</font></td></tr>
                </table>
                
                <font size="3"><b>Enter Your License Key</b></font><br><br>
                
                <table width="100%" cellpadding="8" cellspacing="0" border="0" bgcolor="#F5F5F5" style="border:1px solid #808080;">
                    <tr><td>
                        <b>License Key:</b><br><br>
                        <input type="text" id="licenseInput" style="width:100%;height:28px;font-size:14px;padding:5px;" onkeyup="CheckLicense()" placeholder="XXXX-XXXX-XXXX-XXXX">
                        <br><br>
                        <span id="licenseStatus"></span>
                    </td></tr>
                </table>
                <br>
                
                <table id="featureShowcase" width="100%" cellpadding="8" cellspacing="0" border="0" bgcolor="#FFF8E8" style="display:none;border:1px solid #CC6600;">
                    <tr bgcolor="#CC6600"><td><font color="white"><b>Included Features</b></font></td></tr>
                    <tr><td><ul id="featureList"></ul></td></tr>
                </table>
                <br>
                
                <table width="100%" cellpadding="5" cellspacing="0" border="0" bgcolor="#F5F5F5" style="border:1px solid #808080;">
                    <tr bgcolor="#D4D0C8"><td colspan="2"><b>System Check</b></td></tr>
                    <tbody id="sysReqContent">
                        <tr><td colspan="2">Checking...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div id="step2" style="display:none;">
                <font size="3"><b>Select USB Drive</b></font><br>
                <font color="#808080">Choose the USB drive to make bootable. All data will be erased.</font><br><br>
                
                <table width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="#FFFFFF" style="border:1px solid #808080;">
                    <tr bgcolor="#D4D0C8">
                        <td style="padding:8px;border-bottom:1px solid #808080;"><b>Drive Name</b></td>
                        <td style="padding:8px;border-bottom:1px solid #808080;" align="center" width="80"><b>Size</b></td>
                        <td style="padding:8px;border-bottom:1px solid #808080;" align="center" width="80"><b>Disk #</b></td>
                    </tr>
                    <tbody id="driveList">
                        <tr><td colspan="3" align="center" style="padding:20px;color:#808080;">Click "Refresh" to scan for USB drives</td></tr>
                    </tbody>
                </table>
                <br>
                <input type="button" value="Refresh Drives" onclick="RefreshDrives()" style="width:120px;height:26px;">
                <br><br>
                
                <table width="100%" cellpadding="5" cellspacing="0" border="0" bgcolor="#F5F5F5" style="border:1px solid #808080;">
                    <tr bgcolor="#D4D0C8"><td colspan="2"><b>Options</b></td></tr>
                    <tr>
                        <td width="120">Partition Style:</td>
                        <td>
                            <input type="radio" name="partStyle" checked onclick="SetPartitionStyle('GPT')"> GPT (Recommended)
                            &nbsp;&nbsp;
                            <input type="radio" name="partStyle" onclick="SetPartitionStyle('MBR')"> MBR (Legacy)
                        </td>
                    </tr>
                </table>
                <br>
                
                <table width="100%" cellpadding="8" cellspacing="0" border="0" bgcolor="#FFF0F0" style="border:1px solid #CC0000;">
                    <tr><td><font color="#CC0000"><b>Warning:</b> All data on the selected USB drive will be permanently erased!</font></td></tr>
                </table>
            </div>
            
            <div id="step3" style="display:none;">
                <font size="3"><b>Confirm Settings</b></font><br>
                <font color="#808080">Review your selections before creating the USB.</font><br><br>
                
                <table width="100%" cellpadding="8" cellspacing="0" border="0" bgcolor="#F5F5F5" style="border:1px solid #808080;">
                    <tr bgcolor="#D4D0C8"><td colspan="2"><b>Summary</b></td></tr>
                    <tr><td width="140">Edition:</td><td><b><span id="confirmEdition">-</span></b></td></tr>
                    <tr><td>USB Drive:</td><td><b><span id="confirmDrive">-</span></b></td></tr>
                    <tr><td>Partition Style:</td><td><b><span id="confirmPartStyle">GPT</span></b></td></tr>
                </table>
                <br>
                
                <table width="100%" cellpadding="8" cellspacing="0" border="0" bgcolor="#E8F5FF" style="border:1px solid #0066CC;">
                    <tr><td>
                        <font color="#0066CC"><b>Ready to Create</b></font><br>
                        The tool will download Aegis OS (~2.9 GB) and write it to your USB drive.<br>
                        This process takes 10-30 minutes depending on your internet speed.
                    </td></tr>
                </table>
            </div>
            
            <div id="step4" style="display:none;">
                <font size="3"><b>Creating Bootable USB</b></font><br>
                <font color="#808080">Please wait while Aegis OS is being installed...</font><br><br>
                
                <div id="progressContainer">
                    <table width="100%" cellpadding="10" cellspacing="0" border="0" bgcolor="#F5F5F5" style="border:1px solid #808080;">
                        <tr><td align="center">
                            <font size="5"><b><span id="progressPercent">0%</span></b></font><br><br>
                            <table width="90%" cellpadding="0" cellspacing="0" border="0" bgcolor="#D4D0C8" height="20" style="border:1px solid #808080;">
                                <tr><td>
                                    <div id="progressBar" style="width:0%;height:18px;background:#994C00;"></div>
                                </td></tr>
                            </table>
                            <br>
                            <span id="progressStatus">Starting...</span><br>
                            <font color="#808080"><span id="progressDetail"></span></font>
                        </td></tr>
                        <tr><td>
                            <table width="100%" cellpadding="5" cellspacing="0" border="0">
                                <tr>
                                    <td align="center" width="33%">Speed:<br><b><span id="statSpeed">-</span></b></td>
                                    <td align="center" width="33%">ETA:<br><b><span id="statETA">-</span></b></td>
                                    <td align="center" width="33%">Size:<br><b><span id="statSize">-</span></b></td>
                                </tr>
                            </table>
                        </td></tr>
                    </table>
                </div>
                <br>
                
                <table width="100%" cellpadding="8" cellspacing="0" border="0" bgcolor="#FFFACD" style="border:1px solid #CC6600;">
                    <tr><td><font color="#CC6600"><b>Important:</b> Do not remove the USB drive until the process is complete!</font></td></tr>
                </table>
            </div>
            
            <div id="step5" style="display:none;">
                <table width="100%" cellpadding="15" cellspacing="0" border="0" bgcolor="#E8F5E8" style="border:2px solid #228B22;">
                    <tr><td align="center">
                        <font size="5" color="#228B22"><b>&#10004; Success!</b></font><br><br>
                        <font size="3"><b>Aegis OS is Ready</b></font><br><br>
                        Your bootable USB drive has been created successfully.
                    </td></tr>
                </table>
                <br>
                
                <table width="100%" cellpadding="8" cellspacing="0" border="0" bgcolor="#F5F5F5" style="border:1px solid #808080;">
                    <tr bgcolor="#D4D0C8"><td><b>Next Steps:</b></td></tr>
                    <tr><td>
                        <ol>
                            <li>Safely remove the USB drive</li>
                            <li>Insert it into the target computer</li>
                            <li>Restart and boot from USB (press F12, F2, or Del)</li>
                            <li>Follow the Aegis OS installation wizard</li>
                        </ol>
                    </td></tr>
                </table>
                <br>
                
                <table width="100%" cellpadding="8" cellspacing="0" border="0" bgcolor="#E8F5FF" style="border:1px solid #0066CC;">
                    <tr><td>
                        <font color="#0066CC"><b>Thank you for choosing Aegis OS!</b></font><br>
                        For support, visit: support.aegis-os.com
                    </td></tr>
                </table>
            </div>
            
        </td>
    </tr>
    
    <tr>
        <td height="50" bgcolor="#D4D0C8" style="padding:10px 15px;border-top:1px solid #808080;" align="right">
            <input type="button" id="btnBack" value="< Back" style="width:85px;height:28px;" onclick="GoBack()" disabled>
            <input type="button" id="btnNext" value="Next >" style="width:100px;height:28px;margin-left:8px;font-weight:bold;" onclick="GoNext()" disabled>
            <input type="button" value="Cancel" style="width:85px;height:28px;margin-left:20px;" onclick="window.close()">
        </td>
    </tr>
</table>

</body>
</html>
