#!/usr/bin/env python3
"""
Aegis Welcome - First-run welcome wizard for Freemium edition
Introduces users to Aegis OS and offers trial/upgrade options.
"""

import os
import sys
import json
import subprocess
from pathlib import Path

try:
    import gi
    gi.require_version('Gtk', '3.0')
    from gi.repository import Gtk, Gdk, GLib, GdkPixbuf
    GTK_AVAILABLE = True
except ImportError:
    GTK_AVAILABLE = False

FIRST_RUN_FLAG = Path.home() / ".config/aegis/.welcome_shown"

class WelcomeWindow(Gtk.Window):
    def __init__(self):
        super().__init__(title="Welcome to Aegis OS")
        self.set_default_size(600, 450)
        self.set_position(Gtk.WindowPosition.CENTER)
        self.set_resizable(False)
        
        self.page = 0
        self.pages = [
            self.create_welcome_page,
            self.create_features_page,
            self.create_trial_page,
            self.create_finish_page
        ]
        
        main_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        self.add(main_box)
        
        self.content = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=20)
        self.content.set_margin_top(40)
        self.content.set_margin_bottom(20)
        self.content.set_margin_start(50)
        self.content.set_margin_end(50)
        main_box.pack_start(self.content, True, True, 0)
        
        nav_box = Gtk.Box(spacing=10)
        nav_box.set_margin_bottom(20)
        nav_box.set_margin_start(50)
        nav_box.set_margin_end(50)
        
        self.back_btn = Gtk.Button(label="Back")
        self.back_btn.connect("clicked", self.on_back)
        self.back_btn.set_sensitive(False)
        nav_box.pack_start(self.back_btn, False, False, 0)
        
        self.dots = Gtk.Box(spacing=5)
        for i in range(len(self.pages)):
            dot = Gtk.Label(label="●" if i == 0 else "○")
            self.dots.pack_start(dot, False, False, 0)
        nav_box.pack_start(self.dots, True, True, 0)
        
        self.next_btn = Gtk.Button(label="Next")
        self.next_btn.connect("clicked", self.on_next)
        nav_box.pack_end(self.next_btn, False, False, 0)
        
        main_box.pack_start(nav_box, False, False, 0)
        
        self.show_page(0)
    
    def clear_content(self):
        for child in self.content.get_children():
            self.content.remove(child)
    
    def show_page(self, index):
        self.clear_content()
        self.page = index
        self.pages[index]()
        
        for i, child in enumerate(self.dots.get_children()):
            child.set_text("●" if i == index else "○")
        
        self.back_btn.set_sensitive(index > 0)
        self.next_btn.set_label("Finish" if index == len(self.pages) - 1 else "Next")
        self.content.show_all()
    
    def create_welcome_page(self):
        title = Gtk.Label()
        title.set_markup("<span size='xx-large' weight='bold'>Welcome to Aegis OS</span>")
        self.content.pack_start(title, False, False, 0)
        
        subtitle = Gtk.Label()
        subtitle.set_markup("<span size='large'>The Windows-Compatible Linux Experience</span>")
        subtitle.set_margin_top(10)
        self.content.pack_start(subtitle, False, False, 0)
        
        desc = Gtk.Label(label="Thank you for choosing Aegis OS!\n\nAegis OS brings you a familiar Windows-style desktop\nwith the power and security of Linux.")
        desc.set_justify(Gtk.Justification.CENTER)
        desc.set_margin_top(30)
        self.content.pack_start(desc, False, False, 0)
        
        version = Gtk.Label()
        version.set_markup("<span color='gray'>Freemium Edition v2.0.0</span>")
        version.set_margin_top(40)
        self.content.pack_start(version, False, False, 0)
    
    def create_features_page(self):
        title = Gtk.Label()
        title.set_markup("<span size='x-large' weight='bold'>What's Included</span>")
        self.content.pack_start(title, False, False, 0)
        
        features = [
            ("Windows 10-Style Desktop", "Familiar interface with XFCE"),
            ("Firefox Browser", "Fast and secure web browsing"),
            ("File Manager", "Easy file management with Thunar"),
            ("Terminal", "Powerful command-line access"),
            ("Software Center", "Install apps with one click"),
            ("30-Day Premium Trial", "Try all features free!")
        ]
        
        grid = Gtk.Grid()
        grid.set_row_spacing(10)
        grid.set_column_spacing(20)
        grid.set_margin_top(20)
        
        for i, (name, desc) in enumerate(features):
            check = Gtk.Label(label="✓")
            check.set_markup("<span color='#0078D7'>✓</span>")
            grid.attach(check, 0, i, 1, 1)
            
            name_lbl = Gtk.Label(label=name)
            name_lbl.set_xalign(0)
            name_lbl.set_markup(f"<b>{name}</b>")
            grid.attach(name_lbl, 1, i, 1, 1)
            
            desc_lbl = Gtk.Label(label=desc)
            desc_lbl.set_xalign(0)
            desc_lbl.set_markup(f"<span color='gray'>{desc}</span>")
            grid.attach(desc_lbl, 2, i, 1, 1)
        
        self.content.pack_start(grid, False, False, 0)
    
    def create_trial_page(self):
        title = Gtk.Label()
        title.set_markup("<span size='x-large' weight='bold'>Try Premium Free</span>")
        self.content.pack_start(title, False, False, 0)
        
        desc = Gtk.Label(label="Unlock all premium features for 30 days!\nNo credit card required.")
        desc.set_justify(Gtk.Justification.CENTER)
        desc.set_margin_top(15)
        self.content.pack_start(desc, False, False, 0)
        
        features_box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=8)
        features_box.set_margin_top(20)
        
        trial_features = [
            "Security Suite - Firewall, Antivirus, Encryption",
            "Backup Suite - Scheduled backups & recovery",
            "Media Suite - VLC, Handbrake, Screen Recorder",
            "100+ Premium Themes & Icon Packs"
        ]
        
        for f in trial_features:
            lbl = Gtk.Label()
            lbl.set_markup(f"<span color='#228B22'>★</span> {f}")
            lbl.set_xalign(0)
            features_box.pack_start(lbl, False, False, 0)
        
        self.content.pack_start(features_box, False, False, 0)
        
        trial_btn = Gtk.Button(label="Start 30-Day Trial")
        trial_btn.set_margin_top(25)
        trial_btn.connect("clicked", self.on_start_trial)
        self.content.pack_start(trial_btn, False, False, 0)
        
        skip_lbl = Gtk.Label()
        skip_lbl.set_markup("<span color='gray'>or continue with free version</span>")
        skip_lbl.set_margin_top(10)
        self.content.pack_start(skip_lbl, False, False, 0)
    
    def create_finish_page(self):
        title = Gtk.Label()
        title.set_markup("<span size='x-large' weight='bold'>You're All Set!</span>")
        self.content.pack_start(title, False, False, 0)
        
        desc = Gtk.Label(label="Aegis OS is ready to use.\n\nExplore your new desktop and enjoy!")
        desc.set_justify(Gtk.Justification.CENTER)
        desc.set_margin_top(20)
        self.content.pack_start(desc, False, False, 0)
        
        tips = Gtk.Label()
        tips.set_markup(
            "<span weight='bold'>Quick Tips:</span>\n"
            "• Right-click desktop for options\n"
            "• Press Win key for application menu\n"
            "• Win+E opens file manager\n"
            "• Use Software Center to install apps"
        )
        tips.set_margin_top(30)
        tips.set_xalign(0)
        self.content.pack_start(tips, False, False, 0)
    
    def on_back(self, widget):
        if self.page > 0:
            self.show_page(self.page - 1)
    
    def on_next(self, widget):
        if self.page < len(self.pages) - 1:
            self.show_page(self.page + 1)
        else:
            self.mark_shown()
            self.destroy()
            Gtk.main_quit()
    
    def on_start_trial(self, widget):
        try:
            subprocess.run(["/usr/local/bin/aegis-upgrade-prompt", "--trial"], check=True)
            dialog = Gtk.MessageDialog(
                transient_for=self,
                message_type=Gtk.MessageType.INFO,
                buttons=Gtk.ButtonsType.OK,
                text="Trial Activated!"
            )
            dialog.format_secondary_text("Your 30-day premium trial is now active.")
            dialog.run()
            dialog.destroy()
        except:
            pass
    
    def mark_shown(self):
        FIRST_RUN_FLAG.parent.mkdir(parents=True, exist_ok=True)
        FIRST_RUN_FLAG.touch()

def main():
    if "--force" not in sys.argv and FIRST_RUN_FLAG.exists():
        sys.exit(0)
    
    if GTK_AVAILABLE:
        win = WelcomeWindow()
        win.connect("destroy", Gtk.main_quit)
        win.show_all()
        Gtk.main()
    else:
        print("Welcome to Aegis OS Freemium Edition!")
        print("Visit https://aegis-os.com to upgrade.")

if __name__ == "__main__":
    main()
