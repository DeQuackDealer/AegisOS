#!/bin/bash
#
# Aegis OS Fullscreen Toggle Script v1.0.0
# Toggle window fullscreen state and optionally hide/show panel
#
# Usage:
#   aegis-fullscreen-toggle [--with-panel]
#
# Keybinding: F11 (configured in xfce4-keyboard-shortcuts.xml)
#
# Copyright (c) 2024 Aegis OS Team
# License: GPL-3.0

VERSION="1.0.0"
SCRIPT_NAME="aegis-fullscreen-toggle"

show_help() {
    cat << EOF
Aegis OS Fullscreen Toggle v${VERSION}

Usage: ${SCRIPT_NAME} [OPTIONS]

Options:
    --with-panel    Also toggle panel visibility when entering/exiting fullscreen
    --panel-only    Only toggle panel visibility (don't toggle fullscreen)
    --show-panel    Force show the panel
    --hide-panel    Force hide the panel
    --status        Show current fullscreen and panel status
    -h, --help      Show this help message
    -v, --version   Show version information

Description:
    This script toggles the fullscreen state of the currently focused window
    using wmctrl. It can also optionally hide/show the XFCE panel for a
    truly immersive fullscreen experience.

Examples:
    ${SCRIPT_NAME}                  # Toggle fullscreen for current window
    ${SCRIPT_NAME} --with-panel     # Toggle fullscreen and hide/show panel
    ${SCRIPT_NAME} --panel-only     # Only toggle panel visibility
    ${SCRIPT_NAME} --status         # Check current states

Keybinding:
    This script is bound to F11 by default via xfce4-keyboard-shortcuts.xml

Notes:
    - Requires wmctrl to be installed
    - Works best with XFCE desktop environment
    - Panel visibility is controlled via xfconf-query

EOF
}

show_version() {
    echo "${SCRIPT_NAME} version ${VERSION}"
    echo "Copyright (c) 2024 Aegis OS Team"
}

check_dependencies() {
    if ! command -v wmctrl &> /dev/null; then
        echo "Error: wmctrl is not installed."
        echo "Install it with: sudo apt install wmctrl"
        exit 1
    fi
}

get_active_window_id() {
    xdotool getactivewindow 2>/dev/null || wmctrl -a :ACTIVE: -v 2>&1 | grep -oP '0x[0-9a-f]+' | head -1
}

is_window_fullscreen() {
    local window_id="$1"
    if [ -z "$window_id" ]; then
        return 1
    fi
    
    xprop -id "$window_id" 2>/dev/null | grep -q "_NET_WM_STATE_FULLSCREEN"
    return $?
}

toggle_fullscreen() {
    local window_id
    window_id=$(get_active_window_id)
    
    if [ -z "$window_id" ]; then
        notify-send -i dialog-warning "Fullscreen Toggle" "No active window found" 2>/dev/null
        return 1
    fi
    
    wmctrl -i -r "$window_id" -b toggle,fullscreen
    
    return 0
}

is_panel_visible() {
    local autohide
    autohide=$(xfconf-query -c xfce4-panel -p /panels/panel-1/autohide-behavior 2>/dev/null)
    
    if [ "$autohide" = "2" ]; then
        return 1
    else
        return 0
    fi
}

show_panel() {
    xfconf-query -c xfce4-panel -p /panels/panel-1/autohide-behavior -s 0 2>/dev/null
    
    xfce4-panel --restart 2>/dev/null &
}

hide_panel() {
    xfconf-query -c xfce4-panel -p /panels/panel-1/autohide-behavior -s 2 2>/dev/null
    
    xfce4-panel --restart 2>/dev/null &
}

toggle_panel() {
    if is_panel_visible; then
        hide_panel
    else
        show_panel
    fi
}

show_status() {
    local window_id
    window_id=$(get_active_window_id)
    
    echo "Aegis OS Fullscreen Status"
    echo "=========================="
    echo
    
    if [ -n "$window_id" ]; then
        local window_name
        window_name=$(xdotool getwindowname "$window_id" 2>/dev/null || echo "Unknown")
        echo "Active Window: $window_name"
        echo "Window ID: $window_id"
        
        if is_window_fullscreen "$window_id"; then
            echo "Fullscreen: Yes"
        else
            echo "Fullscreen: No"
        fi
    else
        echo "Active Window: None detected"
    fi
    
    echo
    
    if is_panel_visible; then
        echo "Panel: Visible"
    else
        echo "Panel: Hidden (autohide enabled)"
    fi
}

WITH_PANEL=false
PANEL_ONLY=false
FORCE_SHOW=false
FORCE_HIDE=false
SHOW_STATUS=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --with-panel)
            WITH_PANEL=true
            shift
            ;;
        --panel-only)
            PANEL_ONLY=true
            shift
            ;;
        --show-panel)
            FORCE_SHOW=true
            shift
            ;;
        --hide-panel)
            FORCE_HIDE=true
            shift
            ;;
        --status)
            SHOW_STATUS=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--version)
            show_version
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

check_dependencies

if [ "$SHOW_STATUS" = true ]; then
    show_status
    exit 0
fi

if [ "$FORCE_SHOW" = true ]; then
    show_panel
    exit 0
fi

if [ "$FORCE_HIDE" = true ]; then
    hide_panel
    exit 0
fi

if [ "$PANEL_ONLY" = true ]; then
    toggle_panel
    exit 0
fi

if [ "$WITH_PANEL" = true ]; then
    window_id=$(get_active_window_id)
    
    if is_window_fullscreen "$window_id"; then
        toggle_fullscreen
        show_panel
    else
        toggle_fullscreen
        hide_panel
    fi
else
    toggle_fullscreen
fi

exit 0
