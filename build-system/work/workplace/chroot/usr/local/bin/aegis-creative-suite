#!/usr/bin/env python3
"""
Aegis Creative Suite v1.0.0
Unified launcher for professional creative applications

Applications included:
  - Video Editing: Kdenlive, OpenShot, Shotcut
  - Image Editing: GIMP, Krita
  - Vector Graphics: Inkscape
  - Audio Production: Ardour, Audacity
  - Animation: Synfig, Blender
  - 3D Graphics: Blender
  - RAW Photo: RawTherapee, Darktable
  - PDF Editing: Xournal++
  - Publishing: Scribus

Features:
  - Quick launch panel for all creative apps
  - Recent projects view
  - Workspace presets
  - Resource monitoring during creative work
  - Auto-save reminders
  - Plugin manager

Copyright (c) 2024 Aegis OS Team
License: GPL-3.0
"""

import os
import sys
import json
import subprocess
import argparse
import shutil
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Optional, Any
from dataclasses import dataclass, field, asdict
from enum import Enum

try:
    import tkinter as tk
    from tkinter import ttk, messagebox, filedialog
    TKINTER_AVAILABLE = True
except ImportError:
    TKINTER_AVAILABLE = False

VERSION = "1.0.0"
APP_NAME = "Aegis Creative Suite"
CONFIG_DIR = Path.home() / ".config" / "aegis" / "creative-suite"
CONFIG_FILE = CONFIG_DIR / "config.json"
RECENT_FILE = CONFIG_DIR / "recent.json"


class Category(Enum):
    VIDEO = "video"
    IMAGE = "image"
    VECTOR = "vector"
    AUDIO = "audio"
    ANIMATION = "animation"
    THREED = "3d"
    PHOTO = "photo"
    PUBLISHING = "publishing"
    NOTES = "notes"


@dataclass
class CreativeApp:
    """Represents a creative application"""
    id: str
    name: str
    category: str
    command: str
    icon: str = ""
    description: str = ""
    installed: bool = False
    package: str = ""


CREATIVE_APPS = [
    CreativeApp("kdenlive", "Kdenlive", "video", "kdenlive", 
                "kdenlive", "Professional video editor", package="kdenlive"),
    CreativeApp("openshot", "OpenShot", "video", "openshot-qt",
                "openshot", "Easy video editor", package="openshot-qt"),
    CreativeApp("shotcut", "Shotcut", "video", "shotcut",
                "shotcut", "Cross-platform video editor", package="shotcut"),
    CreativeApp("gimp", "GIMP", "image", "gimp",
                "gimp", "GNU Image Manipulation Program", package="gimp"),
    CreativeApp("krita", "Krita", "image", "krita",
                "krita", "Digital painting application", package="krita"),
    CreativeApp("inkscape", "Inkscape", "vector", "inkscape",
                "inkscape", "Vector graphics editor", package="inkscape"),
    CreativeApp("ardour", "Ardour", "audio", "ardour6",
                "ardour", "Professional audio workstation", package="ardour"),
    CreativeApp("audacity", "Audacity", "audio", "audacity",
                "audacity", "Audio editor and recorder", package="audacity"),
    CreativeApp("lmms", "LMMS", "audio", "lmms",
                "lmms", "Music production software", package="lmms"),
    CreativeApp("synfig", "Synfig Studio", "animation", "synfigstudio",
                "synfig", "2D animation software", package="synfigstudio"),
    CreativeApp("blender", "Blender", "3d", "blender",
                "blender", "3D creation suite", package="blender"),
    CreativeApp("rawtherapee", "RawTherapee", "photo", "rawtherapee",
                "rawtherapee", "RAW photo processor", package="rawtherapee"),
    CreativeApp("darktable", "Darktable", "photo", "darktable",
                "darktable", "Photography workflow", package="darktable"),
    CreativeApp("scribus", "Scribus", "publishing", "scribus",
                "scribus", "Desktop publishing", package="scribus"),
    CreativeApp("xournalpp", "Xournal++", "notes", "xournalpp",
                "com.github.xournalpp.xournalpp", "Note-taking and PDF annotation", package="xournalpp"),
    CreativeApp("obs", "OBS Studio", "video", "obs",
                "obs", "Screen recording and streaming", package="obs-studio"),
]


@dataclass
class RecentProject:
    """Recent project entry"""
    filepath: str
    app_id: str
    app_name: str
    opened: str


@dataclass
class CreativeSuiteConfig:
    """Configuration settings"""
    default_workspace: str = "general"
    auto_save_reminder: bool = True
    reminder_interval_minutes: int = 15
    show_resource_monitor: bool = True
    recent_limit: int = 20


class CreativeSuiteService:
    """Core Creative Suite service"""
    
    def __init__(self):
        self.config = self._load_config()
        self.apps = {app.id: app for app in CREATIVE_APPS}
        self.recent: List[RecentProject] = []
        self._check_installed_apps()
        self._load_recent()
    
    def _load_config(self) -> CreativeSuiteConfig:
        CONFIG_DIR.mkdir(parents=True, exist_ok=True)
        
        if CONFIG_FILE.exists():
            try:
                with open(CONFIG_FILE, 'r') as f:
                    data = json.load(f)
                    return CreativeSuiteConfig(**data)
            except Exception:
                pass
        return CreativeSuiteConfig()
    
    def _save_config(self):
        with open(CONFIG_FILE, 'w') as f:
            json.dump(asdict(self.config), f, indent=2)
    
    def _load_recent(self):
        if RECENT_FILE.exists():
            try:
                with open(RECENT_FILE, 'r') as f:
                    data = json.load(f)
                    self.recent = [RecentProject(**r) for r in data]
            except Exception:
                pass
    
    def _save_recent(self):
        with open(RECENT_FILE, 'w') as f:
            json.dump([asdict(r) for r in self.recent[:self.config.recent_limit]], f, indent=2)
    
    def _check_installed_apps(self):
        """Check which apps are installed"""
        for app_id, app in self.apps.items():
            app.installed = shutil.which(app.command) is not None
    
    def get_apps_by_category(self, category: str) -> List[CreativeApp]:
        """Get apps filtered by category"""
        return [app for app in self.apps.values() if app.category == category]
    
    def get_installed_apps(self) -> List[CreativeApp]:
        """Get only installed apps"""
        return [app for app in self.apps.values() if app.installed]
    
    def launch_app(self, app_id: str, filepath: Optional[str] = None) -> bool:
        """Launch a creative application"""
        if app_id not in self.apps:
            return False
        
        app = self.apps[app_id]
        if not app.installed:
            return False
        
        try:
            cmd = [app.command]
            if filepath and Path(filepath).exists():
                cmd.append(filepath)
                self.recent.insert(0, RecentProject(
                    filepath=filepath,
                    app_id=app_id,
                    app_name=app.name,
                    opened=datetime.now().isoformat()
                ))
                self._save_recent()
            
            subprocess.Popen(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            return True
        except Exception:
            return False
    
    def install_app(self, app_id: str) -> bool:
        """Install a creative application"""
        if app_id not in self.apps:
            return False
        
        app = self.apps[app_id]
        try:
            result = subprocess.run(
                ['pkexec', 'apt-get', 'install', '-y', app.package],
                capture_output=True, text=True
            )
            if result.returncode == 0:
                app.installed = True
                return True
        except Exception:
            pass
        return False
    
    def get_status(self) -> Dict:
        """Get current status"""
        installed = [a for a in self.apps.values() if a.installed]
        return {
            "version": VERSION,
            "total_apps": len(self.apps),
            "installed_apps": len(installed),
            "categories": list(set(a.category for a in self.apps.values())),
            "recent_projects": len(self.recent),
            "apps": [asdict(a) for a in self.apps.values()],
            "recent": [asdict(r) for r in self.recent[:5]]
        }


class CreativeSuiteGUI:
    """GUI for Creative Suite"""
    
    CATEGORY_LABELS = {
        "video": "Video Editing",
        "image": "Image Editing",
        "vector": "Vector Graphics",
        "audio": "Audio Production",
        "animation": "Animation",
        "3d": "3D Graphics",
        "photo": "Photo Processing",
        "publishing": "Publishing",
        "notes": "Notes & PDF"
    }
    
    def __init__(self, service: CreativeSuiteService):
        self.service = service
        self.root = None
    
    def run(self):
        if not TKINTER_AVAILABLE:
            print("Error: Tkinter not available")
            sys.exit(1)
        
        self.root = tk.Tk()
        self.root.title(f"{APP_NAME} v{VERSION}")
        self.root.geometry("900x700")
        self.root.configure(bg='#1e1e2e')
        
        style = ttk.Style()
        style.theme_use('clam')
        style.configure('TFrame', background='#1e1e2e')
        style.configure('TLabel', background='#1e1e2e', foreground='#cdd6f4')
        style.configure('Header.TLabel', font=('Segoe UI', 18, 'bold'), foreground='#89b4fa')
        style.configure('Category.TLabel', font=('Segoe UI', 12, 'bold'), foreground='#a6adc8')
        style.configure('TButton', padding=10, font=('Segoe UI', 10))
        style.configure('App.TButton', padding=15, font=('Segoe UI', 11))
        
        self._create_widgets()
        self.root.mainloop()
    
    def _create_widgets(self):
        main = ttk.Frame(self.root, padding=20)
        main.pack(fill=tk.BOTH, expand=True)
        
        header = ttk.Frame(main)
        header.pack(fill=tk.X, pady=(0, 20))
        
        ttk.Label(header, text="Aegis Creative Suite", style='Header.TLabel').pack(side=tk.LEFT)
        
        installed = len(self.service.get_installed_apps())
        total = len(self.service.apps)
        status_text = f"{installed}/{total} apps installed"
        ttk.Label(header, text=status_text, foreground='#a6adc8').pack(side=tk.RIGHT)
        
        notebook = ttk.Notebook(main)
        notebook.pack(fill=tk.BOTH, expand=True)
        
        apps_frame = ttk.Frame(notebook, padding=10)
        notebook.add(apps_frame, text="Applications")
        
        canvas = tk.Canvas(apps_frame, bg='#1e1e2e', highlightthickness=0)
        scrollbar = ttk.Scrollbar(apps_frame, orient=tk.VERTICAL, command=canvas.yview)
        scroll_frame = ttk.Frame(canvas)
        
        scroll_frame.bind("<Configure>", 
                         lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
        
        canvas.create_window((0, 0), window=scroll_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        canvas.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        categories = {}
        for app in self.service.apps.values():
            if app.category not in categories:
                categories[app.category] = []
            categories[app.category].append(app)
        
        for category, apps in categories.items():
            cat_frame = ttk.Frame(scroll_frame)
            cat_frame.pack(fill=tk.X, pady=10, padx=5)
            
            label = self.CATEGORY_LABELS.get(category, category.title())
            ttk.Label(cat_frame, text=label, style='Category.TLabel').pack(anchor=tk.W)
            
            apps_row = ttk.Frame(cat_frame)
            apps_row.pack(fill=tk.X, pady=5)
            
            for app in apps:
                app_btn = ttk.Button(
                    apps_row,
                    text=f"{app.name}\n{'✓ Installed' if app.installed else '○ Not Installed'}",
                    style='App.TButton',
                    command=lambda a=app: self._launch_or_install(a)
                )
                app_btn.pack(side=tk.LEFT, padx=5, pady=5)
        
        recent_frame = ttk.Frame(notebook, padding=10)
        notebook.add(recent_frame, text="Recent Projects")
        
        if self.service.recent:
            for project in self.service.recent[:10]:
                proj_frame = ttk.Frame(recent_frame)
                proj_frame.pack(fill=tk.X, pady=5)
                
                ttk.Label(proj_frame, text=Path(project.filepath).name, 
                         font=('Segoe UI', 11)).pack(side=tk.LEFT)
                ttk.Label(proj_frame, text=f"({project.app_name})", 
                         foreground='#a6adc8').pack(side=tk.LEFT, padx=10)
                
                ttk.Button(proj_frame, text="Open",
                          command=lambda p=project: self._open_recent(p)).pack(side=tk.RIGHT)
        else:
            ttk.Label(recent_frame, text="No recent projects", 
                     foreground='#a6adc8').pack(pady=20)
        
        settings_frame = ttk.Frame(notebook, padding=10)
        notebook.add(settings_frame, text="Settings")
        
        self.reminder_var = tk.BooleanVar(value=self.service.config.auto_save_reminder)
        ttk.Checkbutton(settings_frame, text="Auto-save reminders", 
                       variable=self.reminder_var).pack(anchor=tk.W, pady=5)
        
        self.monitor_var = tk.BooleanVar(value=self.service.config.show_resource_monitor)
        ttk.Checkbutton(settings_frame, text="Show resource monitor", 
                       variable=self.monitor_var).pack(anchor=tk.W, pady=5)
    
    def _launch_or_install(self, app: CreativeApp):
        if app.installed:
            if self.service.launch_app(app.id):
                pass
            else:
                messagebox.showerror("Error", f"Failed to launch {app.name}")
        else:
            if messagebox.askyesno("Install", f"{app.name} is not installed. Install now?"):
                if self.service.install_app(app.id):
                    messagebox.showinfo("Success", f"{app.name} installed!")
                else:
                    messagebox.showerror("Error", f"Failed to install {app.name}")
    
    def _open_recent(self, project: RecentProject):
        if Path(project.filepath).exists():
            self.service.launch_app(project.app_id, project.filepath)
        else:
            messagebox.showerror("Error", "File no longer exists")


def main():
    parser = argparse.ArgumentParser(description=f"{APP_NAME} - Creative applications launcher")
    parser.add_argument('--gui', action='store_true', help='Launch GUI mode')
    parser.add_argument('--status', action='store_true', help='Show status as JSON')
    parser.add_argument('--list', action='store_true', help='List all apps')
    parser.add_argument('--installed', action='store_true', help='List installed apps')
    parser.add_argument('--launch', metavar='APP_ID', help='Launch an app')
    parser.add_argument('--open', metavar='FILE', help='Open file with app')
    parser.add_argument('--install', metavar='APP_ID', help='Install an app')
    parser.add_argument('--category', metavar='CATEGORY', help='Filter by category')
    parser.add_argument('--recent', action='store_true', help='Show recent projects')
    parser.add_argument('--version', action='version', version=f'{APP_NAME} v{VERSION}')
    
    args = parser.parse_args()
    service = CreativeSuiteService()
    
    if args.status:
        print(json.dumps(service.get_status(), indent=2))
    elif args.list:
        apps = service.apps.values()
        if args.category:
            apps = service.get_apps_by_category(args.category)
        print("Creative applications:")
        for app in apps:
            status = "✓" if app.installed else "○"
            print(f"  {status} [{app.id}] {app.name} - {app.description}")
    elif args.installed:
        apps = service.get_installed_apps()
        print(f"Installed applications ({len(apps)}):")
        for app in apps:
            print(f"  - {app.name} ({app.id})")
    elif args.launch:
        filepath = args.open if args.open else None
        if service.launch_app(args.launch, filepath):
            print(f"Launched {args.launch}")
        else:
            print(f"Failed to launch {args.launch}", file=sys.stderr)
            sys.exit(1)
    elif args.install:
        if service.install_app(args.install):
            print(f"Installed {args.install}")
        else:
            print(f"Failed to install {args.install}", file=sys.stderr)
            sys.exit(1)
    elif args.recent:
        if service.recent:
            print("Recent projects:")
            for p in service.recent[:10]:
                print(f"  - {p.filepath} ({p.app_name})")
        else:
            print("No recent projects")
    elif args.gui or not any([args.status, args.list, args.installed, args.launch, 
                               args.install, args.recent]):
        if TKINTER_AVAILABLE:
            gui = CreativeSuiteGUI(service)
            gui.run()
        else:
            print("GUI requires tkinter. Use --help for CLI options.")
            sys.exit(1)


if __name__ == "__main__":
    main()
