#!/usr/bin/env python3
"""
Aegis Audio Enhance v1.0.0
Audio enhancement and EasyEffects integration

Features:
  - System-wide audio enhancement
  - Per-application audio effects
  - Preset management (Voice, Music, Movie, Gaming)
  - Equalizer with visualizer
  - Noise reduction
  - Bass boost / Loudness
  - Compressor / Limiter
  - Reverb and spatial audio
  - EasyEffects integration

Copyright (c) 2024 Aegis OS Team
License: GPL-3.0
"""

import os
import sys
import json
import subprocess
import argparse
import shutil
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Optional, Any
from dataclasses import dataclass, field, asdict

try:
    import tkinter as tk
    from tkinter import ttk, messagebox
    TKINTER_AVAILABLE = True
except ImportError:
    TKINTER_AVAILABLE = False

VERSION = "1.0.0"
APP_NAME = "Aegis Audio Enhance"
CONFIG_DIR = Path.home() / ".config" / "aegis" / "audio-enhance"
CONFIG_FILE = CONFIG_DIR / "config.json"
PRESETS_DIR = CONFIG_DIR / "presets"
EASYEFFECTS_PRESETS = Path.home() / ".config" / "easyeffects" / "output"


@dataclass
class AudioPreset:
    """Audio enhancement preset"""
    id: str
    name: str
    description: str
    equalizer: Dict[str, float] = field(default_factory=dict)
    bass_boost: float = 0.0
    loudness: float = 0.0
    compressor_enabled: bool = False
    limiter_enabled: bool = True
    noise_reduction: bool = False
    reverb_enabled: bool = False
    reverb_amount: float = 0.0


BUILTIN_PRESETS = [
    AudioPreset(
        id="flat",
        name="Flat",
        description="No enhancement, neutral sound",
        equalizer={"32Hz": 0, "64Hz": 0, "125Hz": 0, "250Hz": 0, "500Hz": 0,
                   "1kHz": 0, "2kHz": 0, "4kHz": 0, "8kHz": 0, "16kHz": 0}
    ),
    AudioPreset(
        id="voice",
        name="Voice/Podcast",
        description="Optimized for speech clarity",
        equalizer={"32Hz": -3, "64Hz": -2, "125Hz": 0, "250Hz": 2, "500Hz": 3,
                   "1kHz": 4, "2kHz": 5, "4kHz": 4, "8kHz": 2, "16kHz": 0},
        compressor_enabled=True,
        noise_reduction=True
    ),
    AudioPreset(
        id="music",
        name="Music",
        description="Enhanced music listening",
        equalizer={"32Hz": 4, "64Hz": 3, "125Hz": 2, "250Hz": 0, "500Hz": -1,
                   "1kHz": 0, "2kHz": 1, "4kHz": 2, "8kHz": 3, "16kHz": 3},
        bass_boost=2.0,
        loudness=1.0
    ),
    AudioPreset(
        id="movie",
        name="Movie/Cinema",
        description="Cinematic audio experience",
        equalizer={"32Hz": 5, "64Hz": 4, "125Hz": 2, "250Hz": 0, "500Hz": -1,
                   "1kHz": 0, "2kHz": 1, "4kHz": 3, "8kHz": 4, "16kHz": 3},
        bass_boost=3.0,
        reverb_enabled=True,
        reverb_amount=0.2
    ),
    AudioPreset(
        id="gaming",
        name="Gaming",
        description="Enhanced for gaming with spatial audio",
        equalizer={"32Hz": 3, "64Hz": 2, "125Hz": 1, "250Hz": 0, "500Hz": 0,
                   "1kHz": 1, "2kHz": 2, "4kHz": 3, "8kHz": 4, "16kHz": 3},
        bass_boost=2.0,
        compressor_enabled=True,
        reverb_enabled=True,
        reverb_amount=0.15
    ),
    AudioPreset(
        id="bass",
        name="Bass Boost",
        description="Heavy bass enhancement",
        equalizer={"32Hz": 8, "64Hz": 7, "125Hz": 5, "250Hz": 3, "500Hz": 1,
                   "1kHz": 0, "2kHz": 0, "4kHz": 0, "8kHz": 0, "16kHz": 0},
        bass_boost=5.0
    ),
    AudioPreset(
        id="clarity",
        name="Clarity/Treble",
        description="Enhanced high frequencies for clarity",
        equalizer={"32Hz": -2, "64Hz": -1, "125Hz": 0, "250Hz": 0, "500Hz": 1,
                   "1kHz": 2, "2kHz": 3, "4kHz": 4, "8kHz": 5, "16kHz": 4}
    ),
]


@dataclass
class AudioEnhanceConfig:
    """Configuration settings"""
    enabled: bool = True
    current_preset: str = "flat"
    master_volume: float = 1.0
    auto_start: bool = True
    show_visualizer: bool = True


class AudioEnhanceService:
    """Core audio enhancement service"""
    
    def __init__(self):
        self.config = self._load_config()
        self.presets = {p.id: p for p in BUILTIN_PRESETS}
        self.easyeffects_available = self._check_easyeffects()
        self._load_custom_presets()
    
    def _check_easyeffects(self) -> bool:
        """Check if EasyEffects is available"""
        return shutil.which('easyeffects') is not None
    
    def _load_config(self) -> AudioEnhanceConfig:
        CONFIG_DIR.mkdir(parents=True, exist_ok=True)
        PRESETS_DIR.mkdir(parents=True, exist_ok=True)
        
        if CONFIG_FILE.exists():
            try:
                with open(CONFIG_FILE, 'r') as f:
                    data = json.load(f)
                    return AudioEnhanceConfig(**data)
            except Exception:
                pass
        return AudioEnhanceConfig()
    
    def _save_config(self):
        with open(CONFIG_FILE, 'w') as f:
            json.dump(asdict(self.config), f, indent=2)
    
    def _load_custom_presets(self):
        for preset_file in PRESETS_DIR.glob("*.json"):
            try:
                with open(preset_file, 'r') as f:
                    data = json.load(f)
                    preset = AudioPreset(**data)
                    self.presets[preset.id] = preset
            except Exception:
                pass
    
    def get_presets(self) -> List[AudioPreset]:
        """Get all available presets"""
        return list(self.presets.values())
    
    def apply_preset(self, preset_id: str) -> bool:
        """Apply an audio preset"""
        if preset_id not in self.presets:
            return False
        
        preset = self.presets[preset_id]
        
        if self.easyeffects_available:
            try:
                subprocess.run(
                    ['easyeffects', '-l', preset.name],
                    capture_output=True, timeout=5
                )
            except Exception:
                pass
        
        try:
            subprocess.Popen(
                ['easyeffects', '-l', preset_id],
                stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL
            )
        except Exception:
            pass
        
        self.config.current_preset = preset_id
        self._save_config()
        return True
    
    def toggle_enhancement(self, enabled: bool) -> bool:
        """Toggle audio enhancement on/off"""
        self.config.enabled = enabled
        self._save_config()
        
        if self.easyeffects_available:
            try:
                if enabled:
                    subprocess.Popen(
                        ['easyeffects'],
                        stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL
                    )
                else:
                    subprocess.run(['pkill', 'easyeffects'], capture_output=True)
                return True
            except Exception:
                pass
        return False
    
    def save_preset(self, preset: AudioPreset) -> bool:
        """Save a custom preset"""
        preset_file = PRESETS_DIR / f"{preset.id}.json"
        try:
            with open(preset_file, 'w') as f:
                json.dump(asdict(preset), f, indent=2)
            self.presets[preset.id] = preset
            return True
        except Exception:
            return False
    
    def get_status(self) -> Dict:
        """Get current status"""
        current = self.presets.get(self.config.current_preset)
        return {
            "version": VERSION,
            "enabled": self.config.enabled,
            "easyeffects_available": self.easyeffects_available,
            "current_preset": self.config.current_preset,
            "current_preset_name": current.name if current else "Unknown",
            "master_volume": self.config.master_volume,
            "presets_count": len(self.presets),
            "presets": [{"id": p.id, "name": p.name} for p in self.presets.values()]
        }


class AudioEnhanceGUI:
    """GUI for Audio Enhance"""
    
    def __init__(self, service: AudioEnhanceService):
        self.service = service
        self.root = None
    
    def run(self):
        if not TKINTER_AVAILABLE:
            print("Error: Tkinter not available")
            sys.exit(1)
        
        self.root = tk.Tk()
        self.root.title(f"{APP_NAME} v{VERSION}")
        self.root.geometry("600x500")
        self.root.configure(bg='#1e1e2e')
        
        style = ttk.Style()
        style.theme_use('clam')
        style.configure('TFrame', background='#1e1e2e')
        style.configure('TLabel', background='#1e1e2e', foreground='#cdd6f4')
        style.configure('Header.TLabel', font=('Segoe UI', 16, 'bold'), foreground='#89b4fa')
        
        self._create_widgets()
        self.root.mainloop()
    
    def _create_widgets(self):
        main = ttk.Frame(self.root, padding=20)
        main.pack(fill=tk.BOTH, expand=True)
        
        header = ttk.Frame(main)
        header.pack(fill=tk.X, pady=(0, 20))
        
        ttk.Label(header, text="Aegis Audio Enhance", style='Header.TLabel').pack(side=tk.LEFT)
        
        self.enable_var = tk.BooleanVar(value=self.service.config.enabled)
        enable_cb = ttk.Checkbutton(header, text="Enabled", variable=self.enable_var,
                                   command=self._toggle_enhancement)
        enable_cb.pack(side=tk.RIGHT)
        
        if not self.service.easyeffects_available:
            warning = ttk.Label(main, text="⚠ EasyEffects not installed - limited functionality",
                               foreground='#f9e2af')
            warning.pack(pady=10)
        
        presets_frame = ttk.LabelFrame(main, text="Audio Presets", padding=10)
        presets_frame.pack(fill=tk.BOTH, expand=True, pady=10)
        
        self.preset_var = tk.StringVar(value=self.service.config.current_preset)
        
        for preset in self.service.get_presets():
            frame = ttk.Frame(presets_frame)
            frame.pack(fill=tk.X, pady=5)
            
            is_current = preset.id == self.service.config.current_preset
            
            rb = ttk.Radiobutton(frame, text=preset.name, value=preset.id,
                                variable=self.preset_var,
                                command=lambda p=preset.id: self._apply_preset(p))
            rb.pack(side=tk.LEFT)
            
            ttk.Label(frame, text=f"- {preset.description}", 
                     foreground='#a6adc8').pack(side=tk.LEFT, padx=10)
            
            if is_current:
                ttk.Label(frame, text="● Active", foreground='#a6e3a1').pack(side=tk.RIGHT)
        
        controls_frame = ttk.LabelFrame(main, text="Quick Controls", padding=10)
        controls_frame.pack(fill=tk.X, pady=10)
        
        vol_frame = ttk.Frame(controls_frame)
        vol_frame.pack(fill=tk.X, pady=5)
        
        ttk.Label(vol_frame, text="Master Volume:").pack(side=tk.LEFT)
        self.volume_scale = ttk.Scale(vol_frame, from_=0, to=150, orient=tk.HORIZONTAL)
        self.volume_scale.set(self.service.config.master_volume * 100)
        self.volume_scale.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=10)
        
        actions_frame = ttk.Frame(main)
        actions_frame.pack(fill=tk.X, pady=10)
        
        ttk.Button(actions_frame, text="Open EasyEffects",
                  command=self._open_easyeffects).pack(side=tk.LEFT, padx=5)
        ttk.Button(actions_frame, text="Reset to Default",
                  command=lambda: self._apply_preset("flat")).pack(side=tk.LEFT, padx=5)
    
    def _toggle_enhancement(self):
        self.service.toggle_enhancement(self.enable_var.get())
    
    def _apply_preset(self, preset_id: str):
        if self.service.apply_preset(preset_id):
            messagebox.showinfo("Success", f"Applied preset: {preset_id}")
    
    def _open_easyeffects(self):
        if self.service.easyeffects_available:
            subprocess.Popen(['easyeffects'], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        else:
            messagebox.showerror("Error", "EasyEffects is not installed")


def main():
    parser = argparse.ArgumentParser(description=f"{APP_NAME} - Audio enhancement")
    parser.add_argument('--gui', action='store_true', help='Launch GUI mode')
    parser.add_argument('--status', action='store_true', help='Show status as JSON')
    parser.add_argument('--list', action='store_true', help='List presets')
    parser.add_argument('--apply', metavar='PRESET_ID', help='Apply a preset')
    parser.add_argument('--enable', action='store_true', help='Enable enhancement')
    parser.add_argument('--disable', action='store_true', help='Disable enhancement')
    parser.add_argument('--version', action='version', version=f'{APP_NAME} v{VERSION}')
    
    args = parser.parse_args()
    service = AudioEnhanceService()
    
    if args.status:
        print(json.dumps(service.get_status(), indent=2))
    elif args.list:
        print("Available presets:")
        current = service.config.current_preset
        for p in service.get_presets():
            marker = "●" if p.id == current else "○"
            print(f"  {marker} [{p.id}] {p.name} - {p.description}")
    elif args.apply:
        if service.apply_preset(args.apply):
            print(f"Applied preset: {args.apply}")
        else:
            print(f"Preset not found: {args.apply}", file=sys.stderr)
            sys.exit(1)
    elif args.enable:
        service.toggle_enhancement(True)
        print("Audio enhancement enabled")
    elif args.disable:
        service.toggle_enhancement(False)
        print("Audio enhancement disabled")
    elif args.gui or not any([args.status, args.list, args.apply, args.enable, args.disable]):
        if TKINTER_AVAILABLE:
            gui = AudioEnhanceGUI(service)
            gui.run()
        else:
            print("GUI requires tkinter. Use --help for CLI options.")
            sys.exit(1)


if __name__ == "__main__":
    main()
