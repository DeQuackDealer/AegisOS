#!/bin/bash
#
# Aegis OS Feature Gate Utility
# Checks if a feature is available based on current tier license
# Usage: aegis-feature-gate check "feature_name" [--quiet] [--upgrade-prompt]
#

TIER_FILE="/etc/aegis/tier.json"
TIER_FEATURES_FILE="/etc/aegis/tier-features.json"
LICENSE_FILE="/etc/aegis/license.json"

QUIET=0
UPGRADE_PROMPT=0

show_help() {
    cat << EOF
Aegis OS Feature Gate Utility

Usage: aegis-feature-gate <command> [feature] [options]

Commands:
    check <feature>     Check if a feature is available
    list                List all features for current tier
    tier                Show current tier information
    help                Show this help message

Options:
    --quiet, -q         Suppress output, only return exit code
    --upgrade-prompt    Show upgrade prompt if feature is locked

Exit Codes:
    0 - Feature is available
    1 - Feature is locked/unavailable
    2 - Error (missing files, invalid tier, etc.)

Examples:
    aegis-feature-gate check "neural_upscaling"
    aegis-feature-gate check "gaming_optimizer" --upgrade-prompt
    aegis-feature-gate list
    aegis-feature-gate tier
EOF
}

get_current_tier() {
    if [ -f "$TIER_FILE" ]; then
        python3 -c "import json; print(json.load(open('$TIER_FILE'))['current_tier'])" 2>/dev/null
    else
        echo "freemium"
    fi
}

get_tier_name() {
    local tier="$1"
    python3 << EOF
import json
try:
    with open('$TIER_FEATURES_FILE', 'r') as f:
        data = json.load(f)
    tier_info = data['tiers'].get('$tier', {})
    print(tier_info.get('name', '$tier'))
except:
    print('$tier')
EOF
}

check_feature() {
    local feature="$1"
    local current_tier=$(get_current_tier)
    
    if [ ! -f "$TIER_FEATURES_FILE" ]; then
        [ $QUIET -eq 0 ] && echo "Error: Tier features file not found"
        return 2
    fi
    
    python3 << EOF
import json
import sys

try:
    with open('$TIER_FEATURES_FILE', 'r') as f:
        data = json.load(f)
    
    tier_data = data['tiers'].get('$current_tier', data['tiers']['freemium'])
    features = tier_data.get('features', {})
    disabled = tier_data.get('disabled_features', [])
    
    feature_name = '$feature'
    
    # Check if feature is explicitly enabled
    if features.get(feature_name, False):
        sys.exit(0)
    
    # Check if feature is in disabled list
    if feature_name in disabled:
        sys.exit(1)
    
    # Feature not found in either list - treat as disabled
    sys.exit(1)
    
except Exception as e:
    print(f"Error checking feature: {e}", file=sys.stderr)
    sys.exit(2)
EOF
    return $?
}

list_features() {
    local current_tier=$(get_current_tier)
    local tier_name=$(get_tier_name "$current_tier")
    
    echo "Current Tier: $tier_name ($current_tier)"
    echo ""
    echo "Enabled Features:"
    echo "================"
    
    python3 << EOF
import json

try:
    with open('$TIER_FEATURES_FILE', 'r') as f:
        data = json.load(f)
    
    tier_data = data['tiers'].get('$current_tier', data['tiers']['freemium'])
    features = tier_data.get('features', {})
    disabled = tier_data.get('disabled_features', [])
    
    for feature, enabled in sorted(features.items()):
        if enabled:
            print(f"  ✓ {feature}")
    
    print("\nDisabled Features:")
    print("==================")
    for feature in sorted(disabled):
        print(f"  ✗ {feature}")
        
except Exception as e:
    print(f"Error: {e}")
EOF
}

show_tier_info() {
    local current_tier=$(get_current_tier)
    local tier_name=$(get_tier_name "$current_tier")
    
    python3 << EOF
import json
from datetime import datetime

try:
    with open('$TIER_FEATURES_FILE', 'r') as f:
        features_data = json.load(f)
    
    tier_data = features_data['tiers'].get('$current_tier', features_data['tiers']['freemium'])
    
    print(f"Current Tier: {tier_data.get('name', '$current_tier')}")
    print(f"Tier Code: {tier_data.get('code', 'FRE')}")
    
    # Check for trial status
    if '$current_tier' == 'freemium' and tier_data.get('trial_days'):
        try:
            with open('$LICENSE_FILE', 'r') as f:
                license_data = json.load(f)
            trial_start = license_data.get('trial_start')
            if trial_start:
                start = datetime.fromisoformat(trial_start)
                days_left = tier_data['trial_days'] - (datetime.now() - start).days
                if days_left > 0:
                    print(f"Premium Trial: {days_left} days remaining")
                else:
                    print("Premium Trial: Expired")
        except:
            print(f"Premium Trial: {tier_data['trial_days']} days available")
    
    max_mem = tier_data.get('max_memory_gb', 4)
    max_cores = tier_data.get('max_cores', 2)
    
    if max_mem == -1:
        print("Max Memory: Unlimited")
    else:
        print(f"Max Memory: {max_mem}GB")
    
    if max_cores == -1:
        print("Max Cores: Unlimited")
    else:
        print(f"Max Cores: {max_cores}")
    
    services = tier_data.get('services', [])
    if services:
        print(f"Enabled Services: {', '.join(services)}")
    
    # Show license info if available
    try:
        with open('$LICENSE_FILE', 'r') as f:
            license_data = json.load(f)
        if license_data.get('license_key'):
            key = license_data['license_key']
            masked = key[:10] + '...' + key[-5:]
            print(f"License Key: {masked}")
            if license_data.get('expires_at'):
                print(f"Expires: {license_data['expires_at']}")
            else:
                print("License Type: Lifetime")
    except:
        if '$current_tier' == 'freemium':
            print("License: None (Freemium)")
        
except Exception as e:
    print(f"Error: {e}")
EOF
}

show_upgrade_prompt() {
    local feature="$1"
    local current_tier=$(get_current_tier)
    
    python3 << EOF
import json

try:
    with open('$TIER_FEATURES_FILE', 'r') as f:
        data = json.load(f)
    
    feature_desc = data.get('feature_descriptions', {}).get('$feature', '$feature')
    upgrade_paths = data.get('upgrade_paths', {}).get('$current_tier', [])
    
    print("")
    print("╔══════════════════════════════════════════════════════════════╗")
    print("║                    FEATURE LOCKED                            ║")
    print("╠══════════════════════════════════════════════════════════════╣")
    print(f"║  Feature: {feature_desc[:50]:<50} ║")
    print("╠══════════════════════════════════════════════════════════════╣")
    
    if upgrade_paths:
        print("║  Upgrade to unlock this feature:                             ║")
        for path in upgrade_paths[:3]:
            tier_info = data['tiers'].get(path, {})
            tier_name = tier_info.get('name', path)
            print(f"║    → {tier_name:<54} ║")
    
    print("╠══════════════════════════════════════════════════════════════╣")
    print("║  Visit https://aegis-os.com/upgrade to upgrade your license  ║")
    print("╚══════════════════════════════════════════════════════════════╝")
    print("")
    
except Exception as e:
    print(f"Feature '$feature' is not available in your current tier.")
    print("Visit https://aegis-os.com/upgrade to upgrade.")
EOF
}

# Parse arguments
COMMAND=""
FEATURE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        check|list|tier|help)
            COMMAND="$1"
            shift
            ;;
        --quiet|-q)
            QUIET=1
            shift
            ;;
        --upgrade-prompt)
            UPGRADE_PROMPT=1
            shift
            ;;
        -*)
            echo "Unknown option: $1"
            show_help
            exit 2
            ;;
        *)
            if [ -z "$FEATURE" ]; then
                FEATURE="$1"
            fi
            shift
            ;;
    esac
done

# Execute command
case "$COMMAND" in
    check)
        if [ -z "$FEATURE" ]; then
            echo "Error: Feature name required"
            echo "Usage: aegis-feature-gate check <feature>"
            exit 2
        fi
        
        check_feature "$FEATURE"
        result=$?
        
        if [ $result -eq 0 ]; then
            [ $QUIET -eq 0 ] && echo "Feature '$FEATURE' is available"
            exit 0
        elif [ $result -eq 1 ]; then
            [ $QUIET -eq 0 ] && echo "Feature '$FEATURE' is locked"
            [ $UPGRADE_PROMPT -eq 1 ] && show_upgrade_prompt "$FEATURE"
            exit 1
        else
            exit 2
        fi
        ;;
    list)
        list_features
        ;;
    tier)
        show_tier_info
        ;;
    help|"")
        show_help
        ;;
    *)
        echo "Unknown command: $COMMAND"
        show_help
        exit 2
        ;;
esac
