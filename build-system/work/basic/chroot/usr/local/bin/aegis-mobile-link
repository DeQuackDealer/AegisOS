#!/usr/bin/env python3
"""
Aegis Mobile Link v1.0.0
Enhanced KDE Connect wrapper with additional features

Features:
  - Full phone notifications on desktop
  - SMS/MMS messaging from desktop
  - File transfer to/from phone
  - Clipboard sync between devices
  - Media playback control
  - Phone battery monitoring
  - Find my phone (ring device)
  - Run commands on phone
  - Share URLs instantly
  - Camera remote shutter
  - Presentation remote
  - Input remote (mouse/keyboard)

Copyright (c) 2024 Aegis OS Team
License: GPL-3.0
"""

import os
import sys
import json
import subprocess
import argparse
import threading
import time
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Optional, Any
from dataclasses import dataclass, field, asdict
from enum import Enum

try:
    import tkinter as tk
    from tkinter import ttk, messagebox, filedialog
    TKINTER_AVAILABLE = True
except ImportError:
    TKINTER_AVAILABLE = False

VERSION = "1.0.0"
APP_NAME = "Aegis Mobile Link"
CONFIG_DIR = Path.home() / ".config" / "aegis" / "mobile-link"
CONFIG_FILE = CONFIG_DIR / "config.json"
DEVICES_FILE = CONFIG_DIR / "devices.json"


@dataclass
class MobileDevice:
    """Represents a connected mobile device"""
    id: str
    name: str
    device_type: str
    is_paired: bool = False
    is_reachable: bool = False
    battery_level: int = -1
    battery_charging: bool = False
    last_seen: str = ""
    supported_plugins: List[str] = field(default_factory=list)


@dataclass
class MobileLinkConfig:
    """Configuration settings"""
    notifications_enabled: bool = True
    clipboard_sync: bool = True
    media_control: bool = True
    file_receive_path: str = ""
    auto_pair: bool = False
    trusted_devices: List[str] = field(default_factory=list)


class MobileLinkService:
    """Core Mobile Link service using KDE Connect"""
    
    def __init__(self):
        self.config = self._load_config()
        self.devices: Dict[str, MobileDevice] = {}
        self.kdeconnect_available = self._check_kdeconnect()
    
    def _check_kdeconnect(self) -> bool:
        """Check if KDE Connect is available"""
        try:
            result = subprocess.run(['kdeconnect-cli', '--version'],
                                   capture_output=True, text=True)
            return result.returncode == 0
        except FileNotFoundError:
            return False
    
    def _load_config(self) -> MobileLinkConfig:
        CONFIG_DIR.mkdir(parents=True, exist_ok=True)
        
        config = MobileLinkConfig()
        config.file_receive_path = str(Path.home() / "Downloads")
        
        if CONFIG_FILE.exists():
            try:
                with open(CONFIG_FILE, 'r') as f:
                    data = json.load(f)
                    for k, v in data.items():
                        if hasattr(config, k):
                            setattr(config, k, v)
            except Exception:
                pass
        
        return config
    
    def _save_config(self):
        with open(CONFIG_FILE, 'w') as f:
            json.dump(asdict(self.config), f, indent=2)
    
    def refresh_devices(self) -> List[MobileDevice]:
        """Refresh list of devices"""
        self.devices.clear()
        
        if not self.kdeconnect_available:
            return []
        
        try:
            result = subprocess.run(
                ['kdeconnect-cli', '-l', '--id-name-only'],
                capture_output=True, text=True
            )
            
            for line in result.stdout.strip().split('\n'):
                if ' - ' in line:
                    parts = line.split(' - ', 1)
                    if len(parts) == 2:
                        device_id = parts[0].strip()
                        device_name = parts[1].strip()
                        
                        device = MobileDevice(
                            id=device_id,
                            name=device_name,
                            device_type="phone",
                            last_seen=datetime.now().isoformat()
                        )
                        
                        info = subprocess.run(
                            ['kdeconnect-cli', '-d', device_id, '--pair-status'],
                            capture_output=True, text=True
                        )
                        device.is_paired = "paired" in info.stdout.lower()
                        
                        reach = subprocess.run(
                            ['kdeconnect-cli', '-d', device_id, '--ping'],
                            capture_output=True, text=True, timeout=2
                        )
                        device.is_reachable = reach.returncode == 0
                        
                        try:
                            bat = subprocess.run(
                                ['kdeconnect-cli', '-d', device_id, '-b'],
                                capture_output=True, text=True, timeout=2
                            )
                            if bat.returncode == 0:
                                level = int(''.join(filter(str.isdigit, bat.stdout)) or -1)
                                device.battery_level = min(level, 100)
                        except Exception:
                            pass
                        
                        self.devices[device_id] = device
                        
        except Exception as e:
            pass
        
        return list(self.devices.values())
    
    def pair_device(self, device_id: str) -> bool:
        """Pair with a device"""
        try:
            result = subprocess.run(
                ['kdeconnect-cli', '-d', device_id, '--pair'],
                capture_output=True, text=True
            )
            return result.returncode == 0
        except Exception:
            return False
    
    def unpair_device(self, device_id: str) -> bool:
        """Unpair a device"""
        try:
            result = subprocess.run(
                ['kdeconnect-cli', '-d', device_id, '--unpair'],
                capture_output=True, text=True
            )
            return result.returncode == 0
        except Exception:
            return False
    
    def ring_device(self, device_id: str) -> bool:
        """Ring a device"""
        try:
            result = subprocess.run(
                ['kdeconnect-cli', '-d', device_id, '--ring'],
                capture_output=True, text=True
            )
            return result.returncode == 0
        except Exception:
            return False
    
    def send_file(self, device_id: str, filepath: str) -> bool:
        """Send file to device"""
        if not Path(filepath).exists():
            return False
        try:
            result = subprocess.run(
                ['kdeconnect-cli', '-d', device_id, '--share', filepath],
                capture_output=True, text=True
            )
            return result.returncode == 0
        except Exception:
            return False
    
    def send_sms(self, device_id: str, phone_number: str, message: str) -> bool:
        """Send SMS via device"""
        try:
            result = subprocess.run(
                ['kdeconnect-cli', '-d', device_id, '--send-sms', message,
                 '--destination', phone_number],
                capture_output=True, text=True
            )
            return result.returncode == 0
        except Exception:
            return False
    
    def share_url(self, device_id: str, url: str) -> bool:
        """Share URL to device"""
        try:
            result = subprocess.run(
                ['kdeconnect-cli', '-d', device_id, '--share', url],
                capture_output=True, text=True
            )
            return result.returncode == 0
        except Exception:
            return False
    
    def send_clipboard(self, device_id: str, text: str) -> bool:
        """Send text to device clipboard"""
        try:
            result = subprocess.run(
                ['kdeconnect-cli', '-d', device_id, '--share-text', text],
                capture_output=True, text=True
            )
            return result.returncode == 0
        except Exception:
            return False
    
    def get_status(self) -> Dict:
        """Get current status"""
        self.refresh_devices()
        return {
            "version": VERSION,
            "kdeconnect_available": self.kdeconnect_available,
            "devices_count": len(self.devices),
            "paired_count": sum(1 for d in self.devices.values() if d.is_paired),
            "reachable_count": sum(1 for d in self.devices.values() if d.is_reachable),
            "devices": [asdict(d) for d in self.devices.values()],
            "config": asdict(self.config)
        }


class MobileLinkGUI:
    """GUI for Mobile Link"""
    
    def __init__(self, service: MobileLinkService):
        self.service = service
        self.root = None
    
    def run(self):
        if not TKINTER_AVAILABLE:
            print("Error: Tkinter not available")
            sys.exit(1)
        
        self.root = tk.Tk()
        self.root.title(f"{APP_NAME} v{VERSION}")
        self.root.geometry("800x600")
        self.root.configure(bg='#2b2b2b')
        
        style = ttk.Style()
        style.theme_use('clam')
        style.configure('TFrame', background='#2b2b2b')
        style.configure('TLabel', background='#2b2b2b', foreground='#ffffff')
        style.configure('Header.TLabel', font=('Segoe UI', 16, 'bold'))
        
        self._create_widgets()
        self._refresh_devices()
        self.root.mainloop()
    
    def _create_widgets(self):
        main = ttk.Frame(self.root, padding=20)
        main.pack(fill=tk.BOTH, expand=True)
        
        header = ttk.Frame(main)
        header.pack(fill=tk.X, pady=(0, 20))
        
        ttk.Label(header, text="Aegis Mobile Link", style='Header.TLabel').pack(side=tk.LEFT)
        
        if not self.service.kdeconnect_available:
            warning = ttk.Label(header, text="KDE Connect not installed", 
                               foreground='#ff6b6b')
            warning.pack(side=tk.RIGHT)
        
        control_frame = ttk.Frame(main)
        control_frame.pack(fill=tk.X, pady=10)
        
        ttk.Button(control_frame, text="Refresh", 
                  command=self._refresh_devices).pack(side=tk.LEFT, padx=5)
        ttk.Button(control_frame, text="Pair", 
                  command=self._pair_device).pack(side=tk.LEFT, padx=5)
        ttk.Button(control_frame, text="Unpair", 
                  command=self._unpair_device).pack(side=tk.LEFT, padx=5)
        ttk.Button(control_frame, text="Ring Phone", 
                  command=self._ring_device).pack(side=tk.LEFT, padx=5)
        ttk.Button(control_frame, text="Send File", 
                  command=self._send_file).pack(side=tk.LEFT, padx=5)
        
        devices_frame = ttk.LabelFrame(main, text="Connected Devices", padding=10)
        devices_frame.pack(fill=tk.BOTH, expand=True, pady=10)
        
        columns = ('name', 'status', 'battery', 'reachable')
        self.devices_tree = ttk.Treeview(devices_frame, columns=columns, show='headings', height=8)
        
        self.devices_tree.heading('name', text='Device Name')
        self.devices_tree.heading('status', text='Paired')
        self.devices_tree.heading('battery', text='Battery')
        self.devices_tree.heading('reachable', text='Reachable')
        
        for col, width in [('name', 250), ('status', 80), ('battery', 80), ('reachable', 80)]:
            self.devices_tree.column(col, width=width)
        
        scrollbar = ttk.Scrollbar(devices_frame, orient=tk.VERTICAL, 
                                  command=self.devices_tree.yview)
        self.devices_tree.configure(yscrollcommand=scrollbar.set)
        
        self.devices_tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        actions_frame = ttk.LabelFrame(main, text="Quick Actions", padding=10)
        actions_frame.pack(fill=tk.X, pady=10)
        
        row1 = ttk.Frame(actions_frame)
        row1.pack(fill=tk.X, pady=5)
        
        ttk.Button(row1, text="Share URL", command=self._share_url).pack(side=tk.LEFT, padx=5)
        ttk.Button(row1, text="Send SMS", command=self._send_sms).pack(side=tk.LEFT, padx=5)
        ttk.Button(row1, text="Share Clipboard", command=self._share_clipboard).pack(side=tk.LEFT, padx=5)
        
        settings_frame = ttk.LabelFrame(main, text="Settings", padding=10)
        settings_frame.pack(fill=tk.X, pady=10)
        
        self.notify_var = tk.BooleanVar(value=self.service.config.notifications_enabled)
        ttk.Checkbutton(settings_frame, text="Show phone notifications", 
                       variable=self.notify_var).pack(anchor=tk.W)
        
        self.clipboard_var = tk.BooleanVar(value=self.service.config.clipboard_sync)
        ttk.Checkbutton(settings_frame, text="Sync clipboard", 
                       variable=self.clipboard_var).pack(anchor=tk.W)
        
        self.media_var = tk.BooleanVar(value=self.service.config.media_control)
        ttk.Checkbutton(settings_frame, text="Media control", 
                       variable=self.media_var).pack(anchor=tk.W)
    
    def _refresh_devices(self):
        for item in self.devices_tree.get_children():
            self.devices_tree.delete(item)
        
        devices = self.service.refresh_devices()
        
        for device in devices:
            paired = "Yes" if device.is_paired else "No"
            battery = f"{device.battery_level}%" if device.battery_level >= 0 else "N/A"
            reachable = "Yes" if device.is_reachable else "No"
            
            self.devices_tree.insert('', tk.END, iid=device.id, values=(
                device.name, paired, battery, reachable
            ))
    
    def _get_selected_device(self) -> Optional[str]:
        selection = self.devices_tree.selection()
        if not selection:
            messagebox.showwarning("Warning", "Please select a device first")
            return None
        return selection[0]
    
    def _pair_device(self):
        device_id = self._get_selected_device()
        if device_id:
            if self.service.pair_device(device_id):
                messagebox.showinfo("Success", "Pairing request sent. Accept on your phone.")
                self._refresh_devices()
            else:
                messagebox.showerror("Error", "Failed to pair device")
    
    def _unpair_device(self):
        device_id = self._get_selected_device()
        if device_id:
            if self.service.unpair_device(device_id):
                messagebox.showinfo("Success", "Device unpaired")
                self._refresh_devices()
            else:
                messagebox.showerror("Error", "Failed to unpair device")
    
    def _ring_device(self):
        device_id = self._get_selected_device()
        if device_id:
            if self.service.ring_device(device_id):
                messagebox.showinfo("Success", "Ringing device...")
            else:
                messagebox.showerror("Error", "Failed to ring device")
    
    def _send_file(self):
        device_id = self._get_selected_device()
        if device_id:
            filepath = filedialog.askopenfilename(title="Select File to Send")
            if filepath:
                if self.service.send_file(device_id, filepath):
                    messagebox.showinfo("Success", "File sent!")
                else:
                    messagebox.showerror("Error", "Failed to send file")
    
    def _share_url(self):
        device_id = self._get_selected_device()
        if device_id:
            dialog = tk.Toplevel(self.root)
            dialog.title("Share URL")
            dialog.geometry("400x100")
            dialog.transient(self.root)
            dialog.grab_set()
            
            frame = ttk.Frame(dialog, padding=20)
            frame.pack(fill=tk.BOTH, expand=True)
            
            ttk.Label(frame, text="URL:").pack(anchor=tk.W)
            url_entry = ttk.Entry(frame, width=50)
            url_entry.pack(fill=tk.X, pady=5)
            
            def share():
                url = url_entry.get().strip()
                if url:
                    self.service.share_url(device_id, url)
                    dialog.destroy()
            
            ttk.Button(frame, text="Share", command=share).pack(pady=10)
    
    def _send_sms(self):
        device_id = self._get_selected_device()
        if device_id:
            dialog = tk.Toplevel(self.root)
            dialog.title("Send SMS")
            dialog.geometry("400x200")
            dialog.transient(self.root)
            dialog.grab_set()
            
            frame = ttk.Frame(dialog, padding=20)
            frame.pack(fill=tk.BOTH, expand=True)
            
            ttk.Label(frame, text="Phone Number:").pack(anchor=tk.W)
            phone_entry = ttk.Entry(frame, width=50)
            phone_entry.pack(fill=tk.X, pady=5)
            
            ttk.Label(frame, text="Message:").pack(anchor=tk.W)
            msg_entry = ttk.Entry(frame, width=50)
            msg_entry.pack(fill=tk.X, pady=5)
            
            def send():
                phone = phone_entry.get().strip()
                msg = msg_entry.get().strip()
                if phone and msg:
                    self.service.send_sms(device_id, phone, msg)
                    dialog.destroy()
            
            ttk.Button(frame, text="Send", command=send).pack(pady=10)
    
    def _share_clipboard(self):
        device_id = self._get_selected_device()
        if device_id:
            try:
                result = subprocess.run(['xclip', '-selection', 'clipboard', '-o'],
                                       capture_output=True, text=True)
                text = result.stdout
                if text:
                    self.service.send_clipboard(device_id, text)
                    messagebox.showinfo("Success", "Clipboard shared!")
                else:
                    messagebox.showwarning("Warning", "Clipboard is empty")
            except Exception:
                messagebox.showerror("Error", "Could not access clipboard")


def main():
    parser = argparse.ArgumentParser(description=f"{APP_NAME} - Phone integration")
    parser.add_argument('--gui', action='store_true', help='Launch GUI mode')
    parser.add_argument('--status', action='store_true', help='Show status as JSON')
    parser.add_argument('--list', action='store_true', help='List devices')
    parser.add_argument('--refresh', action='store_true', help='Refresh device list')
    parser.add_argument('--pair', metavar='DEVICE_ID', help='Pair with device')
    parser.add_argument('--unpair', metavar='DEVICE_ID', help='Unpair device')
    parser.add_argument('--ring', metavar='DEVICE_ID', help='Ring device')
    parser.add_argument('--send-file', nargs=2, metavar=('DEVICE_ID', 'FILE'), help='Send file')
    parser.add_argument('--share-url', nargs=2, metavar=('DEVICE_ID', 'URL'), help='Share URL')
    parser.add_argument('--version', action='version', version=f'{APP_NAME} v{VERSION}')
    
    args = parser.parse_args()
    service = MobileLinkService()
    
    if args.status:
        print(json.dumps(service.get_status(), indent=2))
    elif args.list or args.refresh:
        devices = service.refresh_devices()
        if devices:
            print("Connected devices:")
            for d in devices:
                paired = "paired" if d.is_paired else "unpaired"
                reach = "reachable" if d.is_reachable else "offline"
                bat = f"{d.battery_level}%" if d.battery_level >= 0 else "N/A"
                print(f"  [{d.id}] {d.name} - {paired}, {reach}, battery: {bat}")
        else:
            print("No devices found")
    elif args.pair:
        if service.pair_device(args.pair):
            print("Pairing request sent")
        else:
            print("Failed to pair", file=sys.stderr)
            sys.exit(1)
    elif args.unpair:
        if service.unpair_device(args.unpair):
            print("Device unpaired")
        else:
            print("Failed to unpair", file=sys.stderr)
    elif args.ring:
        if service.ring_device(args.ring):
            print("Ringing device...")
        else:
            print("Failed to ring device", file=sys.stderr)
    elif args.send_file:
        if service.send_file(args.send_file[0], args.send_file[1]):
            print("File sent")
        else:
            print("Failed to send file", file=sys.stderr)
            sys.exit(1)
    elif args.share_url:
        if service.share_url(args.share_url[0], args.share_url[1]):
            print("URL shared")
        else:
            print("Failed to share URL", file=sys.stderr)
    elif args.gui or not any([args.status, args.list, args.refresh, args.pair, 
                               args.unpair, args.ring, args.send_file, args.share_url]):
        if TKINTER_AVAILABLE:
            gui = MobileLinkGUI(service)
            gui.run()
        else:
            print("GUI requires tkinter. Use --help for CLI options.")
            sys.exit(1)


if __name__ == "__main__":
    main()
