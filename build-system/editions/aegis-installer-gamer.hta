<html>
<head>
<title>Aegis OS Gamer Edition Installer</title>
<HTA:APPLICATION ID="AegisGamerInstaller" APPLICATIONNAME="Aegis OS Gamer Edition Installer" BORDER="thick" BORDERSTYLE="normal" CAPTION="yes" MAXIMIZEBUTTON="no" MINIMIZEBUTTON="yes" SHOWINTASKBAR="yes" SINGLEINSTANCE="yes" SYSMENU="yes" VERSION="3.0" SCROLL="no" INNERBORDER="no"/>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #fff; height: 100vh; overflow: hidden; margin: 0; }
.wizard { display: flex; flex-direction: column; height: 100vh; }
.wizard-header { flex-shrink: 0; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); padding: 8px 12px; display: flex; align-items: center; gap: 8px; }
.logo-svg { width: 36px; height: 36px; }
.shield-animate { animation: shieldPulse 2s ease-in-out infinite; }
@keyframes shieldPulse { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 3px rgba(239, 68, 68, 0.5)); } 50% { transform: scale(1.05); filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.8)); } }
.header-text h1 { font-size: 14px; font-weight: 600; }
.header-text p { font-size: 10px; opacity: 0.9; }
.wizard-breadcrumb { flex-shrink: 0; display: flex; justify-content: space-between; gap: 4px; padding: 4px 12px; background: #12122a; border-bottom: 1px solid #1f2a40; }
.step-crumb { flex: 1; text-align: center; font-size: 9px; padding: 5px 3px; border-radius: 4px; background: #1a2438; color: #8ca0c8; }
.step-crumb.active { background: linear-gradient(135deg, #dc2626, #ef4444); color: #fff; font-weight: 600; }
.step-crumb.done { background: #0f1d33; color: #ef4444; }
.wizard-content { flex: 1; overflow: hidden; position: relative; min-height: 0; }
.slide { display: none; padding: 8px 12px; height: 100%; overflow: hidden; }
.slide.active { display: flex; flex-direction: column; }
.wizard-footer { flex-shrink: 0; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #333; background: #12122a; }
.section-title { font-size: 13px; font-weight: 600; margin-bottom: 3px; }
.section-desc { font-size: 10px; color: #b0b0b0; margin-bottom: 6px; line-height: 1.3; }
.info-box { background: rgba(220, 38, 38, 0.15); border: 1px solid rgba(220, 38, 38, 0.3); border-radius: 5px; padding: 6px; margin-bottom: 6px; }
.info-box h3 { font-size: 10px; margin-bottom: 4px; color: #ef4444; }
.info-box ul { font-size: 9px; color: #b0b0b0; padding-left: 14px; margin: 0; }
.info-box li { margin-bottom: 1px; }
.drive-list { background: #1e1e3a; border: 1px solid #333; border-radius: 5px; max-height: 80px; overflow-y: auto; margin-bottom: 6px; }
.drive-item { padding: 6px 8px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
.drive-item:last-child { border-bottom: none; }
.drive-item:hover { background: #2a2a4a; }
.drive-item.selected { background: rgba(220, 38, 38, 0.3); border-left: 3px solid #ef4444; }
.drive-icon { width: 24px; height: 24px; background: linear-gradient(135deg, #dc2626, #ef4444); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: bold; }
.drive-info { flex: 1; }
.drive-name { font-weight: 500; font-size: 11px; }
.drive-size { font-size: 9px; color: #b0b0b0; }
.drive-details { font-size: 8px; color: #909090; }
.no-drives { padding: 15px; text-align: center; color: #888; font-size: 10px; }
.btn { padding: 8px 16px; border-radius: 5px; font-weight: 600; cursor: pointer; border: none; font-size: 11px; transition: all 0.2s; }
.btn-primary { background: linear-gradient(135deg, #dc2626, #ef4444); color: white; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 3px 12px rgba(220, 38, 38, 0.4); }
.btn-primary:disabled { background: #444; cursor: not-allowed; transform: none; box-shadow: none; }
.btn-secondary { background: #2a2a4a; color: #aaa; border: 1px solid #444; }
.btn-refresh { background: #1e1e3a; color: #ef4444; padding: 4px 8px; font-size: 9px; }
.btn-small { padding: 3px 8px; font-size: 9px; }
.btn-create { background: linear-gradient(135deg, #16a34a, #22c55e); padding: 10px 24px; font-size: 12px; }
.progress-container { background: #1e1e3a; border-radius: 5px; padding: 12px; text-align: center; }
.progress-bar-bg { height: 8px; background: #2a2a4a; border-radius: 4px; overflow: hidden; margin: 10px 0; }
.progress-bar-fill { height: 100%; background: linear-gradient(90deg, #dc2626, #ef4444, #dc2626); background-size: 200% 100%; width: 0%; transition: width 0.5s ease-out; border-radius: 4px; }
.progress-bar-fill.animated { animation: shimmer 1.5s infinite linear; }
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
.progress-percent { font-size: 24px; font-weight: 700; color: #ef4444; }
.progress-status { font-size: 11px; color: #aaa; margin-top: 4px; }
.progress-detail { font-size: 9px; color: #a0a0a0; margin-top: 2px; }
.progress-stats { display: flex; justify-content: center; gap: 12px; margin-top: 8px; font-size: 9px; }
.progress-stat { text-align: center; }
.progress-stat-value { font-size: 11px; color: #ef4444; font-weight: 600; }
.progress-stat-label { font-size: 8px; color: #909090; margin-top: 1px; }
.success-container { text-align: center; padding: 10px; }
.success-icon { font-size: 32px; margin-bottom: 8px; color: #10b981; }
.success-title { font-size: 16px; color: #10b981; margin-bottom: 4px; }
.success-desc { font-size: 11px; color: #aaa; }
.success-steps { background: #1e1e3a; border-radius: 5px; padding: 10px; margin-top: 10px; text-align: left; }
.success-steps h3 { font-size: 11px; margin-bottom: 6px; }
.success-steps ol { padding-left: 14px; font-size: 10px; color: #aaa; margin: 0; }
.success-steps li { margin-bottom: 3px; }
.error-box { background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 5px; padding: 8px; color: #f87171; font-size: 11px; }
.warning-box { background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 5px; padding: 8px; margin-bottom: 8px; font-size: 10px; }
.warning-box strong { color: #f87171; }
.sys-req-box { background: #1e1e3a; border: 1px solid #333; border-radius: 5px; padding: 8px; margin-bottom: 8px; }
.sys-req-item { display: flex; align-items: center; gap: 6px; padding: 2px 0; font-size: 10px; }
.sys-req-icon { font-size: 12px; }
.sys-req-pass { color: #10b981; }
.sys-req-fail { color: #ef4444; }
.sys-req-warn { color: #ef4444; }
.option-group { margin-bottom: 8px; }
.option-label { font-size: 10px; color: #aaa; margin-bottom: 4px; display: block; }
.radio-group { display: flex; gap: 12px; }
.radio-item { display: flex; align-items: center; gap: 4px; font-size: 10px; cursor: pointer; }
.radio-item input { accent-color: #ef4444; }
.checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 10px; cursor: pointer; }
.checkbox-item input { accent-color: #ef4444; width: 12px; height: 12px; }
.edition-badge { display: inline-block; background: linear-gradient(135deg, #dc2626, #ef4444); padding: 2px 6px; border-radius: 8px; font-size: 9px; font-weight: 600; }
.feature-section { margin-bottom: 6px; }
.feature-section-title { font-size: 10px; color: #ef4444; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
.core-features { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 5px; padding: 6px; margin-bottom: 6px; }
.core-feature-item { display: flex; align-items: center; gap: 5px; padding: 2px 0; font-size: 9px; color: #aaa; }
.core-feature-item .icon { color: #10b981; font-size: 10px; }
.optional-features { background: #1e1e3a; border: 1px solid #333; border-radius: 5px; padding: 6px; max-height: 60px; overflow-y: auto; flex: 1; min-height: 0; }
.feature-card { display: flex; align-items: flex-start; gap: 6px; padding: 4px; border-bottom: 1px solid #333; }
.feature-card:last-child { border-bottom: none; }
.feature-card:hover { background: rgba(220, 38, 38, 0.1); }
.feature-card input { margin-top: 1px; accent-color: #ef4444; width: 12px; height: 12px; flex-shrink: 0; }
.feature-card-content { flex: 1; min-width: 0; }
.feature-card-name { font-size: 10px; font-weight: 500; color: #fff; }
.feature-card-desc { font-size: 8px; color: #b0b0b0; }
.feature-actions { display: flex; gap: 4px; margin-bottom: 4px; }
.feature-count { font-size: 9px; color: #888; margin-top: 4px; }
.confirm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
.confirm-item { background: #1e1e3a; border-radius: 5px; padding: 8px; }
.confirm-label { font-size: 9px; color: #888; margin-bottom: 2px; }
.confirm-value { font-size: 11px; color: #ef4444; font-weight: 500; }
.hidden { display: none !important; }
</style>
<script language="VBScript">
Const EDITION = "gamer"
Const EDITION_NAME = "Gamer"
Dim selectedDrive, selectedDriveNumber, drives(), driveCount, progressTimer, shell, fso, wmi
Dim lastProgress, smoothProgress, partitionStyle, quickFormat, systemRAM, diskSpace, winVersion, sysReqPassed, selectedFeatures, currentStep

Sub Window_OnLoad()
    window.resizeTo 720, 640
    Set shell = CreateObject("WScript.Shell")
    Set fso = CreateObject("Scripting.FileSystemObject")
    smoothProgress = 0: partitionStyle = "GPT": quickFormat = True: sysReqPassed = False
    selectedFeatures = "wallpaper,stream,gaming,fps_boost": currentStep = 1
    CheckSystemRequirements(): UpdateFooterButtons()
End Sub

Sub CheckSystemRequirements()
    Dim ramGB, freeSpaceGB, osVer
    On Error Resume Next
    Set wmi = GetObject("winmgmts:\\.\root\cimv2")
    ramGB = 0: freeSpaceGB = 0: osVer = ""
    If Not wmi Is Nothing Then
        For Each mem In wmi.ExecQuery("SELECT TotalPhysicalMemory FROM Win32_ComputerSystem")
            ramGB = Round(mem.TotalPhysicalMemory / 1073741824, 1)
        Next
        For Each os In wmi.ExecQuery("SELECT Caption FROM Win32_OperatingSystem")
            osVer = os.Caption
        Next
    End If
    Dim tempFolder: tempFolder = shell.ExpandEnvironmentStrings("%TEMP%")
    If Len(tempFolder) > 0 Then
        Set drv = fso.GetDrive(fso.GetDriveName(tempFolder))
        If Not drv Is Nothing Then freeSpaceGB = Round(drv.FreeSpace / 1073741824, 1)
    End If
    On Error Goto 0
    Dim html: html = "<div class='sys-req-item'><span class='sys-req-icon " & IIf(ramGB >= 4, "sys-req-pass", "sys-req-warn") & "'>" & IIf(ramGB >= 4, "&#10003;", "&#9888;") & "</span> RAM: " & ramGB & " GB</div>"
    html = html & "<div class='sys-req-item'><span class='sys-req-icon " & IIf(freeSpaceGB >= 5, "sys-req-pass", "sys-req-fail") & "'>" & IIf(freeSpaceGB >= 5, "&#10003;", "&#10007;") & "</span> Space: " & freeSpaceGB & " GB</div>"
    html = html & "<div class='sys-req-item'><span class='sys-req-icon sys-req-pass'>&#10003;</span> " & Left(osVer, 20) & "</div>"
    document.getElementById("sysReqContent").innerHTML = html
    sysReqPassed = (freeSpaceGB >= 5)
End Sub

Sub ToggleFeature(featureId)
    Dim chk, features, i, newFeatures
    On Error Resume Next
    Set chk = document.getElementById("chk_" & featureId)
    features = Split(selectedFeatures, ","): newFeatures = ""
    For i = 0 To UBound(features)
        If features(i) <> featureId And Len(features(i)) > 0 Then
            If Len(newFeatures) > 0 Then newFeatures = newFeatures & ","
            newFeatures = newFeatures & features(i)
        End If
    Next
    If chk.checked Then
        If Len(newFeatures) > 0 Then newFeatures = newFeatures & ","
        newFeatures = newFeatures & featureId
    End If
    selectedFeatures = newFeatures
    UpdateFeatureCount
    On Error Goto 0
End Sub

Sub SelectAllFeatures()
    Dim checkboxes, i
    On Error Resume Next
    Set checkboxes = document.querySelectorAll(".optional-features input[type='checkbox']")
    selectedFeatures = ""
    For i = 0 To checkboxes.length - 1
        checkboxes(i).checked = True
        If Len(selectedFeatures) > 0 Then selectedFeatures = selectedFeatures & ","
        selectedFeatures = selectedFeatures & Replace(checkboxes(i).id, "chk_", "")
    Next
    UpdateFeatureCount
End Sub

Sub DeselectAllFeatures()
    Dim checkboxes, i
    On Error Resume Next
    Set checkboxes = document.querySelectorAll(".optional-features input[type='checkbox']")
    For i = 0 To checkboxes.length - 1: checkboxes(i).checked = False: Next
    selectedFeatures = ""
    UpdateFeatureCount
End Sub

Sub UpdateFeatureCount()
    Dim count, features, i
    features = Split(selectedFeatures, ","): count = 0
    For i = 0 To UBound(features): If Len(features(i)) > 0 Then count = count + 1: Next
    document.getElementById("featureCount").innerText = "3 core + " & count & " optional"
End Sub

Sub RefreshDrives()
    Dim diskDrives, disk, html, sizeGB
    On Error Resume Next
    If wmi Is Nothing Then Set wmi = GetObject("winmgmts:\\.\root\cimv2")
    Set diskDrives = wmi.ExecQuery("SELECT * FROM Win32_DiskDrive WHERE MediaType LIKE '%Removable%' OR InterfaceType='USB'")
    ReDim drives(0): driveCount = 0: html = ""
    For Each disk In diskDrives
        If disk.Size > 0 And InStr(LCase(disk.PNPDeviceID), "virtual") = 0 Then
            sizeGB = FormatNumber(disk.Size / 1073741824, 1)
            ReDim Preserve drives(driveCount): drives(driveCount) = disk.Index
            html = html & "<div class='drive-item' onclick='SelectDrive(" & driveCount & ")'><div class='drive-icon'>USB</div><div class='drive-info'><div class='drive-name'>" & disk.Model & "</div><div class='drive-size'>" & sizeGB & " GB</div></div></div>"
            driveCount = driveCount + 1
        End If
    Next
    On Error Goto 0
    If driveCount = 0 Then html = "<div class='no-drives'>No USB drives found. Click Refresh.</div>"
    document.getElementById("driveList").innerHTML = html
    selectedDrive = "": selectedDriveNumber = -1: UpdateFooterButtons()
End Sub

Sub SelectDrive(index)
    Dim items, i
    On Error Resume Next
    Set items = document.getElementsByClassName("drive-item")
    For i = 0 To items.length - 1: items(i).className = "drive-item": Next
    items(index).className = "drive-item selected"
    selectedDriveNumber = drives(index)
    selectedDrive = items(index).getElementsByClassName("drive-name")(0).innerText
    UpdateFooterButtons()
End Sub

Sub SetPartitionStyle(style): partitionStyle = style: End Sub
Sub SetQuickFormat(): quickFormat = document.getElementById("chkQuickFormat").checked: End Sub

Sub GoToStep(stepNum)
    Dim slides, steps, i
    On Error Resume Next
    currentStep = stepNum
    Set slides = document.getElementsByClassName("slide")
    For i = 0 To slides.length - 1: slides(i).className = "slide": Next
    document.getElementById("step" & stepNum).className = "slide active"
    Set steps = document.getElementsByClassName("step-crumb")
    For i = 0 To steps.length - 1
        If i + 1 < stepNum Then steps(i).className = "step-crumb done"
        ElseIf i + 1 = stepNum Then steps(i).className = "step-crumb active"
        Else steps(i).className = "step-crumb"
    Next
    If stepNum = 2 Then RefreshDrives(): document.getElementById("editionDisplay").innerHTML = "<span class='edition-badge'>" & EDITION_NAME & "</span>"
    If stepNum = 3 Then
        document.getElementById("confirmDrive").innerText = selectedDrive
        document.getElementById("confirmEdition").innerHTML = "<span class='edition-badge'>" & EDITION_NAME & "</span>"
        document.getElementById("confirmPartStyle").innerText = partitionStyle
        document.getElementById("confirmQuickFmt").innerText = IIf(quickFormat, "Yes", "No")
        document.getElementById("confirmFeatures").innerText = GetFeatureCountText()
    End If
    If stepNum = 4 Then
        document.getElementById("progressBar").style.width = "0%"
        document.getElementById("progressBar").className = "progress-bar-fill animated"
        document.getElementById("progressPercent").innerText = "0%"
        smoothProgress = 0
    End If
    UpdateFooterButtons()
End Sub

Sub UpdateFooterButtons()
    Dim btnBack, btnNext
    Set btnBack = document.getElementById("btnBack"): Set btnNext = document.getElementById("btnNext")
    If currentStep = 1 Then btnBack.className = "btn btn-secondary hidden": btnNext.innerText = "Next": btnNext.disabled = False
    ElseIf currentStep = 2 Then btnBack.className = "btn btn-secondary": btnNext.innerText = "Next": btnNext.disabled = (selectedDriveNumber < 0)
    ElseIf currentStep = 3 Then btnBack.className = "btn btn-secondary": btnNext.innerText = "Create USB": btnNext.className = "btn btn-primary btn-create": btnNext.disabled = False
    ElseIf currentStep = 4 Then btnBack.className = "btn btn-secondary hidden": btnNext.innerText = "Creating...": btnNext.disabled = True
    ElseIf currentStep = 5 Then btnBack.className = "btn btn-secondary hidden": btnNext.innerText = "Close": btnNext.disabled = False
    End If
End Sub

Function GetFeatureCountText()
    Dim features, count, i: features = Split(selectedFeatures, ","): count = 0
    For i = 0 To UBound(features): If Len(features(i)) > 0 Then count = count + 1: Next
    GetFeatureCountText = "3 core + " & count & " optional"
End Function

Function IIf(cond, trueVal, falseVal): If cond Then IIf = trueVal Else IIf = falseVal: End Function
Sub OnBackClick(): If currentStep > 1 And currentStep < 4 Then GoToStep(currentStep - 1): End Sub
Sub OnNextClick()
    If currentStep = 1 Then GoToStep(2)
    ElseIf currentStep = 2 And selectedDriveNumber >= 0 Then GoToStep(3)
    ElseIf currentStep = 3 Then StartCreation()
    ElseIf currentStep = 5 Then window.close()
End Sub

Sub StartCreation(): GoToStep(4): CreateUSB(): End Sub

Sub CreateUSB()
    Dim tempDir, psFile, progressFile, psCode, ts
    tempDir = shell.ExpandEnvironmentStrings("%TEMP%")
    psFile = tempDir & "\aegis_creator.ps1": progressFile = tempDir & "\aegis_progress.txt"
    If fso.FileExists(progressFile) Then fso.DeleteFile progressFile
    psCode = GetPowerShellCode()
    Set ts = fso.CreateTextFile(psFile, True): ts.Write psCode: ts.Close
    Dim cmd: cmd = "powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File """ & psFile & """ -DiskNumber " & selectedDriveNumber & " -Edition """ & EDITION_NAME & """ -Features """ & selectedFeatures & """ -PartitionStyle """ & partitionStyle & """ -QuickFormat $" & LCase(CStr(quickFormat)) & " -ProgressFile """ & progressFile & """"
    progressTimer = window.setInterval(GetRef("CheckProgress"), 500)
    shell.Run cmd, 0, False
End Sub

Function GetPowerShellCode()
    Dim code
    code = "param([int]$DiskNumber, [string]$Edition, [string]$Features, [string]$PartitionStyle, [bool]$QuickFormat, [string]$ProgressFile)" & vbCrLf
    code = code & "function Write-P { param([int]$P, [string]$S, [string]$D='', [string]$Speed='', [string]$ETA=''); $line = ""$P|$S|$D|$Speed|$ETA""; $line | Out-File $ProgressFile -Encoding UTF8 -Force }" & vbCrLf
    code = code & "function Test-Admin { ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator) }" & vbCrLf
    code = code & "if (-not (Test-Admin)) { Write-P -1 'ADMIN_REQUIRED'; exit 1 }" & vbCrLf
    code = code & "try { Write-P 0 'Initializing...' ""$Edition Edition""" & vbCrLf
    code = code & "$disk = Get-Disk -Number $DiskNumber; if ($disk.IsSystem) { Write-P -1 'SYSTEM_DRIVE'; exit 1 }" & vbCrLf
    code = code & "Write-P 3 'USB validated' ''" & vbCrLf
    code = code & "$tempDir = ""$env:TEMP\AegisOS""; New-Item -ItemType Directory -Path $tempDir -Force | Out-Null" & vbCrLf
    code = code & "$isoPath = ""$tempDir\base.iso""; $mirrors = @('https://repo.linuxliteos.com/linuxlite/isos/7.2/linux-lite-7.2-64bit.iso')" & vbCrLf
    code = code & "$expectedHash = 'DC8955E02C68537815ED0010F7C4C035CE786BBA2C679DD74532B22205DF8216'" & vbCrLf
    code = code & "Write-P 5 'Downloading...' ""Aegis OS $Edition""" & vbCrLf
    code = code & "$webRequest = [System.Net.HttpWebRequest]::Create($mirrors[0]); $webRequest.Timeout = 30000" & vbCrLf
    code = code & "$response = $webRequest.GetResponse(); $totalBytes = $response.ContentLength" & vbCrLf
    code = code & "$responseStream = $response.GetResponseStream(); $fileStream = [System.IO.File]::Create($isoPath)" & vbCrLf
    code = code & "$buffer = New-Object byte[] 8MB; $downloadedBytes = 0; $startTime = Get-Date; $lastTime = $startTime" & vbCrLf
    code = code & "while (($bytesRead = $responseStream.Read($buffer, 0, $buffer.Length)) -gt 0) {" & vbCrLf
    code = code & "  $fileStream.Write($buffer, 0, $bytesRead); $downloadedBytes += $bytesRead" & vbCrLf
    code = code & "  $pct = [int](($downloadedBytes / $totalBytes) * 100); $mappedPct = 8 + [int]($pct * 0.40); $now = Get-Date" & vbCrLf
    code = code & "  if (($now - $lastTime).TotalSeconds -ge 1) { $speed = $downloadedBytes / ($now - $startTime).TotalSeconds / 1MB" & vbCrLf
    code = code & "    Write-P $mappedPct 'Downloading...' ""$pct%"" ('{0:N1} MB/s' -f $speed) ''; $lastTime = $now }}" & vbCrLf
    code = code & "$fileStream.Close(); $responseStream.Close(); $response.Close()" & vbCrLf
    code = code & "Write-P 50 'Verifying...' 'SHA256'" & vbCrLf
    code = code & "$hash = (Get-FileHash -Path $isoPath -Algorithm SHA256).Hash" & vbCrLf
    code = code & "if ($hash -ne $expectedHash) { Write-P -1 'CHECKSUM_FAILED'; exit 1 }" & vbCrLf
    code = code & "Write-P 54 'Preparing USB...' ''" & vbCrLf
    code = code & "$dp = ""select disk $DiskNumber`nclean`noffline disk`nexit""; $dp | Out-File ""$tempDir\dp.txt"" -Encoding ASCII; diskpart /s ""$tempDir\dp.txt"" | Out-Null" & vbCrLf
    code = code & "Write-P 56 'Writing...' 'Do not remove!'" & vbCrLf
    code = code & "$phys = '\\.\PhysicalDrive' + $DiskNumber; Start-Sleep -Seconds 2" & vbCrLf
    code = code & "$src = [IO.File]::OpenRead($isoPath); $dst = New-Object IO.FileStream($phys, [IO.FileMode]::Open, [IO.FileAccess]::ReadWrite, [IO.FileShare]::None, 4MB)" & vbCrLf
    code = code & "$buf = New-Object byte[] 4MB; $written = 0; $total = $src.Length; $writeStart = Get-Date; $lastUpdate = $writeStart" & vbCrLf
    code = code & "while (($read = $src.Read($buf, 0, $buf.Length)) -gt 0) { $dst.Write($buf, 0, $read); $dst.Flush(); $written += $read" & vbCrLf
    code = code & "  $pct = [int](($written / $total) * 100); $mappedPct = 56 + [int]($pct * 0.40); $now = Get-Date" & vbCrLf
    code = code & "  if (($now - $lastUpdate).TotalSeconds -ge 1) { $speed = $written / ($now - $writeStart).TotalSeconds / 1MB" & vbCrLf
    code = code & "    Write-P $mappedPct 'Writing...' ""$pct%"" ('{0:N1} MB/s' -f $speed) ''; $lastUpdate = $now }}" & vbCrLf
    code = code & "$dst.Close(); $src.Close()" & vbCrLf
    code = code & "Write-P 97 'Syncing...' ''" & vbCrLf
    code = code & "$dp2 = ""select disk $DiskNumber`nonline disk`nexit""; $dp2 | Out-File ""$tempDir\dp2.txt"" -Encoding ASCII; diskpart /s ""$tempDir\dp2.txt"" | Out-Null" & vbCrLf
    code = code & "Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue" & vbCrLf
    code = code & "Write-P 100 ""SUCCESS! Aegis OS $Edition ready!"" 'Safe to remove.'" & vbCrLf
    code = code & "} catch { Write-P -1 $_.Exception.Message; exit 1 }" & vbCrLf
    GetPowerShellCode = code
End Function

Sub CheckProgress()
    Dim progressFile, ts, line, parts, pct, status, detail, speed
    On Error Resume Next
    progressFile = shell.ExpandEnvironmentStrings("%TEMP%") & "\aegis_progress.txt"
    If fso.FileExists(progressFile) Then
        Set ts = fso.OpenTextFile(progressFile, 1): line = ts.ReadLine(): ts.Close
        parts = Split(line, "|")
        If IsNumeric(parts(0)) Then pct = CInt(parts(0)) Else pct = 0
        status = "": detail = "": speed = ""
        If UBound(parts) >= 1 Then status = parts(1)
        If UBound(parts) >= 2 Then detail = parts(2)
        If UBound(parts) >= 3 Then speed = parts(3)
        If pct = -1 Then window.clearInterval progressTimer: ShowError status, detail
        ElseIf pct = 100 Then window.clearInterval progressTimer: UpdateProgress 100, status, detail, "": window.setTimeout GetRef("GoToStepFive"), 1500
        Else UpdateProgressSmooth pct, status, detail, speed
    End If
    On Error Goto 0
End Sub

Sub GoToStepFive(): GoToStep(5): End Sub

Sub UpdateProgressSmooth(targetPct, status, detail, speed)
    If targetPct > smoothProgress Then
        Dim delta: delta = targetPct - smoothProgress
        If delta > 10 Then smoothProgress = smoothProgress + Int(delta / 2) Else smoothProgress = smoothProgress + 2
        If smoothProgress > targetPct Then smoothProgress = targetPct
    End If
    UpdateProgress smoothProgress, status, detail, speed
End Sub

Sub UpdateProgress(pct, status, detail, speed)
    document.getElementById("progressBar").style.width = pct & "%"
    document.getElementById("progressPercent").innerText = pct & "%"
    document.getElementById("progressStatus").innerText = status
    document.getElementById("progressDetail").innerText = detail
    If speed <> "" Then document.getElementById("statSpeed").innerText = speed
End Sub

Sub ShowError(msg, detail)
    document.getElementById("progressContainer").innerHTML = "<div style='font-size:32px;color:#ef4444'>&#10060;</div><div style='font-size:14px;color:#ef4444;margin:8px 0'>Error</div><div class='error-box'>" & msg & "</div>"
    currentStep = 1: UpdateFooterButtons()
End Sub
</script>
</head>
<body>
<div class="wizard">
    <div class="wizard-header">
        <svg class="logo-svg shield-animate" viewBox="0 0 48 48" fill="none"><path d="M24 4L6 12v12c0 11 8 17 18 20 10-3 18-9 18-20V12L24 4z" fill="url(#sg)" stroke="#ef4444" stroke-width="2"/><path d="M17 24l5 5 9-10" stroke="#fff" stroke-width="3" stroke-linecap="round"/><defs><linearGradient id="sg" x1="6" y1="4" x2="42" y2="44"><stop stop-color="#dc2626"/><stop offset="1" stop-color="#ef4444"/></linearGradient></defs></svg>
        <div class="header-text"><h1>Aegis OS Gamer Edition Installer</h1><p>Create bootable USB - Gaming optimized</p></div>
    </div>
    <div class="wizard-breadcrumb">
        <div class="step-crumb active">1. Features</div><div class="step-crumb">2. USB Drive</div><div class="step-crumb">3. Confirm</div><div class="step-crumb">4. Creating</div><div class="step-crumb">5. Done</div>
    </div>
    <div class="wizard-content">
        <div id="step1" class="slide active">
            <div class="section-title">Select Features <span class="edition-badge">Gamer</span></div>
            <div class="section-desc">Gaming-optimized features for maximum performance.</div>
            <div class="sys-req-box"><div style="font-size:9px;color:#ef4444;margin-bottom:4px;font-weight:600">System Check</div><div id="sysReqContent" style="display:flex;gap:12px;">Checking...</div></div>
            <div class="feature-section"><div class="feature-section-title"><span class="icon">&#128274;</span> Core Features</div><div class="core-features"><div class="core-feature-item"><span class="icon">&#10003;</span> Aegis OS Gaming Base</div><div class="core-feature-item"><span class="icon">&#10003;</span> Low-latency Kernel</div><div class="core-feature-item"><span class="icon">&#10003;</span> GPU Drivers</div></div></div>
            <div class="feature-section" style="flex:1;display:flex;flex-direction:column;min-height:0;"><div class="feature-section-title"><span class="icon">&#9881;</span> Gaming Features</div><div class="feature-actions"><button class="btn btn-secondary btn-small" onclick="SelectAllFeatures()">All</button><button class="btn btn-secondary btn-small" onclick="DeselectAllFeatures()">None</button></div>
                <div class="optional-features">
                    <div class="feature-card"><input type="checkbox" id="chk_wallpaper" checked onclick="ToggleFeature('wallpaper')"><div class="feature-card-content"><div class="feature-card-name">Wallpaper Engine</div><div class="feature-card-desc">Animated gaming wallpapers</div></div></div>
                    <div class="feature-card"><input type="checkbox" id="chk_stream" checked onclick="ToggleFeature('stream')"><div class="feature-card-content"><div class="feature-card-name">Aegis Stream</div><div class="feature-card-desc">Game streaming tools</div></div></div>
                    <div class="feature-card"><input type="checkbox" id="chk_gaming" checked onclick="ToggleFeature('gaming')"><div class="feature-card-content"><div class="feature-card-name">Gaming Optimizer</div><div class="feature-card-desc">FPS boost, latency reduction</div></div></div>
                    <div class="feature-card"><input type="checkbox" id="chk_fps_boost" checked onclick="ToggleFeature('fps_boost')"><div class="feature-card-content"><div class="feature-card-name">FPS Boost Mode</div><div class="feature-card-desc">Maximize gaming performance</div></div></div>
                </div>
                <div id="featureCount" class="feature-count">3 core + 4 optional</div>
            </div>
        </div>
        <div id="step2" class="slide">
            <div class="section-title">Select USB Drive</div><div class="section-desc">Installing: <span id="editionDisplay">-</span></div>
            <div class="warning-box"><strong>&#9888; Warning:</strong> All data will be erased.</div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;"><span style="font-size:10px;color:#aaa;">USB Drives:</span><button class="btn btn-refresh" onclick="RefreshDrives()">&#8635; Refresh</button></div>
            <div id="driveList" class="drive-list"><div class="no-drives">Click Refresh to scan.</div></div>
            <div class="option-group"><span class="option-label">Partition Style:</span><div class="radio-group"><label class="radio-item"><input type="radio" name="partStyle" checked onclick="SetPartitionStyle('GPT')"> GPT</label><label class="radio-item"><input type="radio" name="partStyle" onclick="SetPartitionStyle('MBR')"> MBR</label></div></div>
            <label class="checkbox-item"><input type="checkbox" id="chkQuickFormat" checked onclick="SetQuickFormat()"> Quick Format</label>
        </div>
        <div id="step3" class="slide">
            <div class="section-title">Confirm Settings</div><div class="section-desc">Review before creating.</div>
            <div class="warning-box"><strong>&#9888; Final Warning:</strong> This will erase all data!</div>
            <div class="confirm-grid"><div class="confirm-item"><div class="confirm-label">Target Drive</div><div class="confirm-value" id="confirmDrive">-</div></div><div class="confirm-item"><div class="confirm-label">Edition</div><div class="confirm-value" id="confirmEdition">-</div></div><div class="confirm-item"><div class="confirm-label">Partition</div><div class="confirm-value" id="confirmPartStyle">GPT</div></div><div class="confirm-item"><div class="confirm-label">Quick Format</div><div class="confirm-value" id="confirmQuickFmt">Yes</div></div></div>
            <div class="confirm-item" style="margin-bottom:8px;"><div class="confirm-label">Features</div><div class="confirm-value" id="confirmFeatures">-</div></div>
            <div class="info-box"><h3>What happens next:</h3><ul><li>Download (~2.9 GB)</li><li>Verify SHA256</li><li>Write to USB</li><li>~15-30 min</li></ul></div>
        </div>
        <div id="step4" class="slide">
            <div class="section-title">Creating Bootable USB</div><div class="section-desc">Do not remove the USB.</div>
            <div id="progressContainer" class="progress-container"><div class="progress-percent" id="progressPercent">0%</div><div class="progress-bar-bg"><div class="progress-bar-fill animated" id="progressBar"></div></div><div class="progress-status" id="progressStatus">Starting...</div><div class="progress-detail" id="progressDetail"></div><div class="progress-stats"><div class="progress-stat"><div class="progress-stat-value" id="statSpeed">--</div><div class="progress-stat-label">Speed</div></div><div class="progress-stat"><div class="progress-stat-value" id="statETA">--</div><div class="progress-stat-label">ETA</div></div></div></div>
        </div>
        <div id="step5" class="slide">
            <div class="success-container"><div class="success-icon">&#10004;</div><div class="success-title">USB Created!</div><div class="success-desc">Aegis OS Gamer Edition ready.</div><div class="success-steps"><h3>Next Steps:</h3><ol><li>Eject USB safely</li><li>Insert into target PC</li><li>Boot from USB (F12/F2)</li><li>Install Aegis OS</li></ol></div></div>
        </div>
    </div>
    <div class="wizard-footer"><button id="btnBack" class="btn btn-secondary hidden" onclick="OnBackClick()">Back</button><button id="btnNext" class="btn btn-primary" onclick="OnNextClick()">Next</button></div>
</div>
</body>
</html>
