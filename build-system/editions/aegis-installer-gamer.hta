<html>
<head>
<title>Aegis OS Media Creation Tool - Gamer Edition</title>
<HTA:APPLICATION ID="AegisGamerInstaller" APPLICATIONNAME="Aegis OS Gamer Edition" BORDER="thick" BORDERSTYLE="raised" CAPTION="yes" MAXIMIZEBUTTON="no" MINIMIZEBUTTON="yes" SHOWINTASKBAR="yes" SINGLEINSTANCE="yes" SYSMENU="yes" VERSION="3.0" SCROLL="no"/>
<script language="VBScript">
Dim selectedDrive, selectedDriveNumber, drives(), driveCount, progressTimer, shell, fso, wmi
Dim smoothProgress, partitionStyle, currentStep
Const EDITION = "gamer"
Const EDITION_NAME = "Gamer"

Function IsAdmin(): On Error Resume Next: IsAdmin = (CreateObject("WScript.Shell").Run("net session", 0, True) = 0): On Error Goto 0: End Function
Sub RestartAsAdmin(): Dim shellApp, htaPath: Set shellApp = CreateObject("Shell.Application"): htaPath = document.location.pathname: If Left(htaPath, 1) = "/" Then htaPath = Mid(htaPath, 2): htaPath = Replace(htaPath, "%20", " "): shellApp.ShellExecute "mshta.exe", Chr(34) & htaPath & Chr(34), "", "runas", 1: window.close: End Sub

Sub Window_OnLoad()
    If Not IsAdmin() Then
        If MsgBox("This tool requires Administrator privileges." & vbCrLf & vbCrLf & "Restart with elevated permissions?", vbYesNo + vbQuestion, "Administrator Required") = vbYes Then RestartAsAdmin: Exit Sub Else document.getElementById("adminNotice").style.display = ""
    End If
    window.resizeTo 720, 500
    Set shell = CreateObject("WScript.Shell"): Set fso = CreateObject("Scripting.FileSystemObject")
    smoothProgress = 0: partitionStyle = "GPT": currentStep = 1
    CheckSystemRequirements: UpdateStepIndicator: UpdateButtons
End Sub

Sub CheckSystemRequirements()
    Dim ramGB, freeSpaceGB, osVer, html
    On Error Resume Next
    Set wmi = GetObject("winmgmts:\\.\root\cimv2"): ramGB = 0: freeSpaceGB = 0: osVer = ""
    For Each mem In wmi.ExecQuery("SELECT TotalPhysicalMemory FROM Win32_ComputerSystem"): ramGB = Round(mem.TotalPhysicalMemory / 1073741824, 1): Next
    For Each os In wmi.ExecQuery("SELECT Caption FROM Win32_OperatingSystem"): osVer = os.Caption: Next
    Set drv = fso.GetDrive(fso.GetDriveName(shell.ExpandEnvironmentStrings("%TEMP%"))): If Not drv Is Nothing Then freeSpaceGB = Round(drv.FreeSpace / 1073741824, 1)
    On Error Goto 0
    html = "<tr><td>RAM:</td><td><b>" & ramGB & " GB</b></td></tr><tr><td>Free Space:</td><td><b>" & freeSpaceGB & " GB</b></td></tr><tr><td>Windows:</td><td><b>" & osVer & "</b></td></tr>"
    document.getElementById("sysReqContent").innerHTML = html
End Sub

Sub RefreshDrives()
    Dim diskDrives, disk, html, sizeGB, modelName
    On Error Resume Next
    If wmi Is Nothing Then Set wmi = GetObject("winmgmts:\\.\root\cimv2")
    Set diskDrives = wmi.ExecQuery("SELECT * FROM Win32_DiskDrive WHERE MediaType LIKE '%Removable%' OR InterfaceType='USB'")
    ReDim drives(0): driveCount = 0: html = ""
    For Each disk In diskDrives
        If disk.Size > 0 And InStr(LCase(disk.PNPDeviceID), "virtual") = 0 Then
            sizeGB = FormatNumber(disk.Size / 1073741824, 1): modelName = disk.Model: If IsNull(modelName) Or modelName = "" Then modelName = "USB Drive"
            ReDim Preserve drives(driveCount): drives(driveCount) = disk.Index
            html = html & "<tr id=""drive" & driveCount & """ onclick=""SelectDrive(" & driveCount & ")"" style=""cursor:pointer;""><td style=""padding:8px;border-bottom:1px solid #D4D0C8;""><b>" & modelName & "</b></td><td style=""padding:8px;border-bottom:1px solid #D4D0C8;"" align=""center"">" & sizeGB & " GB</td><td style=""padding:8px;border-bottom:1px solid #D4D0C8;"" align=""center"">Disk " & disk.Index & "</td></tr>"
            driveCount = driveCount + 1
        End If
    Next
    On Error Goto 0
    If driveCount = 0 Then html = "<tr><td colspan=""3"" align=""center"" style=""padding:20px;color:#808080;"">No USB drives detected.</td></tr>"
    document.getElementById("driveList").innerHTML = html: selectedDrive = "": selectedDriveNumber = -1: UpdateButtons
End Sub

Sub SelectDrive(index)
    Dim i, row
    On Error Resume Next
    For i = 0 To driveCount - 1: Set row = document.getElementById("drive" & i): If Not row Is Nothing Then row.style.backgroundColor = "": Next
    Set row = document.getElementById("drive" & index)
    If Not row Is Nothing Then row.style.backgroundColor = "#FFE4E4": selectedDriveNumber = drives(index): selectedDrive = row.cells(0).innerText
    UpdateButtons: On Error Goto 0
End Sub

Sub SetPartitionStyle(style): partitionStyle = style: End Sub
Sub ShowStep(stepNum)
    Dim i: On Error Resume Next
    For i = 1 To 5: document.getElementById("step" & i).style.display = "none": Next
    document.getElementById("step" & stepNum).style.display = "": currentStep = stepNum
    If stepNum = 2 Then RefreshDrives
    If stepNum = 3 Then document.getElementById("confirmDrive").innerText = selectedDrive: document.getElementById("confirmPartStyle").innerText = partitionStyle
    If stepNum = 4 Then document.getElementById("progressBar").style.width = "0%": document.getElementById("progressPercent").innerText = "0%": document.getElementById("progressStatus").innerText = "Starting...": smoothProgress = 0
    UpdateStepIndicator: UpdateButtons: On Error Goto 0
End Sub

Sub UpdateStepIndicator(): document.getElementById("stepIndicator").innerText = "Step " & currentStep & " of 5: " & Array("Welcome", "USB Drive", "Confirm", "Creating", "Done")(currentStep - 1): End Sub
Sub UpdateButtons()
    On Error Resume Next
    document.getElementById("btnBack").disabled = (currentStep = 1 Or currentStep = 4 Or currentStep = 5)
    Select Case currentStep
        Case 3: document.getElementById("btnNext").value = "Create USB"
        Case 5: document.getElementById("btnNext").value = "Close"
        Case Else: document.getElementById("btnNext").value = "Next >"
    End Select
    document.getElementById("btnNext").disabled = (currentStep = 2 And selectedDriveNumber < 0) Or currentStep = 4
    On Error Goto 0
End Sub

Sub GoBack()
    If currentStep > 1 And currentStep < 4 Then ShowStep(currentStep - 1)
End Sub

Sub GoNext()
    Select Case currentStep
        Case 1: ShowStep 2
        Case 2: If selectedDriveNumber >= 0 Then ShowStep 3
        Case 3: ShowStep 4: CreateUSB
        Case 5: window.close
    End Select
End Sub

Sub CreateUSB()
    Dim tempDir, psFile, progressFile, psCode, ts
    tempDir = shell.ExpandEnvironmentStrings("%TEMP%"): psFile = tempDir & "\aegis_creator.ps1": progressFile = tempDir & "\aegis_progress.txt"
    If fso.FileExists(progressFile) Then fso.DeleteFile progressFile
    psCode = GetPowerShellCode(): Set ts = fso.CreateTextFile(psFile, True): ts.Write psCode: ts.Close
    progressTimer = window.setInterval(GetRef("CheckProgress"), 500)
    shell.Run "powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File """ & psFile & """ -DiskNumber " & selectedDriveNumber & " -PartitionStyle """ & partitionStyle & """ -ProgressFile """ & progressFile & """", 0, False
End Sub

Function GetPowerShellCode()
    Dim code
    code = "param([int]$DiskNumber, [string]$PartitionStyle, [string]$ProgressFile)" & vbCrLf
    code = code & "$ErrorActionPreference = 'Stop'" & vbCrLf
    code = code & "function Write-P { param([int]$P, [string]$S, [string]$D=''); ""$P|$S|$D"" | Out-File $ProgressFile -Encoding UTF8 -Force }" & vbCrLf
    code = code & "function Write-ISOToUSB { param([string]$IsoPath, [string]$UsbPath); $bs=4MB; $is=[IO.File]::OpenRead($IsoPath); $tb=$is.Length; $us=New-Object IO.FileStream($UsbPath,[IO.FileMode]::Open,[IO.FileAccess]::ReadWrite,[IO.FileShare]::None,$bs); $bf=New-Object byte[] $bs; $bw=0; $lu=Get-Date; while(($br=$is.Read($bf,0,$bf.Length)) -gt 0){$us.Write($bf,0,$br);$us.Flush();$bw+=$br;if(((Get-Date)-$lu).TotalSeconds -ge 1){$p=[int](($bw/$tb)*100);Write-P (56+[int]($p*0.40)) ""Writing: $p%"";$lu=Get-Date}};$is.Close();$us.Close();return $true }" & vbCrLf
    code = code & "try { Write-P 0 'Initializing...' 'Aegis OS Gamer'; $disk = Get-Disk -Number $DiskNumber; if ($disk.IsSystem -or $disk.IsBoot) { Write-P -1 'SYSTEM_DRIVE'; exit 1 }; Write-P 3 'USB validated' ''" & vbCrLf
    code = code & "$tempDir = ""$env:TEMP\AegisOS""; New-Item -ItemType Directory -Path $tempDir -Force | Out-Null; $isoPath = ""$tempDir\base.iso""; $mirrors = @('https://repo.linuxliteos.com/linuxlite/isos/7.2/linux-lite-7.2-64bit.iso','https://mirror.freedif.org/LinuxLiteOS/isos/7.2/linux-lite-7.2-64bit.iso'); $expectedHash = 'DC8955E02C68537815ED0010F7C4C035CE786BBA2C679DD74532B22205DF8216'" & vbCrLf
    code = code & "Write-P 5 'Downloading...' 'Aegis OS Gamer (~2.9 GB)'; foreach ($url in $mirrors) { try { $web=[Net.HttpWebRequest]::Create($url);$web.UserAgent='AegisOS/3.0';$resp=$web.GetResponse();$total=$resp.ContentLength;$rs=$resp.GetResponseStream();$fs=[IO.File]::Create($isoPath);$buf=New-Object byte[] 8MB;$dl=0;$lt=Get-Date;while(($br=$rs.Read($buf,0,$buf.Length)) -gt 0){$fs.Write($buf,0,$br);$dl+=$br;if(((Get-Date)-$lt).TotalSeconds -ge 1){$p=[int](($dl/$total)*100);Write-P (8+[int]($p*0.40)) ""Downloading: $p%"";$lt=Get-Date}};$fs.Close();$rs.Close();break } catch { continue }}" & vbCrLf
    code = code & "if (-not (Test-Path $isoPath)) { Write-P -1 'DOWNLOAD_FAILED'; exit 1 }; Write-P 50 'Verifying...' 'SHA256'; $hash=(Get-FileHash $isoPath -Algorithm SHA256).Hash; if ($hash -ne $expectedHash) { Write-P -1 'CHECKSUM_FAILED'; exit 1 }" & vbCrLf
    code = code & "Write-P 54 'Preparing USB...' ''; $dp=""select disk $DiskNumber`nclean`noffline disk`nexit""; $dp | Out-File ""$tempDir\dp.txt"" -Encoding ASCII; diskpart /s ""$tempDir\dp.txt"" | Out-Null; Write-P 56 'Writing...' 'Do not remove USB!'; Start-Sleep 2; Write-ISOToUSB $isoPath ""\\.\PhysicalDrive$DiskNumber"" | Out-Null" & vbCrLf
    code = code & "Write-P 97 'Finishing...' ''; $dp2=""select disk $DiskNumber`nonline disk`nexit""; $dp2 | Out-File ""$tempDir\dp2.txt"" -Encoding ASCII; diskpart /s ""$tempDir\dp2.txt"" | Out-Null; Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue; Write-P 100 'SUCCESS!' 'Safe to remove USB.' } catch { Write-P -1 $_.Exception.Message; exit 1 }" & vbCrLf
    GetPowerShellCode = code
End Function

Sub CheckProgress()
    Dim progressFile, ts, line, parts, pct, status, detail
    On Error Resume Next
    progressFile = shell.ExpandEnvironmentStrings("%TEMP%") & "\aegis_progress.txt"
    If fso.FileExists(progressFile) Then
        Set ts = fso.OpenTextFile(progressFile, 1): line = ts.ReadLine(): ts.Close
        parts = Split(line, "|"): pct = CInt(parts(0))
        status = "": detail = ""
        If UBound(parts) >= 1 Then status = parts(1)
        If UBound(parts) >= 2 Then detail = parts(2)
        If pct = -1 Then
            window.clearInterval progressTimer: ShowError status, detail
        ElseIf pct = 100 Then
            window.clearInterval progressTimer: UpdateProgress 100, status, detail: window.setTimeout GetRef("GoToStepFive"), 1500
        Else
            UpdateProgress pct, status, detail
        End If
    End If
    On Error Goto 0
End Sub

Sub GoToStepFive(): ShowStep 5: End Sub
Sub UpdateProgress(pct, status, detail): document.getElementById("progressBar").style.width = pct & "%": document.getElementById("progressPercent").innerText = pct & "%": document.getElementById("progressStatus").innerText = status: If Len(detail) > 0 Then document.getElementById("progressDetail").innerText = detail: End Sub
Sub ShowError(msg, detail): document.getElementById("progressContainer").innerHTML = "<table width=""100%"" cellpadding=""10"" bgcolor=""#FFF0F0"" style=""border:2px solid #CC0000;""><tr><td align=""center""><font size=""4"" color=""#CC0000""><b>Error</b></font><br><br>" & msg & "</td></tr></table>": currentStep = 1: UpdateButtons: document.getElementById("btnBack").disabled = False: document.getElementById("btnBack").value = "Try Again": End Sub
</script>
</head>
<body bgcolor="#ECE9D8" style="margin:0;padding:0;font-family:Tahoma,Arial,sans-serif;font-size:12px;">
<table width="100%" height="100%" cellpadding="0" cellspacing="0" border="0">
    <tr><td height="50" bgcolor="#CC0000" style="padding:10px 15px;color:white;"><font size="4"><b>Aegis OS Media Creation Tool</b></font><br><font size="2">Gamer Edition</font></td></tr>
    <tr><td height="28" bgcolor="#D4D0C8" style="padding:5px 15px;border-bottom:1px solid #808080;"><span id="stepIndicator">Step 1 of 5: Welcome</span></td></tr>
    <tr><td valign="top" style="padding:15px;">
        <div id="step1">
            <table id="adminNotice" width="100%" cellpadding="8" bgcolor="#FFFACD" style="display:none;border:1px solid #CC6600;margin-bottom:10px;"><tr><td><font color="#CC6600"><b>Note:</b> Run as Administrator.</font></td></tr></table>
            <font size="3"><b>Welcome to Aegis OS Gamer</b></font><br><br>
            <table width="100%" cellpadding="8" bgcolor="#FFE8E8" style="border:1px solid #CC0000;"><tr><td><b>Gaming Features:</b><br><br>&#10003; Gaming Optimizer<br>&#10003; FPS Boost<br>&#10003; Streaming Tools<br>&#10003; Discord Integration<br>&#10003; Low Latency Mode<br>&#10003; GPU Overclocking</td></tr></table><br>
            <table width="100%" cellpadding="5" bgcolor="#F5F5F5" style="border:1px solid #808080;"><tr bgcolor="#D4D0C8"><td colspan="2"><b>System Check</b></td></tr><tbody id="sysReqContent"><tr><td colspan="2">Checking...</td></tr></tbody></table>
        </div>
        <div id="step2" style="display:none;"><font size="3"><b>Select USB Drive</b></font><br><font color="#808080">All data will be erased.</font><br><br><table width="100%" bgcolor="#FFFFFF" style="border:1px solid #808080;"><tr bgcolor="#D4D0C8"><td style="padding:8px;"><b>Drive</b></td><td style="padding:8px;" align="center" width="80"><b>Size</b></td><td style="padding:8px;" align="center" width="80"><b>Disk #</b></td></tr><tbody id="driveList"><tr><td colspan="3" align="center" style="padding:20px;color:#808080;">Click Refresh</td></tr></tbody></table><br><input type="button" value="Refresh" onclick="RefreshDrives()" style="width:100px;height:26px;"><br><br><table width="100%" cellpadding="5" bgcolor="#F5F5F5" style="border:1px solid #808080;"><tr bgcolor="#D4D0C8"><td colspan="2"><b>Options</b></td></tr><tr><td width="120">Partition:</td><td><input type="radio" name="ps" checked onclick="SetPartitionStyle('GPT')"> GPT &nbsp;<input type="radio" name="ps" onclick="SetPartitionStyle('MBR')"> MBR</td></tr></table><br><table width="100%" cellpadding="8" bgcolor="#FFF0F0" style="border:1px solid #CC0000;"><tr><td><font color="#CC0000"><b>Warning:</b> All data will be erased!</font></td></tr></table></div>
        <div id="step3" style="display:none;"><font size="3"><b>Confirm Settings</b></font><br><br><table width="100%" cellpadding="8" bgcolor="#F5F5F5" style="border:1px solid #808080;"><tr bgcolor="#D4D0C8"><td colspan="2"><b>Summary</b></td></tr><tr><td width="140">Edition:</td><td><b>Aegis OS Gamer</b></td></tr><tr><td>USB Drive:</td><td><b><span id="confirmDrive">-</span></b></td></tr><tr><td>Partition:</td><td><b><span id="confirmPartStyle">GPT</span></b></td></tr></table><br><table width="100%" cellpadding="8" bgcolor="#E8F5FF" style="border:1px solid #0066CC;"><tr><td><font color="#0066CC"><b>Ready!</b></font> Click Create USB to begin.</td></tr></table></div>
        <div id="step4" style="display:none;"><font size="3"><b>Creating USB</b></font><br><br><div id="progressContainer"><table width="100%" cellpadding="10" bgcolor="#F5F5F5" style="border:1px solid #808080;"><tr><td align="center"><font size="5"><b><span id="progressPercent">0%</span></b></font><br><br><table width="90%" height="20" bgcolor="#D4D0C8" style="border:1px solid #808080;"><tr><td><div id="progressBar" style="width:0%;height:18px;background:#CC0000;"></div></td></tr></table><br><span id="progressStatus">Starting...</span><br><font color="#808080"><span id="progressDetail"></span></font></td></tr></table></div><br><table width="100%" cellpadding="8" bgcolor="#FFFACD" style="border:1px solid #CC6600;"><tr><td><font color="#CC6600"><b>Do not remove USB!</b></font></td></tr></table></div>
        <div id="step5" style="display:none;"><table width="100%" cellpadding="15" bgcolor="#E8F5E8" style="border:2px solid #228B22;"><tr><td align="center"><font size="5" color="#228B22"><b>&#10004; Success!</b></font><br><br><font size="3"><b>Aegis OS Gamer Ready</b></font></td></tr></table><br><table width="100%" cellpadding="8" bgcolor="#F5F5F5" style="border:1px solid #808080;"><tr bgcolor="#D4D0C8"><td><b>Next Steps:</b></td></tr><tr><td><ol><li>Remove USB safely</li><li>Insert into target PC</li><li>Boot from USB</li><li>Follow installer</li></ol></td></tr></table></div>
    </td></tr>
    <tr><td height="50" bgcolor="#D4D0C8" style="padding:10px 15px;border-top:1px solid #808080;" align="right"><input type="button" id="btnBack" value="< Back" style="width:85px;height:28px;" onclick="GoBack()" disabled><input type="button" id="btnNext" value="Next >" style="width:100px;height:28px;margin-left:8px;font-weight:bold;" onclick="GoNext()"><input type="button" value="Cancel" style="width:85px;height:28px;margin-left:20px;" onclick="window.close()"></td></tr>
</table>
</body>
</html>
