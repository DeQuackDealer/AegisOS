
#!/usr/bin/env python3
"""
Aegis OS VM Optimizer - Detect and optimize for virtual machine environments
"""

import subprocess
import os

def detect_vm():
    """Detect if running in a virtual machine"""
    vm_indicators = [
        ('VMware', ['vmware', 'vmxnet']),
        ('VirtualBox', ['vboxguest', 'vboxsf']),
        ('Hyper-V', ['hv_vmbus', 'hyperv']),
        ('QEMU/KVM', ['virtio', 'qemu'])
    ]
    
    try:
        lsmod_output = subprocess.check_output(['lsmod'], text=True)
        dmesg_output = subprocess.check_output(['dmesg'], text=True, stderr=subprocess.DEVNULL)
        
        for vm_name, indicators in vm_indicators:
            if any(indicator in lsmod_output.lower() or indicator in dmesg_output.lower() 
                   for indicator in indicators):
                return vm_name
    except:
        pass
    
    return None

def optimize_for_vm(vm_type):
    """Apply VM-specific optimizations"""
    print(f"üñ•Ô∏è Virtual Machine detected: {vm_type}")
    
    # Common VM optimizations
    optimizations = [
        # Reduce compositor effects for better performance
        ['xfconf-query', '-c', 'xfwm4', '-p', '/general/use_compositing', '-s', 'false'],
        
        # Optimize desktop for VM
        ['xfconf-query', '-c', 'xfce4-desktop', '-p', '/backdrop/screen0/monitor0/workspace0/color-style', '-s', '0'],
        
        # Reduce visual effects
        ['xfconf-query', '-c', 'xfce4-panel', '-p', '/panels/panel-0/background-alpha', '-s', '100'],
    ]
    
    # VM-specific optimizations
    if vm_type == 'VMware':
        print("üîß Applying VMware optimizations...")
        # Enable VMware tools integration
        optimizations.extend([
            ['systemctl', 'enable', 'vmtoolsd'],
            ['systemctl', 'start', 'vmtoolsd']
        ])
    
    elif vm_type == 'VirtualBox':
        print("üîß Applying VirtualBox optimizations...")
        # Enable VBox guest additions
        optimizations.extend([
            ['systemctl', 'enable', 'vboxservice'],
            ['systemctl', 'start', 'vboxservice']
        ])
    
    # Apply optimizations
    for cmd in optimizations:
        try:
            subprocess.run(cmd, capture_output=True)
        except:
            continue
    
    print("‚úÖ VM optimizations applied successfully!")

if __name__ == "__main__":
    vm_type = detect_vm()
    if vm_type:
        optimize_for_vm(vm_type)
    else:
        print("üíª Running on physical hardware - no VM optimizations needed")
